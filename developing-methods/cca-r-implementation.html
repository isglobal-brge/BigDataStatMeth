<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>CCA Implementation in R – BigDataStatMeth</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../assets/favicon.png" rel="icon" type="image/png">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-065a5179aebd64318d7ea99d77b64a9e.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark-969ddfa49e00a70eb3423444dbc81f6c.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-065a5179aebd64318d7ea99d77b64a9e.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-d0f1cdce0779274a5ec1152cd33adb41.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark-d6747531eee53fd58085a197f3afc013.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-d0f1cdce0779274a5ec1152cd33adb41.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>html{ scroll-behavior: smooth; }</style>

  <script>window.backupDefine = window.define; window.define = undefined;</script><script src="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.js"></script>
  <script>document.addEventListener("DOMContentLoaded", function () {
 var mathElements = document.getElementsByClassName("math");
 var macros = [];
 for (var i = 0; i < mathElements.length; i++) {
  var texText = mathElements[i].firstChild;
  if (mathElements[i].tagName == "SPAN") {
   katex.render(texText.data, mathElements[i], {
    displayMode: mathElements[i].classList.contains('display'),
    throwOnError: false,
    macros: macros,
    fleqn: false
   });
}}});
  </script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css">

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../assets/css/custom.css">
</head>

<body class="nav-sidebar docked nav-fixed quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../assets/images/logo.png" alt="" class="navbar-logo light-content">
    <img src="../assets/images/logo.png" alt="" class="navbar-logo dark-content">
    </a>
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">BigDataStatMeth</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="../index.html" aria-current="page"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-fundamentals" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Fundamentals</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-fundamentals">    
        <li>
    <a class="dropdown-item" href="../fundamentals/big-data-problem.html">
 <span class="dropdown-text">The Big Data Problem</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../fundamentals/understanding-hdf5.html">
 <span class="dropdown-text">Understanding HDF5</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../fundamentals/blockwise-computing.html">
 <span class="dropdown-text">Block-Wise Computing</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../fundamentals/linear-algebra.html">
 <span class="dropdown-text">Linear Algebra Essentials</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-tutorials" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Tutorials</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-tutorials">    
        <li>
    <a class="dropdown-item" href="../tutorials/getting-started.html">
 <span class="dropdown-text">Getting Started</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../tutorials/working-hdf5-matrices.html">
 <span class="dropdown-text">Working with HDF5 Matrices</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../tutorials/first-analysis.html">
 <span class="dropdown-text">Your First Analysis</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-workflows" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Workflows</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-workflows">    
        <li>
    <a class="dropdown-item" href="../workflows/implementing-pca.html">
 <span class="dropdown-text">Implementing PCA</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../workflows/implementing-cca.html">
 <span class="dropdown-text">Implementing CCA</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../workflows/cross-platform.html">
 <span class="dropdown-text">Cross-Platform Workflows</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-developing-methods" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Developing Methods</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-developing-methods">    
        <li>
    <a class="dropdown-item" href="../developing-methods/cca-r-implementation.html">
 <span class="dropdown-text">CCA in R</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../developing-methods/cca-cpp-implementation.html">
 <span class="dropdown-text">CCA in C++</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-api-reference" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">API Reference</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-api-reference">    
        <li>
    <a class="dropdown-item" href="../api-reference/r/index.html">
 <span class="dropdown-text">R Functions</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../api-reference/cpp/index.html">
 <span class="dropdown-text">C++ API</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../technical/performance.html"> 
<span class="menu-text">Technical</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/isglobal-brge/BigDataStatMeth"> <i class="bi bi-github" role="img" aria-label="GitHub">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://cran.r-project.org/package=BigDataStatMeth"> 
<span class="menu-text">CRAN</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../developing-methods/cca-r-implementation.html">Building New Methods</a></li><li class="breadcrumb-item"><a href="../developing-methods/cca-r-implementation.html">CCA Implementation in R</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="../index.html" class="sidebar-logo-link">
      </a>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Building New Methods</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../developing-methods/cca-r-implementation.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">CCA Implementation in R</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../developing-methods/cca-cpp-implementation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">CCA Implementation in C++</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview"><span class="header-section-number">1</span> Overview</a>
  <ul class="collapse">
  <li><a href="#what-youll-learn" id="toc-what-youll-learn" class="nav-link" data-scroll-target="#what-youll-learn"><span class="header-section-number">1.1</span> What You’ll Learn</a></li>
  </ul></li>
  <li><a href="#cca-algorithm-overview" id="toc-cca-algorithm-overview" class="nav-link" data-scroll-target="#cca-algorithm-overview"><span class="header-section-number">2</span> CCA Algorithm Overview</a>
  <ul class="collapse">
  <li><a href="#mathematical-foundation" id="toc-mathematical-foundation" class="nav-link" data-scroll-target="#mathematical-foundation"><span class="header-section-number">2.1</span> Mathematical Foundation</a></li>
  <li><a href="#why-block-wise-processing" id="toc-why-block-wise-processing" class="nav-link" data-scroll-target="#why-block-wise-processing"><span class="header-section-number">2.2</span> Why Block-Wise Processing?</a></li>
  </ul></li>
  <li><a href="#step-1-qr-decomposition-by-blocks" id="toc-step-1-qr-decomposition-by-blocks" class="nav-link" data-scroll-target="#step-1-qr-decomposition-by-blocks"><span class="header-section-number">3</span> Step 1: QR Decomposition by Blocks</a>
  <ul class="collapse">
  <li><a href="#the-getqrbyblocks-function" id="toc-the-getqrbyblocks-function" class="nav-link" data-scroll-target="#the-getqrbyblocks-function"><span class="header-section-number">3.1</span> The getQRbyBlocks Function</a></li>
  </ul></li>
  <li><a href="#step-2-main-cca-function" id="toc-step-2-main-cca-function" class="nav-link" data-scroll-target="#step-2-main-cca-function"><span class="header-section-number">4</span> Step 2: Main CCA Function</a></li>
  <li><a href="#step-3-computing-canonical-coefficients" id="toc-step-3-computing-canonical-coefficients" class="nav-link" data-scroll-target="#step-3-computing-canonical-coefficients"><span class="header-section-number">5</span> Step 3: Computing Canonical Coefficients</a></li>
  <li><a href="#example-usage" id="toc-example-usage" class="nav-link" data-scroll-target="#example-usage"><span class="header-section-number">6</span> Example Usage</a></li>
  <li><a href="#interactive-exercise" id="toc-interactive-exercise" class="nav-link" data-scroll-target="#interactive-exercise"><span class="header-section-number">7</span> Interactive Exercise</a>
  <ul class="collapse">
  <li><a href="#practice-modifying-the-cca-implementation" id="toc-practice-modifying-the-cca-implementation" class="nav-link" data-scroll-target="#practice-modifying-the-cca-implementation"><span class="header-section-number">7.1</span> Practice: Modifying the CCA Implementation</a></li>
  </ul></li>
  <li><a href="#key-takeaways" id="toc-key-takeaways" class="nav-link" data-scroll-target="#key-takeaways"><span class="header-section-number">8</span> Key Takeaways</a>
  <ul class="collapse">
  <li><a href="#essential-concepts" id="toc-essential-concepts" class="nav-link" data-scroll-target="#essential-concepts"><span class="header-section-number">8.1</span> Essential Concepts</a></li>
  <li><a href="#when-to-implement-methods-in-r" id="toc-when-to-implement-methods-in-r" class="nav-link" data-scroll-target="#when-to-implement-methods-in-r"><span class="header-section-number">8.2</span> When to Implement Methods in R</a></li>
  </ul></li>
  <li><a href="#next-steps" id="toc-next-steps" class="nav-link" data-scroll-target="#next-steps"><span class="header-section-number">9</span> Next Steps</a></li>
  <li><a href="#cleanup" id="toc-cleanup" class="nav-link" data-scroll-target="#cleanup"><span class="header-section-number">10</span> Cleanup</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/isglobal-brge/BigDataStatMeth/edit/main/developing-methods/cca-r-implementation.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/isglobal-brge/BigDataStatMeth/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">


<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../developing-methods/cca-r-implementation.html">Building New Methods</a></li><li class="breadcrumb-item"><a href="../developing-methods/cca-r-implementation.html">CCA Implementation in R</a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">CCA Implementation in R</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
<p class="subtitle lead">Building Canonical Correlation Analysis Using BigDataStatMeth R API</p>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="overview" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="overview"><span class="header-section-number">1</span> Overview</h2>
<p>This document shows how to implement Canonical Correlation Analysis (CCA) from scratch using BigDataStatMeth’s R API. Rather than using a pre-built CCA function, you’ll see how to combine BigDataStatMeth’s building blocks—QR decomposition, matrix operations, SVD—to create a complete statistical method.</p>
<p>Think of this as a blueprint for developing your own statistical methods. CCA serves as the example, but the patterns you’ll learn apply to any algorithm: partition data into blocks, apply operations iteratively, combine results hierarchically. This is how you extend BigDataStatMeth beyond its built-in functions to implement novel statistical methods for big data.</p>
<section id="what-youll-learn" class="level3 learning-objectives" data-number="1.1">
<h3 data-number="1.1" class="anchored" data-anchor-id="what-youll-learn"><span class="header-section-number">1.1</span> What You’ll Learn</h3>
<p>By the end of this document, you will:</p>
<ul>
<li>Understand CCA’s mathematical algorithm and why block-wise processing helps</li>
<li>Implement QR decomposition by blocks for large matrices</li>
<li>Combine intermediate QR results hierarchically</li>
<li>Compute canonical correlations from Q matrices</li>
<li>Extract canonical coefficients and variates</li>
<li>Structure complex multi-step algorithms in R</li>
<li>Manage intermediate results in HDF5 files</li>
<li>Create reusable functions for new statistical methods</li>
</ul>
</section>
<hr>
</section>
<section id="cca-algorithm-overview" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="cca-algorithm-overview"><span class="header-section-number">2</span> CCA Algorithm Overview</h2>
<section id="mathematical-foundation" class="level3" data-number="2.1">
<h3 data-number="2.1" class="anchored" data-anchor-id="mathematical-foundation"><span class="header-section-number">2.1</span> Mathematical Foundation</h3>
<p>Canonical Correlation Analysis finds linear combinations of features in X and Y that maximize correlation:</p>
<p><span class="math display">
\max_{\alpha, \beta} \text{cor}(X\alpha, Y\beta)
</span></p>
<p>The standard algorithm:</p>
<ol type="1">
<li>Compute QR decompositions: <span class="math inline">X = Q_X R_X</span>, <span class="math inline">Y = Q_Y R_Y</span></li>
<li>Compute cross-product: <span class="math inline">M = Q_X^T Q_Y</span></li>
<li>SVD of cross-product: <span class="math inline">M = U D V^T</span></li>
<li>Solve for canonical coefficients: <span class="math inline">\alpha = R_X^{-1} U</span>, <span class="math inline">\beta = R_Y^{-1} V</span></li>
<li>Compute canonical variates: <span class="math inline">s_X = X\alpha</span>, <span class="math inline">s_Y = Y\beta</span></li>
</ol>
</section>
<section id="why-block-wise-processing" class="level3" data-number="2.2">
<h3 data-number="2.2" class="anchored" data-anchor-id="why-block-wise-processing"><span class="header-section-number">2.2</span> Why Block-Wise Processing?</h3>
<p>For large matrices (e.g., 50,000 samples × 500,000 genomic features), computing QR decomposition directly requires massive RAM. Block-wise processing:</p>
<ul>
<li>Partitions X into m blocks by rows</li>
<li>Computes QR on each block separately (manageable size)</li>
<li>Combines block QR results hierarchically</li>
<li>Final result identical to full QR, but memory-friendly</li>
</ul>
<hr>
</section>
</section>
<section id="step-1-qr-decomposition-by-blocks" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="step-1-qr-decomposition-by-blocks"><span class="header-section-number">3</span> Step 1: QR Decomposition by Blocks</h2>
<section id="the-getqrbyblocks-function" class="level3" data-number="3.1">
<h3 data-number="3.1" class="anchored" data-anchor-id="the-getqrbyblocks-function"><span class="header-section-number">3.1</span> The getQRbyBlocks Function</h3>
<p>This is the core building block. It computes QR decomposition of a matrix stored in HDF5 by processing it in blocks:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(BigDataStatMeth)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rhdf5)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>getQRbyBlocks <span class="ot">&lt;-</span> <span class="cf">function</span>(strdataset, file, m, center, scale, bcols, overwrt) {</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Parse dataset path (group/dataset)</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  strgroup <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"/.?$"</span>, <span class="st">""</span>, strdataset)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  strdataset <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"^.*/"</span>, <span class="st">""</span>, strdataset)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 1: Normalize the dataset</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Centering and scaling ensure numerical stability</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bdNormalize_hdf5</span>(</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> file,</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> strgroup,</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">dataset =</span> strdataset,</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">bcenter =</span> center,</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">bscale =</span> scale,</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">overwrite =</span> overwrt</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 2: Split matrix into m blocks</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Process by rows (samples) - each block gets ~n/m rows</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bdSplit_matrix_hdf5</span>(</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> file,</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="fu">paste0</span>(<span class="st">"NORMALIZED/"</span>, strgroup),</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">dataset =</span> strdataset,</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">outgroup =</span> <span class="fu">paste0</span>(<span class="st">"Step1/"</span>, strdataset, <span class="st">"rows"</span>),</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">nblocks =</span> m,</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">bycols =</span> bcols,  <span class="co"># FALSE = split by rows</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">overwrite =</span> overwrt</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 3: Apply QR to each block independently</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>  blocks <span class="ot">&lt;-</span> <span class="fu">bdgetDatasetsList_hdf5</span>(file, <span class="fu">paste0</span>(<span class="st">"Step1/"</span>, strdataset, <span class="st">"rows"</span>))</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bdapply_Function_hdf5</span>(</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> file,</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="fu">paste0</span>(<span class="st">"Step1/"</span>, strdataset, <span class="st">"rows"</span>),</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">datasets =</span> blocks,</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">outgroup =</span> <span class="fu">paste0</span>(<span class="st">"Step2/"</span>, strdataset, <span class="st">"rows"</span>),</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">func =</span> <span class="st">"QR"</span>,  <span class="co"># Apply QR decomposition</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">overwrite =</span> overwrt</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 4: Merge R matrices from all blocks</span></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># QR gives Q (orthogonal) and R (upper triangular)</span></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>  <span class="co"># We need to combine all R matrices</span></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>  blocks_qr <span class="ot">&lt;-</span> <span class="fu">bdgetDatasetsList_hdf5</span>(file, <span class="fu">paste0</span>(<span class="st">"Step2/"</span>, strdataset, <span class="st">"rows"</span>))</span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Filter to get only R matrices (not Q)</span></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>  r_matrices <span class="ot">&lt;-</span> blocks_qr[<span class="fu">which</span>(blocks_qr <span class="sc">%like%</span> <span class="st">".R"</span>)]</span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bdBind_hdf5_datasets</span>(</span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> file,</span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="fu">paste0</span>(<span class="st">"Step2/"</span>, strdataset, <span class="st">"rows"</span>),</span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">datasets =</span> r_matrices,</span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">outgroup =</span> <span class="st">"Step3/merged"</span>,</span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">outdataset =</span> <span class="fu">paste0</span>(strdataset, <span class="st">"Rt"</span>),</span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">func =</span> <span class="st">"bindRows"</span>,  <span class="co"># Stack R matrices vertically</span></span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">overwrite =</span> overwrt</span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 5: Final QR on merged R matrices</span></span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This gives us the overall R matrix</span></span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bdapply_Function_hdf5</span>(</span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> file,</span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"Step3/merged"</span>,</span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>    <span class="at">datasets =</span> <span class="fu">paste0</span>(strdataset, <span class="st">"Rt"</span>),</span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>    <span class="at">outgroup =</span> <span class="st">"Step3/Final_QR"</span>,</span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a>    <span class="at">func =</span> <span class="st">"QR"</span>,</span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>    <span class="at">overwrite =</span> overwrt</span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 6: Split final Q for block-wise multiplication</span></span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bdSplit_matrix_hdf5</span>(</span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> file,</span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"Step3/Final_QR"</span>,</span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>    <span class="at">dataset =</span> <span class="fu">paste0</span>(strdataset, <span class="st">"Rt.Q"</span>),</span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a>    <span class="at">outgroup =</span> <span class="st">"Step4/splitted"</span>,</span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a>    <span class="at">nblocks =</span> m,</span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a>    <span class="at">bycols =</span> bcols,</span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a>    <span class="at">overwrite =</span> overwrt</span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 7: Multiply original Q blocks by final Q blocks</span></span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This reconstructs the full Q matrix in blocks</span></span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a>  tmp <span class="ot">&lt;-</span> <span class="fu">bdgetDatasetsList_hdf5</span>(file, <span class="st">"Step4/splitted"</span>)</span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a>  Rt_Q_divide <span class="ot">&lt;-</span> tmp[<span class="fu">which</span>(tmp <span class="sc">%like%</span> <span class="fu">paste0</span>(strdataset, <span class="st">"Rt.Q"</span>))]</span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a>  q_matrices <span class="ot">&lt;-</span> blocks_qr[<span class="fu">which</span>(blocks_qr <span class="sc">%like%</span> <span class="st">".Q"</span>)]</span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bdapply_Function_hdf5</span>(</span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> file,</span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="fu">paste0</span>(<span class="st">"Step2/"</span>, strdataset, <span class="st">"rows"</span>),</span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a>    <span class="at">datasets =</span> q_matrices,</span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a>    <span class="at">outgroup =</span> <span class="st">"Step5"</span>,</span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a>    <span class="at">func =</span> <span class="st">"blockmult"</span>,</span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a>    <span class="at">b_group =</span> <span class="st">"Step4/splitted"</span>,</span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a>    <span class="at">b_datasets =</span> Rt_Q_divide,</span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a>    <span class="at">overwrite =</span> <span class="cn">TRUE</span></span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 8: Combine all Q blocks into final Q matrix</span></span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a>  blocks_Q <span class="ot">&lt;-</span> <span class="fu">bdgetDatasetsList_hdf5</span>(file, <span class="st">"Step5"</span>)</span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bdBind_hdf5_datasets</span>(</span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> file,</span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"Step5"</span>,</span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true" tabindex="-1"></a>    <span class="at">datasets =</span> blocks_Q[<span class="fu">which</span>(blocks_Q <span class="sc">%like%</span> <span class="fu">paste0</span>(strdataset, <span class="st">"."</span>))],</span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true" tabindex="-1"></a>    <span class="at">outgroup =</span> <span class="st">"Step6"</span>,</span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true" tabindex="-1"></a>    <span class="at">outdataset =</span> <span class="fu">paste0</span>(strdataset, <span class="st">"Q"</span>),</span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true" tabindex="-1"></a>    <span class="at">func =</span> <span class="st">"bindRows"</span>,</span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true" tabindex="-1"></a>    <span class="at">overwrite =</span> overwrt</span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-116"><a href="#cb1-116" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"✓ QR decomposition complete for"</span>, strdataset, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb1-117"><a href="#cb1-117" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Why This Multi-Step Process?
</div>
</div>
<div class="callout-body-container callout-body">
<p>Each block gets QR: <span class="math inline">X_i = Q_i R_i</span></p>
<p>Stacking all <span class="math inline">R_i</span> and taking QR again gives: <span class="math inline">[R_1; R_2; ...; R_m] = \tilde{Q} \tilde{R}</span></p>
<p>Multiplying: <span class="math inline">Q = [Q_1; Q_2; ...; Q_m] \times \tilde{Q}</span> gives the final Q</p>
<p>This hierarchical approach is mathematically equivalent to QR on the full matrix but processes data in memory-friendly chunks.</p>
</div>
</div>
<hr>
</section>
</section>
<section id="step-2-main-cca-function" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="step-2-main-cca-function"><span class="header-section-number">4</span> Step 2: Main CCA Function</h2>
<p>Now we combine everything into the complete CCA implementation:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>bdCCA_hdf5 <span class="ot">&lt;-</span> <span class="cf">function</span>(filename, X, Y, <span class="at">m =</span> <span class="dv">10</span>,</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>                       <span class="at">bcenter =</span> <span class="cn">TRUE</span>, <span class="at">bscale =</span> <span class="cn">FALSE</span>, <span class="at">bycols =</span> <span class="cn">FALSE</span>,</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>                       <span class="at">overwriteResults =</span> <span class="cn">FALSE</span>, <span class="at">keepInteResults =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  matrices <span class="ot">&lt;-</span> <span class="fu">c</span>(X, Y)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 1-6: Compute QR for both X and Y</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This is the computationally intensive part</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sapply</span>(</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    matrices,</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    getQRbyBlocks,</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">file =</span> filename,</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">m =</span> m,</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">center =</span> bcenter,</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">scale =</span> bscale,</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">bcols =</span> bycols,</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">overwrt =</span> overwriteResults</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"✓ QR decompositions complete for both matrices</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 7: Compute cross-product of Q matrices</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This finds the canonical space</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">bdCrossprod_hdf5</span>(</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> filename,</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"Step6"</span>,</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">A =</span> <span class="st">"XQ"</span>,</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">groupB =</span> <span class="st">"Step6"</span>,</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">B =</span> <span class="st">"YQ"</span>,</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">outdataset =</span> <span class="st">"CrossProd_XQ_YQ"</span>,</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">outgroup =</span> <span class="st">"Step7"</span>,</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">overwrite =</span> <span class="cn">TRUE</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"✓ Cross-product computed</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 8: SVD of cross-product</span></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Singular values = canonical correlations</span></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># U, V = canonical directions</span></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">bdSVD_hdf5</span>(</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">file =</span> filename,</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"Step7"</span>,</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">dataset =</span> <span class="st">"CrossProd_XQ_YQ"</span>,</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">bcenter =</span> <span class="cn">FALSE</span>,  <span class="co"># Already centered</span></span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">bscale =</span> <span class="cn">FALSE</span>,</span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">k =</span> <span class="dv">16</span>,  <span class="co"># Process in blocks</span></span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">q =</span> <span class="dv">2</span>,   <span class="co"># Two-level hierarchy</span></span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">threads =</span> <span class="dv">3</span>,</span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">overwrite =</span> <span class="cn">TRUE</span></span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"✓ SVD computed - canonical correlations extracted</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get dimensions for coefficient computation</span></span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">sapply</span>(matrices, bdgetDim_hdf5, <span class="at">filename =</span> filename)</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 9: Compute and save canonical coefficients</span></span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">writeCCAComponents_hdf5</span>(filename, res[<span class="dv">2</span>, X], res[<span class="dv">2</span>, Y])</span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"✓ Canonical coefficients and variates saved</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Cleanup intermediate results if requested</span></span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (keepInteResults <span class="sc">==</span> <span class="cn">FALSE</span>) {</span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sapply</span>(<span class="fu">paste0</span>(<span class="st">"Step"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>), <span class="cf">function</span>(x) {</span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a>      <span class="fu">invisible</span>(<span class="fu">bdRemove_hdf5_element</span>(filename, <span class="at">element =</span> x))</span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"  "</span>, x, <span class="st">"removed</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"✓ Intermediate results cleaned up</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(</span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> filename,</span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a>    <span class="at">results_group =</span> <span class="st">"Results"</span></span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<hr>
</section>
<section id="step-3-computing-canonical-coefficients" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="step-3-computing-canonical-coefficients"><span class="header-section-number">5</span> Step 3: Computing Canonical Coefficients</h2>
<p>The final step converts SVD results into interpretable canonical components:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>writeCCAComponents_hdf5 <span class="ot">&lt;-</span> <span class="cf">function</span>(filename, ncolsX, ncolsY) {</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(filename)) {</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"ERROR - File does not exist"</span>)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Read all necessary components from HDF5</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  h5f <span class="ot">&lt;-</span> <span class="fu">H5Fopen</span>(filename)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get first ncolsX × ncolsX and ncolsY × ncolsY from Q matrices</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  XQ <span class="ot">&lt;-</span> h5f<span class="sc">$</span>Step6<span class="sc">$</span>XQ[<span class="dv">1</span><span class="sc">:</span>ncolsX, <span class="dv">1</span><span class="sc">:</span>ncolsX]</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>  YQ <span class="ot">&lt;-</span> h5f<span class="sc">$</span>Step6<span class="sc">$</span>YQ[<span class="dv">1</span><span class="sc">:</span>ncolsY, <span class="dv">1</span><span class="sc">:</span>ncolsY]</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get R matrices from final QR</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  XR <span class="ot">&lt;-</span> h5f<span class="sc">$</span>Step3<span class="sc">$</span>Final_QR<span class="sc">$</span>XRt.R</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>  YR <span class="ot">&lt;-</span> h5f<span class="sc">$</span>Step3<span class="sc">$</span>Final_QR<span class="sc">$</span>YRt.R</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get SVD results (canonical correlations and directions)</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> h5f<span class="sc">$</span>SVD<span class="sc">$</span>CrossProd_XQ_YQ<span class="sc">$</span>d</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>  u <span class="ot">&lt;-</span> h5f<span class="sc">$</span>SVD<span class="sc">$</span>CrossProd_XQ_YQ<span class="sc">$</span>u</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>  v <span class="ot">&lt;-</span> h5f<span class="sc">$</span>SVD<span class="sc">$</span>CrossProd_XQ_YQ<span class="sc">$</span>v</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get centering values</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>  xcenter <span class="ot">&lt;-</span> h5f<span class="sc">$</span>NORMALIZED<span class="sc">$</span>data<span class="sc">$</span>mean.X</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>  ycenter <span class="ot">&lt;-</span> h5f<span class="sc">$</span>NORMALIZED<span class="sc">$</span>data<span class="sc">$</span>mean.Y</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get feature names</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>  x_names <span class="ot">&lt;-</span> h5f<span class="sc">$</span>data<span class="sc">$</span>.X_dimnames<span class="sc">$</span><span class="st">`</span><span class="at">2</span><span class="st">`</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>  y_names <span class="ot">&lt;-</span> h5f<span class="sc">$</span>data<span class="sc">$</span>.Y_dimnames<span class="sc">$</span><span class="st">`</span><span class="at">2</span><span class="st">`</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">h5closeAll</span>()</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Reconstruct compact QR representation</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Q and R are stored separately, combine them</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>  XR[<span class="fu">lower.tri</span>(XR, <span class="at">diag =</span> <span class="cn">FALSE</span>)] <span class="ot">&lt;-</span> <span class="dv">0</span>  <span class="co"># R is upper triangular</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>  XQ[<span class="fu">upper.tri</span>(XQ, <span class="at">diag =</span> <span class="cn">TRUE</span>)] <span class="ot">&lt;-</span> <span class="dv">0</span>   <span class="co"># Q lower part</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>  XQR <span class="ot">&lt;-</span> XR <span class="sc">+</span> XQ</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>  YR[<span class="fu">lower.tri</span>(YR, <span class="at">diag =</span> <span class="cn">FALSE</span>)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>  YQ[<span class="fu">upper.tri</span>(YQ, <span class="at">diag =</span> <span class="cn">TRUE</span>)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>  YQR <span class="ot">&lt;-</span> YR <span class="sc">+</span> YQ</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Solve for canonical coefficients</span></span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>  <span class="co"># X canonical coefficients: solve XQR * xcoef = u</span></span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>  xcoef <span class="ot">&lt;-</span> <span class="fu">bdSolve</span>(XQR, u)</span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Y canonical coefficients: solve YQR * ycoef = v</span></span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>  ycoef <span class="ot">&lt;-</span> <span class="fu">bdSolve</span>(YQR, v)</span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add feature names</span></span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames</span>(xcoef) <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(x_names)</span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames</span>(ycoef) <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(y_names)</span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Save canonical coefficients to HDF5</span></span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bdCreate_hdf5_matrix</span>(</span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>    filename,</span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> xcoef,</span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"Results"</span>,</span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">dataset =</span> <span class="st">"xcoef"</span>,</span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">overwriteDataset =</span> <span class="cn">TRUE</span></span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bdCreate_hdf5_matrix</span>(</span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> filename,</span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> ycoef,</span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"Results"</span>,</span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a>    <span class="at">dataset =</span> <span class="st">"ycoef"</span>,</span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a>    <span class="at">overwriteDataset =</span> <span class="cn">TRUE</span></span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Save canonical correlations</span></span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bdCreate_hdf5_matrix</span>(</span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a>    filename,</span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> <span class="fu">as.matrix</span>(<span class="fu">diag</span>(d)),</span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"Results"</span>,</span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a>    <span class="at">dataset =</span> <span class="st">"cor"</span>,</span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a>    <span class="at">overwriteDataset =</span> <span class="cn">TRUE</span></span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Save centering values (needed for new data projection)</span></span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bdCreate_hdf5_matrix</span>(</span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a>    filename,</span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> xcenter,</span>
<span id="cb3-84"><a href="#cb3-84" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"Results"</span>,</span>
<span id="cb3-85"><a href="#cb3-85" aria-hidden="true" tabindex="-1"></a>    <span class="at">dataset =</span> <span class="st">"xcenter"</span>,</span>
<span id="cb3-86"><a href="#cb3-86" aria-hidden="true" tabindex="-1"></a>    <span class="at">overwriteDataset =</span> <span class="cn">TRUE</span></span>
<span id="cb3-87"><a href="#cb3-87" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb3-88"><a href="#cb3-88" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-89"><a href="#cb3-89" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bdCreate_hdf5_matrix</span>(</span>
<span id="cb3-90"><a href="#cb3-90" aria-hidden="true" tabindex="-1"></a>    filename,</span>
<span id="cb3-91"><a href="#cb3-91" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> ycenter,</span>
<span id="cb3-92"><a href="#cb3-92" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"Results"</span>,</span>
<span id="cb3-93"><a href="#cb3-93" aria-hidden="true" tabindex="-1"></a>    <span class="at">dataset =</span> <span class="st">"ycenter"</span>,</span>
<span id="cb3-94"><a href="#cb3-94" aria-hidden="true" tabindex="-1"></a>    <span class="at">overwriteDataset =</span> <span class="cn">TRUE</span></span>
<span id="cb3-95"><a href="#cb3-95" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb3-96"><a href="#cb3-96" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-97"><a href="#cb3-97" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute canonical variates (scores) for samples</span></span>
<span id="cb3-98"><a href="#cb3-98" aria-hidden="true" tabindex="-1"></a>  <span class="co"># X scores = X * xcoef</span></span>
<span id="cb3-99"><a href="#cb3-99" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bdblockmult_hdf5</span>(</span>
<span id="cb3-100"><a href="#cb3-100" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> filename,</span>
<span id="cb3-101"><a href="#cb3-101" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"data"</span>,</span>
<span id="cb3-102"><a href="#cb3-102" aria-hidden="true" tabindex="-1"></a>    <span class="at">A =</span> <span class="st">"X"</span>,</span>
<span id="cb3-103"><a href="#cb3-103" aria-hidden="true" tabindex="-1"></a>    <span class="at">B =</span> <span class="st">"xcoef"</span>,</span>
<span id="cb3-104"><a href="#cb3-104" aria-hidden="true" tabindex="-1"></a>    <span class="at">groupB =</span> <span class="st">"Results"</span>,</span>
<span id="cb3-105"><a href="#cb3-105" aria-hidden="true" tabindex="-1"></a>    <span class="at">outgroup =</span> <span class="st">"Results"</span>,</span>
<span id="cb3-106"><a href="#cb3-106" aria-hidden="true" tabindex="-1"></a>    <span class="at">outdataset =</span> <span class="st">"xscores"</span>,</span>
<span id="cb3-107"><a href="#cb3-107" aria-hidden="true" tabindex="-1"></a>    <span class="at">overwrite =</span> <span class="cn">TRUE</span></span>
<span id="cb3-108"><a href="#cb3-108" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb3-109"><a href="#cb3-109" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-110"><a href="#cb3-110" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Y scores = Y * ycoef</span></span>
<span id="cb3-111"><a href="#cb3-111" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bdblockmult_hdf5</span>(</span>
<span id="cb3-112"><a href="#cb3-112" aria-hidden="true" tabindex="-1"></a>    filename,</span>
<span id="cb3-113"><a href="#cb3-113" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"data"</span>,</span>
<span id="cb3-114"><a href="#cb3-114" aria-hidden="true" tabindex="-1"></a>    <span class="at">A =</span> <span class="st">"Y"</span>,</span>
<span id="cb3-115"><a href="#cb3-115" aria-hidden="true" tabindex="-1"></a>    <span class="at">B =</span> <span class="st">"ycoef"</span>,</span>
<span id="cb3-116"><a href="#cb3-116" aria-hidden="true" tabindex="-1"></a>    <span class="at">groupB =</span> <span class="st">"Results"</span>,</span>
<span id="cb3-117"><a href="#cb3-117" aria-hidden="true" tabindex="-1"></a>    <span class="at">outgroup =</span> <span class="st">"Results"</span>,</span>
<span id="cb3-118"><a href="#cb3-118" aria-hidden="true" tabindex="-1"></a>    <span class="at">outdataset =</span> <span class="st">"yscores"</span>,</span>
<span id="cb3-119"><a href="#cb3-119" aria-hidden="true" tabindex="-1"></a>    <span class="at">overwrite =</span> <span class="cn">TRUE</span></span>
<span id="cb3-120"><a href="#cb3-120" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb3-121"><a href="#cb3-121" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-122"><a href="#cb3-122" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"✓ All CCA components saved to /Results/</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb3-123"><a href="#cb3-123" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span>Understanding the Coefficients
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><strong>xcoef, ycoef:</strong> Feature loadings - which features contribute to each canonical variate</li>
<li><strong>cor:</strong> Canonical correlations - strength of relationship for each component</li>
<li><strong>xscores, yscores:</strong> Sample scores on canonical variates</li>
<li><strong>xcenter, ycenter:</strong> Means used for centering (needed for projecting new data)</li>
</ul>
<p>These components together provide complete CCA results interpretable just like standard CCA output.</p>
</div>
</div>
<hr>
</section>
<section id="example-usage" class="level2" data-number="6">
<h2 data-number="6" class="anchored" data-anchor-id="example-usage"><span class="header-section-number">6</span> Example Usage</h2>
<p>Here’s how to use the implemented CCA function:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(BigDataStatMeth)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rhdf5)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create example multi-omic data</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>n_samples <span class="ot">&lt;-</span> <span class="dv">500</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>n_genes_x <span class="ot">&lt;-</span> <span class="dv">3000</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>n_genes_y <span class="ot">&lt;-</span> <span class="dv">2000</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Genomic data (X)</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(n_samples <span class="sc">*</span> n_genes_x), n_samples, n_genes_x)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(X) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"Sample_"</span>, <span class="dv">1</span><span class="sc">:</span>n_samples)</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(X) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"Gene_X_"</span>, <span class="dv">1</span><span class="sc">:</span>n_genes_x)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Expression data (Y)</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(n_samples <span class="sc">*</span> n_genes_y), n_samples, n_genes_y)</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(Y) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"Sample_"</span>, <span class="dv">1</span><span class="sc">:</span>n_samples)</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(Y) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"Gene_Y_"</span>, <span class="dv">1</span><span class="sc">:</span>n_genes_y)</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Create HDF5 file</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>cca_file <span class="ot">&lt;-</span> <span class="st">"example_cca.hdf5"</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a><span class="fu">bdCreate_hdf5_matrix</span>(cca_file, X, <span class="st">"data"</span>, <span class="st">"X"</span>, <span class="at">overwriteFile =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a><span class="fu">bdCreate_hdf5_matrix</span>(cca_file, Y, <span class="st">"data"</span>, <span class="st">"Y"</span>, <span class="at">overwriteFile =</span> <span class="cn">FALSE</span>)</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Run CCA</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">bdCCA_hdf5</span>(</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> cca_file,</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> <span class="st">"data/X"</span>,</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y =</span> <span class="st">"data/Y"</span>,</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">m =</span> <span class="dv">4</span>,              <span class="co"># 4 blocks for QR</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>  <span class="at">bcenter =</span> <span class="cn">TRUE</span>,     <span class="co"># Center data</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>  <span class="at">bscale =</span> <span class="cn">TRUE</span>,      <span class="co"># Scale data</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">overwriteResults =</span> <span class="cn">TRUE</span>,</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">keepInteResults =</span> <span class="cn">FALSE</span>  <span class="co"># Remove intermediate steps</span></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Examine results</span></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a><span class="fu">h5ls</span>(cca_file)</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract canonical correlations</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>h5f <span class="ot">&lt;-</span> <span class="fu">H5Fopen</span>(cca_file)</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>canonical_cors <span class="ot">&lt;-</span> <span class="fu">diag</span>(h5f<span class="sc">$</span>Results<span class="sc">$</span>cor)</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>xcoef <span class="ot">&lt;-</span> h5f<span class="sc">$</span>Results<span class="sc">$</span>xcoef</span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>ycoef <span class="ot">&lt;-</span> h5f<span class="sc">$</span>Results<span class="sc">$</span>ycoef</span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a><span class="fu">H5Fclose</span>(h5f)</span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Canonical correlations:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(canonical_cors[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>])</span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Top features for first canonical variate:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"X features:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">head</span>(<span class="fu">sort</span>(<span class="fu">abs</span>(xcoef[, <span class="dv">1</span>]), <span class="at">decreasing =</span> <span class="cn">TRUE</span>)))</span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Y features:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">head</span>(<span class="fu">sort</span>(<span class="fu">abs</span>(ycoef[, <span class="dv">1</span>]), <span class="at">decreasing =</span> <span class="cn">TRUE</span>)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<hr>
</section>
<section id="interactive-exercise" class="level2 exercise" data-number="7">
<h2 class="exercise anchored" data-number="7" data-anchor-id="interactive-exercise"><span class="header-section-number">7</span> Interactive Exercise</h2>
<section id="practice-modifying-the-cca-implementation" class="level3" data-number="7.1">
<h3 data-number="7.1" class="anchored" data-anchor-id="practice-modifying-the-cca-implementation"><span class="header-section-number">7.1</span> Practice: Modifying the CCA Implementation</h3>
<p>Understanding how the algorithm works helps you adapt it for your needs or create entirely new methods.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Exercise 1: Change block size</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Try m = 2, 4, 8, 16</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co"># How does memory usage change?</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># How does computation time change?</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Do results differ?</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Exercise 2: Skip normalization</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Set bcenter = FALSE, bscale = FALSE</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co"># How do canonical correlations change?</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Why does this matter?</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Exercise 3: Keep intermediate results</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Set keepInteResults = TRUE</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Explore Step1 through Step7 in HDF5 file</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="co"># What does each step contain?</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="co"># How does data transform through the pipeline?</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Exercise 4: Add progress reporting</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Modify getQRbyBlocks to print progress</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Track time for each major step</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify bottlenecks</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>Reflection Questions
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>1. Algorithm Understanding:</strong> - Why QR decomposition instead of direct SVD on X and Y? - What would break if you skipped the hierarchical QR merge? - How does block size affect accuracy vs.&nbsp;efficiency?</p>
<p><strong>2. Design Decisions:</strong> - Why store intermediate results in HDF5 instead of memory? - keepInteResults = TRUE vs.&nbsp;FALSE - when use each? - Could you implement this with fewer steps? Trade-offs?</p>
<p><strong>3. Extending to New Methods:</strong> - What if you wanted sparse CCA? Which step changes? - How would you implement regularized CCA? - Could you use this pattern for PLS regression?</p>
<p><strong>4. Practical Considerations:</strong> - Your data has missing values. Where in the pipeline do you handle them? - X has 100,000 features, Y has 50,000. What breaks? - How do you validate results match standard CCA?</p>
<p><strong>5. Performance Optimization:</strong> - Which step is slowest? QR blocks? SVD? Coefficient solving? - Could you parallelize any steps? - When does the C++ version become worth the effort?</p>
<p>Think about how you’d adapt this pattern for your own statistical method. The structure—partition, process blocks, combine hierarchically—applies broadly beyond CCA.</p>
</div>
</div>
<hr>
</section>
</section>
<section id="key-takeaways" class="level2 key-concept" data-number="8">
<h2 class="key-concept anchored" data-number="8" data-anchor-id="key-takeaways"><span class="header-section-number">8</span> Key Takeaways</h2>
<p>Let’s consolidate what you’ve learned about implementing CCA using BigDataStatMeth’s R API.</p>
<section id="essential-concepts" class="level3" data-number="8.1">
<h3 data-number="8.1" class="anchored" data-anchor-id="essential-concepts"><span class="header-section-number">8.1</span> Essential Concepts</h3>
<p><strong>Block-wise algorithms decompose complex operations into manageable steps.</strong> Rather than computing QR decomposition on a 50,000 × 500,000 matrix (requiring hundreds of GB RAM), we partition into blocks, compute QR on each (requiring only GB), then combine results hierarchically. This pattern—partition, process, combine—applies to virtually any matrix algorithm. Understanding this pattern lets you implement statistical methods that would otherwise be impossible on standard hardware.</p>
<p><strong>HDF5 files serve as persistent working memory.</strong> Each step saves results to HDF5: Step1 has split matrices, Step2 has block QRs, Step3 has merged results. This isn’t just storage—it enables debugging (inspect intermediate results), resuming (restart from any step), and memory management (only current block in RAM). Without HDF5’s structure, you’d need everything in memory simultaneously or manage dozens of temporary files manually.</p>
<p><strong>Hierarchical combination preserves mathematical correctness.</strong> Computing QR on blocks, stacking R matrices, taking QR of the stack, and multiplying back through Q matrices gives identical results to single-shot QR on the full matrix. The mathematics works because QR decomposition composes correctly. Not all algorithms have this property—you can’t naively block-wise any operation and expect correct results. Understanding which operations compose correctly is essential for designing block-wise algorithms.</p>
<p><strong>Normalization affects numerical stability more than correctness.</strong> Centering and scaling aren’t just preprocessing niceties for CCA—they prevent numerical precision loss when working with disparate scales. Genomic copy number (±2) and expression (0-100,000) in the same analysis without scaling produces correlations driven by scale, not biology. For block-wise processing on HDF5, normalization happens once upfront and stores normalized data for all subsequent operations, avoiding repeated normalization overhead.</p>
<p><strong>Intermediate result management is a design decision.</strong> keepInteResults = FALSE removes Step1-Step7 after completion, saving disk space. keepInteResults = TRUE preserves them for inspection, debugging, or reusing with different final steps. For production pipelines, clean up. For method development, keep everything until you’re certain it works. The choice affects both disk usage and your ability to troubleshoot problems.</p>
<p><strong>Code structure mirrors algorithm structure.</strong> getQRbyBlocks handles one matrix’s QR decomposition. bdCCA_hdf5 calls it twice (for X and Y), computes cross-product, performs SVD, and extracts coefficients. writeCCAComponents_hdf5 handles result extraction and formatting. This modular structure makes code understandable and reusable—getQRbyBlocks could be used for methods beyond CCA. Clear function boundaries with specific responsibilities enable building complex methods from simple components.</p>
</section>
<section id="when-to-implement-methods-in-r" class="level3" data-number="8.2">
<h3 data-number="8.2" class="anchored" data-anchor-id="when-to-implement-methods-in-r"><span class="header-section-number">8.2</span> When to Implement Methods in R</h3>
<p>Understanding when R implementation suffices versus when C++ becomes necessary guides efficient development.</p>
<p>✅ <strong>Implement in R when:</strong></p>
<ul>
<li><p><strong>Prototyping new methods</strong> - R’s interactive nature enables rapid testing. Write the algorithm, run it on small data, iterate until correct. Once working, optimize or port to C++ if needed. Starting in R saves development time even if you eventually rewrite in C++.</p></li>
<li><p><strong>Combining existing BigDataStatMeth functions</strong> - If your method uses bdSVD_hdf5, bdCrossprod_hdf5, bdSolve, etc., R glue code suffices. The heavy lifting happens in C++ (BigDataStatMeth internals), R just orchestrates. CCA is this case—all computational work happens in compiled code, R just sequences operations.</p></li>
<li><p><strong>Method will be used occasionally</strong> - If you run CCA once per project, R performance is fine. Minutes vs.&nbsp;seconds doesn’t matter when you run it monthly. Save development effort for methods you’ll run thousands of times.</p></li>
<li><p><strong>Your team works primarily in R</strong> - Keeping implementation in R enables others to understand, modify, and extend your code without C++ expertise. Collaboration and maintainability sometimes outweigh raw performance.</p></li>
<li><p><strong>Intermediate result inspection matters</strong> - R makes it trivial to peek at any step: load data from HDF5, examine dimensions, plot distributions. This transparency helps verify correctness and debug problems. C++ implementations bury these details in compiled code.</p></li>
</ul>
<p>✅ <strong>Consider C++ implementation when:</strong></p>
<ul>
<li><p><strong>Performance is critical</strong> - If your method runs hundreds of times daily, saving 50% computation time through C++ pays for development effort. Profile first—identify if performance matters before investing in optimization.</p></li>
<li><p><strong>Custom algorithms, not BigDataStatMeth combinations</strong> - If you’re implementing novel linear algebra (not using existing bdXXX functions), C++ gives you control over algorithms, memory layout, and parallelization. R becomes a bottleneck for truly custom computation.</p></li>
<li><p><strong>Production deployment required</strong> - Software going into production pipelines benefits from C++’s speed and static typing. Development takes longer but runtime is faster and more predictable.</p></li>
<li><p><strong>You need fine-grained parallelization</strong> - R’s parallelization works at function level. C++ with OpenMP or threading libraries enables parallelizing within matrix operations, achieving better speedups for large-scale data.</p></li>
</ul>
<p>❌ <strong>Don’t reimplement in C++ when:</strong></p>
<ul>
<li><p><strong>R version works fine</strong> - “Working” beats “optimal” when deadlines loom. If R implementation meets your needs, moving to C++ wastes time that could go toward science.</p></li>
<li><p><strong>The bottleneck isn’t computation</strong> - If your analysis spends 90% of time reading files or waiting for database queries, optimizing computation achieves nothing. Profile to find true bottlenecks before optimizing.</p></li>
<li><p><strong>You’re still figuring out the algorithm</strong> - Algorithm design in C++ is painful—compile, run, crash, debug, repeat. R’s interactivity (run line-by-line, inspect variables, iterate quickly) is invaluable during method development. Get it working in R, then optimize if needed.</p></li>
</ul>
<p>The key principle: R for development and prototyping, C++ for production and performance-critical code. Many methods never need C++ because R orchestration of C++ building blocks (BigDataStatMeth functions) provides adequate performance.</p>
<hr>
</section>
</section>
<section id="next-steps" class="level2" data-number="9">
<h2 data-number="9" class="anchored" data-anchor-id="next-steps"><span class="header-section-number">9</span> Next Steps</h2>
<p><strong>Explore the C++ implementation:</strong></p>
<ul>
<li><a href="../developing-methods/cca-cpp-implementation.html">CCA Implementation in C++</a> - Same algorithm, different language</li>
<li>Compare R and C++ approaches</li>
<li>Understand when each makes sense</li>
</ul>
<p><strong>Apply this pattern to new methods:</strong></p>
<ul>
<li>Implement PLS (Partial Least Squares) using similar structure</li>
<li>Create sparse CCA with L1 penalties</li>
<li>Develop custom dimensionality reduction methods</li>
</ul>
<p><strong>Extend CCA functionality:</strong></p>
<ul>
<li>Add cross-validation for component selection</li>
<li>Implement permutation testing for significance</li>
<li>Create visualization functions for results</li>
<li>Build prediction functions for new samples</li>
</ul>
<hr>
</section>
<section id="cleanup" class="level2" data-number="10">
<h2 data-number="10" class="anchored" data-anchor-id="cleanup"><span class="header-section-number">10</span> Cleanup</h2>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Close any open HDF5 connections</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">h5closeAll</span>()</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: Keep example_cca.hdf5 for testing and learning</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co"># It contains complete CCA results you can explore</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/isglobal-brge\.github\.io\/BigDataStatMeth\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
            // target, if specified
            link.setAttribute("target", "_blank");
            if (link.getAttribute("rel") === null) {
              link.setAttribute("rel", "noopener");
            }
            // default icon
            link.classList.add("external");
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "CCA Implementation in R"</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="an">subtitle:</span><span class="co"> "Building Canonical Correlation Analysis Using BigDataStatMeth R API"</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="fu">## Overview</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>This document shows how to implement Canonical Correlation Analysis (CCA) from scratch using BigDataStatMeth's R API. Rather than using a pre-built CCA function, you'll see how to combine BigDataStatMeth's building blocks—QR decomposition, matrix operations, SVD—to create a complete statistical method. This is the foundation for understanding how to develop your own statistical methods for big data.</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>The implementation you'll see here is actual working code from the BDStatMethExamples package. It's not pseudocode or simplified for teaching—it's production code that handles real TCGA multi-omic data with thousands of samples and features. By studying this implementation, you learn both the mathematical algorithm and the practical engineering required to make complex statistical methods work on big data.</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>Think of this as a blueprint. CCA serves as the example, but the patterns you'll learn—partitioning data, applying operations iteratively, combining results hierarchically, managing intermediate outputs—apply to any algorithm you might develop. Whether you're implementing sparse PCA, regularized regression, factor analysis, or novel methods from research papers, this workflow shows you how to structure the implementation.</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>::: {.learning-objectives}</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="fu">### What You'll Learn</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>By the end of this document, you will:</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Understand CCA's mathematical algorithm and its implementation challenges</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Implement QR decomposition by blocks for matrices exceeding memory</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Combine intermediate QR results using hierarchical merging</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Compute canonical correlations from Q matrix cross-products</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Extract canonical coefficients by solving triangular systems</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Structure complex multi-step algorithms with clear function separation</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Manage intermediate results strategically in HDF5 files</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Create reusable patterns applicable to other statistical methods</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a><span class="fu">## CCA Algorithm Overview</span></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a><span class="fu">### Mathematical Foundation</span></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>Canonical Correlation Analysis finds linear combinations of features in two datasets that maximize correlation. Given matrices X (n × p) and Y (n × q), CCA seeks weight vectors α and β such that:</span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>\max_{\alpha, \beta} \text{cor}(X\alpha, Y\beta)</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>subject to the constraint that the canonical variates have unit variance. This optimization problem has a classical solution through matrix decompositions.</span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>The standard algorithm proceeds through these mathematical steps:</span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>**Step 1: QR decompositions**</span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>X = Q_X R_X, \quad Y = Q_Y R_Y</span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a>where Q matrices are orthonormal (n × p and n × q) and R matrices are upper triangular.</span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a>**Step 2: Cross-product of Q matrices**</span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a>M = Q_X^T Q_Y</span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a>This (p × q) matrix captures the relationship between the orthonormalized datasets.</span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a>**Step 3: SVD of cross-product**</span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a>M = U D V^T</span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-67"><a href="#cb7-67" aria-hidden="true" tabindex="-1"></a>where D contains singular values (the canonical correlations), and U, V are orthogonal matrices containing canonical directions.</span>
<span id="cb7-68"><a href="#cb7-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-69"><a href="#cb7-69" aria-hidden="true" tabindex="-1"></a>**Step 4: Canonical coefficients**</span>
<span id="cb7-70"><a href="#cb7-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-71"><a href="#cb7-71" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb7-72"><a href="#cb7-72" aria-hidden="true" tabindex="-1"></a>\alpha = R_X^{-1} U, \quad \beta = R_Y^{-1} V</span>
<span id="cb7-73"><a href="#cb7-73" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb7-74"><a href="#cb7-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-75"><a href="#cb7-75" aria-hidden="true" tabindex="-1"></a>These transform original features to canonical space.</span>
<span id="cb7-76"><a href="#cb7-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-77"><a href="#cb7-77" aria-hidden="true" tabindex="-1"></a>**Step 5: Canonical variates**</span>
<span id="cb7-78"><a href="#cb7-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-79"><a href="#cb7-79" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb7-80"><a href="#cb7-80" aria-hidden="true" tabindex="-1"></a>s_X = X\alpha, \quad s_Y = Y\beta</span>
<span id="cb7-81"><a href="#cb7-81" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb7-82"><a href="#cb7-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-83"><a href="#cb7-83" aria-hidden="true" tabindex="-1"></a>These are the actual canonical scores for each sample.</span>
<span id="cb7-84"><a href="#cb7-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-85"><a href="#cb7-85" aria-hidden="true" tabindex="-1"></a><span class="fu">### Why Block-Wise Processing?</span></span>
<span id="cb7-86"><a href="#cb7-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-87"><a href="#cb7-87" aria-hidden="true" tabindex="-1"></a>The algorithm above assumes you can load X and Y into memory, compute their QR decompositions directly, and proceed. For small datasets (thousands of samples, hundreds of features), this works fine. For genomic or multi-omic data—50,000 samples × 500,000 SNPs, or 10,000 samples × 20,000 genes—loading the full matrices into RAM is impossible.</span>
<span id="cb7-88"><a href="#cb7-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-89"><a href="#cb7-89" aria-hidden="true" tabindex="-1"></a>Block-wise processing solves this by:</span>
<span id="cb7-90"><a href="#cb7-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-91"><a href="#cb7-91" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Partitioning** each matrix into m blocks by rows (samples)</span>
<span id="cb7-92"><a href="#cb7-92" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Computing** QR decomposition on each block independently</span>
<span id="cb7-93"><a href="#cb7-93" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Combining** block QR results hierarchically to reconstruct the full QR</span>
<span id="cb7-94"><a href="#cb7-94" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Achieving** identical mathematical results with manageable memory</span>
<span id="cb7-95"><a href="#cb7-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-96"><a href="#cb7-96" aria-hidden="true" tabindex="-1"></a>The key insight is that QR decomposition of stacked matrices can be computed by taking QR of each block, stacking the R matrices, taking QR of that stack, then multiplying the original Q matrices by the new Q. This hierarchical approach is mathematically exact—you get the same final Q and R as if you'd computed QR on the full matrix, but you never load the full matrix into memory.</span>
<span id="cb7-97"><a href="#cb7-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-98"><a href="#cb7-98" aria-hidden="true" tabindex="-1"></a>For a matrix X with 50,000 rows, partitioning into m=10 blocks means each block has 5,000 rows. If X has 500,000 columns, each block is 5,000 × 500,000—still large, but processable. The R matrix from each block QR is only 500,000 × 500,000 (or smaller if you compute economy QR). Stacking 10 such R matrices gives 5,000,000 × 500,000, and taking QR of that is manageable because it's column-heavy, not row-heavy.</span>
<span id="cb7-99"><a href="#cb7-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-100"><a href="#cb7-100" aria-hidden="true" tabindex="-1"></a>This is the pattern we'll implement: partition → process blocks → merge hierarchically → reconstruct full result.</span>
<span id="cb7-101"><a href="#cb7-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-102"><a href="#cb7-102" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb7-103"><a href="#cb7-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-104"><a href="#cb7-104" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 1: QR Decomposition by Blocks</span></span>
<span id="cb7-105"><a href="#cb7-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-106"><a href="#cb7-106" aria-hidden="true" tabindex="-1"></a><span class="fu">### The getQRbyBlocks Function</span></span>
<span id="cb7-107"><a href="#cb7-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-108"><a href="#cb7-108" aria-hidden="true" tabindex="-1"></a>This function is the algorithmic core of block-wise CCA. It takes a dataset stored in HDF5 and computes its QR decomposition by processing the data in m blocks. The function doesn't return matrices to R—instead, it orchestrates a sequence of HDF5 operations, with intermediate results stored in the file under "Step1", "Step2", etc.</span>
<span id="cb7-109"><a href="#cb7-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-110"><a href="#cb7-110" aria-hidden="true" tabindex="-1"></a><span class="in">```{r qr-by-blocks, eval=FALSE}</span></span>
<span id="cb7-111"><a href="#cb7-111" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(BigDataStatMeth)</span>
<span id="cb7-112"><a href="#cb7-112" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rhdf5)</span>
<span id="cb7-113"><a href="#cb7-113" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb7-114"><a href="#cb7-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-115"><a href="#cb7-115" aria-hidden="true" tabindex="-1"></a>getQRbyBlocks <span class="ot">&lt;-</span> <span class="cf">function</span>(strdataset, file, m, center, scale, bcols, overwrt) {</span>
<span id="cb7-116"><a href="#cb7-116" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-117"><a href="#cb7-117" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Parse dataset path into group and dataset components</span></span>
<span id="cb7-118"><a href="#cb7-118" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Example: "data/X" becomes group="data", dataset="X"</span></span>
<span id="cb7-119"><a href="#cb7-119" aria-hidden="true" tabindex="-1"></a>  strgroup <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"/.?$"</span>, <span class="st">""</span>, strdataset)</span>
<span id="cb7-120"><a href="#cb7-120" aria-hidden="true" tabindex="-1"></a>  strdataset <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"^.*/"</span>, <span class="st">""</span>, strdataset)</span>
<span id="cb7-121"><a href="#cb7-121" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-122"><a href="#cb7-122" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 1: Normalize the dataset</span></span>
<span id="cb7-123"><a href="#cb7-123" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Centering removes column means, scaling divides by standard deviations</span></span>
<span id="cb7-124"><a href="#cb7-124" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This ensures numerical stability in QR computation</span></span>
<span id="cb7-125"><a href="#cb7-125" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bdNormalize_hdf5</span>(</span>
<span id="cb7-126"><a href="#cb7-126" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> file,</span>
<span id="cb7-127"><a href="#cb7-127" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> strgroup,</span>
<span id="cb7-128"><a href="#cb7-128" aria-hidden="true" tabindex="-1"></a>    <span class="at">dataset =</span> strdataset,</span>
<span id="cb7-129"><a href="#cb7-129" aria-hidden="true" tabindex="-1"></a>    <span class="at">bcenter =</span> center,</span>
<span id="cb7-130"><a href="#cb7-130" aria-hidden="true" tabindex="-1"></a>    <span class="at">bscale =</span> scale,</span>
<span id="cb7-131"><a href="#cb7-131" aria-hidden="true" tabindex="-1"></a>    <span class="at">overwrite =</span> overwrt</span>
<span id="cb7-132"><a href="#cb7-132" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-133"><a href="#cb7-133" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-134"><a href="#cb7-134" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 2: Split matrix into m blocks by rows</span></span>
<span id="cb7-135"><a href="#cb7-135" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Each block gets approximately n/m rows</span></span>
<span id="cb7-136"><a href="#cb7-136" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Normalized data stored under NORMALIZED/, output goes to Step1/</span></span>
<span id="cb7-137"><a href="#cb7-137" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bdSplit_matrix_hdf5</span>(</span>
<span id="cb7-138"><a href="#cb7-138" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> file,</span>
<span id="cb7-139"><a href="#cb7-139" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="fu">paste0</span>(<span class="st">"NORMALIZED/"</span>, strgroup),</span>
<span id="cb7-140"><a href="#cb7-140" aria-hidden="true" tabindex="-1"></a>    <span class="at">dataset =</span> strdataset,</span>
<span id="cb7-141"><a href="#cb7-141" aria-hidden="true" tabindex="-1"></a>    <span class="at">outgroup =</span> <span class="fu">paste0</span>(<span class="st">"Step1/"</span>, strdataset, <span class="st">"rows"</span>),</span>
<span id="cb7-142"><a href="#cb7-142" aria-hidden="true" tabindex="-1"></a>    <span class="at">nblocks =</span> m,</span>
<span id="cb7-143"><a href="#cb7-143" aria-hidden="true" tabindex="-1"></a>    <span class="at">bycols =</span> bcols,  <span class="co"># FALSE = split by rows (samples)</span></span>
<span id="cb7-144"><a href="#cb7-144" aria-hidden="true" tabindex="-1"></a>    <span class="at">overwrite =</span> overwrt</span>
<span id="cb7-145"><a href="#cb7-145" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-146"><a href="#cb7-146" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-147"><a href="#cb7-147" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 3: Apply QR to each block independently</span></span>
<span id="cb7-148"><a href="#cb7-148" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get list of block datasets created by split</span></span>
<span id="cb7-149"><a href="#cb7-149" aria-hidden="true" tabindex="-1"></a>  blocks <span class="ot">&lt;-</span> <span class="fu">bdgetDatasetsList_hdf5</span>(file, <span class="fu">paste0</span>(<span class="st">"Step1/"</span>, strdataset, <span class="st">"rows"</span>))</span>
<span id="cb7-150"><a href="#cb7-150" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-151"><a href="#cb7-151" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Apply QR decomposition to each block</span></span>
<span id="cb7-152"><a href="#cb7-152" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Creates both Q and R for each block</span></span>
<span id="cb7-153"><a href="#cb7-153" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bdapply_Function_hdf5</span>(</span>
<span id="cb7-154"><a href="#cb7-154" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> file,</span>
<span id="cb7-155"><a href="#cb7-155" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="fu">paste0</span>(<span class="st">"Step1/"</span>, strdataset, <span class="st">"rows"</span>),</span>
<span id="cb7-156"><a href="#cb7-156" aria-hidden="true" tabindex="-1"></a>    <span class="at">datasets =</span> blocks,</span>
<span id="cb7-157"><a href="#cb7-157" aria-hidden="true" tabindex="-1"></a>    <span class="at">outgroup =</span> <span class="fu">paste0</span>(<span class="st">"Step2/"</span>, strdataset, <span class="st">"rows"</span>),</span>
<span id="cb7-158"><a href="#cb7-158" aria-hidden="true" tabindex="-1"></a>    <span class="at">func =</span> <span class="st">"QR"</span>,</span>
<span id="cb7-159"><a href="#cb7-159" aria-hidden="true" tabindex="-1"></a>    <span class="at">overwrite =</span> overwrt</span>
<span id="cb7-160"><a href="#cb7-160" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-161"><a href="#cb7-161" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-162"><a href="#cb7-162" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 4: Merge R matrices from all blocks</span></span>
<span id="cb7-163"><a href="#cb7-163" aria-hidden="true" tabindex="-1"></a>  <span class="co"># QR gives Q (orthogonal) and R (upper triangular) for each block</span></span>
<span id="cb7-164"><a href="#cb7-164" aria-hidden="true" tabindex="-1"></a>  <span class="co"># We need to stack all R matrices vertically</span></span>
<span id="cb7-165"><a href="#cb7-165" aria-hidden="true" tabindex="-1"></a>  blocks_qr <span class="ot">&lt;-</span> <span class="fu">bdgetDatasetsList_hdf5</span>(file, <span class="fu">paste0</span>(<span class="st">"Step2/"</span>, strdataset, <span class="st">"rows"</span>))</span>
<span id="cb7-166"><a href="#cb7-166" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-167"><a href="#cb7-167" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Filter to get only R matrices (dataset names contain ".R")</span></span>
<span id="cb7-168"><a href="#cb7-168" aria-hidden="true" tabindex="-1"></a>  r_matrices <span class="ot">&lt;-</span> blocks_qr[<span class="fu">which</span>(blocks_qr <span class="sc">%like%</span> <span class="st">".R"</span>)]</span>
<span id="cb7-169"><a href="#cb7-169" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-170"><a href="#cb7-170" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Stack R matrices vertically (bind by rows)</span></span>
<span id="cb7-171"><a href="#cb7-171" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bdBind_hdf5_datasets</span>(</span>
<span id="cb7-172"><a href="#cb7-172" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> file,</span>
<span id="cb7-173"><a href="#cb7-173" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="fu">paste0</span>(<span class="st">"Step2/"</span>, strdataset, <span class="st">"rows"</span>),</span>
<span id="cb7-174"><a href="#cb7-174" aria-hidden="true" tabindex="-1"></a>    <span class="at">datasets =</span> r_matrices,</span>
<span id="cb7-175"><a href="#cb7-175" aria-hidden="true" tabindex="-1"></a>    <span class="at">outgroup =</span> <span class="st">"Step3/merged"</span>,</span>
<span id="cb7-176"><a href="#cb7-176" aria-hidden="true" tabindex="-1"></a>    <span class="at">outdataset =</span> <span class="fu">paste0</span>(strdataset, <span class="st">"Rt"</span>),</span>
<span id="cb7-177"><a href="#cb7-177" aria-hidden="true" tabindex="-1"></a>    <span class="at">func =</span> <span class="st">"bindRows"</span>,</span>
<span id="cb7-178"><a href="#cb7-178" aria-hidden="true" tabindex="-1"></a>    <span class="at">overwrite =</span> overwrt</span>
<span id="cb7-179"><a href="#cb7-179" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-180"><a href="#cb7-180" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-181"><a href="#cb7-181" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 5: Final QR on merged R matrices</span></span>
<span id="cb7-182"><a href="#cb7-182" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Taking QR of the stacked R matrices gives us components for final Q</span></span>
<span id="cb7-183"><a href="#cb7-183" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bdapply_Function_hdf5</span>(</span>
<span id="cb7-184"><a href="#cb7-184" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> file,</span>
<span id="cb7-185"><a href="#cb7-185" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"Step3/merged"</span>,</span>
<span id="cb7-186"><a href="#cb7-186" aria-hidden="true" tabindex="-1"></a>    <span class="at">datasets =</span> <span class="fu">paste0</span>(strdataset, <span class="st">"Rt"</span>),</span>
<span id="cb7-187"><a href="#cb7-187" aria-hidden="true" tabindex="-1"></a>    <span class="at">outgroup =</span> <span class="st">"Step3/Final_QR"</span>,</span>
<span id="cb7-188"><a href="#cb7-188" aria-hidden="true" tabindex="-1"></a>    <span class="at">func =</span> <span class="st">"QR"</span>,</span>
<span id="cb7-189"><a href="#cb7-189" aria-hidden="true" tabindex="-1"></a>    <span class="at">overwrite =</span> overwrt</span>
<span id="cb7-190"><a href="#cb7-190" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-191"><a href="#cb7-191" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-192"><a href="#cb7-192" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 6: Split final Q matrix for block-wise multiplication</span></span>
<span id="cb7-193"><a href="#cb7-193" aria-hidden="true" tabindex="-1"></a>  <span class="co"># We need to split this Q to multiply it with original Q blocks</span></span>
<span id="cb7-194"><a href="#cb7-194" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bdSplit_matrix_hdf5</span>(</span>
<span id="cb7-195"><a href="#cb7-195" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> file,</span>
<span id="cb7-196"><a href="#cb7-196" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"Step3/Final_QR"</span>,</span>
<span id="cb7-197"><a href="#cb7-197" aria-hidden="true" tabindex="-1"></a>    <span class="at">dataset =</span> <span class="fu">paste0</span>(strdataset, <span class="st">"Rt.Q"</span>),</span>
<span id="cb7-198"><a href="#cb7-198" aria-hidden="true" tabindex="-1"></a>    <span class="at">outgroup =</span> <span class="st">"Step4/splitted"</span>,</span>
<span id="cb7-199"><a href="#cb7-199" aria-hidden="true" tabindex="-1"></a>    <span class="at">nblocks =</span> m,</span>
<span id="cb7-200"><a href="#cb7-200" aria-hidden="true" tabindex="-1"></a>    <span class="at">bycols =</span> bcols,</span>
<span id="cb7-201"><a href="#cb7-201" aria-hidden="true" tabindex="-1"></a>    <span class="at">overwrite =</span> overwrt</span>
<span id="cb7-202"><a href="#cb7-202" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-203"><a href="#cb7-203" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-204"><a href="#cb7-204" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 7: Multiply original Q blocks by final Q blocks</span></span>
<span id="cb7-205"><a href="#cb7-205" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This reconstructs the full Q matrix in block form</span></span>
<span id="cb7-206"><a href="#cb7-206" aria-hidden="true" tabindex="-1"></a>  tmp <span class="ot">&lt;-</span> <span class="fu">bdgetDatasetsList_hdf5</span>(file, <span class="st">"Step4/splitted"</span>)</span>
<span id="cb7-207"><a href="#cb7-207" aria-hidden="true" tabindex="-1"></a>  Rt_Q_divide <span class="ot">&lt;-</span> tmp[<span class="fu">which</span>(tmp <span class="sc">%like%</span> <span class="fu">paste0</span>(strdataset, <span class="st">"Rt.Q"</span>))]</span>
<span id="cb7-208"><a href="#cb7-208" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-209"><a href="#cb7-209" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get original Q matrices from Step 2</span></span>
<span id="cb7-210"><a href="#cb7-210" aria-hidden="true" tabindex="-1"></a>  q_matrices <span class="ot">&lt;-</span> blocks_qr[<span class="fu">which</span>(blocks_qr <span class="sc">%like%</span> <span class="st">".Q"</span>)]</span>
<span id="cb7-211"><a href="#cb7-211" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-212"><a href="#cb7-212" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Multiply each original Q block by corresponding final Q block</span></span>
<span id="cb7-213"><a href="#cb7-213" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bdapply_Function_hdf5</span>(</span>
<span id="cb7-214"><a href="#cb7-214" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> file,</span>
<span id="cb7-215"><a href="#cb7-215" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="fu">paste0</span>(<span class="st">"Step2/"</span>, strdataset, <span class="st">"rows"</span>),</span>
<span id="cb7-216"><a href="#cb7-216" aria-hidden="true" tabindex="-1"></a>    <span class="at">datasets =</span> q_matrices,</span>
<span id="cb7-217"><a href="#cb7-217" aria-hidden="true" tabindex="-1"></a>    <span class="at">outgroup =</span> <span class="st">"Step5"</span>,</span>
<span id="cb7-218"><a href="#cb7-218" aria-hidden="true" tabindex="-1"></a>    <span class="at">func =</span> <span class="st">"blockmult"</span>,</span>
<span id="cb7-219"><a href="#cb7-219" aria-hidden="true" tabindex="-1"></a>    <span class="at">b_group =</span> <span class="st">"Step4/splitted"</span>,</span>
<span id="cb7-220"><a href="#cb7-220" aria-hidden="true" tabindex="-1"></a>    <span class="at">b_datasets =</span> Rt_Q_divide,</span>
<span id="cb7-221"><a href="#cb7-221" aria-hidden="true" tabindex="-1"></a>    <span class="at">overwrite =</span> <span class="cn">TRUE</span></span>
<span id="cb7-222"><a href="#cb7-222" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-223"><a href="#cb7-223" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-224"><a href="#cb7-224" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 8: Combine all Q blocks into final Q matrix</span></span>
<span id="cb7-225"><a href="#cb7-225" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Stack the multiplied Q blocks vertically</span></span>
<span id="cb7-226"><a href="#cb7-226" aria-hidden="true" tabindex="-1"></a>  blocks_Q <span class="ot">&lt;-</span> <span class="fu">bdgetDatasetsList_hdf5</span>(file, <span class="st">"Step5"</span>)</span>
<span id="cb7-227"><a href="#cb7-227" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-228"><a href="#cb7-228" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bdBind_hdf5_datasets</span>(</span>
<span id="cb7-229"><a href="#cb7-229" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> file,</span>
<span id="cb7-230"><a href="#cb7-230" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"Step5"</span>,</span>
<span id="cb7-231"><a href="#cb7-231" aria-hidden="true" tabindex="-1"></a>    <span class="at">datasets =</span> blocks_Q[<span class="fu">which</span>(blocks_Q <span class="sc">%like%</span> <span class="fu">paste0</span>(strdataset, <span class="st">"."</span>))],</span>
<span id="cb7-232"><a href="#cb7-232" aria-hidden="true" tabindex="-1"></a>    <span class="at">outgroup =</span> <span class="st">"Step6"</span>,</span>
<span id="cb7-233"><a href="#cb7-233" aria-hidden="true" tabindex="-1"></a>    <span class="at">outdataset =</span> <span class="fu">paste0</span>(strdataset, <span class="st">"Q"</span>),</span>
<span id="cb7-234"><a href="#cb7-234" aria-hidden="true" tabindex="-1"></a>    <span class="at">func =</span> <span class="st">"bindRows"</span>,</span>
<span id="cb7-235"><a href="#cb7-235" aria-hidden="true" tabindex="-1"></a>    <span class="at">overwrite =</span> overwrt</span>
<span id="cb7-236"><a href="#cb7-236" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-237"><a href="#cb7-237" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-238"><a href="#cb7-238" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"✓ QR decomposition complete for"</span>, strdataset, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb7-239"><a href="#cb7-239" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-240"><a href="#cb7-240" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb7-241"><a href="#cb7-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-242"><a href="#cb7-242" aria-hidden="true" tabindex="-1"></a><span class="fu">### Understanding the Nine Steps</span></span>
<span id="cb7-243"><a href="#cb7-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-244"><a href="#cb7-244" aria-hidden="true" tabindex="-1"></a>This function implements a carefully orchestrated sequence. Each step builds on previous results, and the order is mathematically necessary.</span>
<span id="cb7-245"><a href="#cb7-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-246"><a href="#cb7-246" aria-hidden="true" tabindex="-1"></a>**Step 1 (Normalization):** Centering and scaling improve numerical stability. Without centering, QR decomposition can be numerically unstable if features have very different means. Without scaling, features with large variance dominate. For multi-omic CCA where X might be methylation (0-1 scale) and Y might be expression (0-10,000 scale), scaling is essential.</span>
<span id="cb7-247"><a href="#cb7-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-248"><a href="#cb7-248" aria-hidden="true" tabindex="-1"></a>**Step 2 (Partitioning):** Splitting into m blocks creates manageable chunks. If your original matrix is 50,000 × 500,000 and won't fit in RAM, m=10 gives you blocks of 5,000 × 500,000 that might fit. The choice of m balances memory usage (larger m = smaller blocks) against computational overhead (more blocks = more operations).</span>
<span id="cb7-249"><a href="#cb7-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-250"><a href="#cb7-250" aria-hidden="true" tabindex="-1"></a>**Step 3 (Block QR):** Computing QR on each block is independent—blocks can be processed in parallel if desired. Each block's QR gives Q_i (5,000 × 500,000 in economy form) and R_i (500,000 × 500,000). The Q_i matrices stay in their original locations; we'll use them later. The R_i matrices move to the next step.</span>
<span id="cb7-251"><a href="#cb7-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-252"><a href="#cb7-252" aria-hidden="true" tabindex="-1"></a>**Step 4 (Merging R):** Stacking all R_i matrices vertically creates a tall-skinny matrix. With m=10 blocks, stacking gives (10 × 500,000) × 500,000 = 5,000,000 × 500,000. This is column-heavy—many rows, but relatively few columns—which is much easier to handle than the original row-heavy matrix.</span>
<span id="cb7-253"><a href="#cb7-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-254"><a href="#cb7-254" aria-hidden="true" tabindex="-1"></a>**Step 5 (Final QR):** Taking QR of the stacked R matrices gives Q_final and R_final. The R_final is the R component of the full matrix's QR decomposition—this is exact, not approximate. The Q_final will be used to combine the original Q blocks.</span>
<span id="cb7-255"><a href="#cb7-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-256"><a href="#cb7-256" aria-hidden="true" tabindex="-1"></a>**Step 6 (Splitting Q_final):** We need to multiply each original Q_i by the corresponding rows of Q_final. Splitting Q_final into m blocks aligns them with the original m blocks of Q.</span>
<span id="cb7-257"><a href="#cb7-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-258"><a href="#cb7-258" aria-hidden="true" tabindex="-1"></a>**Step 7 (Block Multiplication):** For each block i, compute Q_i × Q_final_i. This gives the final Q matrix in block form. The mathematics: if X_i = Q_i R_i, and stacking R_i gives <span class="co">[</span><span class="ot">R_1; R_2; ...</span><span class="co">]</span> = Q_final R_final, then X = <span class="co">[</span><span class="ot">Q_1; Q_2; ...</span><span class="co">]</span> Q_final R_final. So the final Q is <span class="co">[</span><span class="ot">Q_1 Q_final; Q_2 Q_final; ...</span><span class="co">]</span>.</span>
<span id="cb7-259"><a href="#cb7-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-260"><a href="#cb7-260" aria-hidden="true" tabindex="-1"></a>**Step 8 (Combining Final Q):** Stack the multiplied Q blocks vertically to reconstruct the full Q matrix. This final Q, combined with R_final from Step 5, gives you the complete QR decomposition.</span>
<span id="cb7-261"><a href="#cb7-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-262"><a href="#cb7-262" aria-hidden="true" tabindex="-1"></a>**Step 9 (Implicit - Storage):** The function doesn't return anything to R. Instead, results are stored in HDF5 at <span class="in">`/Step6/[dataset]Q`</span> for Q and <span class="in">`/Step3/Final_QR/[dataset]Rt.R`</span> for R. Subsequent functions know to look in these locations.</span>
<span id="cb7-263"><a href="#cb7-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-264"><a href="#cb7-264" aria-hidden="true" tabindex="-1"></a>This multi-step process seems complex, but each step is simple. The complexity is in the orchestration, not the individual operations. And the payoff is that you can compute QR decomposition of matrices that would never fit in memory using a standard algorithm.</span>
<span id="cb7-265"><a href="#cb7-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-266"><a href="#cb7-266" aria-hidden="true" tabindex="-1"></a>::: {.callout-note}</span>
<span id="cb7-267"><a href="#cb7-267" aria-hidden="true" tabindex="-1"></a><span class="fu">## Why Hierarchical Combination Works</span></span>
<span id="cb7-268"><a href="#cb7-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-269"><a href="#cb7-269" aria-hidden="true" tabindex="-1"></a>The mathematical justification for this approach:</span>
<span id="cb7-270"><a href="#cb7-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-271"><a href="#cb7-271" aria-hidden="true" tabindex="-1"></a>If $X_i = Q_i R_i$ for each block, then stacking gives:</span>
<span id="cb7-272"><a href="#cb7-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-273"><a href="#cb7-273" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb7-274"><a href="#cb7-274" aria-hidden="true" tabindex="-1"></a>\begin{bmatrix} X_1 <span class="sc">\\</span> X_2 <span class="sc">\\</span> \vdots <span class="sc">\\</span> X_m \end{bmatrix} = \begin{bmatrix} Q_1 R_1 <span class="sc">\\</span> Q_2 R_2 <span class="sc">\\</span> \vdots <span class="sc">\\</span> Q_m R_m \end{bmatrix}</span>
<span id="cb7-275"><a href="#cb7-275" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb7-276"><a href="#cb7-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-277"><a href="#cb7-277" aria-hidden="true" tabindex="-1"></a>Taking QR of the stacked R matrices:</span>
<span id="cb7-278"><a href="#cb7-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-279"><a href="#cb7-279" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb7-280"><a href="#cb7-280" aria-hidden="true" tabindex="-1"></a>\begin{bmatrix} R_1 <span class="sc">\\</span> R_2 <span class="sc">\\</span> \vdots <span class="sc">\\</span> R_m \end{bmatrix} = \tilde{Q} \tilde{R}</span>
<span id="cb7-281"><a href="#cb7-281" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb7-282"><a href="#cb7-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-283"><a href="#cb7-283" aria-hidden="true" tabindex="-1"></a>Then the full QR decomposition is:</span>
<span id="cb7-284"><a href="#cb7-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-285"><a href="#cb7-285" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb7-286"><a href="#cb7-286" aria-hidden="true" tabindex="-1"></a>X = \begin{bmatrix} Q_1 <span class="sc">\\</span> Q_2 <span class="sc">\\</span> \vdots <span class="sc">\\</span> Q_m \end{bmatrix} \tilde{Q} \tilde{R}</span>
<span id="cb7-287"><a href="#cb7-287" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb7-288"><a href="#cb7-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-289"><a href="#cb7-289" aria-hidden="true" tabindex="-1"></a>The final Q matrix is the block-diagonal matrix of Q_i's times the dense matrix $\tilde{Q}$. The final R is $\tilde{R}$. This is mathematically identical to QR on the full matrix X but computed in memory-friendly steps.</span>
<span id="cb7-290"><a href="#cb7-290" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb7-291"><a href="#cb7-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-292"><a href="#cb7-292" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb7-293"><a href="#cb7-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-294"><a href="#cb7-294" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 2: Main CCA Function</span></span>
<span id="cb7-295"><a href="#cb7-295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-296"><a href="#cb7-296" aria-hidden="true" tabindex="-1"></a><span class="fu">### Orchestrating the Complete Algorithm</span></span>
<span id="cb7-297"><a href="#cb7-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-298"><a href="#cb7-298" aria-hidden="true" tabindex="-1"></a>Now that we have block-wise QR decomposition, we can implement complete CCA. The <span class="in">`bdCCA_hdf5`</span> function orchestrates all steps: QR for both X and Y, computing their cross-product, SVD to extract canonical correlations, solving for coefficients, and computing variates.</span>
<span id="cb7-299"><a href="#cb7-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-300"><a href="#cb7-300" aria-hidden="true" tabindex="-1"></a><span class="in">```{r bdcca-function, eval=FALSE}</span></span>
<span id="cb7-301"><a href="#cb7-301" aria-hidden="true" tabindex="-1"></a>bdCCA_hdf5 <span class="ot">&lt;-</span> <span class="cf">function</span>(filename, X, Y, <span class="at">m =</span> <span class="dv">10</span>,</span>
<span id="cb7-302"><a href="#cb7-302" aria-hidden="true" tabindex="-1"></a>                       <span class="at">bcenter =</span> <span class="cn">TRUE</span>, <span class="at">bscale =</span> <span class="cn">FALSE</span>, <span class="at">bycols =</span> <span class="cn">FALSE</span>,</span>
<span id="cb7-303"><a href="#cb7-303" aria-hidden="true" tabindex="-1"></a>                       <span class="at">overwriteResults =</span> <span class="cn">FALSE</span>, <span class="at">keepInteResults =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb7-304"><a href="#cb7-304" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-305"><a href="#cb7-305" aria-hidden="true" tabindex="-1"></a>  matrices <span class="ot">&lt;-</span> <span class="fu">c</span>(X, Y)</span>
<span id="cb7-306"><a href="#cb7-306" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-307"><a href="#cb7-307" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 1-8: Compute QR decomposition for both X and Y matrices</span></span>
<span id="cb7-308"><a href="#cb7-308" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This is the computationally intensive part - processes data in blocks</span></span>
<span id="cb7-309"><a href="#cb7-309" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Results stored in HDF5 under Step1/ through Step6/</span></span>
<span id="cb7-310"><a href="#cb7-310" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sapply</span>(</span>
<span id="cb7-311"><a href="#cb7-311" aria-hidden="true" tabindex="-1"></a>    matrices,</span>
<span id="cb7-312"><a href="#cb7-312" aria-hidden="true" tabindex="-1"></a>    getQRbyBlocks,</span>
<span id="cb7-313"><a href="#cb7-313" aria-hidden="true" tabindex="-1"></a>    <span class="at">file =</span> filename,</span>
<span id="cb7-314"><a href="#cb7-314" aria-hidden="true" tabindex="-1"></a>    <span class="at">m =</span> m,</span>
<span id="cb7-315"><a href="#cb7-315" aria-hidden="true" tabindex="-1"></a>    <span class="at">center =</span> bcenter,</span>
<span id="cb7-316"><a href="#cb7-316" aria-hidden="true" tabindex="-1"></a>    <span class="at">scale =</span> bscale,</span>
<span id="cb7-317"><a href="#cb7-317" aria-hidden="true" tabindex="-1"></a>    <span class="at">bcols =</span> bycols,</span>
<span id="cb7-318"><a href="#cb7-318" aria-hidden="true" tabindex="-1"></a>    <span class="at">overwrt =</span> overwriteResults</span>
<span id="cb7-319"><a href="#cb7-319" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-320"><a href="#cb7-320" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-321"><a href="#cb7-321" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"✓ QR decompositions complete for both matrices</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb7-322"><a href="#cb7-322" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-323"><a href="#cb7-323" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 9: Compute cross-product of Q matrices</span></span>
<span id="cb7-324"><a href="#cb7-324" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This matrix captures the canonical relationship between X and Y</span></span>
<span id="cb7-325"><a href="#cb7-325" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Q_X is (n × p), Q_Y is (n × q), so Q_X^T Q_Y is (p × q)</span></span>
<span id="cb7-326"><a href="#cb7-326" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">bdCrossprod_hdf5</span>(</span>
<span id="cb7-327"><a href="#cb7-327" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> filename,</span>
<span id="cb7-328"><a href="#cb7-328" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"Step6"</span>,</span>
<span id="cb7-329"><a href="#cb7-329" aria-hidden="true" tabindex="-1"></a>    <span class="at">A =</span> <span class="st">"XQ"</span>,</span>
<span id="cb7-330"><a href="#cb7-330" aria-hidden="true" tabindex="-1"></a>    <span class="at">groupB =</span> <span class="st">"Step6"</span>,</span>
<span id="cb7-331"><a href="#cb7-331" aria-hidden="true" tabindex="-1"></a>    <span class="at">B =</span> <span class="st">"YQ"</span>,</span>
<span id="cb7-332"><a href="#cb7-332" aria-hidden="true" tabindex="-1"></a>    <span class="at">outdataset =</span> <span class="st">"CrossProd_XQ_YQ"</span>,</span>
<span id="cb7-333"><a href="#cb7-333" aria-hidden="true" tabindex="-1"></a>    <span class="at">outgroup =</span> <span class="st">"Step7"</span>,</span>
<span id="cb7-334"><a href="#cb7-334" aria-hidden="true" tabindex="-1"></a>    <span class="at">overwrite =</span> <span class="cn">TRUE</span></span>
<span id="cb7-335"><a href="#cb7-335" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-336"><a href="#cb7-336" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-337"><a href="#cb7-337" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"✓ Cross-product computed</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb7-338"><a href="#cb7-338" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-339"><a href="#cb7-339" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 10: SVD of cross-product</span></span>
<span id="cb7-340"><a href="#cb7-340" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Singular values are the canonical correlations</span></span>
<span id="cb7-341"><a href="#cb7-341" aria-hidden="true" tabindex="-1"></a>  <span class="co"># U and V matrices contain canonical directions</span></span>
<span id="cb7-342"><a href="#cb7-342" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">bdSVD_hdf5</span>(</span>
<span id="cb7-343"><a href="#cb7-343" aria-hidden="true" tabindex="-1"></a>    <span class="at">file =</span> filename,</span>
<span id="cb7-344"><a href="#cb7-344" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"Step7"</span>,</span>
<span id="cb7-345"><a href="#cb7-345" aria-hidden="true" tabindex="-1"></a>    <span class="at">dataset =</span> <span class="st">"CrossProd_XQ_YQ"</span>,</span>
<span id="cb7-346"><a href="#cb7-346" aria-hidden="true" tabindex="-1"></a>    <span class="at">bcenter =</span> <span class="cn">FALSE</span>,  <span class="co"># Already centered in Step 1</span></span>
<span id="cb7-347"><a href="#cb7-347" aria-hidden="true" tabindex="-1"></a>    <span class="at">bscale =</span> <span class="cn">FALSE</span>,</span>
<span id="cb7-348"><a href="#cb7-348" aria-hidden="true" tabindex="-1"></a>    <span class="at">k =</span> <span class="dv">16</span>,   <span class="co"># Number of blocks for SVD computation</span></span>
<span id="cb7-349"><a href="#cb7-349" aria-hidden="true" tabindex="-1"></a>    <span class="at">q =</span> <span class="dv">2</span>,    <span class="co"># Two-level hierarchy for large-scale SVD</span></span>
<span id="cb7-350"><a href="#cb7-350" aria-hidden="true" tabindex="-1"></a>    <span class="at">threads =</span> <span class="dv">3</span>,</span>
<span id="cb7-351"><a href="#cb7-351" aria-hidden="true" tabindex="-1"></a>    <span class="at">overwrite =</span> <span class="cn">TRUE</span></span>
<span id="cb7-352"><a href="#cb7-352" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-353"><a href="#cb7-353" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-354"><a href="#cb7-354" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"✓ SVD computed - canonical correlations extracted</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb7-355"><a href="#cb7-355" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-356"><a href="#cb7-356" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get dimensions needed for coefficient computation</span></span>
<span id="cb7-357"><a href="#cb7-357" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Need number of columns in X and Y to properly dimension coefficients</span></span>
<span id="cb7-358"><a href="#cb7-358" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">sapply</span>(matrices, bdgetDim_hdf5, <span class="at">filename =</span> filename)</span>
<span id="cb7-359"><a href="#cb7-359" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-360"><a href="#cb7-360" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step 11: Compute canonical coefficients and variates</span></span>
<span id="cb7-361"><a href="#cb7-361" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Coefficients show which features contribute to canonical variates</span></span>
<span id="cb7-362"><a href="#cb7-362" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Variates are the actual canonical scores for each sample</span></span>
<span id="cb7-363"><a href="#cb7-363" aria-hidden="true" tabindex="-1"></a>  <span class="fu">writeCCAComponents_hdf5</span>(filename, res[<span class="dv">2</span>, X], res[<span class="dv">2</span>, Y])</span>
<span id="cb7-364"><a href="#cb7-364" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-365"><a href="#cb7-365" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"✓ Canonical coefficients and variates saved</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb7-366"><a href="#cb7-366" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-367"><a href="#cb7-367" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Optional: Remove intermediate results to save disk space</span></span>
<span id="cb7-368"><a href="#cb7-368" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Step1-Step7 contain temporary matrices used during computation</span></span>
<span id="cb7-369"><a href="#cb7-369" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Results/ contains final canonical components</span></span>
<span id="cb7-370"><a href="#cb7-370" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (keepInteResults <span class="sc">==</span> <span class="cn">FALSE</span>) {</span>
<span id="cb7-371"><a href="#cb7-371" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sapply</span>(<span class="fu">paste0</span>(<span class="st">"Step"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>), <span class="cf">function</span>(x) {</span>
<span id="cb7-372"><a href="#cb7-372" aria-hidden="true" tabindex="-1"></a>      <span class="fu">invisible</span>(<span class="fu">bdRemove_hdf5_element</span>(filename, <span class="at">element =</span> x))</span>
<span id="cb7-373"><a href="#cb7-373" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"  "</span>, x, <span class="st">"removed</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb7-374"><a href="#cb7-374" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb7-375"><a href="#cb7-375" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"✓ Intermediate results cleaned up</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb7-376"><a href="#cb7-376" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-377"><a href="#cb7-377" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-378"><a href="#cb7-378" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(</span>
<span id="cb7-379"><a href="#cb7-379" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> filename,</span>
<span id="cb7-380"><a href="#cb7-380" aria-hidden="true" tabindex="-1"></a>    <span class="at">results_group =</span> <span class="st">"Results"</span></span>
<span id="cb7-381"><a href="#cb7-381" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb7-382"><a href="#cb7-382" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-383"><a href="#cb7-383" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb7-384"><a href="#cb7-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-385"><a href="#cb7-385" aria-hidden="true" tabindex="-1"></a><span class="fu">### Function Flow and Design Decisions</span></span>
<span id="cb7-386"><a href="#cb7-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-387"><a href="#cb7-387" aria-hidden="true" tabindex="-1"></a>This function is deceptively simple—only about 50 lines—but it orchestrates a complex multi-stage computation. Several design decisions make it work effectively.</span>
<span id="cb7-388"><a href="#cb7-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-389"><a href="#cb7-389" aria-hidden="true" tabindex="-1"></a>**Separation of concerns:** The function doesn't implement QR decomposition itself; it calls <span class="in">`getQRbyBlocks`</span> for both matrices. This separation means if you want to optimize QR (try different block sizes, use different algorithms), you modify <span class="in">`getQRbyBlocks`</span> without touching this orchestration function. Similarly, SVD computation is delegated to <span class="in">`bdSVD_hdf5`</span>. The main function's job is orchestration, not implementation.</span>
<span id="cb7-390"><a href="#cb7-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-391"><a href="#cb7-391" aria-hidden="true" tabindex="-1"></a>**Sequential dependency management:** Steps must execute in order—you can't compute cross-product before QR, can't do SVD before cross-product, can't solve for coefficients before SVD. The function structure makes this dependency explicit. Each step validates that its inputs exist before proceeding. If Step 3 fails, Step 4 never runs—preventing cascading errors from invalid intermediate results.</span>
<span id="cb7-392"><a href="#cb7-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-393"><a href="#cb7-393" aria-hidden="true" tabindex="-1"></a>**Memory efficiency through streaming:** At no point does this function load the full X or Y matrices into R. All operations happen in HDF5, with only metadata (filenames, dimensions, group names) in R memory. Even when computing with datasets containing millions of elements, R's memory usage stays constant. The HDF5 file grows as results accumulate, but that's disk space, not RAM.</span>
<span id="cb7-394"><a href="#cb7-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-395"><a href="#cb7-395" aria-hidden="true" tabindex="-1"></a>**Parameter propagation:** The <span class="in">`m`</span> parameter (number of blocks) propagates to <span class="in">`getQRbyBlocks`</span>, which propagates it to splitting and merging operations. This single parameter controls memory usage throughout. Want to use less memory? Increase m. Have more RAM available? Decrease m for speed. One parameter tunes the entire computation's memory footprint.</span>
<span id="cb7-396"><a href="#cb7-396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-397"><a href="#cb7-397" aria-hidden="true" tabindex="-1"></a>**Result management flexibility:** The <span class="in">`keepInteResults`</span> parameter lets users choose between disk space (delete intermediates) and debugging capability (keep them). During development, keep intermediate results to inspect where computations fail. In production, delete them to save space. This flexibility costs nothing—it's just a flag controlling cleanup.</span>
<span id="cb7-398"><a href="#cb7-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-399"><a href="#cb7-399" aria-hidden="true" tabindex="-1"></a>**Error propagation:** Each BigDataStatMeth function returns status. If <span class="in">`bdNormalize_hdf5`</span> fails, <span class="in">`getQRbyBlocks`</span> doesn't proceed to splitting. If <span class="in">`getQRbyBlocks`</span> fails for X, Y's QR never starts. Errors stop propagation immediately, preventing corrupted results from appearing as valid output.</span>
<span id="cb7-400"><a href="#cb7-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-401"><a href="#cb7-401" aria-hidden="true" tabindex="-1"></a>The function's apparent simplicity hides careful engineering. It's not just "call these functions in order"—it's "orchestrate a complex computation with clear dependencies, graceful error handling, flexible resource management, and predictable behavior."</span>
<span id="cb7-402"><a href="#cb7-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-403"><a href="#cb7-403" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb7-404"><a href="#cb7-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-405"><a href="#cb7-405" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 3: Computing Canonical Coefficients</span></span>
<span id="cb7-406"><a href="#cb7-406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-407"><a href="#cb7-407" aria-hidden="true" tabindex="-1"></a><span class="fu">### From SVD Results to Interpretable Components</span></span>
<span id="cb7-408"><a href="#cb7-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-409"><a href="#cb7-409" aria-hidden="true" tabindex="-1"></a>The SVD gave us singular values (canonical correlations) and singular vectors (U and V). But these aren't directly the canonical coefficients we want—they're in the orthonormalized Q space. To get coefficients in terms of original features, we need to "undo" the QR transformation by solving triangular systems.</span>
<span id="cb7-410"><a href="#cb7-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-411"><a href="#cb7-411" aria-hidden="true" tabindex="-1"></a><span class="in">```{r write-components, eval=FALSE}</span></span>
<span id="cb7-412"><a href="#cb7-412" aria-hidden="true" tabindex="-1"></a>writeCCAComponents_hdf5 <span class="ot">&lt;-</span> <span class="cf">function</span>(filename, ncolsX, ncolsY) {</span>
<span id="cb7-413"><a href="#cb7-413" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-414"><a href="#cb7-414" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(filename)) {</span>
<span id="cb7-415"><a href="#cb7-415" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"ERROR - File does not exist"</span>)</span>
<span id="cb7-416"><a href="#cb7-416" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-417"><a href="#cb7-417" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-418"><a href="#cb7-418" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Read all necessary components from HDF5</span></span>
<span id="cb7-419"><a href="#cb7-419" aria-hidden="true" tabindex="-1"></a>  h5f <span class="ot">&lt;-</span> <span class="fu">H5Fopen</span>(filename)</span>
<span id="cb7-420"><a href="#cb7-420" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-421"><a href="#cb7-421" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract Q matrices (first ncolsX × ncolsX and ncolsY × ncolsY portions)</span></span>
<span id="cb7-422"><a href="#cb7-422" aria-hidden="true" tabindex="-1"></a>  <span class="co"># These are the orthonormal bases from QR decomposition</span></span>
<span id="cb7-423"><a href="#cb7-423" aria-hidden="true" tabindex="-1"></a>  XQ <span class="ot">&lt;-</span> h5f<span class="sc">$</span>Step6<span class="sc">$</span>XQ[<span class="dv">1</span><span class="sc">:</span>ncolsX, <span class="dv">1</span><span class="sc">:</span>ncolsX]</span>
<span id="cb7-424"><a href="#cb7-424" aria-hidden="true" tabindex="-1"></a>  YQ <span class="ot">&lt;-</span> h5f<span class="sc">$</span>Step6<span class="sc">$</span>YQ[<span class="dv">1</span><span class="sc">:</span>ncolsY, <span class="dv">1</span><span class="sc">:</span>ncolsY]</span>
<span id="cb7-425"><a href="#cb7-425" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-426"><a href="#cb7-426" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract R matrices from final QR</span></span>
<span id="cb7-427"><a href="#cb7-427" aria-hidden="true" tabindex="-1"></a>  <span class="co"># These are upper triangular matrices from the decomposition</span></span>
<span id="cb7-428"><a href="#cb7-428" aria-hidden="true" tabindex="-1"></a>  XR <span class="ot">&lt;-</span> h5f<span class="sc">$</span>Step3<span class="sc">$</span>Final_QR<span class="sc">$</span>XRt.R</span>
<span id="cb7-429"><a href="#cb7-429" aria-hidden="true" tabindex="-1"></a>  YR <span class="ot">&lt;-</span> h5f<span class="sc">$</span>Step3<span class="sc">$</span>Final_QR<span class="sc">$</span>YRt.R</span>
<span id="cb7-430"><a href="#cb7-430" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-431"><a href="#cb7-431" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract SVD results</span></span>
<span id="cb7-432"><a href="#cb7-432" aria-hidden="true" tabindex="-1"></a>  <span class="co"># d: singular values (canonical correlations)</span></span>
<span id="cb7-433"><a href="#cb7-433" aria-hidden="true" tabindex="-1"></a>  <span class="co"># u: left singular vectors (directions in X space)</span></span>
<span id="cb7-434"><a href="#cb7-434" aria-hidden="true" tabindex="-1"></a>  <span class="co"># v: right singular vectors (directions in Y space)</span></span>
<span id="cb7-435"><a href="#cb7-435" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> h5f<span class="sc">$</span>SVD<span class="sc">$</span>CrossProd_XQ_YQ<span class="sc">$</span>d</span>
<span id="cb7-436"><a href="#cb7-436" aria-hidden="true" tabindex="-1"></a>  u <span class="ot">&lt;-</span> h5f<span class="sc">$</span>SVD<span class="sc">$</span>CrossProd_XQ_YQ<span class="sc">$</span>u</span>
<span id="cb7-437"><a href="#cb7-437" aria-hidden="true" tabindex="-1"></a>  v <span class="ot">&lt;-</span> h5f<span class="sc">$</span>SVD<span class="sc">$</span>CrossProd_XQ_YQ<span class="sc">$</span>v</span>
<span id="cb7-438"><a href="#cb7-438" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-439"><a href="#cb7-439" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract centering parameters (means subtracted during normalization)</span></span>
<span id="cb7-440"><a href="#cb7-440" aria-hidden="true" tabindex="-1"></a>  xcenter <span class="ot">&lt;-</span> h5f<span class="sc">$</span>NORMALIZED<span class="sc">$</span>data<span class="sc">$</span>mean.X</span>
<span id="cb7-441"><a href="#cb7-441" aria-hidden="true" tabindex="-1"></a>  ycenter <span class="ot">&lt;-</span> h5f<span class="sc">$</span>NORMALIZED<span class="sc">$</span>data<span class="sc">$</span>mean.Y</span>
<span id="cb7-442"><a href="#cb7-442" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-443"><a href="#cb7-443" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract feature names</span></span>
<span id="cb7-444"><a href="#cb7-444" aria-hidden="true" tabindex="-1"></a>  x.names <span class="ot">&lt;-</span> h5f<span class="sc">$</span>data<span class="sc">$</span>.X_dimnames<span class="sc">$</span><span class="st">`</span><span class="at">2</span><span class="st">`</span></span>
<span id="cb7-445"><a href="#cb7-445" aria-hidden="true" tabindex="-1"></a>  y.names <span class="ot">&lt;-</span> h5f<span class="sc">$</span>data<span class="sc">$</span>.Y_dimnames<span class="sc">$</span><span class="st">`</span><span class="at">2</span><span class="st">`</span></span>
<span id="cb7-446"><a href="#cb7-446" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-447"><a href="#cb7-447" aria-hidden="true" tabindex="-1"></a>  <span class="fu">h5closeAll</span>()</span>
<span id="cb7-448"><a href="#cb7-448" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-449"><a href="#cb7-449" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Reconstruct QR in compact form</span></span>
<span id="cb7-450"><a href="#cb7-450" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Q and R are stored separately; combine into single triangular matrix</span></span>
<span id="cb7-451"><a href="#cb7-451" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Lower triangle = Q (without diagonal), Upper triangle = R (with diagonal)</span></span>
<span id="cb7-452"><a href="#cb7-452" aria-hidden="true" tabindex="-1"></a>  XR[<span class="fu">lower.tri</span>(XR, <span class="at">diag =</span> <span class="cn">FALSE</span>)] <span class="ot">&lt;-</span> <span class="dv">0</span>  <span class="co"># Zero below diagonal</span></span>
<span id="cb7-453"><a href="#cb7-453" aria-hidden="true" tabindex="-1"></a>  XQ[<span class="fu">upper.tri</span>(XQ, <span class="at">diag =</span> <span class="cn">TRUE</span>)] <span class="ot">&lt;-</span> <span class="dv">0</span>   <span class="co"># Zero on and above diagonal</span></span>
<span id="cb7-454"><a href="#cb7-454" aria-hidden="true" tabindex="-1"></a>  XQR <span class="ot">&lt;-</span> XR <span class="sc">+</span> XQ  <span class="co"># Combined representation</span></span>
<span id="cb7-455"><a href="#cb7-455" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-456"><a href="#cb7-456" aria-hidden="true" tabindex="-1"></a>  YR[<span class="fu">lower.tri</span>(YR, <span class="at">diag =</span> <span class="cn">FALSE</span>)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb7-457"><a href="#cb7-457" aria-hidden="true" tabindex="-1"></a>  YQ[<span class="fu">upper.tri</span>(YQ, <span class="at">diag =</span> <span class="cn">TRUE</span>)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb7-458"><a href="#cb7-458" aria-hidden="true" tabindex="-1"></a>  YQR <span class="ot">&lt;-</span> YR <span class="sc">+</span> YQ</span>
<span id="cb7-459"><a href="#cb7-459" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-460"><a href="#cb7-460" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Solve for canonical coefficients</span></span>
<span id="cb7-461"><a href="#cb7-461" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Since X = Q_X R_X and canonical directions are U in Q space,</span></span>
<span id="cb7-462"><a href="#cb7-462" aria-hidden="true" tabindex="-1"></a>  <span class="co"># coefficients in original space are: α = R_X^(-1) U</span></span>
<span id="cb7-463"><a href="#cb7-463" aria-hidden="true" tabindex="-1"></a>  <span class="co"># bdSolve efficiently solves the triangular system R_X α = U</span></span>
<span id="cb7-464"><a href="#cb7-464" aria-hidden="true" tabindex="-1"></a>  xcoef <span class="ot">&lt;-</span> <span class="fu">bdSolve</span>(XQR, u)</span>
<span id="cb7-465"><a href="#cb7-465" aria-hidden="true" tabindex="-1"></a>  ycoef <span class="ot">&lt;-</span> <span class="fu">bdSolve</span>(YQR, v)</span>
<span id="cb7-466"><a href="#cb7-466" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-467"><a href="#cb7-467" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Assign feature names to coefficients</span></span>
<span id="cb7-468"><a href="#cb7-468" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames</span>(xcoef) <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(x.names)</span>
<span id="cb7-469"><a href="#cb7-469" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames</span>(ycoef) <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(y.names)</span>
<span id="cb7-470"><a href="#cb7-470" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-471"><a href="#cb7-471" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Store coefficients in HDF5</span></span>
<span id="cb7-472"><a href="#cb7-472" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bdCreate_hdf5_matrix</span>(</span>
<span id="cb7-473"><a href="#cb7-473" aria-hidden="true" tabindex="-1"></a>    filename, </span>
<span id="cb7-474"><a href="#cb7-474" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> xcoef,</span>
<span id="cb7-475"><a href="#cb7-475" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"Results"</span>,  </span>
<span id="cb7-476"><a href="#cb7-476" aria-hidden="true" tabindex="-1"></a>    <span class="at">dataset =</span> <span class="st">"xcoef"</span>, </span>
<span id="cb7-477"><a href="#cb7-477" aria-hidden="true" tabindex="-1"></a>    <span class="at">overwriteDataset =</span> <span class="cn">TRUE</span></span>
<span id="cb7-478"><a href="#cb7-478" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-479"><a href="#cb7-479" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-480"><a href="#cb7-480" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bdCreate_hdf5_matrix</span>(</span>
<span id="cb7-481"><a href="#cb7-481" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> filename, </span>
<span id="cb7-482"><a href="#cb7-482" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> ycoef,</span>
<span id="cb7-483"><a href="#cb7-483" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"Results"</span>,  </span>
<span id="cb7-484"><a href="#cb7-484" aria-hidden="true" tabindex="-1"></a>    <span class="at">dataset =</span> <span class="st">"ycoef"</span>, </span>
<span id="cb7-485"><a href="#cb7-485" aria-hidden="true" tabindex="-1"></a>    <span class="at">overwriteDataset =</span> <span class="cn">TRUE</span></span>
<span id="cb7-486"><a href="#cb7-486" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-487"><a href="#cb7-487" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-488"><a href="#cb7-488" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Store canonical correlations (diagonal of D from SVD)</span></span>
<span id="cb7-489"><a href="#cb7-489" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bdCreate_hdf5_matrix</span>(</span>
<span id="cb7-490"><a href="#cb7-490" aria-hidden="true" tabindex="-1"></a>    filename, </span>
<span id="cb7-491"><a href="#cb7-491" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> <span class="fu">as.matrix</span>(<span class="fu">diag</span>(d)),</span>
<span id="cb7-492"><a href="#cb7-492" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"Results"</span>, </span>
<span id="cb7-493"><a href="#cb7-493" aria-hidden="true" tabindex="-1"></a>    <span class="at">dataset =</span> <span class="st">"cor"</span>, </span>
<span id="cb7-494"><a href="#cb7-494" aria-hidden="true" tabindex="-1"></a>    <span class="at">overwriteDataset =</span> <span class="cn">TRUE</span></span>
<span id="cb7-495"><a href="#cb7-495" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-496"><a href="#cb7-496" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-497"><a href="#cb7-497" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Store centering parameters for reconstructing original scale</span></span>
<span id="cb7-498"><a href="#cb7-498" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bdCreate_hdf5_matrix</span>(</span>
<span id="cb7-499"><a href="#cb7-499" aria-hidden="true" tabindex="-1"></a>    filename, </span>
<span id="cb7-500"><a href="#cb7-500" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> xcenter,</span>
<span id="cb7-501"><a href="#cb7-501" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"Results"</span>, </span>
<span id="cb7-502"><a href="#cb7-502" aria-hidden="true" tabindex="-1"></a>    <span class="at">dataset =</span> <span class="st">"xcenter"</span>, </span>
<span id="cb7-503"><a href="#cb7-503" aria-hidden="true" tabindex="-1"></a>    <span class="at">overwriteDataset =</span> <span class="cn">TRUE</span></span>
<span id="cb7-504"><a href="#cb7-504" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-505"><a href="#cb7-505" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-506"><a href="#cb7-506" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bdCreate_hdf5_matrix</span>(</span>
<span id="cb7-507"><a href="#cb7-507" aria-hidden="true" tabindex="-1"></a>    filename, </span>
<span id="cb7-508"><a href="#cb7-508" aria-hidden="true" tabindex="-1"></a>    <span class="at">object =</span> ycenter,</span>
<span id="cb7-509"><a href="#cb7-509" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"Results"</span>, </span>
<span id="cb7-510"><a href="#cb7-510" aria-hidden="true" tabindex="-1"></a>    <span class="at">dataset =</span> <span class="st">"ycenter"</span>, </span>
<span id="cb7-511"><a href="#cb7-511" aria-hidden="true" tabindex="-1"></a>    <span class="at">overwriteDataset =</span> <span class="cn">TRUE</span></span>
<span id="cb7-512"><a href="#cb7-512" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-513"><a href="#cb7-513" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-514"><a href="#cb7-514" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute canonical variates (sample scores)</span></span>
<span id="cb7-515"><a href="#cb7-515" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Multiply original data by coefficients: s_X = X α</span></span>
<span id="cb7-516"><a href="#cb7-516" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bdblockmult_hdf5</span>(</span>
<span id="cb7-517"><a href="#cb7-517" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> filename, </span>
<span id="cb7-518"><a href="#cb7-518" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"data"</span>, </span>
<span id="cb7-519"><a href="#cb7-519" aria-hidden="true" tabindex="-1"></a>    <span class="at">A =</span> <span class="st">"X"</span>, </span>
<span id="cb7-520"><a href="#cb7-520" aria-hidden="true" tabindex="-1"></a>    <span class="at">B =</span> <span class="st">"xcoef"</span>,</span>
<span id="cb7-521"><a href="#cb7-521" aria-hidden="true" tabindex="-1"></a>    <span class="at">groupB =</span> <span class="st">"Results"</span>, </span>
<span id="cb7-522"><a href="#cb7-522" aria-hidden="true" tabindex="-1"></a>    <span class="at">outgroup =</span> <span class="st">"Results"</span>,</span>
<span id="cb7-523"><a href="#cb7-523" aria-hidden="true" tabindex="-1"></a>    <span class="at">outdataset =</span> <span class="st">"xscores"</span>, </span>
<span id="cb7-524"><a href="#cb7-524" aria-hidden="true" tabindex="-1"></a>    <span class="at">overwrite =</span> <span class="cn">TRUE</span></span>
<span id="cb7-525"><a href="#cb7-525" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-526"><a href="#cb7-526" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-527"><a href="#cb7-527" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bdblockmult_hdf5</span>(</span>
<span id="cb7-528"><a href="#cb7-528" aria-hidden="true" tabindex="-1"></a>    filename, </span>
<span id="cb7-529"><a href="#cb7-529" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"data"</span>, </span>
<span id="cb7-530"><a href="#cb7-530" aria-hidden="true" tabindex="-1"></a>    <span class="at">A =</span> <span class="st">"Y"</span>, </span>
<span id="cb7-531"><a href="#cb7-531" aria-hidden="true" tabindex="-1"></a>    <span class="at">B =</span> <span class="st">"ycoef"</span>,</span>
<span id="cb7-532"><a href="#cb7-532" aria-hidden="true" tabindex="-1"></a>    <span class="at">groupB =</span> <span class="st">"Results"</span>, </span>
<span id="cb7-533"><a href="#cb7-533" aria-hidden="true" tabindex="-1"></a>    <span class="at">outgroup =</span> <span class="st">"Results"</span>,</span>
<span id="cb7-534"><a href="#cb7-534" aria-hidden="true" tabindex="-1"></a>    <span class="at">outdataset =</span> <span class="st">"yscores"</span>, </span>
<span id="cb7-535"><a href="#cb7-535" aria-hidden="true" tabindex="-1"></a>    <span class="at">overwrite =</span> <span class="cn">TRUE</span></span>
<span id="cb7-536"><a href="#cb7-536" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-537"><a href="#cb7-537" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-538"><a href="#cb7-538" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"✓ All CCA components saved to Results/ group</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb7-539"><a href="#cb7-539" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-540"><a href="#cb7-540" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb7-541"><a href="#cb7-541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-542"><a href="#cb7-542" aria-hidden="true" tabindex="-1"></a><span class="fu">### Why We Need This Step</span></span>
<span id="cb7-543"><a href="#cb7-543" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-544"><a href="#cb7-544" aria-hidden="true" tabindex="-1"></a>The SVD gave us U and V in the Q space—the orthonormalized coordinate system created by QR decomposition. But users want coefficients in terms of original features: "which genes contribute to this canonical variate?" not "which Q-space dimensions contribute?"</span>
<span id="cb7-545"><a href="#cb7-545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-546"><a href="#cb7-546" aria-hidden="true" tabindex="-1"></a>The transformation back requires solving a triangular system. We have X = Q_X R_X, and in Q space the canonical direction is U. To find the direction α in original X space such that Xα corresponds to Q_X U, we solve:</span>
<span id="cb7-547"><a href="#cb7-547" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-548"><a href="#cb7-548" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb7-549"><a href="#cb7-549" aria-hidden="true" tabindex="-1"></a>R_X \alpha = U</span>
<span id="cb7-550"><a href="#cb7-550" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb7-551"><a href="#cb7-551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-552"><a href="#cb7-552" aria-hidden="true" tabindex="-1"></a>Since R_X is upper triangular (from QR decomposition), this system solves efficiently via back-substitution. The <span class="in">`bdSolve`</span> function implements this triangular solve, which is O(n²) rather than O(n³) for general matrix inversion.</span>
<span id="cb7-553"><a href="#cb7-553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-554"><a href="#cb7-554" aria-hidden="true" tabindex="-1"></a><span class="fu">### Understanding the Results Structure</span></span>
<span id="cb7-555"><a href="#cb7-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-556"><a href="#cb7-556" aria-hidden="true" tabindex="-1"></a>After this function completes, the HDF5 file contains a <span class="in">`/Results/`</span> group with these datasets:</span>
<span id="cb7-557"><a href="#cb7-557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-558"><a href="#cb7-558" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**xcoef:** (p × k) matrix of X feature loadings for k canonical components</span>
<span id="cb7-559"><a href="#cb7-559" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**ycoef:** (q × k) matrix of Y feature loadings</span>
<span id="cb7-560"><a href="#cb7-560" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**cor:** (k × 1) vector of canonical correlations</span>
<span id="cb7-561"><a href="#cb7-561" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**xcenter, ycenter:** Mean vectors used for centering</span>
<span id="cb7-562"><a href="#cb7-562" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**xscores:** (n × k) matrix of X canonical variates (sample scores)</span>
<span id="cb7-563"><a href="#cb7-563" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**yscores:** (n × k) matrix of Y canonical variates</span>
<span id="cb7-564"><a href="#cb7-564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-565"><a href="#cb7-565" aria-hidden="true" tabindex="-1"></a>These components support different downstream analyses:</span>
<span id="cb7-566"><a href="#cb7-566" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-567"><a href="#cb7-567" aria-hidden="true" tabindex="-1"></a>**Feature interpretation:** Sort xcoef and ycoef by absolute value to identify which original features (genes, CpG sites) contribute most to each canonical component. High-loading features drive the canonical relationship.</span>
<span id="cb7-568"><a href="#cb7-568" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-569"><a href="#cb7-569" aria-hidden="true" tabindex="-1"></a>**Sample visualization:** Plot xscores vs yscores, colored by sample metadata (cancer type, treatment group). This shows how samples separate in canonical space.</span>
<span id="cb7-570"><a href="#cb7-570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-571"><a href="#cb7-571" aria-hidden="true" tabindex="-1"></a>**Validation:** Compute correlation between xscores and yscores columns—should match the canonical correlations in <span class="in">`cor`</span>.</span>
<span id="cb7-572"><a href="#cb7-572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-573"><a href="#cb7-573" aria-hidden="true" tabindex="-1"></a>**Downstream modeling:** Use xscores and yscores as features in classification, regression, or survival models. They're lower-dimensional representations capturing coordinated variation.</span>
<span id="cb7-574"><a href="#cb7-574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-575"><a href="#cb7-575" aria-hidden="true" tabindex="-1"></a>The centering parameters let you reconstruct original-scale predictions if needed, though typically canonical variates are used directly.</span>
<span id="cb7-576"><a href="#cb7-576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-577"><a href="#cb7-577" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb7-578"><a href="#cb7-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-579"><a href="#cb7-579" aria-hidden="true" tabindex="-1"></a><span class="fu">## Example Usage</span></span>
<span id="cb7-580"><a href="#cb7-580" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-581"><a href="#cb7-581" aria-hidden="true" tabindex="-1"></a>Here's how to use the complete CCA implementation on real data:</span>
<span id="cb7-582"><a href="#cb7-582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-583"><a href="#cb7-583" aria-hidden="true" tabindex="-1"></a><span class="in">```{r example-usage, eval=FALSE}</span></span>
<span id="cb7-584"><a href="#cb7-584" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(BigDataStatMeth)</span>
<span id="cb7-585"><a href="#cb7-585" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rhdf5)</span>
<span id="cb7-586"><a href="#cb7-586" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-587"><a href="#cb7-587" aria-hidden="true" tabindex="-1"></a><span class="co"># Assume we have multi-omic data already in HDF5</span></span>
<span id="cb7-588"><a href="#cb7-588" aria-hidden="true" tabindex="-1"></a><span class="co"># X: methylation (n × p)</span></span>
<span id="cb7-589"><a href="#cb7-589" aria-hidden="true" tabindex="-1"></a><span class="co"># Y: expression (n × q)</span></span>
<span id="cb7-590"><a href="#cb7-590" aria-hidden="true" tabindex="-1"></a>cca_file <span class="ot">&lt;-</span> <span class="st">"multi_omic_cca.hdf5"</span></span>
<span id="cb7-591"><a href="#cb7-591" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-592"><a href="#cb7-592" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform CCA with 4 blocks, centering but not scaling</span></span>
<span id="cb7-593"><a href="#cb7-593" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">bdCCA_hdf5</span>(</span>
<span id="cb7-594"><a href="#cb7-594" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> cca_file,</span>
<span id="cb7-595"><a href="#cb7-595" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> <span class="st">"data/X"</span>,</span>
<span id="cb7-596"><a href="#cb7-596" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y =</span> <span class="st">"data/Y"</span>,</span>
<span id="cb7-597"><a href="#cb7-597" aria-hidden="true" tabindex="-1"></a>  <span class="at">m =</span> <span class="dv">4</span>,</span>
<span id="cb7-598"><a href="#cb7-598" aria-hidden="true" tabindex="-1"></a>  <span class="at">bcenter =</span> <span class="cn">TRUE</span>,</span>
<span id="cb7-599"><a href="#cb7-599" aria-hidden="true" tabindex="-1"></a>  <span class="at">bscale =</span> <span class="cn">FALSE</span>,</span>
<span id="cb7-600"><a href="#cb7-600" aria-hidden="true" tabindex="-1"></a>  <span class="at">overwriteResults =</span> <span class="cn">TRUE</span>,</span>
<span id="cb7-601"><a href="#cb7-601" aria-hidden="true" tabindex="-1"></a>  <span class="at">keepInteResults =</span> <span class="cn">FALSE</span>  <span class="co"># Clean up intermediate steps</span></span>
<span id="cb7-602"><a href="#cb7-602" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-603"><a href="#cb7-603" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-604"><a href="#cb7-604" aria-hidden="true" tabindex="-1"></a><span class="co"># Examine results</span></span>
<span id="cb7-605"><a href="#cb7-605" aria-hidden="true" tabindex="-1"></a><span class="fu">h5ls</span>(cca_file, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-606"><a href="#cb7-606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-607"><a href="#cb7-607" aria-hidden="true" tabindex="-1"></a><span class="co"># Load canonical correlations</span></span>
<span id="cb7-608"><a href="#cb7-608" aria-hidden="true" tabindex="-1"></a>h5f <span class="ot">&lt;-</span> <span class="fu">H5Fopen</span>(cca_file)</span>
<span id="cb7-609"><a href="#cb7-609" aria-hidden="true" tabindex="-1"></a>canonical_cors <span class="ot">&lt;-</span> <span class="fu">diag</span>(h5f<span class="sc">$</span>Results<span class="sc">$</span>cor)</span>
<span id="cb7-610"><a href="#cb7-610" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Canonical correlations:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb7-611"><a href="#cb7-611" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(canonical_cors[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>])</span>
<span id="cb7-612"><a href="#cb7-612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-613"><a href="#cb7-613" aria-hidden="true" tabindex="-1"></a><span class="co"># Load feature coefficients</span></span>
<span id="cb7-614"><a href="#cb7-614" aria-hidden="true" tabindex="-1"></a>xcoef <span class="ot">&lt;-</span> h5f<span class="sc">$</span>Results<span class="sc">$</span>xcoef</span>
<span id="cb7-615"><a href="#cb7-615" aria-hidden="true" tabindex="-1"></a>ycoef <span class="ot">&lt;-</span> h5f<span class="sc">$</span>Results<span class="sc">$</span>ycoef</span>
<span id="cb7-616"><a href="#cb7-616" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-617"><a href="#cb7-617" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify top features for first canonical component</span></span>
<span id="cb7-618"><a href="#cb7-618" aria-hidden="true" tabindex="-1"></a>x_top <span class="ot">&lt;-</span> <span class="fu">order</span>(<span class="fu">abs</span>(xcoef[, <span class="dv">1</span>]), <span class="at">decreasing =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>]</span>
<span id="cb7-619"><a href="#cb7-619" aria-hidden="true" tabindex="-1"></a>y_top <span class="ot">&lt;-</span> <span class="fu">order</span>(<span class="fu">abs</span>(ycoef[, <span class="dv">1</span>]), <span class="at">decreasing =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>]</span>
<span id="cb7-620"><a href="#cb7-620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-621"><a href="#cb7-621" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Top 10 methylation sites:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb7-622"><a href="#cb7-622" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(xcoef[x_top, <span class="dv">1</span>])</span>
<span id="cb7-623"><a href="#cb7-623" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-624"><a href="#cb7-624" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Top 10 genes:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb7-625"><a href="#cb7-625" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(ycoef[y_top, <span class="dv">1</span>])</span>
<span id="cb7-626"><a href="#cb7-626" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-627"><a href="#cb7-627" aria-hidden="true" tabindex="-1"></a><span class="co"># Load sample scores for visualization</span></span>
<span id="cb7-628"><a href="#cb7-628" aria-hidden="true" tabindex="-1"></a>xscores <span class="ot">&lt;-</span> h5f<span class="sc">$</span>Results<span class="sc">$</span>xscores</span>
<span id="cb7-629"><a href="#cb7-629" aria-hidden="true" tabindex="-1"></a>yscores <span class="ot">&lt;-</span> h5f<span class="sc">$</span>Results<span class="sc">$</span>yscores</span>
<span id="cb7-630"><a href="#cb7-630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-631"><a href="#cb7-631" aria-hidden="true" tabindex="-1"></a><span class="fu">h5closeAll</span>()</span>
<span id="cb7-632"><a href="#cb7-632" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-633"><a href="#cb7-633" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify: correlation of scores should match canonical correlation</span></span>
<span id="cb7-634"><a href="#cb7-634" aria-hidden="true" tabindex="-1"></a>cor_check <span class="ot">&lt;-</span> <span class="fu">cor</span>(xscores[, <span class="dv">1</span>], yscores[, <span class="dv">1</span>])</span>
<span id="cb7-635"><a href="#cb7-635" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Verification - CC1:"</span>, canonical_cors[<span class="dv">1</span>], </span>
<span id="cb7-636"><a href="#cb7-636" aria-hidden="true" tabindex="-1"></a>    <span class="st">"| Computed:"</span>, cor_check, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb7-637"><a href="#cb7-637" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb7-638"><a href="#cb7-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-639"><a href="#cb7-639" aria-hidden="true" tabindex="-1"></a>This example shows the typical workflow: run CCA, examine canonical correlations to see how strong the relationships are, inspect feature loadings to understand what drives the relationships, and extract sample scores for visualization or downstream modeling.</span>
<span id="cb7-640"><a href="#cb7-640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-641"><a href="#cb7-641" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb7-642"><a href="#cb7-642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-643"><a href="#cb7-643" aria-hidden="true" tabindex="-1"></a><span class="fu">## Interactive Exercise {.exercise}</span></span>
<span id="cb7-644"><a href="#cb7-644" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-645"><a href="#cb7-645" aria-hidden="true" tabindex="-1"></a><span class="fu">### Practice: Extending the CCA Implementation</span></span>
<span id="cb7-646"><a href="#cb7-646" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-647"><a href="#cb7-647" aria-hidden="true" tabindex="-1"></a>Understanding comes from experimentation. Try these modifications:</span>
<span id="cb7-648"><a href="#cb7-648" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-651"><a href="#cb7-651" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb7-652"><a href="#cb7-652" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb7-653"><a href="#cb7-653" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-654"><a href="#cb7-654" aria-hidden="true" tabindex="-1"></a><span class="co"># Exercise 1: Vary the number of blocks</span></span>
<span id="cb7-655"><a href="#cb7-655" aria-hidden="true" tabindex="-1"></a><span class="co"># Run CCA with m = 2, 4, 8, 16</span></span>
<span id="cb7-656"><a href="#cb7-656" aria-hidden="true" tabindex="-1"></a><span class="co"># Time each execution</span></span>
<span id="cb7-657"><a href="#cb7-657" aria-hidden="true" tabindex="-1"></a><span class="co"># How does block count affect speed and memory?</span></span>
<span id="cb7-658"><a href="#cb7-658" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-659"><a href="#cb7-659" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb7-660"><a href="#cb7-660" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bdCCA_hdf5</span>(cca_file, <span class="st">"data/X"</span>, <span class="st">"data/Y"</span>, <span class="at">m =</span> <span class="dv">2</span>, </span>
<span id="cb7-661"><a href="#cb7-661" aria-hidden="true" tabindex="-1"></a>             <span class="at">overwriteResults =</span> <span class="cn">TRUE</span>, <span class="at">keepInteResults =</span> <span class="cn">FALSE</span>)</span>
<span id="cb7-662"><a href="#cb7-662" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb7-663"><a href="#cb7-663" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-664"><a href="#cb7-664" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb7-665"><a href="#cb7-665" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bdCCA_hdf5</span>(cca_file, <span class="st">"data/X"</span>, <span class="st">"data/Y"</span>, <span class="at">m =</span> <span class="dv">8</span>, </span>
<span id="cb7-666"><a href="#cb7-666" aria-hidden="true" tabindex="-1"></a>             <span class="at">overwriteResults =</span> <span class="cn">TRUE</span>, <span class="at">keepInteResults =</span> <span class="cn">FALSE</span>)</span>
<span id="cb7-667"><a href="#cb7-667" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb7-668"><a href="#cb7-668" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-669"><a href="#cb7-669" aria-hidden="true" tabindex="-1"></a><span class="co"># Exercise 2: Inspect intermediate results</span></span>
<span id="cb7-670"><a href="#cb7-670" aria-hidden="true" tabindex="-1"></a><span class="co"># Run with keepInteResults = TRUE</span></span>
<span id="cb7-671"><a href="#cb7-671" aria-hidden="true" tabindex="-1"></a><span class="co"># Examine Step1 through Step7 in HDF5 file</span></span>
<span id="cb7-672"><a href="#cb7-672" aria-hidden="true" tabindex="-1"></a><span class="co"># What's the size and structure of each step?</span></span>
<span id="cb7-673"><a href="#cb7-673" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-674"><a href="#cb7-674" aria-hidden="true" tabindex="-1"></a><span class="fu">bdCCA_hdf5</span>(cca_file, <span class="st">"data/X"</span>, <span class="st">"data/Y"</span>, <span class="at">m =</span> <span class="dv">4</span>,</span>
<span id="cb7-675"><a href="#cb7-675" aria-hidden="true" tabindex="-1"></a>           <span class="at">keepInteResults =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-676"><a href="#cb7-676" aria-hidden="true" tabindex="-1"></a><span class="fu">h5ls</span>(cca_file, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-677"><a href="#cb7-677" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-678"><a href="#cb7-678" aria-hidden="true" tabindex="-1"></a><span class="co"># Exercise 3: Implement sparse CCA</span></span>
<span id="cb7-679"><a href="#cb7-679" aria-hidden="true" tabindex="-1"></a><span class="co"># Modify writeCCAComponents_hdf5 to:</span></span>
<span id="cb7-680"><a href="#cb7-680" aria-hidden="true" tabindex="-1"></a><span class="co"># - Apply L1 penalty to coefficients</span></span>
<span id="cb7-681"><a href="#cb7-681" aria-hidden="true" tabindex="-1"></a><span class="co"># - Threshold small coefficients to zero</span></span>
<span id="cb7-682"><a href="#cb7-682" aria-hidden="true" tabindex="-1"></a><span class="co"># - Re-normalize remaining coefficients</span></span>
<span id="cb7-683"><a href="#cb7-683" aria-hidden="true" tabindex="-1"></a><span class="co"># How does sparsity affect interpretation?</span></span>
<span id="cb7-684"><a href="#cb7-684" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-685"><a href="#cb7-685" aria-hidden="true" tabindex="-1"></a><span class="co"># Exercise 4: Add cross-validation</span></span>
<span id="cb7-686"><a href="#cb7-686" aria-hidden="true" tabindex="-1"></a><span class="co"># Split samples into train/test</span></span>
<span id="cb7-687"><a href="#cb7-687" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute CCA on train set</span></span>
<span id="cb7-688"><a href="#cb7-688" aria-hidden="true" tabindex="-1"></a><span class="co"># Project test samples onto canonical variates</span></span>
<span id="cb7-689"><a href="#cb7-689" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate stability of canonical correlations</span></span>
<span id="cb7-690"><a href="#cb7-690" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb7-691"><a href="#cb7-691" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-692"><a href="#cb7-692" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip}</span>
<span id="cb7-693"><a href="#cb7-693" aria-hidden="true" tabindex="-1"></a><span class="fu">### Reflection Questions</span></span>
<span id="cb7-694"><a href="#cb7-694" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-695"><a href="#cb7-695" aria-hidden="true" tabindex="-1"></a>**1. Algorithm Design:**</span>
<span id="cb7-696"><a href="#cb7-696" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Why 9 steps in getQRbyBlocks, not fewer?</span>
<span id="cb7-697"><a href="#cb7-697" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Could you compute CCA without QR decomposition?</span>
<span id="cb7-698"><a href="#cb7-698" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>What if you swapped SVD for eigendecomposition?</span>
<span id="cb7-699"><a href="#cb7-699" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-700"><a href="#cb7-700" aria-hidden="true" tabindex="-1"></a>**2. Performance Tuning:**</span>
<span id="cb7-701"><a href="#cb7-701" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>With 100GB data, what m value would you try first?</span>
<span id="cb7-702"><a href="#cb7-702" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>When does increasing m stop helping?</span>
<span id="cb7-703"><a href="#cb7-703" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Would parallel processing help? Which steps?</span>
<span id="cb7-704"><a href="#cb7-704" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-705"><a href="#cb7-705" aria-hidden="true" tabindex="-1"></a>**3. Numerical Stability:**</span>
<span id="cb7-706"><a href="#cb7-706" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Why does normalization improve QR stability?</span>
<span id="cb7-707"><a href="#cb7-707" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>What happens if R matrices become singular?</span>
<span id="cb7-708"><a href="#cb7-708" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>How would you detect and handle ill-conditioning?</span>
<span id="cb7-709"><a href="#cb7-709" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-710"><a href="#cb7-710" aria-hidden="true" tabindex="-1"></a>**4. Extension Possibilities:**</span>
<span id="cb7-711"><a href="#cb7-711" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>How would you implement regularized CCA?</span>
<span id="cb7-712"><a href="#cb7-712" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Could you handle &gt;2 datasets (multi-block CCA)?</span>
<span id="cb7-713"><a href="#cb7-713" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>How would you add permutation testing?</span>
<span id="cb7-714"><a href="#cb7-714" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-715"><a href="#cb7-715" aria-hidden="true" tabindex="-1"></a>**5. Production Deployment:**</span>
<span id="cb7-716"><a href="#cb7-716" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>What validation checks would you add?</span>
<span id="cb7-717"><a href="#cb7-717" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>How would you handle computation failures?</span>
<span id="cb7-718"><a href="#cb7-718" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>What logging would be essential?</span>
<span id="cb7-719"><a href="#cb7-719" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-720"><a href="#cb7-720" aria-hidden="true" tabindex="-1"></a>These questions push beyond the implementation to understand design trade-offs and extension possibilities.</span>
<span id="cb7-721"><a href="#cb7-721" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb7-722"><a href="#cb7-722" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-723"><a href="#cb7-723" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb7-724"><a href="#cb7-724" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-725"><a href="#cb7-725" aria-hidden="true" tabindex="-1"></a><span class="fu">## Key Takeaways {.key-concept}</span></span>
<span id="cb7-726"><a href="#cb7-726" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-727"><a href="#cb7-727" aria-hidden="true" tabindex="-1"></a>Let's consolidate what you've learned about implementing statistical methods using BigDataStatMeth's R API.</span>
<span id="cb7-728"><a href="#cb7-728" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-729"><a href="#cb7-729" aria-hidden="true" tabindex="-1"></a><span class="fu">### Essential Concepts</span></span>
<span id="cb7-730"><a href="#cb7-730" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-731"><a href="#cb7-731" aria-hidden="true" tabindex="-1"></a>**Block-wise algorithms decompose computation into manageable steps.** The QR decomposition by blocks shows the fundamental pattern: partition data, process each partition independently, combine results hierarchically. This isn't an approximation or heuristic—it's mathematically exact. The block-wise QR produces identical results to computing QR on the full matrix, but with dramatically reduced memory requirements. This pattern applies beyond QR: eigendecomposition, SVD, matrix factorizations, even iterative algorithms like EM can be adapted to block-wise processing. The key insight is identifying which operations can be parallelized (processing blocks) and which must be sequential (combining results).</span>
<span id="cb7-732"><a href="#cb7-732" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-733"><a href="#cb7-733" aria-hidden="true" tabindex="-1"></a>**HDF5 acts as persistent working memory.** Traditional R functions load data, compute, return results—everything happens in RAM. BigDataStatMeth functions read from HDF5, compute, write results back to HDF5, return metadata. The HDF5 file becomes working memory that persists between function calls and exceeds RAM capacity. Step1 through Step7 in getQRbyBlocks aren't temporary variables—they're persistent intermediate results that subsequent functions access directly. This changes how you think about algorithms: instead of "what fits in memory," you ask "what's the optimal sequence of disk operations." The HDF5 file documents the computation's progression—if it fails at Step 5, Steps 1-4 remain intact for debugging.</span>
<span id="cb7-734"><a href="#cb7-734" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-735"><a href="#cb7-735" aria-hidden="true" tabindex="-1"></a>**Hierarchical combination preserves mathematical correctness.** Combining block QR results through "stack R matrices, take QR, multiply Q matrices" seems complicated. Why not just concatenate the final Q blocks? Because that wouldn't produce the correct overall QR decomposition. The hierarchical approach is derived from the QR decomposition's mathematical properties—specifically, that QR of a vertically stacked matrix can be computed from the QR decompositions of the blocks. This isn't algorithmic cleverness; it's mathematical necessity. The pattern generalizes: whenever you break a matrix operation into blocks, you need to understand the mathematical relationship between block results and the full result. Sometimes it's simple (addition, subtraction), sometimes it requires hierarchical combining (QR, SVD), sometimes it requires iteration (eigenvalue methods).</span>
<span id="cb7-736"><a href="#cb7-736" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-737"><a href="#cb7-737" aria-hidden="true" tabindex="-1"></a>**Normalization isn't preprocessing—it's algorithmic necessity.** The bcenter and bscale parameters aren't optional niceties for cleaner data. They're essential for numerical stability in QR decomposition. Without centering, features with large means can cause catastrophic cancellation in floating-point arithmetic. Without scaling, features with large variance dominate the decomposition, and features with small variance contribute numerical noise rather than signal. For CCA across multi-omic datasets—methylation (0-1 scale), expression (0-10,000 scale)—scaling isn't just recommended, it's mandatory. The algorithm will run without it, produce results, and those results will be numerically garbage. This is true for most decomposition methods: normalization isn't data cleaning, it's numerical stability.</span>
<span id="cb7-738"><a href="#cb7-738" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-739"><a href="#cb7-739" aria-hidden="true" tabindex="-1"></a>**Intermediate result management balances disk space and debugging.** The keepInteResults parameter exemplifies a design decision in all complex algorithms: clean up as you go (save disk space, hide complexity) or keep intermediates (enable debugging, allow inspection). During development, keep everything—if Step 7 fails, you need Step 6 results to diagnose why. In production, delete intermediates—a CCA pipeline that processes 1000 datasets doesn't need to keep Step1 through Step7 for all of them. The implementation makes this choice explicit and user-controllable. Good algorithm design anticipates both use cases. Consider adding timestamps to intermediate results, logging which steps completed, even storing parameter values that generated each result. These cost little disk space but dramatically improve debugging.</span>
<span id="cb7-740"><a href="#cb7-740" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-741"><a href="#cb7-741" aria-hidden="true" tabindex="-1"></a>**Function structure mirrors mathematical algorithm structure.** The separation between getQRbyBlocks, bdCCA_hdf5, and writeCCAComponents_hdf5 isn't arbitrary. Each function corresponds to a conceptual step in the CCA algorithm: compute QR, compute SVD of cross-product, solve for coefficients. This mapping between mathematical steps and code functions makes the implementation easier to understand, test, and modify. If you want to try a different SVD algorithm, you modify the bdSVD_hdf5 call without touching QR computation. If you want to add regularization, you modify writeCCAComponents_hdf5 to apply penalties when solving for coefficients. Clear separation of concerns—each function does one mathematical thing well—enables compositional algorithm development.</span>
<span id="cb7-742"><a href="#cb7-742" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-743"><a href="#cb7-743" aria-hidden="true" tabindex="-1"></a><span class="fu">### When to Implement in R vs C++</span></span>
<span id="cb7-744"><a href="#cb7-744" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-745"><a href="#cb7-745" aria-hidden="true" tabindex="-1"></a>Understanding when to use R versus when to move to C++ guides efficient development.</span>
<span id="cb7-746"><a href="#cb7-746" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-747"><a href="#cb7-747" aria-hidden="true" tabindex="-1"></a>✅ **Implement in R when:**</span>
<span id="cb7-748"><a href="#cb7-748" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-749"><a href="#cb7-749" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Prototyping new methods** - R's interactive development, immediate feedback, and high-level syntax make it ideal for trying new ideas. Get the algorithm working in R, validate correctness, optimize the mathematical approach. Only then consider C++ for performance.</span>
<span id="cb7-750"><a href="#cb7-750" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-751"><a href="#cb7-751" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Orchestrating existing functions** - If your method combines BigDataStatMeth functions like bdSVD_hdf5, bdCrossprod_hdf5, etc., R orchestration is fine. These functions already use compiled C++ code—R just sequences the calls. The overhead of R function calls is negligible compared to the actual computations.</span>
<span id="cb7-752"><a href="#cb7-752" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-753"><a href="#cb7-753" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Methods used occasionally** - If you run this analysis once per month, R performance is adequate. A method that takes 10 minutes in R versus 3 minutes in C++ doesn't justify C++ development time for infrequent use.</span>
<span id="cb7-754"><a href="#cb7-754" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-755"><a href="#cb7-755" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Leveraging R's statistical ecosystem** - If your method needs permutation testing, cross-validation, statistical tests, or model fitting, R's packages provide these capabilities. Reimplementing in C++ would be massive effort for marginal performance gain.</span>
<span id="cb7-756"><a href="#cb7-756" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-757"><a href="#cb7-757" aria-hidden="true" tabindex="-1"></a>✅ **Consider C++ when:**</span>
<span id="cb7-758"><a href="#cb7-758" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-759"><a href="#cb7-759" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Performance bottlenecks identified** - Profile your R code. If one specific operation consumes most of the runtime, rewrite that operation in C++, not the entire method. Surgical optimization is more efficient than wholesale rewriting.</span>
<span id="cb7-760"><a href="#cb7-760" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-761"><a href="#cb7-761" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Production deployment at scale** - If this method will run thousands of times in production pipelines, C++ performance gains accumulate. A 50% speedup saves hours daily in high-throughput settings.</span>
<span id="cb7-762"><a href="#cb7-762" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-763"><a href="#cb7-763" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Custom algorithms not in BigDataStatMeth** - If you're implementing novel decomposition methods, custom optimization algorithms, or specialized linear algebra, C++ gives you control. You're not constrained to BigDataStatMeth's provided operations.</span>
<span id="cb7-764"><a href="#cb7-764" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-765"><a href="#cb7-765" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Real-time or interactive requirements** - If users interact with the method (parameter changes trigger recomputation), sub-second response requires C++. R's several-second latency is acceptable for batch processing but not interactive exploration.</span>
<span id="cb7-766"><a href="#cb7-766" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-767"><a href="#cb7-767" aria-hidden="true" tabindex="-1"></a>The key principle: start in R, optimize selectively in C++ only when profiling shows clear bottlenecks and usage patterns justify development effort. Most statistical method implementations belong entirely in R, with BigDataStatMeth functions handling the computationally intensive matrix operations.</span>
<span id="cb7-768"><a href="#cb7-768" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-769"><a href="#cb7-769" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb7-770"><a href="#cb7-770" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-771"><a href="#cb7-771" aria-hidden="true" tabindex="-1"></a><span class="fu">## Next Steps</span></span>
<span id="cb7-772"><a href="#cb7-772" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-773"><a href="#cb7-773" aria-hidden="true" tabindex="-1"></a>**Explore C++ implementation:**</span>
<span id="cb7-774"><a href="#cb7-774" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-775"><a href="#cb7-775" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">CCA Implementation in C++</span><span class="co">](cca-cpp-implementation.qmd)</span> - Same algorithm, performance optimization</span>
<span id="cb7-776"><a href="#cb7-776" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-777"><a href="#cb7-777" aria-hidden="true" tabindex="-1"></a>**Apply the patterns:**</span>
<span id="cb7-778"><a href="#cb7-778" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-779"><a href="#cb7-779" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Implement sparse CCA with L1 regularization</span>
<span id="cb7-780"><a href="#cb7-780" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Build regularized CCA for high-dimensional settings</span>
<span id="cb7-781"><a href="#cb7-781" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Develop partial least squares (PLS) using similar structure</span>
<span id="cb7-782"><a href="#cb7-782" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Create custom decomposition methods</span>
<span id="cb7-783"><a href="#cb7-783" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-784"><a href="#cb7-784" aria-hidden="true" tabindex="-1"></a>**Understand the underlying functions:**</span>
<span id="cb7-785"><a href="#cb7-785" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-786"><a href="#cb7-786" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Study BigDataStatMeth's block-wise SVD implementation</span>
<span id="cb7-787"><a href="#cb7-787" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Examine how bdCrossprod_hdf5 handles large matrices</span>
<span id="cb7-788"><a href="#cb7-788" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Learn HDF5 dataset management strategies</span>
<span id="cb7-789"><a href="#cb7-789" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-790"><a href="#cb7-790" aria-hidden="true" tabindex="-1"></a>**Extend for production:**</span>
<span id="cb7-791"><a href="#cb7-791" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-792"><a href="#cb7-792" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Add comprehensive error handling</span>
<span id="cb7-793"><a href="#cb7-793" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Implement parameter validation</span>
<span id="cb7-794"><a href="#cb7-794" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Create progress reporting</span>
<span id="cb7-795"><a href="#cb7-795" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Build result verification functions</span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>© 2025 BigDataStatMeth - ISGlobal BRGE</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/isglobal-brge/BigDataStatMeth/edit/main/developing-methods/cca-r-implementation.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/isglobal-brge/BigDataStatMeth/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/isglobal-brge/BigDataStatMeth">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item">
 License: GPL-3
  </li>  
</ul>
    </div>
  </div>
</footer>




<script src="../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>