<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>CCA Implementation in C++ – BigDataStatMeth</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../assets/favicon.png" rel="icon" type="image/png">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-065a5179aebd64318d7ea99d77b64a9e.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark-969ddfa49e00a70eb3423444dbc81f6c.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-065a5179aebd64318d7ea99d77b64a9e.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-d0f1cdce0779274a5ec1152cd33adb41.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark-d6747531eee53fd58085a197f3afc013.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-d0f1cdce0779274a5ec1152cd33adb41.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>html{ scroll-behavior: smooth; }</style>

  <script>window.backupDefine = window.define; window.define = undefined;</script><script src="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.js"></script>
  <script>document.addEventListener("DOMContentLoaded", function () {
 var mathElements = document.getElementsByClassName("math");
 var macros = [];
 for (var i = 0; i < mathElements.length; i++) {
  var texText = mathElements[i].firstChild;
  if (mathElements[i].tagName == "SPAN") {
   katex.render(texText.data, mathElements[i], {
    displayMode: mathElements[i].classList.contains('display'),
    throwOnError: false,
    macros: macros,
    fleqn: false
   });
}}});
  </script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css">

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../assets/css/custom.css">
</head>

<body class="nav-sidebar docked nav-fixed quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../assets/images/logo.png" alt="" class="navbar-logo light-content">
    <img src="../assets/images/logo.png" alt="" class="navbar-logo dark-content">
    </a>
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">BigDataStatMeth</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="../index.html" aria-current="page"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-fundamentals" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Fundamentals</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-fundamentals">    
        <li>
    <a class="dropdown-item" href="../fundamentals/big-data-problem.html">
 <span class="dropdown-text">The Big Data Problem</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../fundamentals/understanding-hdf5.html">
 <span class="dropdown-text">Understanding HDF5</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../fundamentals/blockwise-computing.html">
 <span class="dropdown-text">Block-Wise Computing</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../fundamentals/linear-algebra.html">
 <span class="dropdown-text">Linear Algebra Essentials</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-tutorials" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Tutorials</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-tutorials">    
        <li>
    <a class="dropdown-item" href="../tutorials/getting-started.html">
 <span class="dropdown-text">Getting Started</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../tutorials/working-hdf5-matrices.html">
 <span class="dropdown-text">Working with HDF5 Matrices</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../tutorials/first-analysis.html">
 <span class="dropdown-text">Your First Analysis</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-workflows" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Workflows</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-workflows">    
        <li>
    <a class="dropdown-item" href="../workflows/implementing-pca.html">
 <span class="dropdown-text">Implementing PCA</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../workflows/implementing-cca.html">
 <span class="dropdown-text">Implementing CCA</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../workflows/cross-platform.html">
 <span class="dropdown-text">Cross-Platform Workflows</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-developing-methods" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Developing Methods</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-developing-methods">    
        <li>
    <a class="dropdown-item" href="../developing-methods/cca-r-implementation.html">
 <span class="dropdown-text">CCA in R</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../developing-methods/cca-cpp-implementation.html">
 <span class="dropdown-text">CCA in C++</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-api-reference" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">API Reference</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-api-reference">    
        <li>
    <a class="dropdown-item" href="../api-reference/r/index.html">
 <span class="dropdown-text">R Functions</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../api-reference/cpp/index.html">
 <span class="dropdown-text">C++ API</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../technical/performance.html"> 
<span class="menu-text">Technical</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/isglobal-brge/BigDataStatMeth"> <i class="bi bi-github" role="img" aria-label="GitHub">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://cran.r-project.org/package=BigDataStatMeth"> 
<span class="menu-text">CRAN</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../developing-methods/cca-r-implementation.html">Building New Methods</a></li><li class="breadcrumb-item"><a href="../developing-methods/cca-cpp-implementation.html">CCA Implementation in C++</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="../index.html" class="sidebar-logo-link">
      </a>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Building New Methods</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../developing-methods/cca-r-implementation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">CCA Implementation in R</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../developing-methods/cca-cpp-implementation.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">CCA Implementation in C++</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview"><span class="header-section-number">1</span> Overview</a>
  <ul class="collapse">
  <li><a href="#what-youll-learn" id="toc-what-youll-learn" class="nav-link" data-scroll-target="#what-youll-learn"><span class="header-section-number">1.1</span> What You’ll Learn</a></li>
  </ul></li>
  <li><a href="#why-c-implementation" id="toc-why-c-implementation" class="nav-link" data-scroll-target="#why-c-implementation"><span class="header-section-number">2</span> Why C++ Implementation?</a>
  <ul class="collapse">
  <li><a href="#when-c-makes-sense" id="toc-when-c-makes-sense" class="nav-link" data-scroll-target="#when-c-makes-sense"><span class="header-section-number">2.1</span> When C++ Makes Sense</a></li>
  <li><a href="#when-r-suffices" id="toc-when-r-suffices" class="nav-link" data-scroll-target="#when-r-suffices"><span class="header-section-number">2.2</span> When R Suffices</a></li>
  </ul></li>
  <li><a href="#c-prerequisites" id="toc-c-prerequisites" class="nav-link" data-scroll-target="#c-prerequisites"><span class="header-section-number">3</span> C++ Prerequisites</a>
  <ul class="collapse">
  <li><a href="#required-headers" id="toc-required-headers" class="nav-link" data-scroll-target="#required-headers"><span class="header-section-number">3.1</span> Required Headers</a></li>
  <li><a href="#understanding-hdf5dataset-class" id="toc-understanding-hdf5dataset-class" class="nav-link" data-scroll-target="#understanding-hdf5dataset-class"><span class="header-section-number">3.2</span> Understanding hdf5Dataset Class</a></li>
  </ul></li>
  <li><a href="#mathematical-foundation-reference" id="toc-mathematical-foundation-reference" class="nav-link" data-scroll-target="#mathematical-foundation-reference"><span class="header-section-number">4</span> Mathematical Foundation (Reference)</a></li>
  <li><a href="#step-1-qr-decomposition-by-blocks-in-c" id="toc-step-1-qr-decomposition-by-blocks-in-c" class="nav-link" data-scroll-target="#step-1-qr-decomposition-by-blocks-in-c"><span class="header-section-number">5</span> Step 1: QR Decomposition by Blocks in C++</a>
  <ul class="collapse">
  <li><a href="#the-getqrbyblocks_rcpp-function" id="toc-the-getqrbyblocks_rcpp-function" class="nav-link" data-scroll-target="#the-getqrbyblocks_rcpp-function"><span class="header-section-number">5.1</span> The getQRbyBlocks_rcpp Function</a></li>
  </ul></li>
  <li><a href="#step-2-main-cca-function-in-c" id="toc-step-2-main-cca-function-in-c" class="nav-link" data-scroll-target="#step-2-main-cca-function-in-c"><span class="header-section-number">6</span> Step 2: Main CCA Function in C++</a>
  <ul class="collapse">
  <li><a href="#the-bdcca_hdf5_rcpp-function" id="toc-the-bdcca_hdf5_rcpp-function" class="nav-link" data-scroll-target="#the-bdcca_hdf5_rcpp-function"><span class="header-section-number">6.1</span> The bdCCA_hdf5_rcpp Function</a></li>
  </ul></li>
  <li><a href="#step-3-computing-canonical-coefficients" id="toc-step-3-computing-canonical-coefficients" class="nav-link" data-scroll-target="#step-3-computing-canonical-coefficients"><span class="header-section-number">7</span> Step 3: Computing Canonical Coefficients</a>
  <ul class="collapse">
  <li><a href="#option-a-call-r-function-from-c" id="toc-option-a-call-r-function-from-c" class="nav-link" data-scroll-target="#option-a-call-r-function-from-c"><span class="header-section-number">7.1</span> Option A: Call R Function from C++</a></li>
  <li><a href="#option-b-full-c-implementation-advanced" id="toc-option-b-full-c-implementation-advanced" class="nav-link" data-scroll-target="#option-b-full-c-implementation-advanced"><span class="header-section-number">7.2</span> Option B: Full C++ Implementation (Advanced)</a></li>
  </ul></li>
  <li><a href="#compiling-and-using" id="toc-compiling-and-using" class="nav-link" data-scroll-target="#compiling-and-using"><span class="header-section-number">8</span> Compiling and Using</a>
  <ul class="collapse">
  <li><a href="#package-structure" id="toc-package-structure" class="nav-link" data-scroll-target="#package-structure"><span class="header-section-number">8.1</span> Package Structure</a></li>
  <li><a href="#the-header-file-bdcca.h" id="toc-the-header-file-bdcca.h" class="nav-link" data-scroll-target="#the-header-file-bdcca.h"><span class="header-section-number">8.2</span> The Header File (bdCCA.h)</a></li>
  <li><a href="#compile-with-rcpp" id="toc-compile-with-rcpp" class="nav-link" data-scroll-target="#compile-with-rcpp"><span class="header-section-number">8.3</span> Compile with Rcpp</a></li>
  </ul></li>
  <li><a href="#example-usage-r-vs-c" id="toc-example-usage-r-vs-c" class="nav-link" data-scroll-target="#example-usage-r-vs-c"><span class="header-section-number">9</span> Example Usage: R vs C++</a>
  <ul class="collapse">
  <li><a href="#side-by-side-comparison" id="toc-side-by-side-comparison" class="nav-link" data-scroll-target="#side-by-side-comparison"><span class="header-section-number">9.1</span> Side-by-Side Comparison</a></li>
  </ul></li>
  <li><a href="#interactive-exercise" id="toc-interactive-exercise" class="nav-link" data-scroll-target="#interactive-exercise"><span class="header-section-number">10</span> Interactive Exercise</a>
  <ul class="collapse">
  <li><a href="#practice-optimizing-c-implementation" id="toc-practice-optimizing-c-implementation" class="nav-link" data-scroll-target="#practice-optimizing-c-implementation"><span class="header-section-number">10.1</span> Practice: Optimizing C++ Implementation</a></li>
  </ul></li>
  <li><a href="#key-takeaways" id="toc-key-takeaways" class="nav-link" data-scroll-target="#key-takeaways"><span class="header-section-number">11</span> Key Takeaways</a>
  <ul class="collapse">
  <li><a href="#essential-concepts" id="toc-essential-concepts" class="nav-link" data-scroll-target="#essential-concepts"><span class="header-section-number">11.1</span> Essential Concepts</a></li>
  <li><a href="#when-to-use-c-vs-r" id="toc-when-to-use-c-vs-r" class="nav-link" data-scroll-target="#when-to-use-c-vs-r"><span class="header-section-number">11.2</span> When to Use C++ vs R</a></li>
  </ul></li>
  <li><a href="#next-steps" id="toc-next-steps" class="nav-link" data-scroll-target="#next-steps"><span class="header-section-number">12</span> Next Steps</a></li>
  <li><a href="#cleanup" id="toc-cleanup" class="nav-link" data-scroll-target="#cleanup"><span class="header-section-number">13</span> Cleanup</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/isglobal-brge/BigDataStatMeth/edit/main/developing-methods/cca-cpp-implementation.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/isglobal-brge/BigDataStatMeth/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">


<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../developing-methods/cca-r-implementation.html">Building New Methods</a></li><li class="breadcrumb-item"><a href="../developing-methods/cca-cpp-implementation.html">CCA Implementation in C++</a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">CCA Implementation in C++</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
<p class="subtitle lead">Building Canonical Correlation Analysis Using BigDataStatMeth C++ API</p>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="overview" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="overview"><span class="header-section-number">1</span> Overview</h2>
<p>This document shows how to implement Canonical Correlation Analysis (CCA) in C++ using BigDataStatMeth’s header-only library. While the <a href="../developing-methods/cca-r-implementation.html">R implementation</a> demonstrated the algorithm using R’s BigDataStatMeth functions, this C++ version provides direct control over computation, memory management, and performance optimization.</p>
<p>The C++ implementation isn’t just a faster version of the R code—it’s designed for scenarios where performance is critical, where you need fine-grained control over algorithms, or where you’re building production systems. You’ll see how to work with HDF5 datasets directly in C++, manage memory safely with pointers, handle errors robustly, and integrate everything back into R through Rcpp.</p>
<section id="what-youll-learn" class="level3 learning-objectives" data-number="1.1">
<h3 data-number="1.1" class="anchored" data-anchor-id="what-youll-learn"><span class="header-section-number">1.1</span> What You’ll Learn</h3>
<p>By the end of this document, you will:</p>
<ul>
<li>Work with BigDataStatMeth’s C++ header-only library</li>
<li>Manage HDF5 datasets using the hdf5Dataset class</li>
<li>Implement block-wise QR decomposition in C++</li>
<li>Handle pointers and memory management safely</li>
<li>Use exception handling to prevent crashes</li>
<li>Integrate C++ functions with R through Rcpp</li>
<li>Compile and test C++ implementations</li>
<li>Decide when C++ optimization is worth the effort</li>
</ul>
</section>
<hr>
</section>
<section id="why-c-implementation" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="why-c-implementation"><span class="header-section-number">2</span> Why C++ Implementation?</h2>
<section id="when-c-makes-sense" class="level3" data-number="2.1">
<h3 data-number="2.1" class="anchored" data-anchor-id="when-c-makes-sense"><span class="header-section-number">2.1</span> When C++ Makes Sense</h3>
<p><strong>Performance-critical applications:</strong> If you run CCA hundreds or thousands of times (production pipelines, simulation studies), C++ performance gains accumulate significantly. A 50% speedup doesn’t matter for one-off analyses but saves days in large studies.</p>
<p><strong>Custom algorithms:</strong> If you’re implementing novel CCA variants (sparse, regularized, kernel) not available in BigDataStatMeth’s R functions, C++ gives you algorithmic control. You’re not constrained to pre-built operations.</p>
<p><strong>Production deployment:</strong> Software going into production systems benefits from C++’s speed and static typing. Compile-time errors prevent runtime failures that could break pipelines.</p>
<p><strong>Fine-grained parallelization:</strong> C++ with OpenMP enables parallelizing within matrix operations, not just across function calls. This achieves better speedups for large-scale computations.</p>
</section>
<section id="when-r-suffices" class="level3" data-number="2.2">
<h3 data-number="2.2" class="anchored" data-anchor-id="when-r-suffices"><span class="header-section-number">2.2</span> When R Suffices</h3>
<p><strong>Prototyping and development:</strong> Algorithm design in R is faster—run line-by-line, inspect variables, iterate quickly. Get it working in R, then optimize in C++ if needed.</p>
<p><strong>Combining existing functions:</strong> If your method uses <code>bdSVD_hdf5()</code>, <code>bdCrossprod_hdf5()</code>, etc., R orchestration is fine. The heavy lifting happens in compiled code anyway.</p>
<p><strong>Occasional use:</strong> Running CCA once per month? R performance is adequate. Save development time for frequently-used methods.</p>
<p>The R implementation showed you CCA’s algorithm structure. This C++ version shows you how to optimize when performance matters.</p>
<hr>
</section>
</section>
<section id="c-prerequisites" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="c-prerequisites"><span class="header-section-number">3</span> C++ Prerequisites</h2>
<section id="required-headers" class="level3" data-number="3.1">
<h3 data-number="3.1" class="anchored" data-anchor-id="required-headers"><span class="header-section-number">3.1</span> Required Headers</h3>
<p>BigDataStatMeth provides a header-only C++ library—include the main header and you have access to all classes and functions:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rcpp.h&gt;</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">"BigDataStatMeth.hpp"</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> Rcpp<span class="op">;</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> BigDataStatMeth<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>The <code>Rcpp.h</code> header enables integration with R. The <code>BigDataStatMeth.hpp</code> header provides: - <code>hdf5Dataset</code> class for HDF5 I/O - Matrix operation functions (crossprod, SVD, QR, etc.) - Utility functions for block-wise processing</p>
</section>
<section id="understanding-hdf5dataset-class" class="level3" data-number="3.2">
<h3 data-number="3.2" class="anchored" data-anchor-id="understanding-hdf5dataset-class"><span class="header-section-number">3.2</span> Understanding hdf5Dataset Class</h3>
<p>The <code>hdf5Dataset</code> class is your interface to HDF5 files in C++:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Constructor</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>hdf5Dataset<span class="op">*</span> ds <span class="op">=</span> <span class="kw">new</span> hdf5Dataset<span class="op">(</span>filename<span class="op">,</span> group<span class="op">,</span> dataset<span class="op">,</span> create_new<span class="op">);</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Open for reading/writing</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>ds<span class="op">-&gt;</span>openDataset<span class="op">();</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Get dimensions</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> nrows <span class="op">=</span> ds<span class="op">-&gt;</span>nrows<span class="op">();</span>      <span class="co">// Total rows</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> ncols <span class="op">=</span> ds<span class="op">-&gt;</span>ncols<span class="op">();</span>      <span class="co">// Total columns</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> nrows_r <span class="op">=</span> ds<span class="op">-&gt;</span>nrows_r<span class="op">();</span>  <span class="co">// Rows (R indexing)</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> ncols_r <span class="op">=</span> ds<span class="op">-&gt;</span>ncols_r<span class="op">();</span>  <span class="co">// Columns (R indexing)</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="co">// Read data block</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> data<span class="op">(</span>nrows <span class="op">*</span> ncols<span class="op">);</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">hsize_t</span><span class="op">&gt;</span> offset <span class="op">=</span> <span class="op">{</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">};</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">hsize_t</span><span class="op">&gt;</span> count <span class="op">=</span> <span class="op">{</span>nrows<span class="op">,</span> ncols<span class="op">};</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">hsize_t</span><span class="op">&gt;</span> stride <span class="op">=</span> <span class="op">{</span><span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">};</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">hsize_t</span><span class="op">&gt;</span> block <span class="op">=</span> <span class="op">{</span><span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">};</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>ds<span class="op">-&gt;</span>readDatasetBlock<span class="op">(</span>offset<span class="op">,</span> count<span class="op">,</span> stride<span class="op">,</span> block<span class="op">,</span> data<span class="op">.</span>data<span class="op">());</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="co">// Write data block</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>ds<span class="op">-&gt;</span>writeDatasetBlock<span class="op">(</span>offset<span class="op">,</span> count<span class="op">,</span> stride<span class="op">,</span> block<span class="op">,</span> data<span class="op">.</span>data<span class="op">());</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a><span class="co">// Cleanup</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="kw">delete</span> ds<span class="op">;</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>ds <span class="op">=</span> <span class="kw">nullptr</span><span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong>Key points:</strong> - Always <code>openDataset()</code> before reading/writing - Always <code>delete</code> and set to <code>nullptr</code> when done - Use <code>try/catch</code> to handle errors safely</p>
<hr>
</section>
</section>
<section id="mathematical-foundation-reference" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="mathematical-foundation-reference"><span class="header-section-number">4</span> Mathematical Foundation (Reference)</h2>
<p>The mathematical foundations of CCA are detailed in the <a href="../developing-methods/cca-r-implementation.html#cca-algorithm-overview">R implementation document</a>. Here’s a quick summary:</p>
<p><strong>CCA algorithm:</strong> 1. QR decomposition: <span class="math inline">X = Q_X R_X</span>, <span class="math inline">Y = Q_Y R_Y</span> 2. Cross-product: <span class="math inline">M = Q_X^T Q_Y</span> 3. SVD: <span class="math inline">M = U D V^T</span> (D contains canonical correlations) 4. Coefficients: <span class="math inline">\alpha = R_X^{-1} U</span>, <span class="math inline">\beta = R_Y^{-1} V</span> 5. Variates: <span class="math inline">s_X = X\alpha</span>, <span class="math inline">s_Y = Y\beta</span></p>
<p>The C++ implementation follows the same mathematical steps but with manual memory management and direct HDF5 access.</p>
<hr>
</section>
<section id="step-1-qr-decomposition-by-blocks-in-c" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="step-1-qr-decomposition-by-blocks-in-c"><span class="header-section-number">5</span> Step 1: QR Decomposition by Blocks in C++</h2>
<section id="the-getqrbyblocks_rcpp-function" class="level3" data-number="5.1">
<h3 data-number="5.1" class="anchored" data-anchor-id="the-getqrbyblocks_rcpp-function"><span class="header-section-number">5.1</span> The getQRbyBlocks_rcpp Function</h3>
<p>This function computes QR decomposition of a matrix in HDF5 by processing blocks. It mirrors the R version but with C++ memory management:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> getQRbyBlocks_rcpp<span class="op">(</span>hdf5Dataset <span class="op">*</span>dsA<span class="op">,</span> <span class="dt">int</span> mblocks<span class="op">,</span> </span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>                        <span class="dt">bool</span> bcenter<span class="op">,</span> <span class="dt">bool</span> bscale<span class="op">,</span> </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>                        <span class="dt">bool</span> byrows<span class="op">,</span> <span class="dt">bool</span> overwrite<span class="op">,</span> </span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>                        Rcpp<span class="op">::</span>Nullable<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> threads<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    hdf5Dataset<span class="op">*</span> dstmp <span class="op">=</span> <span class="kw">nullptr</span><span class="op">;</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>string strInPath<span class="op">,</span> strOutPath<span class="op">;</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>        <span class="dt">bool</span> btransp_dataset <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>        <span class="dt">bool</span> btransp_bdataset <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>        <span class="dt">bool</span> bfullMatrix <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>        <span class="dt">bool</span> bycols <span class="op">=</span> <span class="op">!</span>byrows<span class="op">;</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>string strdataset <span class="op">=</span> dsA<span class="op">-&gt;</span>getDatasetName<span class="op">();</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Step 1: Normalize the dataset</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>        <span class="co">// This ensures numerical stability during QR decomposition</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>        RcppNormalizeHdf5<span class="op">(</span>dsA<span class="op">,</span> bcenter<span class="op">,</span> bscale<span class="op">,</span> byrows<span class="op">);</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Step 2: Open normalized dataset</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>        dstmp <span class="op">=</span> <span class="kw">new</span> hdf5Dataset<span class="op">(</span>dsA<span class="op">-&gt;</span>getFileName<span class="op">(),</span> </span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>                               <span class="st">"NORMALIZED/"</span> <span class="op">+</span> dsA<span class="op">-&gt;</span>getGroupName<span class="op">(),</span> </span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>                               strdataset<span class="op">,</span> <span class="kw">false</span><span class="op">);</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>        dstmp<span class="op">-&gt;</span>openDataset<span class="op">();</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Step 3: Split matrix into mblocks</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Each block will be processed independently</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>        strOutPath <span class="op">=</span> <span class="st">"Step1/"</span> <span class="op">+</span> strdataset <span class="op">+</span> <span class="st">"rows"</span><span class="op">;</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>        RcppSplit_matrix_hdf5_internal<span class="op">(</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>            dstmp<span class="op">,</span> strOutPath<span class="op">,</span> strdataset<span class="op">,</span> bycols<span class="op">,</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>            mblocks<span class="op">,</span> <span class="op">-</span><span class="dv">1</span><span class="op">,</span> dstmp<span class="op">-&gt;</span>nrows<span class="op">(),</span> dstmp<span class="op">-&gt;</span>ncols<span class="op">()</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>        <span class="kw">delete</span> dstmp<span class="op">;</span> </span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>        dstmp <span class="op">=</span> <span class="kw">nullptr</span><span class="op">;</span>    </span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Step 4: Apply QR to each block</span></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>        StringVector blocks <span class="op">=</span> dsA<span class="op">-&gt;</span>getDatasetNames<span class="op">(</span>strOutPath<span class="op">,</span> <span class="st">""</span><span class="op">,</span> <span class="st">""</span><span class="op">);</span></span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>        strInPath <span class="op">=</span> strOutPath<span class="op">;</span></span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>        strOutPath <span class="op">=</span> <span class="st">"Step2/"</span> <span class="op">+</span> strdataset <span class="op">+</span> <span class="st">"rows"</span><span class="op">;</span></span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>        RcppApplyFunctionHdf5<span class="op">(</span></span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>            dsA<span class="op">-&gt;</span>getFileName<span class="op">(),</span> strInPath<span class="op">,</span> blocks<span class="op">,</span> strOutPath<span class="op">,</span> <span class="st">"QR"</span><span class="op">,</span></span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>            R_NilValue<span class="op">,</span> R_NilValue<span class="op">,</span> wrap<span class="op">(</span>overwrite<span class="op">),</span> </span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>            wrap<span class="op">(</span>btransp_dataset<span class="op">),</span> wrap<span class="op">(</span>btransp_bdataset<span class="op">),</span> </span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>            wrap<span class="op">(</span>bfullMatrix<span class="op">),</span> wrap<span class="op">(</span>byrows<span class="op">),</span> threads</span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Step 5: Merge all R matrices from block QRs</span></span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>        StringVector blocks_qr <span class="op">=</span> dsA<span class="op">-&gt;</span>getDatasetNames<span class="op">(</span>strOutPath<span class="op">,</span> </span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>                                                       strdataset<span class="op">,</span> <span class="st">".R"</span><span class="op">);</span></span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>        strInPath <span class="op">=</span> strOutPath<span class="op">;</span></span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>        strOutPath <span class="op">=</span> <span class="st">"Step3/merged"</span><span class="op">;</span></span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>        RcppBind_datasets_hdf5<span class="op">(</span></span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>            dsA<span class="op">-&gt;</span>getFileName<span class="op">(),</span> strInPath<span class="op">,</span> blocks_qr<span class="op">,</span></span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>            strOutPath<span class="op">,</span> strdataset <span class="op">+</span> <span class="st">"Rt"</span><span class="op">,</span> <span class="st">"bindRows"</span><span class="op">,</span> </span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a>            <span class="kw">false</span><span class="op">,</span> wrap<span class="op">(</span>overwrite<span class="op">)</span></span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Step 6: Final QR on merged R matrix</span></span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>        <span class="co">// This gives us the overall R matrix for the full dataset</span></span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a>        strInPath <span class="op">=</span> strOutPath<span class="op">;</span></span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a>        strOutPath <span class="op">=</span> <span class="st">"Step3/Final_QR"</span><span class="op">;</span></span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a>        RcppApplyFunctionHdf5<span class="op">(</span></span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a>            dsA<span class="op">-&gt;</span>getFileName<span class="op">(),</span> strInPath<span class="op">,</span> strdataset <span class="op">+</span> <span class="st">"Rt"</span><span class="op">,</span> </span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a>            strOutPath<span class="op">,</span> <span class="st">"QR"</span><span class="op">,</span></span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a>            R_NilValue<span class="op">,</span> R_NilValue<span class="op">,</span> wrap<span class="op">(</span>overwrite<span class="op">),</span> </span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a>            wrap<span class="op">(</span>btransp_dataset<span class="op">),</span> wrap<span class="op">(</span>btransp_bdataset<span class="op">),</span> </span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a>            wrap<span class="op">(</span>bfullMatrix<span class="op">),</span> wrap<span class="op">(</span>byrows<span class="op">),</span> threads</span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Step 7: Split final Q matrix</span></span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a>        strInPath <span class="op">=</span> strOutPath<span class="op">;</span></span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a>        strOutPath <span class="op">=</span> <span class="st">"Step4/splitted"</span><span class="op">;</span></span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a>        dstmp <span class="op">=</span> <span class="kw">new</span> hdf5Dataset<span class="op">(</span>dsA<span class="op">-&gt;</span>getFileName<span class="op">(),</span> strInPath<span class="op">,</span> </span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a>                               strdataset <span class="op">+</span> <span class="st">"Rt.Q"</span><span class="op">,</span> <span class="kw">false</span><span class="op">);</span></span>
<span id="cb3-84"><a href="#cb3-84" aria-hidden="true" tabindex="-1"></a>        dstmp<span class="op">-&gt;</span>openDataset<span class="op">();</span></span>
<span id="cb3-85"><a href="#cb3-85" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-86"><a href="#cb3-86" aria-hidden="true" tabindex="-1"></a>        RcppSplit_matrix_hdf5_internal<span class="op">(</span></span>
<span id="cb3-87"><a href="#cb3-87" aria-hidden="true" tabindex="-1"></a>            dstmp<span class="op">,</span> strOutPath<span class="op">,</span> strdataset <span class="op">+</span> <span class="st">"Rt.Q"</span><span class="op">,</span> bycols<span class="op">,</span></span>
<span id="cb3-88"><a href="#cb3-88" aria-hidden="true" tabindex="-1"></a>            mblocks<span class="op">,</span> <span class="op">-</span><span class="dv">1</span><span class="op">,</span> dstmp<span class="op">-&gt;</span>nrows<span class="op">(),</span> dstmp<span class="op">-&gt;</span>ncols<span class="op">()</span></span>
<span id="cb3-89"><a href="#cb3-89" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb3-90"><a href="#cb3-90" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-91"><a href="#cb3-91" aria-hidden="true" tabindex="-1"></a>        <span class="kw">delete</span> dstmp<span class="op">;</span> </span>
<span id="cb3-92"><a href="#cb3-92" aria-hidden="true" tabindex="-1"></a>        dstmp <span class="op">=</span> <span class="kw">nullptr</span><span class="op">;</span> </span>
<span id="cb3-93"><a href="#cb3-93" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-94"><a href="#cb3-94" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Step 8: Multiply original Q blocks by final Q blocks</span></span>
<span id="cb3-95"><a href="#cb3-95" aria-hidden="true" tabindex="-1"></a>        <span class="co">// This reconstructs the full Q matrix in blocks</span></span>
<span id="cb3-96"><a href="#cb3-96" aria-hidden="true" tabindex="-1"></a>        strInPath <span class="op">=</span> <span class="st">"Step2/"</span> <span class="op">+</span> strdataset <span class="op">+</span> <span class="st">"rows"</span><span class="op">;</span></span>
<span id="cb3-97"><a href="#cb3-97" aria-hidden="true" tabindex="-1"></a>        strOutPath <span class="op">=</span> <span class="st">"Step5"</span><span class="op">;</span></span>
<span id="cb3-98"><a href="#cb3-98" aria-hidden="true" tabindex="-1"></a>        CharacterVector b_group <span class="op">=</span> <span class="st">"Step4/splitted"</span><span class="op">;</span></span>
<span id="cb3-99"><a href="#cb3-99" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-100"><a href="#cb3-100" aria-hidden="true" tabindex="-1"></a>        blocks_qr <span class="op">=</span> dsA<span class="op">-&gt;</span>getDatasetNames<span class="op">(</span>strInPath<span class="op">,</span> strdataset<span class="op">,</span> <span class="st">".Q"</span><span class="op">);</span></span>
<span id="cb3-101"><a href="#cb3-101" aria-hidden="true" tabindex="-1"></a>        StringVector b_blocks <span class="op">=</span> dsA<span class="op">-&gt;</span>getDatasetNames<span class="op">(</span><span class="st">"Step4/splitted"</span><span class="op">,</span> </span>
<span id="cb3-102"><a href="#cb3-102" aria-hidden="true" tabindex="-1"></a>                                                      strdataset <span class="op">+</span> <span class="st">"Rt.Q"</span><span class="op">,</span> <span class="st">""</span><span class="op">);</span></span>
<span id="cb3-103"><a href="#cb3-103" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-104"><a href="#cb3-104" aria-hidden="true" tabindex="-1"></a>        RcppApplyFunctionHdf5<span class="op">(</span></span>
<span id="cb3-105"><a href="#cb3-105" aria-hidden="true" tabindex="-1"></a>            dsA<span class="op">-&gt;</span>getFileName<span class="op">(),</span> strInPath<span class="op">,</span> blocks_qr<span class="op">,</span> strOutPath<span class="op">,</span> </span>
<span id="cb3-106"><a href="#cb3-106" aria-hidden="true" tabindex="-1"></a>            <span class="st">"blockmult"</span><span class="op">,</span></span>
<span id="cb3-107"><a href="#cb3-107" aria-hidden="true" tabindex="-1"></a>            b_group<span class="op">,</span> b_blocks<span class="op">,</span> wrap<span class="op">(</span>overwrite<span class="op">),</span> </span>
<span id="cb3-108"><a href="#cb3-108" aria-hidden="true" tabindex="-1"></a>            wrap<span class="op">(</span>btransp_dataset<span class="op">),</span> wrap<span class="op">(</span>btransp_bdataset<span class="op">),</span> </span>
<span id="cb3-109"><a href="#cb3-109" aria-hidden="true" tabindex="-1"></a>            wrap<span class="op">(</span>bfullMatrix<span class="op">),</span> wrap<span class="op">(</span>byrows<span class="op">),</span> threads</span>
<span id="cb3-110"><a href="#cb3-110" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb3-111"><a href="#cb3-111" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-112"><a href="#cb3-112" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Step 9: Bind all Q blocks into final Q matrix</span></span>
<span id="cb3-113"><a href="#cb3-113" aria-hidden="true" tabindex="-1"></a>        strInPath <span class="op">=</span> strOutPath<span class="op">;</span> </span>
<span id="cb3-114"><a href="#cb3-114" aria-hidden="true" tabindex="-1"></a>        strOutPath <span class="op">=</span> <span class="st">"Step6"</span><span class="op">;</span></span>
<span id="cb3-115"><a href="#cb3-115" aria-hidden="true" tabindex="-1"></a>        blocks <span class="op">=</span> dsA<span class="op">-&gt;</span>getDatasetNames<span class="op">(</span>strInPath<span class="op">,</span> strdataset <span class="op">+</span> <span class="st">"."</span><span class="op">,</span> <span class="st">""</span><span class="op">);</span></span>
<span id="cb3-116"><a href="#cb3-116" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-117"><a href="#cb3-117" aria-hidden="true" tabindex="-1"></a>        RcppBind_datasets_hdf5<span class="op">(</span></span>
<span id="cb3-118"><a href="#cb3-118" aria-hidden="true" tabindex="-1"></a>            dsA<span class="op">-&gt;</span>getFileName<span class="op">(),</span> strInPath<span class="op">,</span> blocks<span class="op">,</span></span>
<span id="cb3-119"><a href="#cb3-119" aria-hidden="true" tabindex="-1"></a>            strOutPath<span class="op">,</span> strdataset <span class="op">+</span> <span class="st">"Q"</span><span class="op">,</span> <span class="st">"bindRows"</span><span class="op">,</span> </span>
<span id="cb3-120"><a href="#cb3-120" aria-hidden="true" tabindex="-1"></a>            <span class="kw">false</span><span class="op">,</span> wrap<span class="op">(</span>overwrite<span class="op">)</span></span>
<span id="cb3-121"><a href="#cb3-121" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb3-122"><a href="#cb3-122" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-123"><a href="#cb3-123" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">catch</span><span class="op">(</span><span class="bu">std::</span>exception<span class="op">&amp;</span> ex<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-124"><a href="#cb3-124" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Critical: always cleanup on error</span></span>
<span id="cb3-125"><a href="#cb3-125" aria-hidden="true" tabindex="-1"></a>        checkClose_file<span class="op">(</span>dsA<span class="op">,</span> dstmp<span class="op">);</span></span>
<span id="cb3-126"><a href="#cb3-126" aria-hidden="true" tabindex="-1"></a>        Rcpp<span class="op">::</span>Rcout <span class="op">&lt;&lt;</span> <span class="st">"C++ exception getQRbyBlocks_rcpp: "</span> </span>
<span id="cb3-127"><a href="#cb3-127" aria-hidden="true" tabindex="-1"></a>                    <span class="op">&lt;&lt;</span> ex<span class="op">.</span>what<span class="op">()</span> <span class="op">&lt;&lt;</span> <span class="st">"</span><span class="sc">\n</span><span class="st">"</span><span class="op">;</span></span>
<span id="cb3-128"><a href="#cb3-128" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dt">void</span><span class="op">();</span></span>
<span id="cb3-129"><a href="#cb3-129" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-130"><a href="#cb3-130" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-131"><a href="#cb3-131" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dt">void</span><span class="op">();</span></span>
<span id="cb3-132"><a href="#cb3-132" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong>Key differences from R:</strong></p>
<ol type="1">
<li><strong>Pointer management:</strong> <code>dstmp</code> allocated with <code>new</code>, must be deleted</li>
<li><strong>Exception handling:</strong> <code>try/catch</code> prevents crashes, ensures cleanup</li>
<li><strong>Explicit types:</strong> <code>std::string</code>, <code>bool</code>, <code>int</code> declared explicitly</li>
<li><strong>Null checking:</strong> Set to <code>nullptr</code> after deletion to prevent double-free</li>
</ol>
<p>The algorithm is identical to R, but memory safety requires careful management.</p>
<hr>
</section>
</section>
<section id="step-2-main-cca-function-in-c" class="level2" data-number="6">
<h2 data-number="6" class="anchored" data-anchor-id="step-2-main-cca-function-in-c"><span class="header-section-number">6</span> Step 2: Main CCA Function in C++</h2>
<section id="the-bdcca_hdf5_rcpp-function" class="level3" data-number="6.1">
<h3 data-number="6.1" class="anchored" data-anchor-id="the-bdcca_hdf5_rcpp-function"><span class="header-section-number">6.1</span> The bdCCA_hdf5_rcpp Function</h3>
<p>This is the main entry point, orchestrating the full CCA computation:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> bdCCA_hdf5_rcpp<span class="op">(</span><span class="bu">std::</span>string filename<span class="op">,</span> </span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>                     <span class="bu">std::</span>string datasetX<span class="op">,</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>                     <span class="bu">std::</span>string datasetY<span class="op">,</span> </span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>                     <span class="dt">bool</span> bcenter<span class="op">,</span> <span class="dt">bool</span> bscale<span class="op">,</span> </span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>                     <span class="dt">int</span> mblocks<span class="op">,</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>                     <span class="dt">bool</span> overwrite<span class="op">,</span> </span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>                     Rcpp<span class="op">::</span>Nullable<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> threads <span class="op">=</span> R_NilValue<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Declare all pointers at function start</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// This ensures they're in scope for cleanup</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    hdf5Dataset<span class="op">*</span> dsX <span class="op">=</span> <span class="kw">nullptr</span><span class="op">;</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    hdf5Dataset<span class="op">*</span> dsY <span class="op">=</span> <span class="kw">nullptr</span><span class="op">;</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    hdf5Dataset<span class="op">*</span> dsXQ <span class="op">=</span> <span class="kw">nullptr</span><span class="op">;</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    hdf5Dataset<span class="op">*</span> dsYQ <span class="op">=</span> <span class="kw">nullptr</span><span class="op">;</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    hdf5Dataset<span class="op">*</span> dsC <span class="op">=</span> <span class="kw">nullptr</span><span class="op">;</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> ncolsX<span class="op">,</span> ncolsY<span class="op">;</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Step 1: Open X dataset and compute QR</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>        dsX <span class="op">=</span> <span class="kw">new</span> hdf5Dataset<span class="op">(</span>filename<span class="op">,</span> datasetX<span class="op">,</span> <span class="kw">false</span><span class="op">);</span> </span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>        dsX<span class="op">-&gt;</span>openDataset<span class="op">();</span> </span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>        getQRbyBlocks_rcpp<span class="op">(</span>dsX<span class="op">,</span> mblocks<span class="op">,</span> bcenter<span class="op">,</span> bscale<span class="op">,</span> </span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>                          <span class="kw">false</span><span class="op">,</span> overwrite<span class="op">,</span> threads<span class="op">);</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Step 2: Open Y dataset and compute QR</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>        dsY <span class="op">=</span> <span class="kw">new</span> hdf5Dataset<span class="op">(</span>filename<span class="op">,</span> datasetY<span class="op">,</span> <span class="kw">false</span><span class="op">);</span> </span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>        dsY<span class="op">-&gt;</span>openDataset<span class="op">();</span> </span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>        getQRbyBlocks_rcpp<span class="op">(</span>dsY<span class="op">,</span> mblocks<span class="op">,</span> bcenter<span class="op">,</span> bscale<span class="op">,</span> </span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>                          <span class="kw">false</span><span class="op">,</span> overwrite<span class="op">,</span> threads<span class="op">);</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Step 3: Open Q matrices from QR results</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>        dsXQ <span class="op">=</span> <span class="kw">new</span> hdf5Dataset<span class="op">(</span>filename<span class="op">,</span> <span class="st">"Step6"</span><span class="op">,</span> <span class="st">"XQ"</span><span class="op">,</span> <span class="kw">false</span><span class="op">);</span> </span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>        dsXQ<span class="op">-&gt;</span>openDataset<span class="op">();</span> </span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>        dsYQ <span class="op">=</span> <span class="kw">new</span> hdf5Dataset<span class="op">(</span>filename<span class="op">,</span> <span class="st">"Step6"</span><span class="op">,</span> <span class="st">"YQ"</span><span class="op">,</span> <span class="kw">false</span><span class="op">);</span> </span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>        dsYQ<span class="op">-&gt;</span>openDataset<span class="op">();</span> </span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Step 4: Compute cross-product of Q matrices</span></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>        <span class="co">// This creates the canonical space</span></span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>        dsC <span class="op">=</span> <span class="kw">new</span> hdf5Dataset<span class="op">(</span>filename<span class="op">,</span> <span class="st">"Step7"</span><span class="op">,</span> <span class="st">"CrossProd_XQ_YQ"</span><span class="op">,</span> overwrite<span class="op">);</span></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> optimBlock <span class="op">=</span> getMaxBlockSize<span class="op">(</span></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>            dsXQ<span class="op">-&gt;</span>nrows<span class="op">(),</span> dsXQ<span class="op">-&gt;</span>ncols<span class="op">(),</span> </span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>            dsYQ<span class="op">-&gt;</span>nrows<span class="op">(),</span> dsYQ<span class="op">-&gt;</span>ncols<span class="op">(),</span> </span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>            <span class="dv">2</span><span class="op">,</span> R_NilValue</span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>        dsC <span class="op">=</span> BigDataStatMeth<span class="op">::</span>crossprod<span class="op">(</span></span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>            dsXQ<span class="op">,</span> dsYQ<span class="op">,</span> dsC<span class="op">,</span> </span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>            optimBlock<span class="op">,</span> optimBlock<span class="op">/</span><span class="dv">2</span><span class="op">,</span> </span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>            <span class="kw">true</span><span class="op">,</span> <span class="kw">true</span><span class="op">,</span> threads</span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Step 5: Cleanup Q matrix pointers (no longer needed)</span></span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>        <span class="kw">delete</span> dsXQ<span class="op">;</span> dsXQ <span class="op">=</span> <span class="kw">nullptr</span><span class="op">;</span></span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>        <span class="kw">delete</span> dsYQ<span class="op">;</span> dsYQ <span class="op">=</span> <span class="kw">nullptr</span><span class="op">;</span></span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Step 6: Get dimensions for coefficient computation</span></span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a>        ncolsX <span class="op">=</span> dsX<span class="op">-&gt;</span>ncols_r<span class="op">();</span></span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>        ncolsY <span class="op">=</span> dsY<span class="op">-&gt;</span>ncols_r<span class="op">();</span></span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Step 7: Compute SVD of cross-product</span></span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a>        <span class="co">// This extracts canonical correlations</span></span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>        RcppbdSVD_hdf5<span class="op">(</span></span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>            dsC<span class="op">-&gt;</span>getFileName<span class="op">(),</span> dsC<span class="op">-&gt;</span>getGroupName<span class="op">(),</span> </span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a>            dsC<span class="op">-&gt;</span>getDatasetName<span class="op">(),</span>  </span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a>            <span class="dv">16</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span>           <span class="co">// k, q, components</span></span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a>            <span class="kw">false</span><span class="op">,</span> <span class="kw">false</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span>    <span class="co">// bcenter, bscale, blocksize</span></span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a>            overwrite<span class="op">,</span> <span class="kw">false</span><span class="op">,</span>   <span class="co">// overwrite, paral</span></span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a>            R_NilValue<span class="op">,</span> R_NilValue  <span class="co">// threads, method</span></span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Step 8: Cleanup cross-product</span></span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a>        <span class="kw">delete</span> dsC<span class="op">;</span> dsC <span class="op">=</span> <span class="kw">nullptr</span><span class="op">;</span></span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Step 9: Compute canonical coefficients and variates</span></span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a>        writeCCAComponents_hdf5_rcpp<span class="op">(</span>filename<span class="op">,</span> ncolsX<span class="op">,</span> ncolsY<span class="op">);</span></span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Step 10: Final cleanup</span></span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a>        <span class="kw">delete</span> dsX<span class="op">;</span> dsX <span class="op">=</span> <span class="kw">nullptr</span><span class="op">;</span></span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a>        <span class="kw">delete</span> dsY<span class="op">;</span> dsY <span class="op">=</span> <span class="kw">nullptr</span><span class="op">;</span></span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">catch</span><span class="op">(</span><span class="bu">std::</span>exception<span class="op">&amp;</span> ex<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Critical error handling</span></span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Cleanup ALL pointers on any exception</span></span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true" tabindex="-1"></a>        checkClose_file<span class="op">(</span>dsX<span class="op">,</span> dsY<span class="op">,</span> dsXQ<span class="op">,</span> dsYQ<span class="op">,</span> dsC<span class="op">);</span></span>
<span id="cb4-92"><a href="#cb4-92" aria-hidden="true" tabindex="-1"></a>        Rcerr <span class="op">&lt;&lt;</span> <span class="st">"</span><span class="sc">\n</span><span class="st">C++ exception bdCCA_hdf5_rcpp: "</span> </span>
<span id="cb4-93"><a href="#cb4-93" aria-hidden="true" tabindex="-1"></a>              <span class="op">&lt;&lt;</span> ex<span class="op">.</span>what<span class="op">()</span> <span class="op">&lt;&lt;</span> <span class="st">"</span><span class="sc">\n</span><span class="st">"</span><span class="op">;</span></span>
<span id="cb4-94"><a href="#cb4-94" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dt">void</span><span class="op">();</span></span>
<span id="cb4-95"><a href="#cb4-95" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-96"><a href="#cb4-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-97"><a href="#cb4-97" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dt">void</span><span class="op">();</span></span>
<span id="cb4-98"><a href="#cb4-98" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong>Important patterns:</strong></p>
<ol type="1">
<li><strong>Pointer declaration:</strong> All declared at start, initialized to <code>nullptr</code></li>
<li><strong>Sequential cleanup:</strong> Delete after use, set to <code>nullptr</code> immediately<br>
</li>
<li><strong>Exception safety:</strong> <code>try/catch</code> ensures cleanup even on errors</li>
<li><strong>checkClose_file():</strong> Utility function that safely deletes multiple pointers</li>
</ol>
<p>This pattern prevents memory leaks and dangling pointers.</p>
<hr>
</section>
</section>
<section id="step-3-computing-canonical-coefficients" class="level2" data-number="7">
<h2 data-number="7" class="anchored" data-anchor-id="step-3-computing-canonical-coefficients"><span class="header-section-number">7</span> Step 3: Computing Canonical Coefficients</h2>
<section id="option-a-call-r-function-from-c" class="level3" data-number="7.1">
<h3 data-number="7.1" class="anchored" data-anchor-id="option-a-call-r-function-from-c"><span class="header-section-number">7.1</span> Option A: Call R Function from C++</h3>
<p>The simplest approach calls the R implementation for coefficient computation:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> writeCCAComponents_hdf5_rcpp<span class="op">(</span><span class="bu">std::</span>string filename<span class="op">,</span> </span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>                                   <span class="dt">int</span> ncolsX<span class="op">,</span> <span class="dt">int</span> ncolsY<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Access R package environment</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    Rcpp<span class="op">::</span>Environment base<span class="op">(</span><span class="st">"package:BDStatMethExamples"</span><span class="op">);</span> </span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Get R function</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    Rcpp<span class="op">::</span>Function write_components <span class="op">=</span> base<span class="op">[</span><span class="st">"writeCCAComponents_hdf5"</span><span class="op">];</span>    </span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Call R function with named parameters</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    write_components<span class="op">(</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>        Rcpp<span class="op">::</span>_<span class="op">[</span><span class="st">"filename"</span><span class="op">]</span> <span class="op">=</span> wrap<span class="op">(</span>filename<span class="op">),</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>        Rcpp<span class="op">::</span>_<span class="op">[</span><span class="st">"ncolsX"</span><span class="op">]</span>  <span class="op">=</span> ncolsX<span class="op">,</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>        Rcpp<span class="op">::</span>_<span class="op">[</span><span class="st">"ncolsY"</span><span class="op">]</span>  <span class="op">=</span> ncolsY</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">);</span> </span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dt">void</span><span class="op">();</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong>When this makes sense:</strong></p>
<ul>
<li>Coefficient computation isn’t the bottleneck</li>
<li>R implementation is well-tested and working</li>
<li>You want to minimize C++ code complexity</li>
</ul>
<p><strong>Trade-off:</strong> Adds R dependency. For pure C++ deployment, use Option B.</p>
</section>
<section id="option-b-full-c-implementation-advanced" class="level3" data-number="7.2">
<h3 data-number="7.2" class="anchored" data-anchor-id="option-b-full-c-implementation-advanced"><span class="header-section-number">7.2</span> Option B: Full C++ Implementation (Advanced)</h3>
<p>For complete C++ control, implement coefficient computation directly:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> writeCCAComponents_hdf5_full_cpp<span class="op">(</span><span class="bu">std::</span>string filename<span class="op">,</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>                                       <span class="dt">int</span> ncolsX<span class="op">,</span> <span class="dt">int</span> ncolsY<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    hdf5Dataset<span class="op">*</span> dstmpX <span class="op">=</span> <span class="kw">nullptr</span><span class="op">;</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    hdf5Dataset<span class="op">*</span> dstmpY <span class="op">=</span> <span class="kw">nullptr</span><span class="op">;</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">hsize_t</span><span class="op">&gt;</span> stride <span class="op">=</span> <span class="op">{</span><span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">};</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">hsize_t</span><span class="op">&gt;</span> block <span class="op">=</span> <span class="op">{</span><span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">};</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>        <span class="dt">hsize_t</span> ncolsX_h <span class="op">=</span> <span class="kw">static_cast</span><span class="op">&lt;</span><span class="dt">hsize_t</span><span class="op">&gt;(</span>ncolsX<span class="op">);</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>        <span class="dt">hsize_t</span> ncolsY_h <span class="op">=</span> <span class="kw">static_cast</span><span class="op">&lt;</span><span class="dt">hsize_t</span><span class="op">&gt;(</span>ncolsY<span class="op">);</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Allocate memory for Q and R matrices</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> vdXQ<span class="op">(</span>ncolsX <span class="op">*</span> ncolsX<span class="op">);</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> vdYQ<span class="op">(</span>ncolsY <span class="op">*</span> ncolsY<span class="op">);</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> vdXR<span class="op">(</span>ncolsX <span class="op">*</span> ncolsX<span class="op">);</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> vdYR<span class="op">(</span>ncolsY <span class="op">*</span> ncolsY<span class="op">);</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Read X Q matrix</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>        dstmpX <span class="op">=</span> <span class="kw">new</span> hdf5Dataset<span class="op">(</span>filename<span class="op">,</span> <span class="st">"Step6/XQ"</span><span class="op">,</span> <span class="kw">false</span><span class="op">);</span>  </span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>        dstmpX<span class="op">-&gt;</span>openDataset<span class="op">();</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>        dstmpX<span class="op">-&gt;</span>readDatasetBlock<span class="op">(</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>            <span class="op">{</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">},</span> <span class="op">{</span>ncolsX_h<span class="op">,</span> ncolsX_h<span class="op">},</span> </span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>            stride<span class="op">,</span> block<span class="op">,</span> vdXQ<span class="op">.</span>data<span class="op">()</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Map to Eigen matrix for linear algebra</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>        Eigen<span class="op">::</span>MatrixXd XQR <span class="op">=</span> Eigen<span class="op">::</span>Map<span class="op">&lt;</span>Eigen<span class="op">::</span>Matrix<span class="op">&lt;</span><span class="dt">double</span><span class="op">,</span> </span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>                              Eigen<span class="op">::</span>Dynamic<span class="op">,</span> Eigen<span class="op">::</span>Dynamic<span class="op">,</span> </span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>                              Eigen<span class="op">::</span>ColMajor<span class="op">&gt;&gt;(</span>vdXQ<span class="op">.</span>data<span class="op">(),</span> ncolsX<span class="op">,</span> ncolsX<span class="op">);</span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>        <span class="kw">delete</span> dstmpX<span class="op">;</span> dstmpX <span class="op">=</span> <span class="kw">nullptr</span><span class="op">;</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Read Y Q matrix</span></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>        dstmpY <span class="op">=</span> <span class="kw">new</span> hdf5Dataset<span class="op">(</span>filename<span class="op">,</span> <span class="st">"Step6/YQ"</span><span class="op">,</span> <span class="kw">false</span><span class="op">);</span> </span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>        dstmpY<span class="op">-&gt;</span>openDataset<span class="op">();</span></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>        dstmpY<span class="op">-&gt;</span>readDatasetBlock<span class="op">(</span></span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>            <span class="op">{</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">},</span> <span class="op">{</span>ncolsY_h<span class="op">,</span> ncolsY_h<span class="op">},</span> </span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>            stride<span class="op">,</span> block<span class="op">,</span> vdYQ<span class="op">.</span>data<span class="op">()</span></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>        Eigen<span class="op">::</span>MatrixXd YQR <span class="op">=</span> Eigen<span class="op">::</span>Map<span class="op">&lt;</span>Eigen<span class="op">::</span>Matrix<span class="op">&lt;</span><span class="dt">double</span><span class="op">,</span> </span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>                              Eigen<span class="op">::</span>Dynamic<span class="op">,</span> Eigen<span class="op">::</span>Dynamic<span class="op">,</span> </span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>                              Eigen<span class="op">::</span>ColMajor<span class="op">&gt;&gt;(</span>vdYQ<span class="op">.</span>data<span class="op">(),</span> ncolsY<span class="op">,</span> ncolsY<span class="op">);</span></span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>        <span class="kw">delete</span> dstmpY<span class="op">;</span> dstmpY <span class="op">=</span> <span class="kw">nullptr</span><span class="op">;</span></span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Read X R matrix</span></span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>        dstmpX <span class="op">=</span> <span class="kw">new</span> hdf5Dataset<span class="op">(</span>filename<span class="op">,</span> <span class="st">"Step3/Final_QR/XRt.R"</span><span class="op">,</span> <span class="kw">false</span><span class="op">);</span> </span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>        dstmpX<span class="op">-&gt;</span>openDataset<span class="op">();</span></span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>        dstmpX<span class="op">-&gt;</span>readDatasetBlock<span class="op">(</span></span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>            <span class="op">{</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">},</span> <span class="op">{</span>ncolsX_h<span class="op">,</span> ncolsX_h<span class="op">},</span> </span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>            stride<span class="op">,</span> block<span class="op">,</span> vdXR<span class="op">.</span>data<span class="op">()</span></span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a>        Eigen<span class="op">::</span>Map<span class="op">&lt;</span>Eigen<span class="op">::</span>Matrix<span class="op">&lt;</span><span class="dt">double</span><span class="op">,</span> Eigen<span class="op">::</span>Dynamic<span class="op">,</span> </span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a>                   Eigen<span class="op">::</span>Dynamic<span class="op">,</span> Eigen<span class="op">::</span>ColMajor<span class="op">&gt;&gt;</span> XR<span class="op">(</span></span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a>            vdXR<span class="op">.</span>data<span class="op">(),</span> ncolsX<span class="op">,</span> ncolsX</span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a>        <span class="kw">delete</span> dstmpX<span class="op">;</span> dstmpX <span class="op">=</span> <span class="kw">nullptr</span><span class="op">;</span></span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Read Y R matrix</span></span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true" tabindex="-1"></a>        dstmpY <span class="op">=</span> <span class="kw">new</span> hdf5Dataset<span class="op">(</span>filename<span class="op">,</span> <span class="st">"Step3/Final_QR/YRt.R"</span><span class="op">,</span> <span class="kw">false</span><span class="op">);</span> </span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true" tabindex="-1"></a>        dstmpY<span class="op">-&gt;</span>openDataset<span class="op">();</span></span>
<span id="cb6-68"><a href="#cb6-68" aria-hidden="true" tabindex="-1"></a>        dstmpY<span class="op">-&gt;</span>readDatasetBlock<span class="op">(</span></span>
<span id="cb6-69"><a href="#cb6-69" aria-hidden="true" tabindex="-1"></a>            <span class="op">{</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">},</span> <span class="op">{</span>ncolsY_h<span class="op">,</span> ncolsY_h<span class="op">},</span> </span>
<span id="cb6-70"><a href="#cb6-70" aria-hidden="true" tabindex="-1"></a>            stride<span class="op">,</span> block<span class="op">,</span> vdYR<span class="op">.</span>data<span class="op">()</span></span>
<span id="cb6-71"><a href="#cb6-71" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb6-72"><a href="#cb6-72" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-73"><a href="#cb6-73" aria-hidden="true" tabindex="-1"></a>        Eigen<span class="op">::</span>Map<span class="op">&lt;</span>Eigen<span class="op">::</span>Matrix<span class="op">&lt;</span><span class="dt">double</span><span class="op">,</span> Eigen<span class="op">::</span>Dynamic<span class="op">,</span> </span>
<span id="cb6-74"><a href="#cb6-74" aria-hidden="true" tabindex="-1"></a>                   Eigen<span class="op">::</span>Dynamic<span class="op">,</span> Eigen<span class="op">::</span>ColMajor<span class="op">&gt;&gt;</span> YR<span class="op">(</span></span>
<span id="cb6-75"><a href="#cb6-75" aria-hidden="true" tabindex="-1"></a>            vdYR<span class="op">.</span>data<span class="op">(),</span> ncolsY<span class="op">,</span> ncolsY</span>
<span id="cb6-76"><a href="#cb6-76" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb6-77"><a href="#cb6-77" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-78"><a href="#cb6-78" aria-hidden="true" tabindex="-1"></a>        <span class="kw">delete</span> dstmpY<span class="op">;</span> dstmpY <span class="op">=</span> <span class="kw">nullptr</span><span class="op">;</span></span>
<span id="cb6-79"><a href="#cb6-79" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-80"><a href="#cb6-80" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Combine Q and R into compact QR representation</span></span>
<span id="cb6-81"><a href="#cb6-81" aria-hidden="true" tabindex="-1"></a>        <span class="co">// R is upper triangular, Q is lower triangular</span></span>
<span id="cb6-82"><a href="#cb6-82" aria-hidden="true" tabindex="-1"></a>        XQR<span class="op">.</span>triangularView<span class="op">&lt;</span>Eigen<span class="op">::</span>Upper<span class="op">&gt;()</span> <span class="op">=</span> XR<span class="op">.</span>triangularView<span class="op">&lt;</span>Eigen<span class="op">::</span>Upper<span class="op">&gt;();</span></span>
<span id="cb6-83"><a href="#cb6-83" aria-hidden="true" tabindex="-1"></a>        YQR<span class="op">.</span>triangularView<span class="op">&lt;</span>Eigen<span class="op">::</span>Upper<span class="op">&gt;()</span> <span class="op">=</span> YR<span class="op">.</span>triangularView<span class="op">&lt;</span>Eigen<span class="op">::</span>Upper<span class="op">&gt;();</span></span>
<span id="cb6-84"><a href="#cb6-84" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-85"><a href="#cb6-85" aria-hidden="true" tabindex="-1"></a>        <span class="co">// At this point:</span></span>
<span id="cb6-86"><a href="#cb6-86" aria-hidden="true" tabindex="-1"></a>        <span class="co">// - XQR contains compact QR for X</span></span>
<span id="cb6-87"><a href="#cb6-87" aria-hidden="true" tabindex="-1"></a>        <span class="co">// - YQR contains compact QR for Y</span></span>
<span id="cb6-88"><a href="#cb6-88" aria-hidden="true" tabindex="-1"></a>        <span class="co">// - Could proceed to solve for coefficients using Eigen</span></span>
<span id="cb6-89"><a href="#cb6-89" aria-hidden="true" tabindex="-1"></a>        <span class="co">// - Would need to read SVD results (u, v, d)</span></span>
<span id="cb6-90"><a href="#cb6-90" aria-hidden="true" tabindex="-1"></a>        <span class="co">// - Solve XQR * xcoef = u and YQR * ycoef = v</span></span>
<span id="cb6-91"><a href="#cb6-91" aria-hidden="true" tabindex="-1"></a>        <span class="co">// - Compute variates and save to HDF5</span></span>
<span id="cb6-92"><a href="#cb6-92" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-93"><a href="#cb6-93" aria-hidden="true" tabindex="-1"></a>        <span class="co">// [Full implementation would continue here...]</span></span>
<span id="cb6-94"><a href="#cb6-94" aria-hidden="true" tabindex="-1"></a>        <span class="co">// For most use cases, calling R function is simpler</span></span>
<span id="cb6-95"><a href="#cb6-95" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-96"><a href="#cb6-96" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">catch</span><span class="op">(</span><span class="bu">std::</span>exception<span class="op">&amp;</span> ex<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-97"><a href="#cb6-97" aria-hidden="true" tabindex="-1"></a>        checkClose_file<span class="op">(</span>dstmpX<span class="op">,</span> dstmpY<span class="op">);</span></span>
<span id="cb6-98"><a href="#cb6-98" aria-hidden="true" tabindex="-1"></a>        Rcpp<span class="op">::</span>Rcout <span class="op">&lt;&lt;</span> <span class="st">"C++ exception writeCCAComponents: "</span> </span>
<span id="cb6-99"><a href="#cb6-99" aria-hidden="true" tabindex="-1"></a>                    <span class="op">&lt;&lt;</span> ex<span class="op">.</span>what<span class="op">()</span> <span class="op">&lt;&lt;</span> <span class="st">"</span><span class="sc">\n</span><span class="st">"</span><span class="op">;</span></span>
<span id="cb6-100"><a href="#cb6-100" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dt">void</span><span class="op">();</span></span>
<span id="cb6-101"><a href="#cb6-101" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb6-102"><a href="#cb6-102" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-103"><a href="#cb6-103" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dt">void</span><span class="op">();</span></span>
<span id="cb6-104"><a href="#cb6-104" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong>When full C++ makes sense:</strong></p>
<ul>
<li>Pure C++ deployment (no R dependency)</li>
<li>Custom coefficient computation (sparse, regularized)</li>
<li>Need maximum performance for this step</li>
</ul>
<p><strong>Trade-off:</strong> Much more code, more complexity, more testing needed.</p>
<p>For most applications, Option A (calling R function) is the pragmatic choice.</p>
<hr>
</section>
</section>
<section id="compiling-and-using" class="level2" data-number="8">
<h2 data-number="8" class="anchored" data-anchor-id="compiling-and-using"><span class="header-section-number">8</span> Compiling and Using</h2>
<section id="package-structure" class="level3" data-number="8.1">
<h3 data-number="8.1" class="anchored" data-anchor-id="package-structure"><span class="header-section-number">8.1</span> Package Structure</h3>
<p>Create a package with C++ source and R wrappers:</p>
<pre><code>BDStatMethExamples/
├── DESCRIPTION
├── NAMESPACE
├── R/
│   └── RcppExports.R      # Auto-generated by Rcpp
├── src/
│   ├── bdCCA.cpp          # Main CCA implementation
│   ├── bdCCA.h            # Header with helper functions
│   └── RcppExports.cpp    # Auto-generated by Rcpp
└── inst/
    └── include/
        └── (BigDataStatMeth headers if bundling)</code></pre>
</section>
<section id="the-header-file-bdcca.h" class="level3" data-number="8.2">
<h3 data-number="8.2" class="anchored" data-anchor-id="the-header-file-bdcca.h"><span class="header-section-number">8.2</span> The Header File (bdCCA.h)</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifndef BDSTATMETHEXAMPLES_CCA_HPP</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#define BDSTATMETHEXAMPLES_CCA_HPP</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rcpp.h&gt;</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">"BigDataStatMeth.hpp"</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> Rcpp<span class="op">;</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> BigDataStatMeth<span class="op">;</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Function declarations</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> getQRbyBlocks_rcpp<span class="op">(</span>hdf5Dataset <span class="op">*</span>dsA<span class="op">,</span> <span class="dt">int</span> mblocks<span class="op">,</span> </span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>                        <span class="dt">bool</span> bcenter<span class="op">,</span> <span class="dt">bool</span> bscale<span class="op">,</span> </span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>                        <span class="dt">bool</span> byrows<span class="op">,</span> <span class="dt">bool</span> overwrite<span class="op">,</span> </span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>                        Nullable<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> threads <span class="op">=</span> R_NilValue<span class="op">);</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> writeCCAComponents_hdf5_rcpp<span class="op">(</span><span class="bu">std::</span>string filename<span class="op">,</span> </span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>                                   <span class="dt">int</span> ncolsX<span class="op">,</span> <span class="dt">int</span> ncolsY<span class="op">);</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif </span><span class="co">// BDSTATMETHEXAMPLES_CCA_HPP</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="compile-with-rcpp" class="level3" data-number="8.3">
<h3 data-number="8.3" class="anchored" data-anchor-id="compile-with-rcpp"><span class="header-section-number">8.3</span> Compile with Rcpp</h3>
<p>Two approaches:</p>
<p><strong>Option 1: Quick testing with sourceCpp</strong></p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Rcpp)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Include path to BigDataStatMeth headers</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="fu">Sys.setenv</span>(<span class="at">PKG_CXXFLAGS =</span> <span class="st">"-I/path/to/BigDataStatMeth/inst/include"</span>)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Compile and load</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="fu">sourceCpp</span>(<span class="st">"src/bdCCA.cpp"</span>)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Test</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="fu">bdCCA_hdf5_rcpp</span>(</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> <span class="st">"test.hdf5"</span>,</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">datasetX =</span> <span class="st">"data/X"</span>,</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">datasetY =</span> <span class="st">"data/Y"</span>,</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">bcenter =</span> <span class="cn">TRUE</span>,</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">bscale =</span> <span class="cn">TRUE</span>,</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">mblocks =</span> <span class="dv">4</span>,</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">overwrite =</span> <span class="cn">TRUE</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p><strong>Option 2: Build full package</strong></p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(devtools)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Document (generates RcppExports.R and RcppExports.cpp)</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="fu">document</span>()</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Build package</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="fu">build</span>()</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Install</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="fu">install</span>()</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Load and use</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(BDStatMethExamples)</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="fu">bdCCA_hdf5_rcpp</span>(...)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<hr>
</section>
</section>
<section id="example-usage-r-vs-c" class="level2" data-number="9">
<h2 data-number="9" class="anchored" data-anchor-id="example-usage-r-vs-c"><span class="header-section-number">9</span> Example Usage: R vs C++</h2>
<section id="side-by-side-comparison" class="level3" data-number="9.1">
<h3 data-number="9.1" class="anchored" data-anchor-id="side-by-side-comparison"><span class="header-section-number">9.1</span> Side-by-Side Comparison</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(BDStatMethExamples)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(microbenchmark)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create test data</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">500</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>p_x <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>p_y <span class="ot">&lt;-</span> <span class="dv">800</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(n <span class="sc">*</span> p_x), n, p_x)</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(n <span class="sc">*</span> p_y), n, p_y)</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>test_file <span class="ot">&lt;-</span> <span class="st">"comparison.hdf5"</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="fu">bdCreate_hdf5_matrix</span>(test_file, X, <span class="st">"data"</span>, <span class="st">"X"</span>, <span class="at">overwriteFile =</span> <span class="cn">TRUE</span>)</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="fu">bdCreate_hdf5_matrix</span>(test_file, Y, <span class="st">"data"</span>, <span class="st">"Y"</span>, <span class="at">overwriteFile =</span> <span class="cn">FALSE</span>)</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a><span class="co"># R version</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>time_r <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bdCCA_hdf5</span>(</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> test_file,</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">X =</span> <span class="st">"data/X"</span>,</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">Y =</span> <span class="st">"data/Y"</span>,</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">m =</span> <span class="dv">4</span>,</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">bcenter =</span> <span class="cn">TRUE</span>,</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">bscale =</span> <span class="cn">TRUE</span>,</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">overwriteResults =</span> <span class="cn">TRUE</span>,</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">keepInteResults =</span> <span class="cn">FALSE</span></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a><span class="co"># C++ version</span></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>time_cpp <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bdCCA_hdf5_rcpp</span>(</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> test_file,</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">datasetX =</span> <span class="st">"data/X"</span>,</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">datasetY =</span> <span class="st">"data/Y"</span>,</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">bcenter =</span> <span class="cn">TRUE</span>,</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">bscale =</span> <span class="cn">TRUE</span>,</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">mblocks =</span> <span class="dv">4</span>,</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">overwrite =</span> <span class="cn">TRUE</span></span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Timing comparison:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  R version:"</span>, time_r[<span class="dv">3</span>], <span class="st">"seconds</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  C++ version:"</span>, time_cpp[<span class="dv">3</span>], <span class="st">"seconds</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Speedup:"</span>, <span class="fu">round</span>(time_r[<span class="dv">3</span>] <span class="sc">/</span> time_cpp[<span class="dv">3</span>], <span class="dv">2</span>), <span class="st">"x</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify results are identical</span></span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>h5f <span class="ot">&lt;-</span> <span class="fu">H5Fopen</span>(test_file)</span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>cor_r <span class="ot">&lt;-</span> h5f<span class="sc">$</span>Results<span class="sc">$</span>cor</span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a><span class="fu">H5Fclose</span>(h5f)</span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Results comparison:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Canonical correlations match</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(cor_r[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p><strong>Expected results:</strong></p>
<ul>
<li>C++ typically 1.5-3× faster than R for this operation</li>
<li>Results numerically identical (within floating-point precision)</li>
<li>Memory usage similar (both use block-wise processing)</li>
</ul>
<p>The speedup comes from eliminating R overhead in function calls and data copying, not from algorithmic differences.</p>
<hr>
</section>
</section>
<section id="interactive-exercise" class="level2 exercise" data-number="10">
<h2 class="exercise anchored" data-number="10" data-anchor-id="interactive-exercise"><span class="header-section-number">10</span> Interactive Exercise</h2>
<section id="practice-optimizing-c-implementation" class="level3" data-number="10.1">
<h3 data-number="10.1" class="anchored" data-anchor-id="practice-optimizing-c-implementation"><span class="header-section-number">10.1</span> Practice: Optimizing C++ Implementation</h3>
<p>Understanding C++ optimization opportunities helps you improve performance.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Exercise 1: Add timing to each step</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Modify bdCCA_hdf5_rcpp to print step times</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Which step is slowest? QR? Cross-product? SVD?</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Exercise 2: Parallelize with OpenMP</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Add #pragma omp parallel in getQRbyBlocks_rcpp</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Compile with -fopenmp flag</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="co"># How much speedup on multi-core CPU?</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Exercise 3: Profile memory usage</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Use valgrind or similar tool</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Are there memory leaks?</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Are pointers being cleaned up properly?</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Exercise 4: Compare block sizes</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Try mblocks = 2, 4, 8, 16</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="co"># How does block size affect speed?</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Is there an optimal value?</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>Reflection Questions
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>1. C++ vs R Trade-offs:</strong> - When is 2× speedup worth the development time? - How much C++ expertise does your team have? - What’s the maintenance burden of C++ code?</p>
<p><strong>2. Memory Management:</strong> - Why are pointers necessary vs.&nbsp;automatic variables? - What happens if you forget to delete a pointer? - How does try/catch prevent memory leaks?</p>
<p><strong>3. Integration Patterns:</strong> - When should C++ call R functions vs.&nbsp;pure C++? - How do you pass complex data structures between R and C++? - What about error messages—C++ vs R errors?</p>
<p><strong>4. Performance Optimization:</strong> - Which operations benefit most from C++? - Where is R “fast enough”? - When does I/O dominate vs.&nbsp;computation?</p>
<p><strong>5. Production Deployment:</strong> - How do you test C++ code for correctness? - What about platform differences (Windows vs Linux)? - How do you version control C++ + R packages?</p>
<p>These questions help you decide when C++ optimization is worth the complexity for your specific use case.</p>
</div>
</div>
<hr>
</section>
</section>
<section id="key-takeaways" class="level2 key-concept" data-number="11">
<h2 class="key-concept anchored" data-number="11" data-anchor-id="key-takeaways"><span class="header-section-number">11</span> Key Takeaways</h2>
<p>Let’s consolidate what you’ve learned about implementing CCA in C++ using BigDataStatMeth.</p>
<section id="essential-concepts" class="level3" data-number="11.1">
<h3 data-number="11.1" class="anchored" data-anchor-id="essential-concepts"><span class="header-section-number">11.1</span> Essential Concepts</h3>
<p><strong>C++ provides performance, not different algorithms.</strong> The C++ implementation performs the same mathematical operations as the R version—QR decomposition, cross-product, SVD. The speedup (typically 1.5-3×) comes from eliminating R overhead, not from algorithmic improvements. If you need different algorithms (sparse CCA, kernel CCA), C++ enables that flexibility, but for standard CCA, the performance gain is incremental, not transformational.</p>
<p><strong>Memory management is mandatory, not optional.</strong> In R, garbage collection handles memory automatically. In C++, every <code>new</code> requires a <code>delete</code>, every opened dataset must be closed, every allocated resource needs cleanup. Forgetting cleanup causes memory leaks—your program uses more RAM over time until it crashes. The <code>try/catch</code> pattern with pointer cleanup isn’t defensive programming, it’s required for production C++ code.</p>
<p><strong>Exception handling prevents catastrophic failures.</strong> When R code encounters an error, it returns to the console. When C++ code encounters an error without exception handling, the program crashes, potentially corrupting HDF5 files or leaving resources locked. The <code>try/catch</code> blocks with <code>checkClose_file()</code> ensure that errors cause controlled returns, not crashes. This pattern is essential for any C++ code that manages resources.</p>
<p><strong>Rcpp bridges two worlds effectively but with costs.</strong> Calling R functions from C++ (<code>writeCCAComponents_hdf5_rcpp</code>) is convenient—you reuse tested R code. But it adds R dependency and crossing the R/C++ boundary has overhead. For operations called once (coefficient computation), the convenience wins. For operations called millions of times (inner loops), the overhead matters. Understanding when crossing the boundary costs more than it saves guides integration design.</p>
<p><strong>BigDataStatMeth::functions do heavy lifting.</strong> The C++ implementation doesn’t reimplement matrix multiplication, SVD, or QR decomposition. It calls <code>BigDataStatMeth::crossprod()</code>, <code>RcppbdSVD_hdf5()</code>, etc.—compiled C++ functions that do the computation. Your C++ code orchestrates these operations with better control over memory and flow than R allows. You’re not writing low-level linear algebra; you’re combining high-level operations with better performance characteristics.</p>
<p><strong>Compilation adds complexity but catches errors early.</strong> R scripts run immediately; C++ requires compilation. Compilation takes time, requires build tools, and can fail on different platforms. But compilation catches type errors, function signature mismatches, and memory issues before runtime. R discovers these problems when code executes (potentially hours into a computation). The compile-time cost buys runtime robustness.</p>
</section>
<section id="when-to-use-c-vs-r" class="level3" data-number="11.2">
<h3 data-number="11.2" class="anchored" data-anchor-id="when-to-use-c-vs-r"><span class="header-section-number">11.2</span> When to Use C++ vs R</h3>
<p>Understanding when C++ optimization pays for itself versus when R suffices guides development priorities.</p>
<p>✅ <strong>Use C++ implementation when:</strong></p>
<ul>
<li><p><strong>Performance is demonstrably critical</strong> - Profile first. If CCA takes 10 minutes in R and you run it 100 times daily, 2× speedup saves ~8 hours per day. That justifies C++ development. If you run it twice per month, R is fine.</p></li>
<li><p><strong>Building production systems</strong> - Software running in production benefits from C++’s speed, type safety, and error handling. Development takes longer but runtime is more predictable and failures are more controlled.</p></li>
<li><p><strong>Implementing custom algorithms</strong> - If you need sparse CCA, regularized CCA, or novel variants not in BigDataStatMeth’s R API, C++ gives you algorithmic control. You can implement custom linear algebra, not just combine existing functions.</p></li>
<li><p><strong>Need fine-grained parallelization</strong> - C++ with OpenMP enables parallelizing within matrix operations. R’s parallelization works at function call level. For very large matrices, OpenMP’s finer granularity achieves better speedups.</p></li>
<li><p><strong>Eliminating R dependency</strong> - If deploying to environments without R (embedded systems, HPC clusters with restrictions), pure C++ implementation is necessary despite the development effort.</p></li>
</ul>
<p>✅ <strong>Use R implementation when:</strong></p>
<ul>
<li><p><strong>Prototyping and development</strong> - Get the algorithm working in R first. Interactive debugging, variable inspection, and rapid iteration are invaluable during development. Optimize to C++ later if profiling shows it’s worthwhile.</p></li>
<li><p><strong>Performance is adequate</strong> - If R version completes in acceptable time (minutes for interactive work, hours for batch jobs), don’t optimize prematurely. Spend development time on science, not engineering.</p></li>
<li><p><strong>Team lacks C++ expertise</strong> - Maintaining C++ code requires C++ knowledge. If your team works in R, keeping implementation in R enables everyone to understand and modify the code. Collaboration often outweighs raw performance.</p></li>
<li><p><strong>Combining existing BigDataStatMeth functions</strong> - If your method uses <code>bdSVD_hdf5()</code>, <code>bdCrossprod_hdf5()</code>, etc., R glue code is fine. The heavy lifting happens in compiled code anyway. C++ overhead doesn’t help when you’re just calling C++ functions from R.</p></li>
</ul>
<p>The key principle is evidence-based optimization. Profile to find bottlenecks, then optimize the 20% of code that takes 80% of time. Often, that 20% is already in compiled code (BigDataStatMeth functions), and your R code is just orchestration. C++ shines when you’re implementing novel algorithms or when profiling proves performance is critical.</p>
<hr>
</section>
</section>
<section id="next-steps" class="level2" data-number="12">
<h2 data-number="12" class="anchored" data-anchor-id="next-steps"><span class="header-section-number">12</span> Next Steps</h2>
<p><strong>Compare with R implementation:</strong></p>
<ul>
<li><a href="../developing-methods/cca-r-implementation.html">CCA Implementation in R</a> - Same algorithm, different language</li>
<li>Understand trade-offs between approaches</li>
<li>Decide which to use for your projects</li>
</ul>
<p><strong>Advanced C++ topics:</strong></p>
<ul>
<li>Add OpenMP parallelization for multi-core speedup</li>
<li>Implement custom sparse CCA algorithms<br>
</li>
<li>Optimize memory layout for cache performance</li>
<li>Build standalone C++ library (no R dependency)</li>
</ul>
<p><strong>Production deployment:</strong></p>
<ul>
<li>Write comprehensive tests (unit tests, integration tests)</li>
<li>Add extensive error handling and logging</li>
<li>Create benchmarks to track performance</li>
<li>Document compilation and deployment procedures</li>
</ul>
<hr>
</section>
<section id="cleanup" class="level2" data-number="13">
<h2 data-number="13" class="anchored" data-anchor-id="cleanup"><span class="header-section-number">13</span> Cleanup</h2>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Close any open HDF5 connections</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">h5closeAll</span>()</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: C++ compiled code is in package</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Source files remain in src/ directory</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Recompile after any modifications</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/isglobal-brge\.github\.io\/BigDataStatMeth\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
            // target, if specified
            link.setAttribute("target", "_blank");
            if (link.getAttribute("rel") === null) {
              link.setAttribute("rel", "noopener");
            }
            // default icon
            link.classList.add("external");
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "CCA Implementation in C++"</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="an">subtitle:</span><span class="co"> "Building Canonical Correlation Analysis Using BigDataStatMeth C++ API"</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="fu">## Overview</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>This document shows how to implement Canonical Correlation Analysis (CCA) in C++ using BigDataStatMeth's header-only library. While the <span class="co">[</span><span class="ot">R implementation</span><span class="co">](cca-r-implementation.qmd)</span> demonstrated the algorithm using R's BigDataStatMeth functions, this C++ version provides direct control over computation, memory management, and performance optimization for production environments.</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>The C++ implementation you'll see here is actual production code from the BDStatMethExamples package. It's not simplified teaching code—it's the real implementation handling TCGA multi-omic datasets with careful memory management, exception handling, and integration with R through Rcpp. By studying this code, you learn not just C++ syntax but the engineering discipline required for robust statistical software.</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>Moving from R to C++ isn't just about speed—it's about control. In R, BigDataStatMeth functions handle memory, choose algorithms, manage errors. In C++, you make those decisions explicitly. This control enables custom algorithms, fine-grained optimization, and production deployment where reliability and performance are critical. But it comes with responsibility: you must manage pointers, handle exceptions, prevent memory leaks, and ensure numerical stability.</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>::: {.learning-objectives}</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="fu">### What You'll Learn</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>By the end of this document, you will:</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Work with BigDataStatMeth's C++ header-only library effectively</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Manage HDF5 datasets using the hdf5Dataset class safely</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Implement block-wise QR decomposition with pointer management</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Handle exceptions to prevent crashes and memory leaks</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Integrate C++ functions with R through Rcpp seamlessly</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Decide when C++ optimization justifies development effort</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Compile and test C++ implementations systematically</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Choose between calling R functions vs pure C++ for flexibility</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a><span class="fu">## Why C++ Implementation?</span></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a><span class="fu">### When C++ Makes Sense</span></span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>Before diving into code, understand when C++ optimization is worth the development investment.</span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>**Performance-critical production pipelines:** If you run CCA thousands of times daily in production—processing every new patient sample, updating analyses continuously, serving real-time predictions—C++ performance gains compound. A 50% speedup on one analysis is negligible. A 50% speedup on 10,000 daily analyses saves hours of compute time and enables faster turnaround for clinical or research needs.</span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>**Custom algorithmic control:** If you're implementing novel CCA variants not available in BigDataStatMeth—sparse regularization with custom penalties, kernel CCA with specialized kernels, streaming CCA that processes data in one pass—C++ gives you algorithmic freedom. You're not constrained to pre-built functions; you implement exactly the algorithm you need, with exactly the optimizations that matter for your use case.</span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>**Memory-constrained environments:** In production environments with limited RAM or when processing extremely large datasets, C++'s explicit memory management prevents unexpected allocation failures. You control exactly when memory is allocated and freed, enabling precise tuning for available resources. R's garbage collection can cause unpredictable memory spikes; C++'s deterministic deallocation doesn't.</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>**Integration with existing C++ systems:** If your organization has existing C++ pipelines, statistical libraries, or infrastructure, adding a C++ CCA implementation integrates naturally. No language barriers, no R installation required, consistent deployment practices. The entire stack remains C++, simplifying maintenance and deployment.</span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a><span class="fu">### When R Suffices</span></span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>Don't assume C++ is always better. R often provides better development velocity with adequate performance.</span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>**Algorithm prototyping and development:** Developing new statistical methods in R is faster—you iterate quickly, inspect variables at every step, leverage R's statistical ecosystem. Get the algorithm mathematically correct in R, validate it thoroughly, then optimize in C++ if performance profiling shows bottlenecks. Many methods never need C++ because R performance is adequate.</span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>**Infrequent use cases:** If you run CCA once per month on a dataset that completes in 10 minutes, C++ optimization isn't justified. The development time—writing C++ code, testing memory management, handling edge cases—exceeds the total computation time saved over the method's lifetime. Use R, wait 10 minutes, move on to analysis.</span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a>**Leveraging BigDataStatMeth functions:** If your algorithm composes existing BigDataStatMeth functions (bdSVD_hdf5, bdCrossprod_hdf5, etc.), the heavy lifting already happens in compiled code. R orchestration overhead is negligible. Only if you need custom operations not provided by BigDataStatMeth does C++ implementation add value.</span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a>**Team expertise considerations:** If your team excels in R but struggles with C++, the maintenance burden of C++ code may outweigh performance benefits. Statistical correctness and code maintainability matter more than speed. Better to have understandable R code that runs slightly slower than inscrutable C++ code that nobody can debug or extend.</span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a>The decision rule: profile first, optimize selectively. Identify actual bottlenecks through profiling, then apply C++ surgically to those specific operations. Wholesale R-to-C++ rewrites are rarely the right answer.</span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a><span class="fu">## C++ Prerequisites</span></span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-63"><a href="#cb14-63" aria-hidden="true" tabindex="-1"></a><span class="fu">### Required Headers</span></span>
<span id="cb14-64"><a href="#cb14-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-65"><a href="#cb14-65" aria-hidden="true" tabindex="-1"></a>BigDataStatMeth provides a header-only C++ library. Include the main header and you have access to all classes and functions without linking against compiled libraries:</span>
<span id="cb14-66"><a href="#cb14-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-67"><a href="#cb14-67" aria-hidden="true" tabindex="-1"></a><span class="in">```cpp</span></span>
<span id="cb14-68"><a href="#cb14-68" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rcpp.h&gt;</span></span>
<span id="cb14-69"><a href="#cb14-69" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">"BigDataStatMeth.hpp"</span></span>
<span id="cb14-70"><a href="#cb14-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-71"><a href="#cb14-71" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> Rcpp<span class="op">;</span></span>
<span id="cb14-72"><a href="#cb14-72" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> BigDataStatMeth<span class="op">;</span></span>
<span id="cb14-73"><a href="#cb14-73" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-74"><a href="#cb14-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-75"><a href="#cb14-75" aria-hidden="true" tabindex="-1"></a>The <span class="in">`Rcpp.h`</span> header enables R integration—exporting C++ functions to R, converting between R and C++ data structures, handling R's error model. Without Rcpp, you'd write pure C++ code that R can't call directly.</span>
<span id="cb14-76"><a href="#cb14-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-77"><a href="#cb14-77" aria-hidden="true" tabindex="-1"></a>The <span class="in">`BigDataStatMeth.hpp`</span> header provides the core functionality:</span>
<span id="cb14-78"><a href="#cb14-78" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`hdf5Dataset`</span> class for HDF5 file I/O</span>
<span id="cb14-79"><a href="#cb14-79" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Matrix operation functions (crossprod, SVD, QR)</span>
<span id="cb14-80"><a href="#cb14-80" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Block-wise processing utilities</span>
<span id="cb14-81"><a href="#cb14-81" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Memory management helpers</span>
<span id="cb14-82"><a href="#cb14-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-83"><a href="#cb14-83" aria-hidden="true" tabindex="-1"></a><span class="fu">### Understanding hdf5Dataset Class</span></span>
<span id="cb14-84"><a href="#cb14-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-85"><a href="#cb14-85" aria-hidden="true" tabindex="-1"></a>The <span class="in">`hdf5Dataset`</span> class is your interface to HDF5 files in C++. Unlike R's transparent HDF5 access, C++ requires explicit dataset opening, reading, writing, and closing.</span>
<span id="cb14-86"><a href="#cb14-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-87"><a href="#cb14-87" aria-hidden="true" tabindex="-1"></a>**Basic usage pattern:**</span>
<span id="cb14-88"><a href="#cb14-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-89"><a href="#cb14-89" aria-hidden="true" tabindex="-1"></a><span class="in">```cpp</span></span>
<span id="cb14-90"><a href="#cb14-90" aria-hidden="true" tabindex="-1"></a><span class="co">// Constructor: create dataset object</span></span>
<span id="cb14-91"><a href="#cb14-91" aria-hidden="true" tabindex="-1"></a><span class="co">// Parameters: filename, dataset_path, create_if_new</span></span>
<span id="cb14-92"><a href="#cb14-92" aria-hidden="true" tabindex="-1"></a>hdf5Dataset<span class="op">*</span> ds <span class="op">=</span> <span class="kw">new</span> hdf5Dataset<span class="op">(</span><span class="st">"file.hdf5"</span><span class="op">,</span> <span class="st">"data/matrix"</span><span class="op">,</span> <span class="kw">false</span><span class="op">);</span></span>
<span id="cb14-93"><a href="#cb14-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-94"><a href="#cb14-94" aria-hidden="true" tabindex="-1"></a><span class="co">// Open for reading/writing</span></span>
<span id="cb14-95"><a href="#cb14-95" aria-hidden="true" tabindex="-1"></a><span class="co">// Must call before any I/O operations</span></span>
<span id="cb14-96"><a href="#cb14-96" aria-hidden="true" tabindex="-1"></a>ds<span class="op">-&gt;</span>openDataset<span class="op">();</span></span>
<span id="cb14-97"><a href="#cb14-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-98"><a href="#cb14-98" aria-hidden="true" tabindex="-1"></a><span class="co">// Get dimensions</span></span>
<span id="cb14-99"><a href="#cb14-99" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> nrows <span class="op">=</span> ds<span class="op">-&gt;</span>nrows<span class="op">();</span>      <span class="co">// Total rows (C indexing: 0-based)</span></span>
<span id="cb14-100"><a href="#cb14-100" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> ncols <span class="op">=</span> ds<span class="op">-&gt;</span>ncols<span class="op">();</span>      <span class="co">// Total columns</span></span>
<span id="cb14-101"><a href="#cb14-101" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> nrows_r <span class="op">=</span> ds<span class="op">-&gt;</span>nrows_r<span class="op">();</span>  <span class="co">// Rows (R indexing: 1-based)</span></span>
<span id="cb14-102"><a href="#cb14-102" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> ncols_r <span class="op">=</span> ds<span class="op">-&gt;</span>ncols_r<span class="op">();</span>  <span class="co">// Columns (R indexing: 1-based)</span></span>
<span id="cb14-103"><a href="#cb14-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-104"><a href="#cb14-104" aria-hidden="true" tabindex="-1"></a><span class="co">// Read data block</span></span>
<span id="cb14-105"><a href="#cb14-105" aria-hidden="true" tabindex="-1"></a><span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> data<span class="op">(</span>nrows <span class="op">*</span> ncols<span class="op">);</span></span>
<span id="cb14-106"><a href="#cb14-106" aria-hidden="true" tabindex="-1"></a><span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">hsize_t</span><span class="op">&gt;</span> offset <span class="op">=</span> <span class="op">{</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">};</span>        <span class="co">// Start position</span></span>
<span id="cb14-107"><a href="#cb14-107" aria-hidden="true" tabindex="-1"></a><span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">hsize_t</span><span class="op">&gt;</span> count <span class="op">=</span> <span class="op">{</span>nrows<span class="op">,</span> ncols<span class="op">};</span> <span class="co">// How much to read</span></span>
<span id="cb14-108"><a href="#cb14-108" aria-hidden="true" tabindex="-1"></a><span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">hsize_t</span><span class="op">&gt;</span> stride <span class="op">=</span> <span class="op">{</span><span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">};</span>        <span class="co">// Step size (usually 1,1)</span></span>
<span id="cb14-109"><a href="#cb14-109" aria-hidden="true" tabindex="-1"></a><span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">hsize_t</span><span class="op">&gt;</span> block <span class="op">=</span> <span class="op">{</span><span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">};</span>         <span class="co">// Block size (usually 1,1)</span></span>
<span id="cb14-110"><a href="#cb14-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-111"><a href="#cb14-111" aria-hidden="true" tabindex="-1"></a>ds<span class="op">-&gt;</span>readDatasetBlock<span class="op">(</span>offset<span class="op">,</span> count<span class="op">,</span> stride<span class="op">,</span> block<span class="op">,</span> data<span class="op">.</span>data<span class="op">());</span></span>
<span id="cb14-112"><a href="#cb14-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-113"><a href="#cb14-113" aria-hidden="true" tabindex="-1"></a><span class="co">// Write data block</span></span>
<span id="cb14-114"><a href="#cb14-114" aria-hidden="true" tabindex="-1"></a>ds<span class="op">-&gt;</span>writeDatasetBlock<span class="op">(</span>offset<span class="op">,</span> count<span class="op">,</span> stride<span class="op">,</span> block<span class="op">,</span> data<span class="op">.</span>data<span class="op">());</span></span>
<span id="cb14-115"><a href="#cb14-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-116"><a href="#cb14-116" aria-hidden="true" tabindex="-1"></a><span class="co">// Cleanup - CRITICAL</span></span>
<span id="cb14-117"><a href="#cb14-117" aria-hidden="true" tabindex="-1"></a><span class="kw">delete</span> ds<span class="op">;</span></span>
<span id="cb14-118"><a href="#cb14-118" aria-hidden="true" tabindex="-1"></a>ds <span class="op">=</span> <span class="kw">nullptr</span><span class="op">;</span>  <span class="co">// Prevent double-delete</span></span>
<span id="cb14-119"><a href="#cb14-119" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-120"><a href="#cb14-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-121"><a href="#cb14-121" aria-hidden="true" tabindex="-1"></a>**Critical memory management rules:**</span>
<span id="cb14-122"><a href="#cb14-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-123"><a href="#cb14-123" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Always delete:** Every <span class="in">`new hdf5Dataset`</span> requires corresponding <span class="in">`delete`</span>. Forgetting causes memory leaks—the HDF5 handle stays open, consuming resources.</span>
<span id="cb14-124"><a href="#cb14-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-125"><a href="#cb14-125" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Set to nullptr after delete:** Prevents accidentally using a deleted pointer (accessing freed memory causes crashes).</span>
<span id="cb14-126"><a href="#cb14-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-127"><a href="#cb14-127" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Use try/catch:** HDF5 operations can fail (file not found, dataset doesn't exist, permissions denied). Wrap in try/catch to clean up properly on errors.</span>
<span id="cb14-128"><a href="#cb14-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-129"><a href="#cb14-129" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Check nullptr before delete:** If pointer might be null, check before deleting to avoid crashes.</span>
<span id="cb14-130"><a href="#cb14-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-131"><a href="#cb14-131" aria-hidden="true" tabindex="-1"></a>**Common pitfalls:**</span>
<span id="cb14-132"><a href="#cb14-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-133"><a href="#cb14-133" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Forgetting <span class="in">`openDataset()`</span> before reading → runtime error</span>
<span id="cb14-134"><a href="#cb14-134" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Reading without allocating sufficient buffer space → buffer overflow</span>
<span id="cb14-135"><a href="#cb14-135" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Deleting same pointer twice → crash</span>
<span id="cb14-136"><a href="#cb14-136" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Returning from function without deleting → memory leak</span>
<span id="cb14-137"><a href="#cb14-137" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Catching exception but not deleting pointers → memory leak</span>
<span id="cb14-138"><a href="#cb14-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-139"><a href="#cb14-139" aria-hidden="true" tabindex="-1"></a>The pattern you'll see repeatedly: declare pointer to nullptr, allocate with new, use in try block, delete in catch and after try, set to nullptr. This discipline prevents the memory leaks and crashes that plague C++ codebases.</span>
<span id="cb14-140"><a href="#cb14-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-141"><a href="#cb14-141" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb14-142"><a href="#cb14-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-143"><a href="#cb14-143" aria-hidden="true" tabindex="-1"></a><span class="fu">## Mathematical Foundation (Reference)</span></span>
<span id="cb14-144"><a href="#cb14-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-145"><a href="#cb14-145" aria-hidden="true" tabindex="-1"></a>The mathematical foundations of CCA are detailed in the <span class="co">[</span><span class="ot">R implementation document</span><span class="co">](cca-r-implementation.qmd#cca-algorithm-overview)</span>. Rather than duplicating that content, here's a condensed reference.</span>
<span id="cb14-146"><a href="#cb14-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-147"><a href="#cb14-147" aria-hidden="true" tabindex="-1"></a>**CCA algorithm steps:**</span>
<span id="cb14-148"><a href="#cb14-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-149"><a href="#cb14-149" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**QR decomposition:** $X = Q_X R_X$, $Y = Q_Y R_Y$  </span>
<span id="cb14-150"><a href="#cb14-150" aria-hidden="true" tabindex="-1"></a>   Orthonormalizes matrices while preserving column space</span>
<span id="cb14-151"><a href="#cb14-151" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb14-152"><a href="#cb14-152" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Cross-product:** $M = Q_X^T Q_Y$  </span>
<span id="cb14-153"><a href="#cb14-153" aria-hidden="true" tabindex="-1"></a>   Captures relationship between orthonormalized datasets</span>
<span id="cb14-154"><a href="#cb14-154" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb14-155"><a href="#cb14-155" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**SVD:** $M = U D V^T$  </span>
<span id="cb14-156"><a href="#cb14-156" aria-hidden="true" tabindex="-1"></a>   Diagonal D contains canonical correlations, U and V are canonical directions</span>
<span id="cb14-157"><a href="#cb14-157" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb14-158"><a href="#cb14-158" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Canonical coefficients:** $\alpha = R_X^{-1} U$, $\beta = R_Y^{-1} V$  </span>
<span id="cb14-159"><a href="#cb14-159" aria-hidden="true" tabindex="-1"></a>   Transform back to original feature space</span>
<span id="cb14-160"><a href="#cb14-160" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb14-161"><a href="#cb14-161" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>**Canonical variates:** $s_X = X\alpha$, $s_Y = Y\beta$  </span>
<span id="cb14-162"><a href="#cb14-162" aria-hidden="true" tabindex="-1"></a>   Sample scores in canonical space</span>
<span id="cb14-163"><a href="#cb14-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-164"><a href="#cb14-164" aria-hidden="true" tabindex="-1"></a>**Block-wise processing rationale:**</span>
<span id="cb14-165"><a href="#cb14-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-166"><a href="#cb14-166" aria-hidden="true" tabindex="-1"></a>For large matrices (50,000 samples × 500,000 features), computing full QR decomposition requires massive RAM. Block-wise approach:</span>
<span id="cb14-167"><a href="#cb14-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-168"><a href="#cb14-168" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Partitions matrix into m blocks by rows</span>
<span id="cb14-169"><a href="#cb14-169" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Computes QR on each block (memory-friendly)</span>
<span id="cb14-170"><a href="#cb14-170" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Combines results hierarchically</span>
<span id="cb14-171"><a href="#cb14-171" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Achieves identical result to full QR but with reduced memory</span>
<span id="cb14-172"><a href="#cb14-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-173"><a href="#cb14-173" aria-hidden="true" tabindex="-1"></a>The C++ implementation follows this same mathematical algorithm. The difference is how it's expressed—explicit pointer management, manual memory allocation, direct HDF5 calls—not what it computes.</span>
<span id="cb14-174"><a href="#cb14-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-175"><a href="#cb14-175" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb14-176"><a href="#cb14-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-177"><a href="#cb14-177" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 1: QR Decomposition by Blocks in C++</span></span>
<span id="cb14-178"><a href="#cb14-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-179"><a href="#cb14-179" aria-hidden="true" tabindex="-1"></a><span class="fu">### The getQRbyBlocks_rcpp Function</span></span>
<span id="cb14-180"><a href="#cb14-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-181"><a href="#cb14-181" aria-hidden="true" tabindex="-1"></a>This function implements block-wise QR decomposition in C++, mirroring the R version but with explicit memory and error handling:</span>
<span id="cb14-182"><a href="#cb14-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-183"><a href="#cb14-183" aria-hidden="true" tabindex="-1"></a><span class="in">```cpp</span></span>
<span id="cb14-184"><a href="#cb14-184" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> getQRbyBlocks_rcpp<span class="op">(</span>hdf5Dataset <span class="op">*</span>dsA<span class="op">,</span> <span class="dt">int</span> mblocks<span class="op">,</span> </span>
<span id="cb14-185"><a href="#cb14-185" aria-hidden="true" tabindex="-1"></a>                        <span class="dt">bool</span> bcenter<span class="op">,</span> <span class="dt">bool</span> bscale<span class="op">,</span> </span>
<span id="cb14-186"><a href="#cb14-186" aria-hidden="true" tabindex="-1"></a>                        <span class="dt">bool</span> byrows<span class="op">,</span> <span class="dt">bool</span> overwrite<span class="op">,</span> </span>
<span id="cb14-187"><a href="#cb14-187" aria-hidden="true" tabindex="-1"></a>                        Rcpp<span class="op">::</span>Nullable<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> threads<span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-188"><a href="#cb14-188" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-189"><a href="#cb14-189" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Temporary dataset pointer - initialize to nullptr for safety</span></span>
<span id="cb14-190"><a href="#cb14-190" aria-hidden="true" tabindex="-1"></a>    hdf5Dataset<span class="op">*</span> dstmp <span class="op">=</span> <span class="kw">nullptr</span><span class="op">;</span></span>
<span id="cb14-191"><a href="#cb14-191" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-192"><a href="#cb14-192" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb14-193"><a href="#cb14-193" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-194"><a href="#cb14-194" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>string strInPath<span class="op">,</span> strOutPath<span class="op">;</span></span>
<span id="cb14-195"><a href="#cb14-195" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-196"><a href="#cb14-196" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Flags for matrix operation parameters</span></span>
<span id="cb14-197"><a href="#cb14-197" aria-hidden="true" tabindex="-1"></a>        <span class="dt">bool</span> btransp_dataset <span class="op">=</span> <span class="kw">false</span><span class="op">;</span>   <span class="co">// Transpose first matrix?</span></span>
<span id="cb14-198"><a href="#cb14-198" aria-hidden="true" tabindex="-1"></a>        <span class="dt">bool</span> btransp_bdataset <span class="op">=</span> <span class="kw">false</span><span class="op">;</span>  <span class="co">// Transpose second matrix?</span></span>
<span id="cb14-199"><a href="#cb14-199" aria-hidden="true" tabindex="-1"></a>        <span class="dt">bool</span> bfullMatrix <span class="op">=</span> <span class="kw">false</span><span class="op">;</span>       <span class="co">// Use full matrix vs economy?</span></span>
<span id="cb14-200"><a href="#cb14-200" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-201"><a href="#cb14-201" aria-hidden="true" tabindex="-1"></a>        <span class="dt">bool</span> bycols <span class="op">=</span> <span class="op">!</span>byrows<span class="op">;</span>  <span class="co">// Convert row-wise to column-wise flag</span></span>
<span id="cb14-202"><a href="#cb14-202" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-203"><a href="#cb14-203" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Get dataset name for path construction</span></span>
<span id="cb14-204"><a href="#cb14-204" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>string strdataset <span class="op">=</span> dsA<span class="op">-&gt;</span>getDatasetName<span class="op">();</span></span>
<span id="cb14-205"><a href="#cb14-205" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-206"><a href="#cb14-206" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Step 1: Normalize dataset (center and/or scale)</span></span>
<span id="cb14-207"><a href="#cb14-207" aria-hidden="true" tabindex="-1"></a>        <span class="co">// This calls R's normalization function for simplicity</span></span>
<span id="cb14-208"><a href="#cb14-208" aria-hidden="true" tabindex="-1"></a>        RcppNormalizeHdf5<span class="op">(</span>dsA<span class="op">,</span> bcenter<span class="op">,</span> bscale<span class="op">,</span> byrows<span class="op">);</span></span>
<span id="cb14-209"><a href="#cb14-209" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-210"><a href="#cb14-210" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Step 2: Open normalized dataset</span></span>
<span id="cb14-211"><a href="#cb14-211" aria-hidden="true" tabindex="-1"></a>        dstmp <span class="op">=</span> <span class="kw">new</span> hdf5Dataset<span class="op">(</span>dsA<span class="op">-&gt;</span>getFileName<span class="op">(),</span> </span>
<span id="cb14-212"><a href="#cb14-212" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"NORMALIZED/"</span> <span class="op">+</span> dsA<span class="op">-&gt;</span>getGroupName<span class="op">(),</span> </span>
<span id="cb14-213"><a href="#cb14-213" aria-hidden="true" tabindex="-1"></a>                                strdataset<span class="op">,</span> <span class="kw">false</span><span class="op">);</span></span>
<span id="cb14-214"><a href="#cb14-214" aria-hidden="true" tabindex="-1"></a>        dstmp<span class="op">-&gt;</span>openDataset<span class="op">();</span></span>
<span id="cb14-215"><a href="#cb14-215" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-216"><a href="#cb14-216" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Step 3: Split into blocks</span></span>
<span id="cb14-217"><a href="#cb14-217" aria-hidden="true" tabindex="-1"></a>        strOutPath <span class="op">=</span> <span class="st">"Step1/"</span> <span class="op">+</span> strdataset <span class="op">+</span> <span class="st">"rows"</span><span class="op">;</span></span>
<span id="cb14-218"><a href="#cb14-218" aria-hidden="true" tabindex="-1"></a>        RcppSplit_matrix_hdf5_internal<span class="op">(</span></span>
<span id="cb14-219"><a href="#cb14-219" aria-hidden="true" tabindex="-1"></a>            dstmp<span class="op">,</span> strOutPath<span class="op">,</span> strdataset<span class="op">,</span> bycols<span class="op">,</span></span>
<span id="cb14-220"><a href="#cb14-220" aria-hidden="true" tabindex="-1"></a>            mblocks<span class="op">,</span> <span class="op">-</span><span class="dv">1</span><span class="op">,</span> dstmp<span class="op">-&gt;</span>nrows<span class="op">(),</span> dstmp<span class="op">-&gt;</span>ncols<span class="op">()</span></span>
<span id="cb14-221"><a href="#cb14-221" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb14-222"><a href="#cb14-222" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-223"><a href="#cb14-223" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Close and delete temporary dataset - critical for memory</span></span>
<span id="cb14-224"><a href="#cb14-224" aria-hidden="true" tabindex="-1"></a>        <span class="kw">delete</span> dstmp<span class="op">;</span> </span>
<span id="cb14-225"><a href="#cb14-225" aria-hidden="true" tabindex="-1"></a>        dstmp <span class="op">=</span> <span class="kw">nullptr</span><span class="op">;</span>    </span>
<span id="cb14-226"><a href="#cb14-226" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-227"><a href="#cb14-227" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Step 4: Apply QR to each block</span></span>
<span id="cb14-228"><a href="#cb14-228" aria-hidden="true" tabindex="-1"></a>        StringVector blocks <span class="op">=</span> dsA<span class="op">-&gt;</span>getDatasetNames<span class="op">(</span>strOutPath<span class="op">,</span> <span class="st">""</span><span class="op">,</span> <span class="st">""</span><span class="op">);</span></span>
<span id="cb14-229"><a href="#cb14-229" aria-hidden="true" tabindex="-1"></a>        strInPath <span class="op">=</span> strOutPath<span class="op">;</span></span>
<span id="cb14-230"><a href="#cb14-230" aria-hidden="true" tabindex="-1"></a>        strOutPath <span class="op">=</span> <span class="st">"Step2/"</span> <span class="op">+</span> strdataset <span class="op">+</span> <span class="st">"rows"</span><span class="op">;</span></span>
<span id="cb14-231"><a href="#cb14-231" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-232"><a href="#cb14-232" aria-hidden="true" tabindex="-1"></a>        RcppApplyFunctionHdf5<span class="op">(</span></span>
<span id="cb14-233"><a href="#cb14-233" aria-hidden="true" tabindex="-1"></a>            dsA<span class="op">-&gt;</span>getFileName<span class="op">(),</span> strInPath<span class="op">,</span> blocks<span class="op">,</span> strOutPath<span class="op">,</span> <span class="st">"QR"</span><span class="op">,</span></span>
<span id="cb14-234"><a href="#cb14-234" aria-hidden="true" tabindex="-1"></a>            R_NilValue<span class="op">,</span> R_NilValue<span class="op">,</span> wrap<span class="op">(</span>overwrite<span class="op">),</span> </span>
<span id="cb14-235"><a href="#cb14-235" aria-hidden="true" tabindex="-1"></a>            wrap<span class="op">(</span>btransp_dataset<span class="op">),</span> wrap<span class="op">(</span>btransp_bdataset<span class="op">),</span> </span>
<span id="cb14-236"><a href="#cb14-236" aria-hidden="true" tabindex="-1"></a>            wrap<span class="op">(</span>bfullMatrix<span class="op">),</span> wrap<span class="op">(</span>byrows<span class="op">),</span> threads</span>
<span id="cb14-237"><a href="#cb14-237" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb14-238"><a href="#cb14-238" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-239"><a href="#cb14-239" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Step 5: Merge R matrices from blocks</span></span>
<span id="cb14-240"><a href="#cb14-240" aria-hidden="true" tabindex="-1"></a>        StringVector blocks_qr <span class="op">=</span> dsA<span class="op">-&gt;</span>getDatasetNames<span class="op">(</span>strOutPath<span class="op">,</span> </span>
<span id="cb14-241"><a href="#cb14-241" aria-hidden="true" tabindex="-1"></a>                                                       strdataset<span class="op">,</span> <span class="st">".R"</span><span class="op">);</span></span>
<span id="cb14-242"><a href="#cb14-242" aria-hidden="true" tabindex="-1"></a>        strInPath <span class="op">=</span> strOutPath<span class="op">;</span></span>
<span id="cb14-243"><a href="#cb14-243" aria-hidden="true" tabindex="-1"></a>        strOutPath <span class="op">=</span> <span class="st">"Step3/merged"</span><span class="op">;</span></span>
<span id="cb14-244"><a href="#cb14-244" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-245"><a href="#cb14-245" aria-hidden="true" tabindex="-1"></a>        RcppBind_datasets_hdf5<span class="op">(</span></span>
<span id="cb14-246"><a href="#cb14-246" aria-hidden="true" tabindex="-1"></a>            dsA<span class="op">-&gt;</span>getFileName<span class="op">(),</span> strInPath<span class="op">,</span> blocks_qr<span class="op">,</span></span>
<span id="cb14-247"><a href="#cb14-247" aria-hidden="true" tabindex="-1"></a>            strOutPath<span class="op">,</span> strdataset <span class="op">+</span> <span class="st">"Rt"</span><span class="op">,</span> <span class="st">"bindRows"</span><span class="op">,</span> </span>
<span id="cb14-248"><a href="#cb14-248" aria-hidden="true" tabindex="-1"></a>            <span class="kw">false</span><span class="op">,</span> wrap<span class="op">(</span>overwrite<span class="op">)</span></span>
<span id="cb14-249"><a href="#cb14-249" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb14-250"><a href="#cb14-250" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-251"><a href="#cb14-251" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Step 6: Final QR on merged R matrices</span></span>
<span id="cb14-252"><a href="#cb14-252" aria-hidden="true" tabindex="-1"></a>        strInPath <span class="op">=</span> strOutPath<span class="op">;</span></span>
<span id="cb14-253"><a href="#cb14-253" aria-hidden="true" tabindex="-1"></a>        strOutPath <span class="op">=</span> <span class="st">"Step3/Final_QR"</span><span class="op">;</span></span>
<span id="cb14-254"><a href="#cb14-254" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-255"><a href="#cb14-255" aria-hidden="true" tabindex="-1"></a>        RcppApplyFunctionHdf5<span class="op">(</span></span>
<span id="cb14-256"><a href="#cb14-256" aria-hidden="true" tabindex="-1"></a>            dsA<span class="op">-&gt;</span>getFileName<span class="op">(),</span> strInPath<span class="op">,</span> strdataset <span class="op">+</span> <span class="st">"Rt"</span><span class="op">,</span> </span>
<span id="cb14-257"><a href="#cb14-257" aria-hidden="true" tabindex="-1"></a>            strOutPath<span class="op">,</span> <span class="st">"QR"</span><span class="op">,</span></span>
<span id="cb14-258"><a href="#cb14-258" aria-hidden="true" tabindex="-1"></a>            R_NilValue<span class="op">,</span> R_NilValue<span class="op">,</span> wrap<span class="op">(</span>overwrite<span class="op">),</span> </span>
<span id="cb14-259"><a href="#cb14-259" aria-hidden="true" tabindex="-1"></a>            wrap<span class="op">(</span>btransp_dataset<span class="op">),</span> wrap<span class="op">(</span>btransp_bdataset<span class="op">),</span> </span>
<span id="cb14-260"><a href="#cb14-260" aria-hidden="true" tabindex="-1"></a>            wrap<span class="op">(</span>bfullMatrix<span class="op">),</span> wrap<span class="op">(</span>byrows<span class="op">),</span> threads</span>
<span id="cb14-261"><a href="#cb14-261" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb14-262"><a href="#cb14-262" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-263"><a href="#cb14-263" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Step 7: Split final Q for multiplication</span></span>
<span id="cb14-264"><a href="#cb14-264" aria-hidden="true" tabindex="-1"></a>        strInPath <span class="op">=</span> strOutPath<span class="op">;</span></span>
<span id="cb14-265"><a href="#cb14-265" aria-hidden="true" tabindex="-1"></a>        strOutPath <span class="op">=</span> <span class="st">"Step4/splitted"</span><span class="op">;</span></span>
<span id="cb14-266"><a href="#cb14-266" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-267"><a href="#cb14-267" aria-hidden="true" tabindex="-1"></a>        dstmp <span class="op">=</span> <span class="kw">new</span> hdf5Dataset<span class="op">(</span>dsA<span class="op">-&gt;</span>getFileName<span class="op">(),</span> strInPath<span class="op">,</span> </span>
<span id="cb14-268"><a href="#cb14-268" aria-hidden="true" tabindex="-1"></a>                                strdataset <span class="op">+</span> <span class="st">"Rt.Q"</span><span class="op">,</span> <span class="kw">false</span><span class="op">);</span></span>
<span id="cb14-269"><a href="#cb14-269" aria-hidden="true" tabindex="-1"></a>        dstmp<span class="op">-&gt;</span>openDataset<span class="op">();</span></span>
<span id="cb14-270"><a href="#cb14-270" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-271"><a href="#cb14-271" aria-hidden="true" tabindex="-1"></a>        RcppSplit_matrix_hdf5_internal<span class="op">(</span></span>
<span id="cb14-272"><a href="#cb14-272" aria-hidden="true" tabindex="-1"></a>            dstmp<span class="op">,</span> strOutPath<span class="op">,</span> strdataset <span class="op">+</span> <span class="st">"Rt.Q"</span><span class="op">,</span> bycols<span class="op">,</span></span>
<span id="cb14-273"><a href="#cb14-273" aria-hidden="true" tabindex="-1"></a>            mblocks<span class="op">,</span> <span class="op">-</span><span class="dv">1</span><span class="op">,</span> dstmp<span class="op">-&gt;</span>nrows<span class="op">(),</span> dstmp<span class="op">-&gt;</span>ncols<span class="op">()</span></span>
<span id="cb14-274"><a href="#cb14-274" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb14-275"><a href="#cb14-275" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-276"><a href="#cb14-276" aria-hidden="true" tabindex="-1"></a>        <span class="kw">delete</span> dstmp<span class="op">;</span> </span>
<span id="cb14-277"><a href="#cb14-277" aria-hidden="true" tabindex="-1"></a>        dstmp <span class="op">=</span> <span class="kw">nullptr</span><span class="op">;</span> </span>
<span id="cb14-278"><a href="#cb14-278" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-279"><a href="#cb14-279" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Step 8: Multiply original Q blocks by final Q blocks</span></span>
<span id="cb14-280"><a href="#cb14-280" aria-hidden="true" tabindex="-1"></a>        strInPath <span class="op">=</span> <span class="st">"Step2/"</span> <span class="op">+</span> strdataset <span class="op">+</span> <span class="st">"rows"</span><span class="op">;</span></span>
<span id="cb14-281"><a href="#cb14-281" aria-hidden="true" tabindex="-1"></a>        strOutPath <span class="op">=</span> <span class="st">"Step5"</span><span class="op">;</span></span>
<span id="cb14-282"><a href="#cb14-282" aria-hidden="true" tabindex="-1"></a>        CharacterVector b_group <span class="op">=</span> <span class="st">"Step4/splitted"</span><span class="op">;</span></span>
<span id="cb14-283"><a href="#cb14-283" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-284"><a href="#cb14-284" aria-hidden="true" tabindex="-1"></a>        blocks_qr <span class="op">=</span> dsA<span class="op">-&gt;</span>getDatasetNames<span class="op">(</span>strInPath<span class="op">,</span> strdataset<span class="op">,</span> <span class="st">".Q"</span><span class="op">);</span></span>
<span id="cb14-285"><a href="#cb14-285" aria-hidden="true" tabindex="-1"></a>        StringVector b_blocks <span class="op">=</span> dsA<span class="op">-&gt;</span>getDatasetNames<span class="op">(</span></span>
<span id="cb14-286"><a href="#cb14-286" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Step4/splitted"</span><span class="op">,</span> strdataset <span class="op">+</span> <span class="st">"Rt.Q"</span><span class="op">,</span> <span class="st">""</span></span>
<span id="cb14-287"><a href="#cb14-287" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb14-288"><a href="#cb14-288" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-289"><a href="#cb14-289" aria-hidden="true" tabindex="-1"></a>        RcppApplyFunctionHdf5<span class="op">(</span></span>
<span id="cb14-290"><a href="#cb14-290" aria-hidden="true" tabindex="-1"></a>            dsA<span class="op">-&gt;</span>getFileName<span class="op">(),</span> strInPath<span class="op">,</span> blocks_qr<span class="op">,</span> strOutPath<span class="op">,</span> </span>
<span id="cb14-291"><a href="#cb14-291" aria-hidden="true" tabindex="-1"></a>            <span class="st">"blockmult"</span><span class="op">,</span> b_group<span class="op">,</span> b_blocks<span class="op">,</span> wrap<span class="op">(</span>overwrite<span class="op">),</span> </span>
<span id="cb14-292"><a href="#cb14-292" aria-hidden="true" tabindex="-1"></a>            wrap<span class="op">(</span>btransp_dataset<span class="op">),</span> wrap<span class="op">(</span>btransp_bdataset<span class="op">),</span> </span>
<span id="cb14-293"><a href="#cb14-293" aria-hidden="true" tabindex="-1"></a>            wrap<span class="op">(</span>bfullMatrix<span class="op">),</span> wrap<span class="op">(</span>byrows<span class="op">),</span> threads</span>
<span id="cb14-294"><a href="#cb14-294" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb14-295"><a href="#cb14-295" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-296"><a href="#cb14-296" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Step 9: Bind Q blocks into final Q matrix</span></span>
<span id="cb14-297"><a href="#cb14-297" aria-hidden="true" tabindex="-1"></a>        strInPath <span class="op">=</span> strOutPath<span class="op">;</span> </span>
<span id="cb14-298"><a href="#cb14-298" aria-hidden="true" tabindex="-1"></a>        strOutPath <span class="op">=</span> <span class="st">"Step6"</span><span class="op">;</span></span>
<span id="cb14-299"><a href="#cb14-299" aria-hidden="true" tabindex="-1"></a>        blocks <span class="op">=</span> dsA<span class="op">-&gt;</span>getDatasetNames<span class="op">(</span>strInPath<span class="op">,</span> strdataset <span class="op">+</span> <span class="st">"."</span><span class="op">,</span> <span class="st">""</span><span class="op">);</span></span>
<span id="cb14-300"><a href="#cb14-300" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-301"><a href="#cb14-301" aria-hidden="true" tabindex="-1"></a>        RcppBind_datasets_hdf5<span class="op">(</span></span>
<span id="cb14-302"><a href="#cb14-302" aria-hidden="true" tabindex="-1"></a>            dsA<span class="op">-&gt;</span>getFileName<span class="op">(),</span> strInPath<span class="op">,</span> blocks<span class="op">,</span></span>
<span id="cb14-303"><a href="#cb14-303" aria-hidden="true" tabindex="-1"></a>            strOutPath<span class="op">,</span> strdataset <span class="op">+</span> <span class="st">"Q"</span><span class="op">,</span> <span class="st">"bindRows"</span><span class="op">,</span> </span>
<span id="cb14-304"><a href="#cb14-304" aria-hidden="true" tabindex="-1"></a>            <span class="kw">false</span><span class="op">,</span> wrap<span class="op">(</span>overwrite<span class="op">)</span></span>
<span id="cb14-305"><a href="#cb14-305" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb14-306"><a href="#cb14-306" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-307"><a href="#cb14-307" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">catch</span><span class="op">(</span><span class="bu">std::</span>exception<span class="op">&amp;</span> ex<span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-308"><a href="#cb14-308" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Critical: clean up pointers on error</span></span>
<span id="cb14-309"><a href="#cb14-309" aria-hidden="true" tabindex="-1"></a>        checkClose_file<span class="op">(</span>dsA<span class="op">,</span> dstmp<span class="op">);</span></span>
<span id="cb14-310"><a href="#cb14-310" aria-hidden="true" tabindex="-1"></a>        Rcout<span class="op">&lt;&lt;</span> <span class="st">"c++ exception getQRbyBlocks_rcpp: "</span><span class="op">&lt;&lt;</span> ex<span class="op">.</span>what<span class="op">()</span> <span class="op">&lt;&lt;</span> <span class="st">"</span><span class="sc">\n</span><span class="st">"</span><span class="op">;</span></span>
<span id="cb14-311"><a href="#cb14-311" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dt">void</span><span class="op">();</span></span>
<span id="cb14-312"><a href="#cb14-312" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb14-313"><a href="#cb14-313" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-314"><a href="#cb14-314" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dt">void</span><span class="op">();</span></span>
<span id="cb14-315"><a href="#cb14-315" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb14-316"><a href="#cb14-316" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-317"><a href="#cb14-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-318"><a href="#cb14-318" aria-hidden="true" tabindex="-1"></a><span class="fu">### Key Differences from R Implementation</span></span>
<span id="cb14-319"><a href="#cb14-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-320"><a href="#cb14-320" aria-hidden="true" tabindex="-1"></a>While the algorithm is identical, the C++ implementation requires explicit management of resources that R handles automatically.</span>
<span id="cb14-321"><a href="#cb14-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-322"><a href="#cb14-322" aria-hidden="true" tabindex="-1"></a>**Memory management:** Every <span class="in">`new hdf5Dataset`</span> requires matching <span class="in">`delete`</span>. The R version doesn't show this because R's garbage collector handles it. In C++, forgetting a <span class="in">`delete`</span> causes a memory leak—the HDF5 file handle stays open, consuming system resources. After thousands of operations, you run out of file handles and the system fails. The pattern <span class="in">`new → use → delete → set nullptr`</span> prevents this.</span>
<span id="cb14-323"><a href="#cb14-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-324"><a href="#cb14-324" aria-hidden="true" tabindex="-1"></a>**Exception handling:** The entire function body wraps in try/catch. If any operation fails—file not found, dataset doesn't exist, out of memory—the catch block cleans up allocated pointers before returning. Without this, an exception thrown by HDF5 would skip the <span class="in">`delete`</span> statements, causing memory leaks. R's error handling stops function execution and cleans up automatically; C++ requires explicit cleanup in exception paths.</span>
<span id="cb14-325"><a href="#cb14-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-326"><a href="#cb14-326" aria-hidden="true" tabindex="-1"></a>**Explicit string manipulation:** R's <span class="in">`paste0()`</span> and <span class="in">`gsub()`</span> are replaced by C++ string concatenation (<span class="in">`+`</span>) and std::string methods. The logic is identical, but syntax differs. C++ strings are mutable, allow efficient concatenation, but require more verbose operations than R's vectorized string functions.</span>
<span id="cb14-327"><a href="#cb14-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-328"><a href="#cb14-328" aria-hidden="true" tabindex="-1"></a>**Calling R functions from C++:** Functions like <span class="in">`RcppNormalizeHdf5`</span>, <span class="in">`RcppSplit_matrix_hdf5_internal`</span>, <span class="in">`RcppBind_datasets_hdf5`</span> are wrappers around BigDataStatMeth's R functions. This hybrid approach—C++ orchestration, R implementation—balances performance and maintainability. Writing pure C++ versions of these operations would require thousands of additional lines without significant performance gain because they already use compiled code internally.</span>
<span id="cb14-329"><a href="#cb14-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-330"><a href="#cb14-330" aria-hidden="true" tabindex="-1"></a>**Pointer checks:** Before deleting, we don't explicitly check <span class="in">`if (dstmp != nullptr)`</span> because we initialize to nullptr and only assign once. In more complex code with conditional allocation, always check before deleting. The <span class="in">`checkClose_file`</span> utility function handles this checking, ensuring we don't delete null pointers or already-deleted pointers.</span>
<span id="cb14-331"><a href="#cb14-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-332"><a href="#cb14-332" aria-hidden="true" tabindex="-1"></a>**Return type:** The function returns <span class="in">`void()`</span> rather than a value. It modifies the HDF5 file in place, with results stored at known locations. R users call this function for side effects (creating datasets in HDF5), not for return values. This design simplifies memory management—no need to allocate, populate, and return large matrices.</span>
<span id="cb14-333"><a href="#cb14-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-334"><a href="#cb14-334" aria-hidden="true" tabindex="-1"></a><span class="fu">### Why This Pattern Matters</span></span>
<span id="cb14-335"><a href="#cb14-335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-336"><a href="#cb14-336" aria-hidden="true" tabindex="-1"></a>This function demonstrates the fundamental pattern for all C++ implementations with BigDataStatMeth:</span>
<span id="cb14-337"><a href="#cb14-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-338"><a href="#cb14-338" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Initialize pointers to nullptr**</span>
<span id="cb14-339"><a href="#cb14-339" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Wrap logic in try block**</span>
<span id="cb14-340"><a href="#cb14-340" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Allocate with new, use, immediately delete when done**</span>
<span id="cb14-341"><a href="#cb14-341" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Catch exceptions, clean up, report error**</span>
<span id="cb14-342"><a href="#cb14-342" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>**Return void after modifying HDF5 file in place**</span>
<span id="cb14-343"><a href="#cb14-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-344"><a href="#cb14-344" aria-hidden="true" tabindex="-1"></a>This pattern prevents the three most common C++ failures: memory leaks (forgetting delete), crashes (accessing deleted pointers), and silent corruption (exceptions bypassing cleanup). Master this pattern, and you can implement any statistical method in C++ using BigDataStatMeth.</span>
<span id="cb14-345"><a href="#cb14-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-346"><a href="#cb14-346" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb14-347"><a href="#cb14-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-348"><a href="#cb14-348" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 2: Main CCA Function in C++</span></span>
<span id="cb14-349"><a href="#cb14-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-350"><a href="#cb14-350" aria-hidden="true" tabindex="-1"></a><span class="fu">### Orchestrating the Complete Algorithm</span></span>
<span id="cb14-351"><a href="#cb14-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-352"><a href="#cb14-352" aria-hidden="true" tabindex="-1"></a>The main CCA function coordinates QR decomposition for both matrices, computes their cross-product, performs SVD, and initiates coefficient computation:</span>
<span id="cb14-353"><a href="#cb14-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-354"><a href="#cb14-354" aria-hidden="true" tabindex="-1"></a><span class="in">```cpp</span></span>
<span id="cb14-355"><a href="#cb14-355" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb14-356"><a href="#cb14-356" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> bdCCA_hdf5_rcpp<span class="op">(</span><span class="bu">std::</span>string filename<span class="op">,</span> <span class="bu">std::</span>string datasetX<span class="op">,</span></span>
<span id="cb14-357"><a href="#cb14-357" aria-hidden="true" tabindex="-1"></a>                     <span class="bu">std::</span>string datasetY<span class="op">,</span> <span class="dt">bool</span> bcenter<span class="op">,</span> <span class="dt">bool</span> bscale<span class="op">,</span> </span>
<span id="cb14-358"><a href="#cb14-358" aria-hidden="true" tabindex="-1"></a>                     <span class="dt">int</span> mblocks<span class="op">,</span> <span class="dt">bool</span> overwrite<span class="op">,</span> </span>
<span id="cb14-359"><a href="#cb14-359" aria-hidden="true" tabindex="-1"></a>                     Rcpp<span class="op">::</span>Nullable<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> threads <span class="op">=</span> R_NilValue<span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-360"><a href="#cb14-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-361"><a href="#cb14-361" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Declare all pointers upfront, initialize to nullptr</span></span>
<span id="cb14-362"><a href="#cb14-362" aria-hidden="true" tabindex="-1"></a>    hdf5Dataset<span class="op">*</span> dsX <span class="op">=</span> <span class="kw">nullptr</span><span class="op">;</span></span>
<span id="cb14-363"><a href="#cb14-363" aria-hidden="true" tabindex="-1"></a>    hdf5Dataset<span class="op">*</span> dsY <span class="op">=</span> <span class="kw">nullptr</span><span class="op">;</span></span>
<span id="cb14-364"><a href="#cb14-364" aria-hidden="true" tabindex="-1"></a>    hdf5Dataset<span class="op">*</span> dsXQ <span class="op">=</span> <span class="kw">nullptr</span><span class="op">;</span></span>
<span id="cb14-365"><a href="#cb14-365" aria-hidden="true" tabindex="-1"></a>    hdf5Dataset<span class="op">*</span> dsYQ <span class="op">=</span> <span class="kw">nullptr</span><span class="op">;</span></span>
<span id="cb14-366"><a href="#cb14-366" aria-hidden="true" tabindex="-1"></a>    hdf5Dataset<span class="op">*</span> dsC <span class="op">=</span> <span class="kw">nullptr</span><span class="op">;</span></span>
<span id="cb14-367"><a href="#cb14-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-368"><a href="#cb14-368" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb14-369"><a href="#cb14-369" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-370"><a href="#cb14-370" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> ncolsX<span class="op">,</span> ncolsY<span class="op">;</span></span>
<span id="cb14-371"><a href="#cb14-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-372"><a href="#cb14-372" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Step 1: QR decomposition of X</span></span>
<span id="cb14-373"><a href="#cb14-373" aria-hidden="true" tabindex="-1"></a>        dsX <span class="op">=</span> <span class="kw">new</span> hdf5Dataset<span class="op">(</span>filename<span class="op">,</span> datasetX<span class="op">,</span> <span class="kw">false</span><span class="op">);</span> </span>
<span id="cb14-374"><a href="#cb14-374" aria-hidden="true" tabindex="-1"></a>        dsX<span class="op">-&gt;</span>openDataset<span class="op">();</span> </span>
<span id="cb14-375"><a href="#cb14-375" aria-hidden="true" tabindex="-1"></a>        getQRbyBlocks_rcpp<span class="op">(</span>dsX<span class="op">,</span> mblocks<span class="op">,</span> bcenter<span class="op">,</span> bscale<span class="op">,</span> </span>
<span id="cb14-376"><a href="#cb14-376" aria-hidden="true" tabindex="-1"></a>                          <span class="kw">false</span><span class="op">,</span> overwrite<span class="op">,</span> threads<span class="op">);</span></span>
<span id="cb14-377"><a href="#cb14-377" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-378"><a href="#cb14-378" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Step 2: QR decomposition of Y</span></span>
<span id="cb14-379"><a href="#cb14-379" aria-hidden="true" tabindex="-1"></a>        dsY <span class="op">=</span> <span class="kw">new</span> hdf5Dataset<span class="op">(</span>filename<span class="op">,</span> datasetY<span class="op">,</span> <span class="kw">false</span><span class="op">);</span> </span>
<span id="cb14-380"><a href="#cb14-380" aria-hidden="true" tabindex="-1"></a>        dsY<span class="op">-&gt;</span>openDataset<span class="op">();</span> </span>
<span id="cb14-381"><a href="#cb14-381" aria-hidden="true" tabindex="-1"></a>        getQRbyBlocks_rcpp<span class="op">(</span>dsY<span class="op">,</span> mblocks<span class="op">,</span> bcenter<span class="op">,</span> bscale<span class="op">,</span> </span>
<span id="cb14-382"><a href="#cb14-382" aria-hidden="true" tabindex="-1"></a>                          <span class="kw">false</span><span class="op">,</span> overwrite<span class="op">,</span> threads<span class="op">);</span></span>
<span id="cb14-383"><a href="#cb14-383" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-384"><a href="#cb14-384" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Step 3: Compute cross-product of Q matrices</span></span>
<span id="cb14-385"><a href="#cb14-385" aria-hidden="true" tabindex="-1"></a>        dsXQ <span class="op">=</span> <span class="kw">new</span> hdf5Dataset<span class="op">(</span>filename<span class="op">,</span> <span class="st">"Step6"</span><span class="op">,</span> <span class="st">"XQ"</span><span class="op">,</span> <span class="kw">false</span><span class="op">);</span> </span>
<span id="cb14-386"><a href="#cb14-386" aria-hidden="true" tabindex="-1"></a>        dsXQ<span class="op">-&gt;</span>openDataset<span class="op">();</span> </span>
<span id="cb14-387"><a href="#cb14-387" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-388"><a href="#cb14-388" aria-hidden="true" tabindex="-1"></a>        dsYQ <span class="op">=</span> <span class="kw">new</span> hdf5Dataset<span class="op">(</span>filename<span class="op">,</span> <span class="st">"Step6"</span><span class="op">,</span> <span class="st">"YQ"</span><span class="op">,</span> <span class="kw">false</span><span class="op">);</span> </span>
<span id="cb14-389"><a href="#cb14-389" aria-hidden="true" tabindex="-1"></a>        dsYQ<span class="op">-&gt;</span>openDataset<span class="op">();</span> </span>
<span id="cb14-390"><a href="#cb14-390" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-391"><a href="#cb14-391" aria-hidden="true" tabindex="-1"></a>        dsC <span class="op">=</span> <span class="kw">new</span> hdf5Dataset<span class="op">(</span>filename<span class="op">,</span> <span class="st">"Step7"</span><span class="op">,</span> </span>
<span id="cb14-392"><a href="#cb14-392" aria-hidden="true" tabindex="-1"></a>                             <span class="st">"CrossProd_XQ_YQ"</span><span class="op">,</span> overwrite<span class="op">);</span></span>
<span id="cb14-393"><a href="#cb14-393" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-394"><a href="#cb14-394" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Compute optimal block size for cross-product operation</span></span>
<span id="cb14-395"><a href="#cb14-395" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> optimBlock <span class="op">=</span> getMaxBlockSize<span class="op">(</span></span>
<span id="cb14-396"><a href="#cb14-396" aria-hidden="true" tabindex="-1"></a>            dsXQ<span class="op">-&gt;</span>nrows<span class="op">(),</span> dsXQ<span class="op">-&gt;</span>ncols<span class="op">(),</span> </span>
<span id="cb14-397"><a href="#cb14-397" aria-hidden="true" tabindex="-1"></a>            dsYQ<span class="op">-&gt;</span>nrows<span class="op">(),</span> dsYQ<span class="op">-&gt;</span>ncols<span class="op">(),</span> </span>
<span id="cb14-398"><a href="#cb14-398" aria-hidden="true" tabindex="-1"></a>            <span class="dv">2</span><span class="op">,</span> R_NilValue</span>
<span id="cb14-399"><a href="#cb14-399" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb14-400"><a href="#cb14-400" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-401"><a href="#cb14-401" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Perform cross-product: Q_X^T Q_Y</span></span>
<span id="cb14-402"><a href="#cb14-402" aria-hidden="true" tabindex="-1"></a>        dsC <span class="op">=</span> BigDataStatMeth<span class="op">::</span>crossprod<span class="op">(</span></span>
<span id="cb14-403"><a href="#cb14-403" aria-hidden="true" tabindex="-1"></a>            dsXQ<span class="op">,</span> dsYQ<span class="op">,</span> dsC<span class="op">,</span> </span>
<span id="cb14-404"><a href="#cb14-404" aria-hidden="true" tabindex="-1"></a>            optimBlock<span class="op">,</span> optimBlock<span class="op">/</span><span class="dv">2</span><span class="op">,</span> </span>
<span id="cb14-405"><a href="#cb14-405" aria-hidden="true" tabindex="-1"></a>            <span class="kw">true</span><span class="op">,</span> <span class="kw">true</span><span class="op">,</span> threads</span>
<span id="cb14-406"><a href="#cb14-406" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb14-407"><a href="#cb14-407" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-408"><a href="#cb14-408" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Clean up Q datasets - no longer needed</span></span>
<span id="cb14-409"><a href="#cb14-409" aria-hidden="true" tabindex="-1"></a>        <span class="kw">delete</span> dsXQ<span class="op">;</span> dsXQ <span class="op">=</span> <span class="kw">nullptr</span><span class="op">;</span></span>
<span id="cb14-410"><a href="#cb14-410" aria-hidden="true" tabindex="-1"></a>        <span class="kw">delete</span> dsYQ<span class="op">;</span> dsYQ <span class="op">=</span> <span class="kw">nullptr</span><span class="op">;</span></span>
<span id="cb14-411"><a href="#cb14-411" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-412"><a href="#cb14-412" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Store dimensions for coefficient computation</span></span>
<span id="cb14-413"><a href="#cb14-413" aria-hidden="true" tabindex="-1"></a>        ncolsX <span class="op">=</span> dsX<span class="op">-&gt;</span>ncols_r<span class="op">();</span></span>
<span id="cb14-414"><a href="#cb14-414" aria-hidden="true" tabindex="-1"></a>        ncolsY <span class="op">=</span> dsY<span class="op">-&gt;</span>ncols_r<span class="op">();</span></span>
<span id="cb14-415"><a href="#cb14-415" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-416"><a href="#cb14-416" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Step 4: SVD of cross-product matrix</span></span>
<span id="cb14-417"><a href="#cb14-417" aria-hidden="true" tabindex="-1"></a>        <span class="co">// This extracts canonical correlations and directions</span></span>
<span id="cb14-418"><a href="#cb14-418" aria-hidden="true" tabindex="-1"></a>        RcppbdSVD_hdf5<span class="op">(</span></span>
<span id="cb14-419"><a href="#cb14-419" aria-hidden="true" tabindex="-1"></a>            dsC<span class="op">-&gt;</span>getFileName<span class="op">(),</span> dsC<span class="op">-&gt;</span>getGroupName<span class="op">(),</span> </span>
<span id="cb14-420"><a href="#cb14-420" aria-hidden="true" tabindex="-1"></a>            dsC<span class="op">-&gt;</span>getDatasetName<span class="op">(),</span>  </span>
<span id="cb14-421"><a href="#cb14-421" aria-hidden="true" tabindex="-1"></a>            <span class="dv">16</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="kw">false</span><span class="op">,</span> <span class="kw">false</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> </span>
<span id="cb14-422"><a href="#cb14-422" aria-hidden="true" tabindex="-1"></a>            overwrite<span class="op">,</span> <span class="kw">false</span><span class="op">,</span> R_NilValue<span class="op">,</span> R_NilValue</span>
<span id="cb14-423"><a href="#cb14-423" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb14-424"><a href="#cb14-424" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-425"><a href="#cb14-425" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Clean up cross-product dataset</span></span>
<span id="cb14-426"><a href="#cb14-426" aria-hidden="true" tabindex="-1"></a>        <span class="kw">delete</span> dsC<span class="op">;</span> dsC <span class="op">=</span> <span class="kw">nullptr</span><span class="op">;</span></span>
<span id="cb14-427"><a href="#cb14-427" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-428"><a href="#cb14-428" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Clean up X and Y datasets</span></span>
<span id="cb14-429"><a href="#cb14-429" aria-hidden="true" tabindex="-1"></a>        <span class="kw">delete</span> dsX<span class="op">;</span> dsX <span class="op">=</span> <span class="kw">nullptr</span><span class="op">;</span></span>
<span id="cb14-430"><a href="#cb14-430" aria-hidden="true" tabindex="-1"></a>        <span class="kw">delete</span> dsY<span class="op">;</span> dsY <span class="op">=</span> <span class="kw">nullptr</span><span class="op">;</span></span>
<span id="cb14-431"><a href="#cb14-431" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-432"><a href="#cb14-432" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Step 5: Compute canonical coefficients and variates</span></span>
<span id="cb14-433"><a href="#cb14-433" aria-hidden="true" tabindex="-1"></a>        <span class="co">// This function is implemented in R for flexibility</span></span>
<span id="cb14-434"><a href="#cb14-434" aria-hidden="true" tabindex="-1"></a>        writeCCAComponents_hdf5_rcpp<span class="op">(</span>filename<span class="op">,</span> ncolsX<span class="op">,</span> ncolsY<span class="op">);</span></span>
<span id="cb14-435"><a href="#cb14-435" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-436"><a href="#cb14-436" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">catch</span><span class="op">(</span><span class="bu">std::</span>exception<span class="op">&amp;</span> ex<span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-437"><a href="#cb14-437" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Critical: clean up all pointers on error</span></span>
<span id="cb14-438"><a href="#cb14-438" aria-hidden="true" tabindex="-1"></a>        checkClose_file<span class="op">(</span>dsX<span class="op">,</span> dsY<span class="op">,</span> dsXQ<span class="op">,</span> dsYQ<span class="op">,</span> dsC<span class="op">);</span></span>
<span id="cb14-439"><a href="#cb14-439" aria-hidden="true" tabindex="-1"></a>        Rcerr<span class="op">&lt;&lt;</span> <span class="st">"</span><span class="sc">\n</span><span class="st"> c++ exception bdCCA_hdf5_rcpp: "</span><span class="op">&lt;&lt;</span> ex<span class="op">.</span>what<span class="op">()</span> <span class="op">&lt;&lt;</span> <span class="st">"</span><span class="sc">\n</span><span class="st">"</span><span class="op">;</span></span>
<span id="cb14-440"><a href="#cb14-440" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dt">void</span><span class="op">();</span></span>
<span id="cb14-441"><a href="#cb14-441" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb14-442"><a href="#cb14-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-443"><a href="#cb14-443" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dt">void</span><span class="op">();</span></span>
<span id="cb14-444"><a href="#cb14-444" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb14-445"><a href="#cb14-445" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-446"><a href="#cb14-446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-447"><a href="#cb14-447" aria-hidden="true" tabindex="-1"></a><span class="fu">### Understanding the Implementation</span></span>
<span id="cb14-448"><a href="#cb14-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-449"><a href="#cb14-449" aria-hidden="true" tabindex="-1"></a>This function demonstrates orchestration patterns essential for complex C++ algorithms.</span>
<span id="cb14-450"><a href="#cb14-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-451"><a href="#cb14-451" aria-hidden="true" tabindex="-1"></a>**Sequential cleanup:** After each step, we delete pointers no longer needed. After computing cross-product, we delete dsXQ and dsYQ—the Q matrices were used, results stored, pointers can be freed. This progressive cleanup minimizes memory usage. Contrast with keeping all pointers until the end—memory usage grows throughout the function. In production with many concurrent CCA calls, aggressive cleanup prevents memory exhaustion.</span>
<span id="cb14-452"><a href="#cb14-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-453"><a href="#cb14-453" aria-hidden="true" tabindex="-1"></a>**`[[Rcpp::export]]` annotation:** This tells Rcpp to make the function callable from R. Without it, the function compiles but R can't call it. The annotation generates wrapper code converting R data types (strings, booleans, integers) to C++ types and vice versa. This is why we can call <span class="in">`bdCCA_hdf5_rcpp(filename, "data/X", "data/Y", ...)`</span> from R—Rcpp handles the type conversion automatically.</span>
<span id="cb14-454"><a href="#cb14-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-455"><a href="#cb14-455" aria-hidden="true" tabindex="-1"></a>**Error propagation:** If <span class="in">`getQRbyBlocks_rcpp`</span> throws an exception for X, the catch block activates, cleans up dsX, and returns without attempting Y's QR decomposition. This prevents cascading errors where failure in step N causes nonsensical errors in step N+1. The error message identifies which operation failed, critical for debugging.</span>
<span id="cb14-456"><a href="#cb14-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-457"><a href="#cb14-457" aria-hidden="true" tabindex="-1"></a>**Calling R functions from C++:** The <span class="in">`writeCCAComponents_hdf5_rcpp`</span> function (shown next) calls an R implementation. This hybrid approach is pragmatic—computing coefficients requires solving triangular systems, matrix multiplications, and HDF5 I/O for storing results. The R implementation already does this correctly. Rather than rewrite in pure C++, we call the R function. The performance difference is negligible because the computationally intensive parts (solving systems, matrix multiplications) use compiled BLAS/LAPACK regardless of whether called from R or C++.</span>
<span id="cb14-458"><a href="#cb14-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-459"><a href="#cb14-459" aria-hidden="true" tabindex="-1"></a>**Block size optimization:** The <span class="in">`getMaxBlockSize`</span> function dynamically determines optimal block size based on matrix dimensions and available memory. Hardcoding block size works for fixed data sizes but fails when dimensions vary. Adaptive block sizing ensures the function works efficiently across diverse datasets without user tuning.</span>
<span id="cb14-460"><a href="#cb14-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-461"><a href="#cb14-461" aria-hidden="true" tabindex="-1"></a>**Memory failure handling:** If <span class="in">`new`</span> fails (out of memory), C++ throws <span class="in">`std::bad_alloc`</span>. Our catch block catches this (it's a <span class="in">`std::exception`</span> subclass), reports the error, and returns cleanly. Without exception handling, an allocation failure crashes the entire R session—unacceptable in production. Proper error handling degrades gracefully: report error, clean up, return, let user diagnose.</span>
<span id="cb14-462"><a href="#cb14-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-463"><a href="#cb14-463" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb14-464"><a href="#cb14-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-465"><a href="#cb14-465" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 3: Computing Canonical Coefficients</span></span>
<span id="cb14-466"><a href="#cb14-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-467"><a href="#cb14-467" aria-hidden="true" tabindex="-1"></a><span class="fu">### Option A: Calling R Function (Pragmatic Approach)</span></span>
<span id="cb14-468"><a href="#cb14-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-469"><a href="#cb14-469" aria-hidden="true" tabindex="-1"></a>The simplest and most maintainable approach is calling the existing R implementation:</span>
<span id="cb14-470"><a href="#cb14-470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-471"><a href="#cb14-471" aria-hidden="true" tabindex="-1"></a><span class="in">```cpp</span></span>
<span id="cb14-472"><a href="#cb14-472" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> writeCCAComponents_hdf5_rcpp<span class="op">(</span><span class="bu">std::</span>string filename<span class="op">,</span> </span>
<span id="cb14-473"><a href="#cb14-473" aria-hidden="true" tabindex="-1"></a>                                   <span class="dt">int</span> ncolsX<span class="op">,</span> <span class="dt">int</span> ncolsY<span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-474"><a href="#cb14-474" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-475"><a href="#cb14-475" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Access R environment where function exists</span></span>
<span id="cb14-476"><a href="#cb14-476" aria-hidden="true" tabindex="-1"></a>    Rcpp<span class="op">::</span>Environment base<span class="op">(</span><span class="st">"package:BDStatMethExamples"</span><span class="op">);</span> </span>
<span id="cb14-477"><a href="#cb14-477" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-478"><a href="#cb14-478" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Get R function object</span></span>
<span id="cb14-479"><a href="#cb14-479" aria-hidden="true" tabindex="-1"></a>    Rcpp<span class="op">::</span>Function write_components <span class="op">=</span> base<span class="op">[</span><span class="st">"writeCCAComponents_hdf5"</span><span class="op">];</span>    </span>
<span id="cb14-480"><a href="#cb14-480" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-481"><a href="#cb14-481" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Call R function with C++ arguments</span></span>
<span id="cb14-482"><a href="#cb14-482" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Rcpp automatically converts int → numeric, string → character</span></span>
<span id="cb14-483"><a href="#cb14-483" aria-hidden="true" tabindex="-1"></a>    write_components<span class="op">(</span></span>
<span id="cb14-484"><a href="#cb14-484" aria-hidden="true" tabindex="-1"></a>        Rcpp<span class="op">::</span>_<span class="op">[</span><span class="st">"filename"</span><span class="op">]</span> <span class="op">=</span> wrap<span class="op">(</span>filename<span class="op">),</span></span>
<span id="cb14-485"><a href="#cb14-485" aria-hidden="true" tabindex="-1"></a>        Rcpp<span class="op">::</span>_<span class="op">[</span><span class="st">"ncolsX"</span><span class="op">]</span>  <span class="op">=</span> ncolsX<span class="op">,</span></span>
<span id="cb14-486"><a href="#cb14-486" aria-hidden="true" tabindex="-1"></a>        Rcpp<span class="op">::</span>_<span class="op">[</span><span class="st">"ncolsY"</span><span class="op">]</span>  <span class="op">=</span> ncolsY</span>
<span id="cb14-487"><a href="#cb14-487" aria-hidden="true" tabindex="-1"></a>    <span class="op">);</span> </span>
<span id="cb14-488"><a href="#cb14-488" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-489"><a href="#cb14-489" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dt">void</span><span class="op">();</span></span>
<span id="cb14-490"><a href="#cb14-490" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb14-491"><a href="#cb14-491" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-492"><a href="#cb14-492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-493"><a href="#cb14-493" aria-hidden="true" tabindex="-1"></a>This approach has significant advantages:</span>
<span id="cb14-494"><a href="#cb14-494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-495"><a href="#cb14-495" aria-hidden="true" tabindex="-1"></a>**Maintainability:** The R function is already tested, documented, handles edge cases. If you find a bug or need to add features, you fix it in one place (R) and both R and C++ code benefit. Duplicating logic in C++ means duplicating maintenance effort.</span>
<span id="cb14-496"><a href="#cb14-496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-497"><a href="#cb14-497" aria-hidden="true" tabindex="-1"></a>**Flexibility:** The R function can easily use R's statistical functions, plotting capabilities, diagnostic output. Reimplementing all of that in C++ would be massive effort. By calling R, you get that functionality "for free."</span>
<span id="cb14-498"><a href="#cb14-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-499"><a href="#cb14-499" aria-hidden="true" tabindex="-1"></a>**Performance reality:** The computationally intensive parts—solving triangular systems with BLAS, matrix multiplication—use compiled code whether called from R or C++. The overhead of the R function call is negligible compared to the actual computation time. Only if profiling shows this specific function as a bottleneck would pure C++ implementation be justified.</span>
<span id="cb14-500"><a href="#cb14-500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-501"><a href="#cb14-501" aria-hidden="true" tabindex="-1"></a>**Development speed:** This approach took 10 lines of code. A pure C++ implementation would take hundreds of lines plus extensive testing. Unless you need that pure C++ version for specific deployment reasons, this pragmatic approach is superior.</span>
<span id="cb14-502"><a href="#cb14-502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-503"><a href="#cb14-503" aria-hidden="true" tabindex="-1"></a><span class="fu">### Option B: Pure C++ Implementation (For Reference)</span></span>
<span id="cb14-504"><a href="#cb14-504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-505"><a href="#cb14-505" aria-hidden="true" tabindex="-1"></a>For completeness, here's how you'd implement coefficient computation in pure C++. This is shown for educational purposes—most users should use Option A.</span>
<span id="cb14-506"><a href="#cb14-506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-507"><a href="#cb14-507" aria-hidden="true" tabindex="-1"></a><span class="in">```cpp</span></span>
<span id="cb14-508"><a href="#cb14-508" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> writeCCAComponents_hdf5_cpp<span class="op">(</span><span class="bu">std::</span>string filename<span class="op">,</span> </span>
<span id="cb14-509"><a href="#cb14-509" aria-hidden="true" tabindex="-1"></a>                                  <span class="dt">int</span> ncolsX<span class="op">,</span> <span class="dt">int</span> ncolsY<span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-510"><a href="#cb14-510" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-511"><a href="#cb14-511" aria-hidden="true" tabindex="-1"></a>    hdf5Dataset<span class="op">*</span> dstmpX <span class="op">=</span> <span class="kw">nullptr</span><span class="op">;</span></span>
<span id="cb14-512"><a href="#cb14-512" aria-hidden="true" tabindex="-1"></a>    hdf5Dataset<span class="op">*</span> dstmpY <span class="op">=</span> <span class="kw">nullptr</span><span class="op">;</span></span>
<span id="cb14-513"><a href="#cb14-513" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-514"><a href="#cb14-514" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">hsize_t</span><span class="op">&gt;</span> stride <span class="op">=</span> <span class="op">{</span><span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">};</span></span>
<span id="cb14-515"><a href="#cb14-515" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">hsize_t</span><span class="op">&gt;</span> block <span class="op">=</span> <span class="op">{</span><span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">};</span></span>
<span id="cb14-516"><a href="#cb14-516" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-517"><a href="#cb14-517" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb14-518"><a href="#cb14-518" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-519"><a href="#cb14-519" aria-hidden="true" tabindex="-1"></a>        <span class="dt">hsize_t</span> nX <span class="op">=</span> <span class="kw">static_cast</span><span class="op">&lt;</span><span class="dt">hsize_t</span><span class="op">&gt;(</span>ncolsX<span class="op">);</span></span>
<span id="cb14-520"><a href="#cb14-520" aria-hidden="true" tabindex="-1"></a>        <span class="dt">hsize_t</span> nY <span class="op">=</span> <span class="kw">static_cast</span><span class="op">&lt;</span><span class="dt">hsize_t</span><span class="op">&gt;(</span>ncolsY<span class="op">);</span></span>
<span id="cb14-521"><a href="#cb14-521" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-522"><a href="#cb14-522" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Allocate storage for Q and R matrices</span></span>
<span id="cb14-523"><a href="#cb14-523" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> vdXQ<span class="op">(</span>nX <span class="op">*</span> nX<span class="op">);</span></span>
<span id="cb14-524"><a href="#cb14-524" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> vdYQ<span class="op">(</span>nY <span class="op">*</span> nY<span class="op">);</span></span>
<span id="cb14-525"><a href="#cb14-525" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> vdXR<span class="op">(</span>nX <span class="op">*</span> nX<span class="op">);</span></span>
<span id="cb14-526"><a href="#cb14-526" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> vdYR<span class="op">(</span>nY <span class="op">*</span> nY<span class="op">);</span></span>
<span id="cb14-527"><a href="#cb14-527" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-528"><a href="#cb14-528" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Read X components</span></span>
<span id="cb14-529"><a href="#cb14-529" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb14-530"><a href="#cb14-530" aria-hidden="true" tabindex="-1"></a>            dstmpX <span class="op">=</span> <span class="kw">new</span> hdf5Dataset<span class="op">(</span>filename<span class="op">,</span> <span class="st">"Step6/XQ"</span><span class="op">,</span> <span class="kw">false</span><span class="op">);</span>  </span>
<span id="cb14-531"><a href="#cb14-531" aria-hidden="true" tabindex="-1"></a>            dstmpX<span class="op">-&gt;</span>openDataset<span class="op">();</span></span>
<span id="cb14-532"><a href="#cb14-532" aria-hidden="true" tabindex="-1"></a>            dstmpX<span class="op">-&gt;</span>readDatasetBlock<span class="op">(</span></span>
<span id="cb14-533"><a href="#cb14-533" aria-hidden="true" tabindex="-1"></a>                <span class="op">{</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">},</span> <span class="op">{</span>nX<span class="op">,</span> nX<span class="op">},</span> stride<span class="op">,</span> block<span class="op">,</span> vdXQ<span class="op">.</span>data<span class="op">()</span></span>
<span id="cb14-534"><a href="#cb14-534" aria-hidden="true" tabindex="-1"></a>            <span class="op">);</span></span>
<span id="cb14-535"><a href="#cb14-535" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb14-536"><a href="#cb14-536" aria-hidden="true" tabindex="-1"></a>            dstmpY <span class="op">=</span> <span class="kw">new</span> hdf5Dataset<span class="op">(</span>filename<span class="op">,</span> <span class="st">"Step6/YQ"</span><span class="op">,</span> <span class="kw">false</span><span class="op">);</span> </span>
<span id="cb14-537"><a href="#cb14-537" aria-hidden="true" tabindex="-1"></a>            dstmpY<span class="op">-&gt;</span>openDataset<span class="op">();</span></span>
<span id="cb14-538"><a href="#cb14-538" aria-hidden="true" tabindex="-1"></a>            dstmpY<span class="op">-&gt;</span>readDatasetBlock<span class="op">(</span></span>
<span id="cb14-539"><a href="#cb14-539" aria-hidden="true" tabindex="-1"></a>                <span class="op">{</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">},</span> <span class="op">{</span>nY<span class="op">,</span> nY<span class="op">},</span> stride<span class="op">,</span> block<span class="op">,</span> vdYQ<span class="op">.</span>data<span class="op">()</span></span>
<span id="cb14-540"><a href="#cb14-540" aria-hidden="true" tabindex="-1"></a>            <span class="op">);</span></span>
<span id="cb14-541"><a href="#cb14-541" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb14-542"><a href="#cb14-542" aria-hidden="true" tabindex="-1"></a>            <span class="kw">delete</span> dstmpX<span class="op">;</span> dstmpX <span class="op">=</span> <span class="kw">nullptr</span><span class="op">;</span></span>
<span id="cb14-543"><a href="#cb14-543" aria-hidden="true" tabindex="-1"></a>            <span class="kw">delete</span> dstmpY<span class="op">;</span> dstmpY <span class="op">=</span> <span class="kw">nullptr</span><span class="op">;</span></span>
<span id="cb14-544"><a href="#cb14-544" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb14-545"><a href="#cb14-545" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Read R matrices</span></span>
<span id="cb14-546"><a href="#cb14-546" aria-hidden="true" tabindex="-1"></a>            dstmpX <span class="op">=</span> <span class="kw">new</span> hdf5Dataset<span class="op">(</span>filename<span class="op">,</span> </span>
<span id="cb14-547"><a href="#cb14-547" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">"Step3/Final_QR/XRt.R"</span><span class="op">,</span> <span class="kw">false</span><span class="op">);</span> </span>
<span id="cb14-548"><a href="#cb14-548" aria-hidden="true" tabindex="-1"></a>            dstmpX<span class="op">-&gt;</span>openDataset<span class="op">();</span></span>
<span id="cb14-549"><a href="#cb14-549" aria-hidden="true" tabindex="-1"></a>            dstmpX<span class="op">-&gt;</span>readDatasetBlock<span class="op">(</span></span>
<span id="cb14-550"><a href="#cb14-550" aria-hidden="true" tabindex="-1"></a>                <span class="op">{</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">},</span> <span class="op">{</span>nX<span class="op">,</span> nX<span class="op">},</span> stride<span class="op">,</span> block<span class="op">,</span> vdXR<span class="op">.</span>data<span class="op">()</span></span>
<span id="cb14-551"><a href="#cb14-551" aria-hidden="true" tabindex="-1"></a>            <span class="op">);</span></span>
<span id="cb14-552"><a href="#cb14-552" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb14-553"><a href="#cb14-553" aria-hidden="true" tabindex="-1"></a>            dstmpY <span class="op">=</span> <span class="kw">new</span> hdf5Dataset<span class="op">(</span>filename<span class="op">,</span> </span>
<span id="cb14-554"><a href="#cb14-554" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">"Step3/Final_QR/YRt.R"</span><span class="op">,</span> <span class="kw">false</span><span class="op">);</span> </span>
<span id="cb14-555"><a href="#cb14-555" aria-hidden="true" tabindex="-1"></a>            dstmpY<span class="op">-&gt;</span>openDataset<span class="op">();</span></span>
<span id="cb14-556"><a href="#cb14-556" aria-hidden="true" tabindex="-1"></a>            dstmpY<span class="op">-&gt;</span>readDatasetBlock<span class="op">(</span></span>
<span id="cb14-557"><a href="#cb14-557" aria-hidden="true" tabindex="-1"></a>                <span class="op">{</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">},</span> <span class="op">{</span>nY<span class="op">,</span> nY<span class="op">},</span> stride<span class="op">,</span> block<span class="op">,</span> vdYR<span class="op">.</span>data<span class="op">()</span></span>
<span id="cb14-558"><a href="#cb14-558" aria-hidden="true" tabindex="-1"></a>            <span class="op">);</span></span>
<span id="cb14-559"><a href="#cb14-559" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb14-560"><a href="#cb14-560" aria-hidden="true" tabindex="-1"></a>            <span class="kw">delete</span> dstmpX<span class="op">;</span> dstmpX <span class="op">=</span> <span class="kw">nullptr</span><span class="op">;</span></span>
<span id="cb14-561"><a href="#cb14-561" aria-hidden="true" tabindex="-1"></a>            <span class="kw">delete</span> dstmpY<span class="op">;</span> dstmpY <span class="op">=</span> <span class="kw">nullptr</span><span class="op">;</span></span>
<span id="cb14-562"><a href="#cb14-562" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb14-563"><a href="#cb14-563" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-564"><a href="#cb14-564" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Map to Eigen matrices for linear algebra</span></span>
<span id="cb14-565"><a href="#cb14-565" aria-hidden="true" tabindex="-1"></a>        Eigen<span class="op">::</span>Map<span class="op">&lt;</span>Eigen<span class="op">::</span>Matrix<span class="op">&lt;</span><span class="dt">double</span><span class="op">,</span> Eigen<span class="op">::</span>Dynamic<span class="op">,</span> Eigen<span class="op">::</span>Dynamic<span class="op">,</span> </span>
<span id="cb14-566"><a href="#cb14-566" aria-hidden="true" tabindex="-1"></a>                                 Eigen<span class="op">::</span>ColMajor<span class="op">&gt;&gt;</span> </span>
<span id="cb14-567"><a href="#cb14-567" aria-hidden="true" tabindex="-1"></a>            XQ<span class="op">(</span>vdXQ<span class="op">.</span>data<span class="op">(),</span> nX<span class="op">,</span> nX<span class="op">);</span></span>
<span id="cb14-568"><a href="#cb14-568" aria-hidden="true" tabindex="-1"></a>        Eigen<span class="op">::</span>Map<span class="op">&lt;</span>Eigen<span class="op">::</span>Matrix<span class="op">&lt;</span><span class="dt">double</span><span class="op">,</span> Eigen<span class="op">::</span>Dynamic<span class="op">,</span> Eigen<span class="op">::</span>Dynamic<span class="op">,</span> </span>
<span id="cb14-569"><a href="#cb14-569" aria-hidden="true" tabindex="-1"></a>                                 Eigen<span class="op">::</span>ColMajor<span class="op">&gt;&gt;</span> </span>
<span id="cb14-570"><a href="#cb14-570" aria-hidden="true" tabindex="-1"></a>            YQ<span class="op">(</span>vdYQ<span class="op">.</span>data<span class="op">(),</span> nY<span class="op">,</span> nY<span class="op">);</span></span>
<span id="cb14-571"><a href="#cb14-571" aria-hidden="true" tabindex="-1"></a>        Eigen<span class="op">::</span>Map<span class="op">&lt;</span>Eigen<span class="op">::</span>Matrix<span class="op">&lt;</span><span class="dt">double</span><span class="op">,</span> Eigen<span class="op">::</span>Dynamic<span class="op">,</span> Eigen<span class="op">::</span>Dynamic<span class="op">,</span> </span>
<span id="cb14-572"><a href="#cb14-572" aria-hidden="true" tabindex="-1"></a>                                 Eigen<span class="op">::</span>ColMajor<span class="op">&gt;&gt;</span> </span>
<span id="cb14-573"><a href="#cb14-573" aria-hidden="true" tabindex="-1"></a>            XR<span class="op">(</span>vdXR<span class="op">.</span>data<span class="op">(),</span> nX<span class="op">,</span> nX<span class="op">);</span></span>
<span id="cb14-574"><a href="#cb14-574" aria-hidden="true" tabindex="-1"></a>        Eigen<span class="op">::</span>Map<span class="op">&lt;</span>Eigen<span class="op">::</span>Matrix<span class="op">&lt;</span><span class="dt">double</span><span class="op">,</span> Eigen<span class="op">::</span>Dynamic<span class="op">,</span> Eigen<span class="op">::</span>Dynamic<span class="op">,</span> </span>
<span id="cb14-575"><a href="#cb14-575" aria-hidden="true" tabindex="-1"></a>                                 Eigen<span class="op">::</span>ColMajor<span class="op">&gt;&gt;</span> </span>
<span id="cb14-576"><a href="#cb14-576" aria-hidden="true" tabindex="-1"></a>            YR<span class="op">(</span>vdYR<span class="op">.</span>data<span class="op">(),</span> nY<span class="op">,</span> nY<span class="op">);</span></span>
<span id="cb14-577"><a href="#cb14-577" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-578"><a href="#cb14-578" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Combine Q and R into single triangular representation</span></span>
<span id="cb14-579"><a href="#cb14-579" aria-hidden="true" tabindex="-1"></a>        Eigen<span class="op">::</span>MatrixXd XQR <span class="op">=</span> Eigen<span class="op">::</span>MatrixXd<span class="op">::</span>Zero<span class="op">(</span>nX<span class="op">,</span> nX<span class="op">);</span></span>
<span id="cb14-580"><a href="#cb14-580" aria-hidden="true" tabindex="-1"></a>        Eigen<span class="op">::</span>MatrixXd YQR <span class="op">=</span> Eigen<span class="op">::</span>MatrixXd<span class="op">::</span>Zero<span class="op">(</span>nY<span class="op">,</span> nY<span class="op">);</span></span>
<span id="cb14-581"><a href="#cb14-581" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-582"><a href="#cb14-582" aria-hidden="true" tabindex="-1"></a>        XQR<span class="op">.</span>triangularView<span class="op">&lt;</span>Eigen<span class="op">::</span>Upper<span class="op">&gt;()</span> <span class="op">=</span> XR<span class="op">.</span>triangularView<span class="op">&lt;</span>Eigen<span class="op">::</span>Upper<span class="op">&gt;();</span></span>
<span id="cb14-583"><a href="#cb14-583" aria-hidden="true" tabindex="-1"></a>        XQR<span class="op">.</span>triangularView<span class="op">&lt;</span>Eigen<span class="op">::</span>StrictlyLower<span class="op">&gt;()</span> <span class="op">=</span> XQ<span class="op">.</span>triangularView<span class="op">&lt;</span>Eigen<span class="op">::</span>StrictlyLower<span class="op">&gt;();</span></span>
<span id="cb14-584"><a href="#cb14-584" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-585"><a href="#cb14-585" aria-hidden="true" tabindex="-1"></a>        YQR<span class="op">.</span>triangularView<span class="op">&lt;</span>Eigen<span class="op">::</span>Upper<span class="op">&gt;()</span> <span class="op">=</span> YR<span class="op">.</span>triangularView<span class="op">&lt;</span>Eigen<span class="op">::</span>Upper<span class="op">&gt;();</span></span>
<span id="cb14-586"><a href="#cb14-586" aria-hidden="true" tabindex="-1"></a>        YQR<span class="op">.</span>triangularView<span class="op">&lt;</span>Eigen<span class="op">::</span>StrictlyLower<span class="op">&gt;()</span> <span class="op">=</span> YQ<span class="op">.</span>triangularView<span class="op">&lt;</span>Eigen<span class="op">::</span>StrictlyLower<span class="op">&gt;();</span></span>
<span id="cb14-587"><a href="#cb14-587" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-588"><a href="#cb14-588" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Read SVD results (U, V matrices)</span></span>
<span id="cb14-589"><a href="#cb14-589" aria-hidden="true" tabindex="-1"></a>        dstmpX <span class="op">=</span> <span class="kw">new</span> hdf5Dataset<span class="op">(</span>filename<span class="op">,</span> </span>
<span id="cb14-590"><a href="#cb14-590" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"SVD/CrossProd_XQ_YQ/u"</span><span class="op">,</span> <span class="kw">false</span><span class="op">);</span> </span>
<span id="cb14-591"><a href="#cb14-591" aria-hidden="true" tabindex="-1"></a>        dstmpX<span class="op">-&gt;</span>openDataset<span class="op">();</span></span>
<span id="cb14-592"><a href="#cb14-592" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> nu_rows <span class="op">=</span> dstmpX<span class="op">-&gt;</span>nrows<span class="op">();</span></span>
<span id="cb14-593"><a href="#cb14-593" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> nu_cols <span class="op">=</span> dstmpX<span class="op">-&gt;</span>ncols<span class="op">();</span></span>
<span id="cb14-594"><a href="#cb14-594" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> vdU<span class="op">(</span>nu_rows <span class="op">*</span> nu_cols<span class="op">);</span></span>
<span id="cb14-595"><a href="#cb14-595" aria-hidden="true" tabindex="-1"></a>        dstmpX<span class="op">-&gt;</span>readDatasetBlock<span class="op">(</span></span>
<span id="cb14-596"><a href="#cb14-596" aria-hidden="true" tabindex="-1"></a>            <span class="op">{</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">},</span> <span class="op">{(</span><span class="dt">hsize_t</span><span class="op">)</span>nu_rows<span class="op">,</span> <span class="op">(</span><span class="dt">hsize_t</span><span class="op">)</span>nu_cols<span class="op">},</span> </span>
<span id="cb14-597"><a href="#cb14-597" aria-hidden="true" tabindex="-1"></a>            stride<span class="op">,</span> block<span class="op">,</span> vdU<span class="op">.</span>data<span class="op">()</span></span>
<span id="cb14-598"><a href="#cb14-598" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb14-599"><a href="#cb14-599" aria-hidden="true" tabindex="-1"></a>        <span class="kw">delete</span> dstmpX<span class="op">;</span> dstmpX <span class="op">=</span> <span class="kw">nullptr</span><span class="op">;</span></span>
<span id="cb14-600"><a href="#cb14-600" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-601"><a href="#cb14-601" aria-hidden="true" tabindex="-1"></a>        dstmpY <span class="op">=</span> <span class="kw">new</span> hdf5Dataset<span class="op">(</span>filename<span class="op">,</span> </span>
<span id="cb14-602"><a href="#cb14-602" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"SVD/CrossProd_XQ_YQ/v"</span><span class="op">,</span> <span class="kw">false</span><span class="op">);</span> </span>
<span id="cb14-603"><a href="#cb14-603" aria-hidden="true" tabindex="-1"></a>        dstmpY<span class="op">-&gt;</span>openDataset<span class="op">();</span></span>
<span id="cb14-604"><a href="#cb14-604" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> nv_rows <span class="op">=</span> dstmpY<span class="op">-&gt;</span>nrows<span class="op">();</span></span>
<span id="cb14-605"><a href="#cb14-605" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> nv_cols <span class="op">=</span> dstmpY<span class="op">-&gt;</span>ncols<span class="op">();</span></span>
<span id="cb14-606"><a href="#cb14-606" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> vdV<span class="op">(</span>nv_rows <span class="op">*</span> nv_cols<span class="op">);</span></span>
<span id="cb14-607"><a href="#cb14-607" aria-hidden="true" tabindex="-1"></a>        dstmpY<span class="op">-&gt;</span>readDatasetBlock<span class="op">(</span></span>
<span id="cb14-608"><a href="#cb14-608" aria-hidden="true" tabindex="-1"></a>            <span class="op">{</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">},</span> <span class="op">{(</span><span class="dt">hsize_t</span><span class="op">)</span>nv_rows<span class="op">,</span> <span class="op">(</span><span class="dt">hsize_t</span><span class="op">)</span>nv_cols<span class="op">},</span> </span>
<span id="cb14-609"><a href="#cb14-609" aria-hidden="true" tabindex="-1"></a>            stride<span class="op">,</span> block<span class="op">,</span> vdV<span class="op">.</span>data<span class="op">()</span></span>
<span id="cb14-610"><a href="#cb14-610" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb14-611"><a href="#cb14-611" aria-hidden="true" tabindex="-1"></a>        <span class="kw">delete</span> dstmpY<span class="op">;</span> dstmpY <span class="op">=</span> <span class="kw">nullptr</span><span class="op">;</span></span>
<span id="cb14-612"><a href="#cb14-612" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-613"><a href="#cb14-613" aria-hidden="true" tabindex="-1"></a>        Eigen<span class="op">::</span>Map<span class="op">&lt;</span>Eigen<span class="op">::</span>Matrix<span class="op">&lt;</span><span class="dt">double</span><span class="op">,</span> Eigen<span class="op">::</span>Dynamic<span class="op">,</span> Eigen<span class="op">::</span>Dynamic<span class="op">,</span> </span>
<span id="cb14-614"><a href="#cb14-614" aria-hidden="true" tabindex="-1"></a>                                 Eigen<span class="op">::</span>ColMajor<span class="op">&gt;&gt;</span> </span>
<span id="cb14-615"><a href="#cb14-615" aria-hidden="true" tabindex="-1"></a>            U<span class="op">(</span>vdU<span class="op">.</span>data<span class="op">(),</span> nu_rows<span class="op">,</span> nu_cols<span class="op">);</span></span>
<span id="cb14-616"><a href="#cb14-616" aria-hidden="true" tabindex="-1"></a>        Eigen<span class="op">::</span>Map<span class="op">&lt;</span>Eigen<span class="op">::</span>Matrix<span class="op">&lt;</span><span class="dt">double</span><span class="op">,</span> Eigen<span class="op">::</span>Dynamic<span class="op">,</span> Eigen<span class="op">::</span>Dynamic<span class="op">,</span> </span>
<span id="cb14-617"><a href="#cb14-617" aria-hidden="true" tabindex="-1"></a>                                 Eigen<span class="op">::</span>ColMajor<span class="op">&gt;&gt;</span> </span>
<span id="cb14-618"><a href="#cb14-618" aria-hidden="true" tabindex="-1"></a>            V<span class="op">(</span>vdV<span class="op">.</span>data<span class="op">(),</span> nv_rows<span class="op">,</span> nv_cols<span class="op">);</span></span>
<span id="cb14-619"><a href="#cb14-619" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-620"><a href="#cb14-620" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Solve for canonical coefficients: R^(-1) * U</span></span>
<span id="cb14-621"><a href="#cb14-621" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Using triangular solve (efficient for triangular matrices)</span></span>
<span id="cb14-622"><a href="#cb14-622" aria-hidden="true" tabindex="-1"></a>        Eigen<span class="op">::</span>MatrixXd xcoef <span class="op">=</span> XQR<span class="op">.</span>triangularView<span class="op">&lt;</span>Eigen<span class="op">::</span>Upper<span class="op">&gt;().</span>solve<span class="op">(</span>U<span class="op">);</span></span>
<span id="cb14-623"><a href="#cb14-623" aria-hidden="true" tabindex="-1"></a>        Eigen<span class="op">::</span>MatrixXd ycoef <span class="op">=</span> YQR<span class="op">.</span>triangularView<span class="op">&lt;</span>Eigen<span class="op">::</span>Upper<span class="op">&gt;().</span>solve<span class="op">(</span>V<span class="op">);</span></span>
<span id="cb14-624"><a href="#cb14-624" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-625"><a href="#cb14-625" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Here you would write xcoef and ycoef back to HDF5</span></span>
<span id="cb14-626"><a href="#cb14-626" aria-hidden="true" tabindex="-1"></a>        <span class="co">// using BigDataStatMeth's HDF5 writing functions</span></span>
<span id="cb14-627"><a href="#cb14-627" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Omitted for brevity - see R implementation for reference</span></span>
<span id="cb14-628"><a href="#cb14-628" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-629"><a href="#cb14-629" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">catch</span><span class="op">(</span><span class="bu">std::</span>exception<span class="op">&amp;</span> ex<span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-630"><a href="#cb14-630" aria-hidden="true" tabindex="-1"></a>        checkClose_file<span class="op">(</span>dstmpX<span class="op">,</span> dstmpY<span class="op">);</span></span>
<span id="cb14-631"><a href="#cb14-631" aria-hidden="true" tabindex="-1"></a>        Rcout<span class="op">&lt;&lt;</span> <span class="st">"c++ exception writeCCAComponents_hdf5_cpp: "</span></span>
<span id="cb14-632"><a href="#cb14-632" aria-hidden="true" tabindex="-1"></a>             <span class="op">&lt;&lt;</span> ex<span class="op">.</span>what<span class="op">()</span> <span class="op">&lt;&lt;</span> <span class="st">"</span><span class="sc">\n</span><span class="st">"</span><span class="op">;</span></span>
<span id="cb14-633"><a href="#cb14-633" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dt">void</span><span class="op">();</span></span>
<span id="cb14-634"><a href="#cb14-634" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb14-635"><a href="#cb14-635" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-636"><a href="#cb14-636" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dt">void</span><span class="op">();</span></span>
<span id="cb14-637"><a href="#cb14-637" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb14-638"><a href="#cb14-638" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-639"><a href="#cb14-639" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-640"><a href="#cb14-640" aria-hidden="true" tabindex="-1"></a>This pure C++ version demonstrates several advanced techniques:</span>
<span id="cb14-641"><a href="#cb14-641" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-642"><a href="#cb14-642" aria-hidden="true" tabindex="-1"></a>**Eigen for linear algebra:** The Eigen library provides efficient matrix operations. The <span class="in">`Eigen::Map`</span> creates Eigen matrix objects that share memory with C++ vectors—no copying overhead. Operations like triangular solve (<span class="in">`triangularView&lt;Upper&gt;().solve()`</span>) use optimized BLAS/LAPACK implementations.</span>
<span id="cb14-643"><a href="#cb14-643" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-644"><a href="#cb14-644" aria-hidden="true" tabindex="-1"></a>**Memory mapping:** Rather than copying data from std::vector to Eigen::Matrix, we map the vector's memory directly. This zero-copy approach is essential for large matrices—copying megabytes or gigabytes is expensive both in time and temporary memory allocation.</span>
<span id="cb14-645"><a href="#cb14-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-646"><a href="#cb14-646" aria-hidden="true" tabindex="-1"></a>**Triangular system solving:** The <span class="in">`triangularView&lt;Upper&gt;().solve()`</span> exploits the triangular structure of R matrices. Solving a triangular system is O(n²), much faster than general matrix inverse which is O(n³). This is why QR decomposition is useful—it gives triangular matrices that solve efficiently.</span>
<span id="cb14-647"><a href="#cb14-647" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-648"><a href="#cb14-648" aria-hidden="true" tabindex="-1"></a>**Complexity vs benefit:** This pure C++ implementation is ~100 lines versus ~10 lines for calling R. Unless profiling shows coefficient computation as a bottleneck (unlikely—SVD and QR dominate compute time), the simpler approach is better.</span>
<span id="cb14-649"><a href="#cb14-649" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-650"><a href="#cb14-650" aria-hidden="true" tabindex="-1"></a><span class="fu">### When Each Approach Makes Sense</span></span>
<span id="cb14-651"><a href="#cb14-651" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-652"><a href="#cb14-652" aria-hidden="true" tabindex="-1"></a>**Use Option A (call R) when:**</span>
<span id="cb14-653"><a href="#cb14-653" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Development speed matters more than microseconds</span>
<span id="cb14-654"><a href="#cb14-654" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>R function handles edge cases, provides diagnostics</span>
<span id="cb14-655"><a href="#cb14-655" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Team maintains R code more easily</span>
<span id="cb14-656"><a href="#cb14-656" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>No strict deployment requirement for pure C++</span>
<span id="cb14-657"><a href="#cb14-657" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-658"><a href="#cb14-658" aria-hidden="true" tabindex="-1"></a>**Use Option B (pure C++) when:**</span>
<span id="cb14-659"><a href="#cb14-659" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Deploying in environments without R</span>
<span id="cb14-660"><a href="#cb14-660" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Profiling shows coefficient computation as bottleneck</span>
<span id="cb14-661"><a href="#cb14-661" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Need to modify algorithm in ways R version doesn't support</span>
<span id="cb14-662"><a href="#cb14-662" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Building standalone C++ library</span>
<span id="cb14-663"><a href="#cb14-663" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-664"><a href="#cb14-664" aria-hidden="true" tabindex="-1"></a>For most users, Option A is the right choice. This pragmatic approach combines C++ performance where it matters (QR, SVD) with R flexibility where it helps (coefficient computation, result storage).</span>
<span id="cb14-665"><a href="#cb14-665" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-666"><a href="#cb14-666" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb14-667"><a href="#cb14-667" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-668"><a href="#cb14-668" aria-hidden="true" tabindex="-1"></a><span class="fu">## Compiling and Using</span></span>
<span id="cb14-669"><a href="#cb14-669" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-670"><a href="#cb14-670" aria-hidden="true" tabindex="-1"></a><span class="fu">### Package Structure</span></span>
<span id="cb14-671"><a href="#cb14-671" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-672"><a href="#cb14-672" aria-hidden="true" tabindex="-1"></a>To use C++ functions in an R package, you need proper structure:</span>
<span id="cb14-673"><a href="#cb14-673" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-674"><a href="#cb14-674" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-675"><a href="#cb14-675" aria-hidden="true" tabindex="-1"></a><span class="in">BDStatMethExamples/</span></span>
<span id="cb14-676"><a href="#cb14-676" aria-hidden="true" tabindex="-1"></a><span class="in">├── DESCRIPTION</span></span>
<span id="cb14-677"><a href="#cb14-677" aria-hidden="true" tabindex="-1"></a><span class="in">├── NAMESPACE</span></span>
<span id="cb14-678"><a href="#cb14-678" aria-hidden="true" tabindex="-1"></a><span class="in">├── R/</span></span>
<span id="cb14-679"><a href="#cb14-679" aria-hidden="true" tabindex="-1"></a><span class="in">│   └── RcppExports.R          # Auto-generated</span></span>
<span id="cb14-680"><a href="#cb14-680" aria-hidden="true" tabindex="-1"></a><span class="in">├── src/</span></span>
<span id="cb14-681"><a href="#cb14-681" aria-hidden="true" tabindex="-1"></a><span class="in">│   ├── bdCCA.cpp              # Implementation</span></span>
<span id="cb14-682"><a href="#cb14-682" aria-hidden="true" tabindex="-1"></a><span class="in">│   ├── bdCCA.h                # Header declarations</span></span>
<span id="cb14-683"><a href="#cb14-683" aria-hidden="true" tabindex="-1"></a><span class="in">│   └── RcppExports.cpp        # Auto-generated</span></span>
<span id="cb14-684"><a href="#cb14-684" aria-hidden="true" tabindex="-1"></a><span class="in">└── inst/</span></span>
<span id="cb14-685"><a href="#cb14-685" aria-hidden="true" tabindex="-1"></a><span class="in">    └── include/</span></span>
<span id="cb14-686"><a href="#cb14-686" aria-hidden="true" tabindex="-1"></a><span class="in">        └── BigDataStatMeth.hpp</span></span>
<span id="cb14-687"><a href="#cb14-687" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-688"><a href="#cb14-688" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-689"><a href="#cb14-689" aria-hidden="true" tabindex="-1"></a>**Header file (bdCCA.h):**</span>
<span id="cb14-690"><a href="#cb14-690" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-691"><a href="#cb14-691" aria-hidden="true" tabindex="-1"></a><span class="in">```cpp</span></span>
<span id="cb14-692"><a href="#cb14-692" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifndef BDSTATMETHEXAMPLES_CCA_HPP</span></span>
<span id="cb14-693"><a href="#cb14-693" aria-hidden="true" tabindex="-1"></a><span class="pp">#define BDSTATMETHEXAMPLES_CCA_HPP</span></span>
<span id="cb14-694"><a href="#cb14-694" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-695"><a href="#cb14-695" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rcpp.h&gt;</span></span>
<span id="cb14-696"><a href="#cb14-696" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">"BigDataStatMeth.hpp"</span></span>
<span id="cb14-697"><a href="#cb14-697" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-698"><a href="#cb14-698" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> Rcpp<span class="op">;</span></span>
<span id="cb14-699"><a href="#cb14-699" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> BigDataStatMeth<span class="op">;</span></span>
<span id="cb14-700"><a href="#cb14-700" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-701"><a href="#cb14-701" aria-hidden="true" tabindex="-1"></a><span class="co">// Function declarations</span></span>
<span id="cb14-702"><a href="#cb14-702" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> getQRbyBlocks_rcpp<span class="op">(</span></span>
<span id="cb14-703"><a href="#cb14-703" aria-hidden="true" tabindex="-1"></a>    hdf5Dataset <span class="op">*</span>dsA<span class="op">,</span> <span class="dt">int</span> mblocks<span class="op">,</span> <span class="dt">bool</span> bcenter<span class="op">,</span> <span class="dt">bool</span> bscale<span class="op">,</span> </span>
<span id="cb14-704"><a href="#cb14-704" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> byrows<span class="op">,</span> <span class="dt">bool</span> overwrite<span class="op">,</span> Nullable<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> threads <span class="op">=</span> R_NilValue</span>
<span id="cb14-705"><a href="#cb14-705" aria-hidden="true" tabindex="-1"></a><span class="op">);</span></span>
<span id="cb14-706"><a href="#cb14-706" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-707"><a href="#cb14-707" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> writeCCAComponents_hdf5_rcpp<span class="op">(</span></span>
<span id="cb14-708"><a href="#cb14-708" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>string filename<span class="op">,</span> <span class="dt">int</span> ncolsX<span class="op">,</span> <span class="dt">int</span> ncolsY</span>
<span id="cb14-709"><a href="#cb14-709" aria-hidden="true" tabindex="-1"></a><span class="op">);</span></span>
<span id="cb14-710"><a href="#cb14-710" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-711"><a href="#cb14-711" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif </span><span class="co">// BDSTATMETHEXAMPLES_CCA_HPP</span></span>
<span id="cb14-712"><a href="#cb14-712" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-713"><a href="#cb14-713" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-714"><a href="#cb14-714" aria-hidden="true" tabindex="-1"></a><span class="fu">### Option 1: Compile with sourceCpp (Testing)</span></span>
<span id="cb14-715"><a href="#cb14-715" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-716"><a href="#cb14-716" aria-hidden="true" tabindex="-1"></a>For development and testing, compile individual files:</span>
<span id="cb14-717"><a href="#cb14-717" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-718"><a href="#cb14-718" aria-hidden="true" tabindex="-1"></a><span class="in">```{r compile-single, eval=FALSE}</span></span>
<span id="cb14-719"><a href="#cb14-719" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Rcpp)</span>
<span id="cb14-720"><a href="#cb14-720" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-721"><a href="#cb14-721" aria-hidden="true" tabindex="-1"></a><span class="co"># Set include path</span></span>
<span id="cb14-722"><a href="#cb14-722" aria-hidden="true" tabindex="-1"></a><span class="fu">Sys.setenv</span>(<span class="at">PKG_CXXFLAGS =</span> <span class="fu">paste0</span>(</span>
<span id="cb14-723"><a href="#cb14-723" aria-hidden="true" tabindex="-1"></a>  <span class="st">"-I"</span>, <span class="fu">system.file</span>(<span class="st">"include"</span>, <span class="at">package =</span> <span class="st">"BigDataStatMeth"</span>)</span>
<span id="cb14-724"><a href="#cb14-724" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb14-725"><a href="#cb14-725" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-726"><a href="#cb14-726" aria-hidden="true" tabindex="-1"></a><span class="co"># Compile and load</span></span>
<span id="cb14-727"><a href="#cb14-727" aria-hidden="true" tabindex="-1"></a><span class="fu">sourceCpp</span>(<span class="st">"src/bdCCA.cpp"</span>)</span>
<span id="cb14-728"><a href="#cb14-728" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-729"><a href="#cb14-729" aria-hidden="true" tabindex="-1"></a><span class="co"># Now function is available in R</span></span>
<span id="cb14-730"><a href="#cb14-730" aria-hidden="true" tabindex="-1"></a><span class="fu">bdCCA_hdf5_rcpp</span>(</span>
<span id="cb14-731"><a href="#cb14-731" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> <span class="st">"test.hdf5"</span>,</span>
<span id="cb14-732"><a href="#cb14-732" aria-hidden="true" tabindex="-1"></a>  <span class="at">datasetX =</span> <span class="st">"data/X"</span>,</span>
<span id="cb14-733"><a href="#cb14-733" aria-hidden="true" tabindex="-1"></a>  <span class="at">datasetY =</span> <span class="st">"data/Y"</span>,</span>
<span id="cb14-734"><a href="#cb14-734" aria-hidden="true" tabindex="-1"></a>  <span class="at">bcenter =</span> <span class="cn">TRUE</span>,</span>
<span id="cb14-735"><a href="#cb14-735" aria-hidden="true" tabindex="-1"></a>  <span class="at">bscale =</span> <span class="cn">FALSE</span>,</span>
<span id="cb14-736"><a href="#cb14-736" aria-hidden="true" tabindex="-1"></a>  <span class="at">mblocks =</span> <span class="dv">4</span>,</span>
<span id="cb14-737"><a href="#cb14-737" aria-hidden="true" tabindex="-1"></a>  <span class="at">overwrite =</span> <span class="cn">TRUE</span></span>
<span id="cb14-738"><a href="#cb14-738" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-739"><a href="#cb14-739" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-740"><a href="#cb14-740" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-741"><a href="#cb14-741" aria-hidden="true" tabindex="-1"></a><span class="fu">### Option 2: Build Package (Production)</span></span>
<span id="cb14-742"><a href="#cb14-742" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-743"><a href="#cb14-743" aria-hidden="true" tabindex="-1"></a>For production use, build the full package:</span>
<span id="cb14-744"><a href="#cb14-744" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-745"><a href="#cb14-745" aria-hidden="true" tabindex="-1"></a><span class="in">```bash</span></span>
<span id="cb14-746"><a href="#cb14-746" aria-hidden="true" tabindex="-1"></a><span class="co"># From package directory</span></span>
<span id="cb14-747"><a href="#cb14-747" aria-hidden="true" tabindex="-1"></a><span class="ex">R</span> CMD build .</span>
<span id="cb14-748"><a href="#cb14-748" aria-hidden="true" tabindex="-1"></a><span class="ex">R</span> CMD INSTALL BDStatMethExamples_1.0.tar.gz</span>
<span id="cb14-749"><a href="#cb14-749" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-750"><a href="#cb14-750" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-751"><a href="#cb14-751" aria-hidden="true" tabindex="-1"></a>Or in R:</span>
<span id="cb14-752"><a href="#cb14-752" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-753"><a href="#cb14-753" aria-hidden="true" tabindex="-1"></a><span class="in">```{r build-package, eval=FALSE}</span></span>
<span id="cb14-754"><a href="#cb14-754" aria-hidden="true" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">document</span>()    <span class="co"># Generate documentation</span></span>
<span id="cb14-755"><a href="#cb14-755" aria-hidden="true" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">build</span>()       <span class="co"># Build package</span></span>
<span id="cb14-756"><a href="#cb14-756" aria-hidden="true" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">install</span>()     <span class="co"># Install locally</span></span>
<span id="cb14-757"><a href="#cb14-757" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-758"><a href="#cb14-758" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-759"><a href="#cb14-759" aria-hidden="true" tabindex="-1"></a><span class="fu">### Comparing R and C++ Performance</span></span>
<span id="cb14-760"><a href="#cb14-760" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-761"><a href="#cb14-761" aria-hidden="true" tabindex="-1"></a>Here's how to benchmark the two implementations:</span>
<span id="cb14-762"><a href="#cb14-762" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-763"><a href="#cb14-763" aria-hidden="true" tabindex="-1"></a><span class="in">```{r benchmark, eval=FALSE}</span></span>
<span id="cb14-764"><a href="#cb14-764" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(BDStatMethExamples)</span>
<span id="cb14-765"><a href="#cb14-765" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(microbenchmark)</span>
<span id="cb14-766"><a href="#cb14-766" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-767"><a href="#cb14-767" aria-hidden="true" tabindex="-1"></a><span class="co"># Create test data</span></span>
<span id="cb14-768"><a href="#cb14-768" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb14-769"><a href="#cb14-769" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">5000</span></span>
<span id="cb14-770"><a href="#cb14-770" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb14-771"><a href="#cb14-771" aria-hidden="true" tabindex="-1"></a>q <span class="ot">&lt;-</span> <span class="dv">800</span></span>
<span id="cb14-772"><a href="#cb14-772" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-773"><a href="#cb14-773" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(n<span class="sc">*</span>p), n, p)</span>
<span id="cb14-774"><a href="#cb14-774" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(n<span class="sc">*</span>q), n, q)</span>
<span id="cb14-775"><a href="#cb14-775" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-776"><a href="#cb14-776" aria-hidden="true" tabindex="-1"></a>test_file <span class="ot">&lt;-</span> <span class="st">"benchmark_cca.hdf5"</span></span>
<span id="cb14-777"><a href="#cb14-777" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-778"><a href="#cb14-778" aria-hidden="true" tabindex="-1"></a><span class="fu">bdCreate_hdf5_matrix</span>(test_file, X, <span class="st">"data"</span>, <span class="st">"X"</span>, <span class="at">overwriteFile =</span> <span class="cn">TRUE</span>)</span>
<span id="cb14-779"><a href="#cb14-779" aria-hidden="true" tabindex="-1"></a><span class="fu">bdCreate_hdf5_matrix</span>(test_file, Y, <span class="st">"data"</span>, <span class="st">"Y"</span>, <span class="at">overwriteFile =</span> <span class="cn">FALSE</span>)</span>
<span id="cb14-780"><a href="#cb14-780" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-781"><a href="#cb14-781" aria-hidden="true" tabindex="-1"></a><span class="co"># Benchmark</span></span>
<span id="cb14-782"><a href="#cb14-782" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">microbenchmark</span>(</span>
<span id="cb14-783"><a href="#cb14-783" aria-hidden="true" tabindex="-1"></a>  <span class="at">R_version =</span> <span class="fu">bdCCA_hdf5</span>(</span>
<span id="cb14-784"><a href="#cb14-784" aria-hidden="true" tabindex="-1"></a>    test_file, <span class="st">"data/X"</span>, <span class="st">"data/Y"</span>, <span class="at">m =</span> <span class="dv">4</span>,</span>
<span id="cb14-785"><a href="#cb14-785" aria-hidden="true" tabindex="-1"></a>    <span class="at">overwriteResults =</span> <span class="cn">TRUE</span></span>
<span id="cb14-786"><a href="#cb14-786" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb14-787"><a href="#cb14-787" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-788"><a href="#cb14-788" aria-hidden="true" tabindex="-1"></a>  <span class="at">Cpp_version =</span> <span class="fu">bdCCA_hdf5_rcpp</span>(</span>
<span id="cb14-789"><a href="#cb14-789" aria-hidden="true" tabindex="-1"></a>    test_file, <span class="st">"data/X"</span>, <span class="st">"data/Y"</span>, </span>
<span id="cb14-790"><a href="#cb14-790" aria-hidden="true" tabindex="-1"></a>    <span class="at">bcenter =</span> <span class="cn">TRUE</span>, <span class="at">bscale =</span> <span class="cn">FALSE</span>, <span class="at">mblocks =</span> <span class="dv">4</span>, </span>
<span id="cb14-791"><a href="#cb14-791" aria-hidden="true" tabindex="-1"></a>    <span class="at">overwrite =</span> <span class="cn">TRUE</span></span>
<span id="cb14-792"><a href="#cb14-792" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb14-793"><a href="#cb14-793" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-794"><a href="#cb14-794" aria-hidden="true" tabindex="-1"></a>  <span class="at">times =</span> <span class="dv">10</span></span>
<span id="cb14-795"><a href="#cb14-795" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-796"><a href="#cb14-796" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-797"><a href="#cb14-797" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(results)</span>
<span id="cb14-798"><a href="#cb14-798" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-799"><a href="#cb14-799" aria-hidden="true" tabindex="-1"></a><span class="co"># Typically expect:</span></span>
<span id="cb14-800"><a href="#cb14-800" aria-hidden="true" tabindex="-1"></a><span class="co"># R version:   ~15-25 seconds</span></span>
<span id="cb14-801"><a href="#cb14-801" aria-hidden="true" tabindex="-1"></a><span class="co"># C++ version: ~10-15 seconds</span></span>
<span id="cb14-802"><a href="#cb14-802" aria-hidden="true" tabindex="-1"></a><span class="co"># Speedup:     ~1.5-2x</span></span>
<span id="cb14-803"><a href="#cb14-803" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-804"><a href="#cb14-804" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-805"><a href="#cb14-805" aria-hidden="true" tabindex="-1"></a>The C++ version is faster, but not dramatically—both use the same underlying BLAS/LAPACK for matrix operations. The speedup comes from reduced overhead in function calls and memory management, not from algorithmic differences.</span>
<span id="cb14-806"><a href="#cb14-806" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-807"><a href="#cb14-807" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb14-808"><a href="#cb14-808" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-809"><a href="#cb14-809" aria-hidden="true" tabindex="-1"></a><span class="fu">## Interactive Exercise {.exercise}</span></span>
<span id="cb14-810"><a href="#cb14-810" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-811"><a href="#cb14-811" aria-hidden="true" tabindex="-1"></a><span class="fu">### Practice: Optimizing C++ Implementation</span></span>
<span id="cb14-812"><a href="#cb14-812" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-813"><a href="#cb14-813" aria-hidden="true" tabindex="-1"></a>Understanding comes from hands-on modification:</span>
<span id="cb14-814"><a href="#cb14-814" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-817"><a href="#cb14-817" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb14-818"><a href="#cb14-818" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb14-819"><a href="#cb14-819" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-820"><a href="#cb14-820" aria-hidden="true" tabindex="-1"></a><span class="co"># Exercise 1: Add error checking</span></span>
<span id="cb14-821"><a href="#cb14-821" aria-hidden="true" tabindex="-1"></a><span class="co"># Modify bdCCA_hdf5_rcpp to validate:</span></span>
<span id="cb14-822"><a href="#cb14-822" aria-hidden="true" tabindex="-1"></a><span class="co"># - File exists before opening</span></span>
<span id="cb14-823"><a href="#cb14-823" aria-hidden="true" tabindex="-1"></a><span class="co"># - Datasets have matching sample counts</span></span>
<span id="cb14-824"><a href="#cb14-824" aria-hidden="true" tabindex="-1"></a><span class="co"># - Sufficient memory available</span></span>
<span id="cb14-825"><a href="#cb14-825" aria-hidden="true" tabindex="-1"></a><span class="co"># How do these checks affect performance?</span></span>
<span id="cb14-826"><a href="#cb14-826" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-827"><a href="#cb14-827" aria-hidden="true" tabindex="-1"></a><span class="co"># Exercise 2: Implement parallel QR</span></span>
<span id="cb14-828"><a href="#cb14-828" aria-hidden="true" tabindex="-1"></a><span class="co"># Modify getQRbyBlocks_rcpp to:</span></span>
<span id="cb14-829"><a href="#cb14-829" aria-hidden="true" tabindex="-1"></a><span class="co"># - Process blocks in parallel using OpenMP</span></span>
<span id="cb14-830"><a href="#cb14-830" aria-hidden="true" tabindex="-1"></a><span class="co"># - Measure speedup with 2, 4, 8 threads</span></span>
<span id="cb14-831"><a href="#cb14-831" aria-hidden="true" tabindex="-1"></a><span class="co"># When does parallelization help?</span></span>
<span id="cb14-832"><a href="#cb14-832" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-833"><a href="#cb14-833" aria-hidden="true" tabindex="-1"></a><span class="co"># Exercise 3: Profile memory usage</span></span>
<span id="cb14-834"><a href="#cb14-834" aria-hidden="true" tabindex="-1"></a><span class="co"># Instrument the code to track:</span></span>
<span id="cb14-835"><a href="#cb14-835" aria-hidden="true" tabindex="-1"></a><span class="co"># - Peak memory usage at each step</span></span>
<span id="cb14-836"><a href="#cb14-836" aria-hidden="true" tabindex="-1"></a><span class="co"># - Number of active HDF5 handles</span></span>
<span id="cb14-837"><a href="#cb14-837" aria-hidden="true" tabindex="-1"></a><span class="co"># - Dataset sizes created</span></span>
<span id="cb14-838"><a href="#cb14-838" aria-hidden="true" tabindex="-1"></a><span class="co"># Where is memory bottleneck?</span></span>
<span id="cb14-839"><a href="#cb14-839" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-840"><a href="#cb14-840" aria-hidden="true" tabindex="-1"></a><span class="co"># Exercise 4: Pure C++ coefficient computation</span></span>
<span id="cb14-841"><a href="#cb14-841" aria-hidden="true" tabindex="-1"></a><span class="co"># Complete the writeCCAComponents_hdf5_cpp function:</span></span>
<span id="cb14-842"><a href="#cb14-842" aria-hidden="true" tabindex="-1"></a><span class="co"># - Write xcoef and ycoef to HDF5</span></span>
<span id="cb14-843"><a href="#cb14-843" aria-hidden="true" tabindex="-1"></a><span class="co"># - Compute and save canonical variates</span></span>
<span id="cb14-844"><a href="#cb14-844" aria-hidden="true" tabindex="-1"></a><span class="co"># - Compare performance to R version</span></span>
<span id="cb14-845"><a href="#cb14-845" aria-hidden="true" tabindex="-1"></a><span class="co"># Is the complexity justified?</span></span>
<span id="cb14-846"><a href="#cb14-846" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb14-847"><a href="#cb14-847" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-848"><a href="#cb14-848" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip}</span>
<span id="cb14-849"><a href="#cb14-849" aria-hidden="true" tabindex="-1"></a><span class="fu">### Reflection Questions</span></span>
<span id="cb14-850"><a href="#cb14-850" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-851"><a href="#cb14-851" aria-hidden="true" tabindex="-1"></a>**1. Development Trade-offs:**</span>
<span id="cb14-852"><a href="#cb14-852" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>How much faster must C++ be to justify development cost?</span>
<span id="cb14-853"><a href="#cb14-853" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>At what data size does C++ become necessary?</span>
<span id="cb14-854"><a href="#cb14-854" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>How do you decide R vs C++ for new methods?</span>
<span id="cb14-855"><a href="#cb14-855" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-856"><a href="#cb14-856" aria-hidden="true" tabindex="-1"></a>**2. Memory Management:**</span>
<span id="cb14-857"><a href="#cb14-857" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Why initialize pointers to nullptr?</span>
<span id="cb14-858"><a href="#cb14-858" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>What happens if you forget delete?</span>
<span id="cb14-859"><a href="#cb14-859" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>How do smart pointers (unique_ptr, shared_ptr) help?</span>
<span id="cb14-860"><a href="#cb14-860" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-861"><a href="#cb14-861" aria-hidden="true" tabindex="-1"></a>**3. Error Handling:**</span>
<span id="cb14-862"><a href="#cb14-862" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Why wrap everything in try/catch?</span>
<span id="cb14-863"><a href="#cb14-863" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>What errors can HDF5 operations throw?</span>
<span id="cb14-864"><a href="#cb14-864" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>How do you test error handling paths?</span>
<span id="cb14-865"><a href="#cb14-865" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-866"><a href="#cb14-866" aria-hidden="true" tabindex="-1"></a>**4. Hybrid Approaches:**</span>
<span id="cb14-867"><a href="#cb14-867" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>When is calling R from C++ appropriate?</span>
<span id="cb14-868"><a href="#cb14-868" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>What's the overhead of R function calls?</span>
<span id="cb14-869"><a href="#cb14-869" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>How do you profile mixed R/C++ code?</span>
<span id="cb14-870"><a href="#cb14-870" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-871"><a href="#cb14-871" aria-hidden="true" tabindex="-1"></a>**5. Production Deployment:**</span>
<span id="cb14-872"><a href="#cb14-872" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>How do you ensure C++ code is maintainable?</span>
<span id="cb14-873"><a href="#cb14-873" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>What testing is essential for C++ implementations?</span>
<span id="cb14-874"><a href="#cb14-874" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>How do you document C++ API for users?</span>
<span id="cb14-875"><a href="#cb14-875" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-876"><a href="#cb14-876" aria-hidden="true" tabindex="-1"></a>These questions guide you beyond syntax to software engineering principles essential for production statistical code.</span>
<span id="cb14-877"><a href="#cb14-877" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb14-878"><a href="#cb14-878" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-879"><a href="#cb14-879" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb14-880"><a href="#cb14-880" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-881"><a href="#cb14-881" aria-hidden="true" tabindex="-1"></a><span class="fu">## Key Takeaways {.key-concept}</span></span>
<span id="cb14-882"><a href="#cb14-882" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-883"><a href="#cb14-883" aria-hidden="true" tabindex="-1"></a>Let's consolidate what you've learned about implementing statistical methods in C++ with BigDataStatMeth.</span>
<span id="cb14-884"><a href="#cb14-884" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-885"><a href="#cb14-885" aria-hidden="true" tabindex="-1"></a><span class="fu">### Essential Concepts</span></span>
<span id="cb14-886"><a href="#cb14-886" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-887"><a href="#cb14-887" aria-hidden="true" tabindex="-1"></a>**C++ provides performance, not different algorithms.** The mathematical algorithm—QR decomposition, cross-product, SVD, solving for coefficients—is identical between R and C++ implementations. The difference is execution efficiency, not what's computed. C++ is faster because of reduced overhead in memory management, function calls, and type conversions, not because it uses superior mathematics. Don't assume C++ is always necessary; profile first to identify actual bottlenecks. Many statistical methods run adequately in R because the heavy lifting (BLAS, LAPACK operations) uses compiled code regardless of whether called from R or C++.</span>
<span id="cb14-888"><a href="#cb14-888" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-889"><a href="#cb14-889" aria-hidden="true" tabindex="-1"></a>**Memory management is mandatory, not optional.** Every <span class="in">`new`</span> requires matching <span class="in">`delete`</span>. Every opened HDF5 dataset must be closed. Every allocated pointer must be tracked through exception paths. R's garbage collector handles this automatically, making R code shorter and less error-prone. C++ requires explicit management, which is why production C++ code includes try/catch blocks, cleanup functions, and defensive null checks. Forgetting these leads to memory leaks (gradual resource exhaustion), crashes (accessing freed memory), or corrupted results (partial cleanup). The discipline of declaring pointers to nullptr, allocating in try blocks, deleting in catch and after use, then setting to nullptr prevents these failures.</span>
<span id="cb14-890"><a href="#cb14-890" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-891"><a href="#cb14-891" aria-hidden="true" tabindex="-1"></a>**Exception handling prevents crashes.** HDF5 operations can fail—file not found, dataset doesn't exist, out of disk space, permissions denied. Without exception handling, these failures crash the entire R session. With proper try/catch, the function reports the error, cleans up allocated resources, and returns gracefully. The user sees a clear error message, R continues running, and memory doesn't leak. Production code must never crash—degrading gracefully (return error, let user fix problem) is mandatory. The pattern of wrapping all operations in try and checking for exceptions isn't paranoia; it's engineering reliability.</span>
<span id="cb14-892"><a href="#cb14-892" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-893"><a href="#cb14-893" aria-hidden="true" tabindex="-1"></a>**Rcpp bridges R and C++ transparently.** The <span class="in">`[[Rcpp::export]]`</span> annotation makes C++ functions callable from R without manual wrapper code. Type conversion—R strings to C++ std::string, R numerics to C++ double, R booleans to C++ bool—happens automatically. Calling R functions from C++ (like <span class="in">`writeCCAComponents_hdf5_rcpp`</span> calling R's implementation) is equally transparent. This seamless integration means you can use C++ where it provides value (tight loops, custom algorithms, memory control) while keeping flexible parts in R (statistical tests, plotting, diagnostics). Don't think of R and C++ as separate worlds requiring manual integration; Rcpp makes them a unified environment.</span>
<span id="cb14-894"><a href="#cb14-894" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-895"><a href="#cb14-895" aria-hidden="true" tabindex="-1"></a>**BigDataStatMeth's C++ functions do the heavy lifting.** Writing pure C++ linear algebra from scratch—QR decomposition, SVD, matrix multiplication—would be thousands of lines and likely slower than using BigDataStatMeth's implementations (which internally use optimized BLAS/LAPACK). The value of C++ isn't reimplementing everything; it's combining BigDataStatMeth's building blocks in custom ways, adding algorithms not provided, or optimizing specific bottlenecks. The hybrid approach—calling BigDataStatMeth functions from C++, calling R functions where convenient—is pragmatic engineering, not compromise.</span>
<span id="cb14-896"><a href="#cb14-896" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-897"><a href="#cb14-897" aria-hidden="true" tabindex="-1"></a>**Compilation catches errors early.** R is interpreted—errors appear at runtime, potentially deep into analysis. C++ is compiled—type mismatches, missing headers, syntax errors appear before execution. This is why C++ development feels slower (write code, compile, fix errors, repeat) but produces more robust code. Once C++ code compiles, many categories of errors (wrong types, missing functions, invalid syntax) are impossible at runtime. The debugging time shifts from runtime to compile time, and compile-time debugging is easier—the compiler tells you exactly what's wrong. Runtime debugging in statistical code often requires re-running expensive analyses; compile-time debugging prevents that wasted time.</span>
<span id="cb14-898"><a href="#cb14-898" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-899"><a href="#cb14-899" aria-hidden="true" tabindex="-1"></a><span class="fu">### When to Use C++ vs R</span></span>
<span id="cb14-900"><a href="#cb14-900" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-901"><a href="#cb14-901" aria-hidden="true" tabindex="-1"></a>Understanding when C++ justifies the development investment versus when R suffices guides efficient method development.</span>
<span id="cb14-902"><a href="#cb14-902" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-903"><a href="#cb14-903" aria-hidden="true" tabindex="-1"></a>✅ **Implement in C++ when:**</span>
<span id="cb14-904"><a href="#cb14-904" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-905"><a href="#cb14-905" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Profiling identifies clear bottlenecks** - Don't guess; measure. If profiling shows 80% of time in a specific operation not using compiled code (e.g., custom R loops), that's a C++ candidate. If 80% of time is in <span class="in">`bdSVD_hdf5`</span> (already compiled), C++ won't help.</span>
<span id="cb14-906"><a href="#cb14-906" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-907"><a href="#cb14-907" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Method runs thousands of times in production** - A 50% speedup irrelevant for one-off analyses matters hugely in pipelines processing thousands of datasets daily. The accumulated time savings—and reduced compute costs—justify development effort.</span>
<span id="cb14-908"><a href="#cb14-908" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-909"><a href="#cb14-909" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Custom algorithms not in BigDataStatMeth** - If implementing novel decompositions, specialized optimization, or algorithms from cutting-edge papers, C++ provides algorithmic freedom. You're not limited to existing BigDataStatMeth functions; you implement exactly what you need.</span>
<span id="cb14-910"><a href="#cb14-910" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-911"><a href="#cb14-911" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Deploying in pure C++ environments** - If your production infrastructure is pure C++ (no R installed), you need C++ implementations. This is rare—most scientific computing environments have R—but in embedded systems, real-time environments, or certain production systems, pure C++ is mandatory.</span>
<span id="cb14-912"><a href="#cb14-912" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-913"><a href="#cb14-913" aria-hidden="true" tabindex="-1"></a>❌ **Stay in R when:**</span>
<span id="cb14-914"><a href="#cb14-914" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-915"><a href="#cb14-915" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Development speed matters more** - For research methods, prototype algorithms, exploratory analyses, R's faster development cycle (write, run, inspect, iterate) is more valuable than execution speed. Perfect code running slow beats broken code running fast.</span>
<span id="cb14-916"><a href="#cb14-916" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-917"><a href="#cb14-917" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Method uses existing BigDataStatMeth functions** - If your method orchestrates <span class="in">`bdSVD_hdf5`</span>, <span class="in">`bdCrossprod_hdf5`</span>, <span class="in">`bdQR_hdf5`</span>, the heavy computation already uses compiled code. R orchestration overhead is negligible. Only if you need custom operations not provided by BigDataStatMeth is C++ needed.</span>
<span id="cb14-918"><a href="#cb14-918" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-919"><a href="#cb14-919" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Infrequent use** - Monthly analysis taking 10 minutes in R? Don't optimize. The development time (writing C++, testing, debugging) exceeds total computation time saved over the method's lifetime. Spend development time on methods used frequently.</span>
<span id="cb14-920"><a href="#cb14-920" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-921"><a href="#cb14-921" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Team maintains R more easily** - If your team excels in R but struggles with C++ pointer management, memory leaks, and compilation issues, maintainability matters more than speed. Better to have understandable R code that runs slightly slower than inscrutable C++ code nobody can debug or extend.</span>
<span id="cb14-922"><a href="#cb14-922" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-923"><a href="#cb14-923" aria-hidden="true" tabindex="-1"></a>The key principle: profile to identify bottlenecks, optimize selectively where profiling shows benefit, and use each language where it excels. Most statistical method implementations belong in R, with BigDataStatMeth's compiled functions handling computational intensity.</span>
<span id="cb14-924"><a href="#cb14-924" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-925"><a href="#cb14-925" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb14-926"><a href="#cb14-926" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-927"><a href="#cb14-927" aria-hidden="true" tabindex="-1"></a><span class="fu">## Next Steps</span></span>
<span id="cb14-928"><a href="#cb14-928" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-929"><a href="#cb14-929" aria-hidden="true" tabindex="-1"></a>**Deepen C++ expertise:**</span>
<span id="cb14-930"><a href="#cb14-930" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-931"><a href="#cb14-931" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Study BigDataStatMeth's header implementations</span>
<span id="cb14-932"><a href="#cb14-932" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Learn OpenMP for parallel computing</span>
<span id="cb14-933"><a href="#cb14-933" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Explore Eigen library for advanced linear algebra</span>
<span id="cb14-934"><a href="#cb14-934" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Master C++ debugging tools (gdb, valgrind)</span>
<span id="cb14-935"><a href="#cb14-935" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-936"><a href="#cb14-936" aria-hidden="true" tabindex="-1"></a>**Optimize existing methods:**</span>
<span id="cb14-937"><a href="#cb14-937" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-938"><a href="#cb14-938" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Profile CCA implementation to find bottlenecks</span>
<span id="cb14-939"><a href="#cb14-939" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Implement parallel block processing</span>
<span id="cb14-940"><a href="#cb14-940" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Optimize memory allocation patterns</span>
<span id="cb14-941"><a href="#cb14-941" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Add SIMD vectorization where beneficial</span>
<span id="cb14-942"><a href="#cb14-942" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-943"><a href="#cb14-943" aria-hidden="true" tabindex="-1"></a>**Extend to new methods:**</span>
<span id="cb14-944"><a href="#cb14-944" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-945"><a href="#cb14-945" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Implement sparse CCA with custom regularization</span>
<span id="cb14-946"><a href="#cb14-946" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Build regularized PLS using similar patterns</span>
<span id="cb14-947"><a href="#cb14-947" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Create custom matrix factorizations</span>
<span id="cb14-948"><a href="#cb14-948" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Develop online/streaming algorithms</span>
<span id="cb14-949"><a href="#cb14-949" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-950"><a href="#cb14-950" aria-hidden="true" tabindex="-1"></a>**Production deployment:**</span>
<span id="cb14-951"><a href="#cb14-951" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-952"><a href="#cb14-952" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Add comprehensive error handling</span>
<span id="cb14-953"><a href="#cb14-953" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Implement logging and diagnostics</span>
<span id="cb14-954"><a href="#cb14-954" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Create extensive test suites</span>
<span id="cb14-955"><a href="#cb14-955" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Document C++ API for users</span>
<span id="cb14-956"><a href="#cb14-956" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Build CI/CD pipelines for testing</span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>© 2025 BigDataStatMeth - ISGlobal BRGE</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/isglobal-brge/BigDataStatMeth/edit/main/developing-methods/cca-cpp-implementation.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/isglobal-brge/BigDataStatMeth/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/isglobal-brge/BigDataStatMeth">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item">
 License: GPL-3
  </li>  
</ul>
    </div>
  </div>
</footer>




<script src="../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>