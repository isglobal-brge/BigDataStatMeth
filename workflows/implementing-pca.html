<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Implementing PCA – BigDataStatMeth</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../assets/favicon.png" rel="icon" type="image/png">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-065a5179aebd64318d7ea99d77b64a9e.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark-969ddfa49e00a70eb3423444dbc81f6c.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-065a5179aebd64318d7ea99d77b64a9e.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-d0f1cdce0779274a5ec1152cd33adb41.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark-d6747531eee53fd58085a197f3afc013.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-d0f1cdce0779274a5ec1152cd33adb41.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>html{ scroll-behavior: smooth; }</style>


<link rel="stylesheet" href="../assets/css/custom.css">
</head>

<body class="nav-sidebar docked nav-fixed quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../assets/images/logo.png" alt="" class="navbar-logo light-content">
    <img src="../assets/images/logo.png" alt="" class="navbar-logo dark-content">
    </a>
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">BigDataStatMeth</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="../index.html" aria-current="page"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-fundamentals" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Fundamentals</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-fundamentals">    
        <li>
    <a class="dropdown-item" href="../fundamentals/big-data-problem.html">
 <span class="dropdown-text">The Big Data Problem</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../fundamentals/understanding-hdf5.html">
 <span class="dropdown-text">Understanding HDF5</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../fundamentals/blockwise-computing.html">
 <span class="dropdown-text">Block-Wise Computing</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../fundamentals/linear-algebra.html">
 <span class="dropdown-text">Linear Algebra Essentials</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-tutorials" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Tutorials</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-tutorials">    
        <li>
    <a class="dropdown-item" href="../tutorials/getting-started.html">
 <span class="dropdown-text">Getting Started</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../tutorials/working-hdf5-matrices.html">
 <span class="dropdown-text">Working with HDF5 Matrices</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../tutorials/first-analysis.html">
 <span class="dropdown-text">Your First Analysis</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-workflows" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Workflows</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-workflows">    
        <li>
    <a class="dropdown-item" href="../workflows/implementing-pca.html">
 <span class="dropdown-text">Implementing PCA</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../workflows/implementing-cca.html">
 <span class="dropdown-text">Implementing CCA</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../workflows/cross-platform.html">
 <span class="dropdown-text">Cross-Platform Workflows</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-developing-methods" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Developing Methods</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-developing-methods">    
        <li>
    <a class="dropdown-item" href="../developing-methods/cca-r-implementation.html">
 <span class="dropdown-text">CCA in R</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../developing-methods/cca-cpp-implementation.html">
 <span class="dropdown-text">CCA in C++</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-api-reference" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">API Reference</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-api-reference">    
        <li>
    <a class="dropdown-item" href="../api-reference/r/index.html">
 <span class="dropdown-text">R Functions</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../api-reference/cpp/index.html">
 <span class="dropdown-text">C++ API</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../technical/performance.html"> 
<span class="menu-text">Technical</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/isglobal-brge/BigDataStatMeth"> <i class="bi bi-github" role="img" aria-label="GitHub">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://cran.r-project.org/package=BigDataStatMeth"> 
<span class="menu-text">CRAN</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../workflows/implementing-pca.html">Complete Examples</a></li><li class="breadcrumb-item"><a href="../workflows/implementing-pca.html">Implementing PCA</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="../index.html" class="sidebar-logo-link">
      </a>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Complete Examples</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../workflows/implementing-pca.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Implementing PCA</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../workflows/implementing-cca.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Implementing CCA</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../workflows/cross-platform.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Cross-Platform Workflows</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview"><span class="header-section-number">1</span> Overview</a>
  <ul class="collapse">
  <li><a href="#what-youll-learn" id="toc-what-youll-learn" class="nav-link" data-scroll-target="#what-youll-learn"><span class="header-section-number">1.1</span> What You’ll Learn</a></li>
  </ul></li>
  <li><a href="#the-dataset" id="toc-the-dataset" class="nav-link" data-scroll-target="#the-dataset"><span class="header-section-number">2</span> The Dataset</a></li>
  <li><a href="#step-1-data-preparation" id="toc-step-1-data-preparation" class="nav-link" data-scroll-target="#step-1-data-preparation"><span class="header-section-number">3</span> Step 1: Data Preparation</a>
  <ul class="collapse">
  <li><a href="#download-the-example-data" id="toc-download-the-example-data" class="nav-link" data-scroll-target="#download-the-example-data"><span class="header-section-number">3.1</span> Download the Example Data</a></li>
  <li><a href="#convert-gds-to-hdf5" id="toc-convert-gds-to-hdf5" class="nav-link" data-scroll-target="#convert-gds-to-hdf5"><span class="header-section-number">3.2</span> Convert GDS to HDF5</a></li>
  </ul></li>
  <li><a href="#step-2-quality-control" id="toc-step-2-quality-control" class="nav-link" data-scroll-target="#step-2-quality-control"><span class="header-section-number">4</span> Step 2: Quality Control</a>
  <ul class="collapse">
  <li><a href="#remove-low-quality-samples" id="toc-remove-low-quality-samples" class="nav-link" data-scroll-target="#remove-low-quality-samples"><span class="header-section-number">4.1</span> Remove Low-Quality Samples</a></li>
  <li><a href="#remove-low-frequency-and-high-missingness-snps" id="toc-remove-low-frequency-and-high-missingness-snps" class="nav-link" data-scroll-target="#remove-low-frequency-and-high-missingness-snps"><span class="header-section-number">4.2</span> Remove Low-Frequency and High-Missingness SNPs</a></li>
  <li><a href="#impute-remaining-missing-data" id="toc-impute-remaining-missing-data" class="nav-link" data-scroll-target="#impute-remaining-missing-data"><span class="header-section-number">4.3</span> Impute Remaining Missing Data</a></li>
  </ul></li>
  <li><a href="#step-3-perform-pca" id="toc-step-3-perform-pca" class="nav-link" data-scroll-target="#step-3-perform-pca"><span class="header-section-number">5</span> Step 3: Perform PCA</a>
  <ul class="collapse">
  <li><a href="#understanding-the-parameters" id="toc-understanding-the-parameters" class="nav-link" data-scroll-target="#understanding-the-parameters"><span class="header-section-number">5.1</span> Understanding the Parameters</a></li>
  </ul></li>
  <li><a href="#step-4-extract-and-examine-results" id="toc-step-4-extract-and-examine-results" class="nav-link" data-scroll-target="#step-4-extract-and-examine-results"><span class="header-section-number">6</span> Step 4: Extract and Examine Results</a>
  <ul class="collapse">
  <li><a href="#load-pca-components" id="toc-load-pca-components" class="nav-link" data-scroll-target="#load-pca-components"><span class="header-section-number">6.1</span> Load PCA Components</a></li>
  </ul></li>
  <li><a href="#step-5-visualize-population-structure" id="toc-step-5-visualize-population-structure" class="nav-link" data-scroll-target="#step-5-visualize-population-structure"><span class="header-section-number">7</span> Step 5: Visualize Population Structure</a>
  <ul class="collapse">
  <li><a href="#merge-with-population-labels" id="toc-merge-with-population-labels" class="nav-link" data-scroll-target="#merge-with-population-labels"><span class="header-section-number">7.1</span> Merge with Population Labels</a></li>
  <li><a href="#create-pca-plot" id="toc-create-pca-plot" class="nav-link" data-scroll-target="#create-pca-plot"><span class="header-section-number">7.2</span> Create PCA Plot</a></li>
  <li><a href="#scree-plot-for-variance" id="toc-scree-plot-for-variance" class="nav-link" data-scroll-target="#scree-plot-for-variance"><span class="header-section-number">7.3</span> Scree Plot for Variance</a></li>
  </ul></li>
  <li><a href="#step-6-export-results" id="toc-step-6-export-results" class="nav-link" data-scroll-target="#step-6-export-results"><span class="header-section-number">8</span> Step 6: Export Results</a>
  <ul class="collapse">
  <li><a href="#save-principal-components-for-downstream-analysis" id="toc-save-principal-components-for-downstream-analysis" class="nav-link" data-scroll-target="#save-principal-components-for-downstream-analysis"><span class="header-section-number">8.1</span> Save Principal Components for Downstream Analysis</a></li>
  </ul></li>
  <li><a href="#interactive-exercise" id="toc-interactive-exercise" class="nav-link" data-scroll-target="#interactive-exercise"><span class="header-section-number">9</span> Interactive Exercise</a>
  <ul class="collapse">
  <li><a href="#practice-optimizing-pca-for-your-data" id="toc-practice-optimizing-pca-for-your-data" class="nav-link" data-scroll-target="#practice-optimizing-pca-for-your-data"><span class="header-section-number">9.1</span> Practice: Optimizing PCA for Your Data</a></li>
  </ul></li>
  <li><a href="#key-takeaways" id="toc-key-takeaways" class="nav-link" data-scroll-target="#key-takeaways"><span class="header-section-number">10</span> Key Takeaways</a>
  <ul class="collapse">
  <li><a href="#essential-concepts" id="toc-essential-concepts" class="nav-link" data-scroll-target="#essential-concepts"><span class="header-section-number">10.1</span> Essential Concepts</a></li>
  <li><a href="#when-to-use-this-workflow" id="toc-when-to-use-this-workflow" class="nav-link" data-scroll-target="#when-to-use-this-workflow"><span class="header-section-number">10.2</span> When to Use This Workflow</a></li>
  </ul></li>
  <li><a href="#next-steps" id="toc-next-steps" class="nav-link" data-scroll-target="#next-steps"><span class="header-section-number">11</span> Next Steps</a></li>
  <li><a href="#cleanup" id="toc-cleanup" class="nav-link" data-scroll-target="#cleanup"><span class="header-section-number">12</span> Cleanup</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/isglobal-brge/BigDataStatMeth/edit/main/workflows/implementing-pca.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/isglobal-brge/BigDataStatMeth/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">


<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../workflows/implementing-pca.html">Complete Examples</a></li><li class="breadcrumb-item"><a href="../workflows/implementing-pca.html">Implementing PCA</a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Implementing PCA</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
<p class="subtitle lead">Principal Component Analysis on Large-Scale Genomic Data</p>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="overview" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="overview"><span class="header-section-number">1</span> Overview</h2>
<p>Principal Component Analysis (PCA) is fundamental in genomics for identifying population structure, detecting batch effects, and reducing dimensionality before association tests. This workflow demonstrates a complete PCA implementation on real-world scale genomic data using BigDataStatMeth, from raw GDS files through quality control to publication-quality visualizations.</p>
<p>Unlike tutorial examples with synthetic data, this workflow uses realistic dataset dimensions (hundreds of thousands of variants, thousands of samples) and addresses practical challenges you’ll face with real data: file format conversions, multi-step quality control, computational optimization, and result interpretation. Think of this as the blueprint for your actual genomic PCA analyses.</p>
<section id="what-youll-learn" class="level3 learning-objectives" data-number="1.1">
<h3 data-number="1.1" class="anchored" data-anchor-id="what-youll-learn"><span class="header-section-number">1.1</span> What You’ll Learn</h3>
<p>By the end of this workflow, you will:</p>
<ul>
<li>Convert GDS (Genomic Data Structure) files to HDF5 format for analysis</li>
<li>Apply comprehensive quality control for genomic data</li>
<li>Perform block-wise PCA on datasets too large for memory</li>
<li>Optimize computational parameters for your hardware</li>
<li>Interpret variance explained and principal component loadings</li>
<li>Create publication-quality PCA plots showing population structure</li>
<li>Export results for downstream analyses</li>
<li>Understand when and why each processing step matters</li>
</ul>
</section>
<hr>
</section>
<section id="the-dataset" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="the-dataset"><span class="header-section-number">2</span> The Dataset</h2>
<p>We’ll analyze the 1000 Genomes Project data, which provides genetic variants from diverse human populations. This represents a realistic scale for many genomic studies:</p>
<ul>
<li><strong>Samples:</strong> 2,504 individuals from 26 populations</li>
<li><strong>Variants:</strong> ~800,000 SNPs after standard QC</li>
<li><strong>File size:</strong> ~2-3 GB in GDS format</li>
<li><strong>Analysis goal:</strong> Identify continental ancestry structure</li>
</ul>
<p>This dataset is small enough to complete on a workstation but large enough that naive approaches (loading everything into memory, using standard R PCA) become problematic. It perfectly illustrates when and why BigDataStatMeth becomes necessary.</p>
<hr>
</section>
<section id="step-1-data-preparation" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="step-1-data-preparation"><span class="header-section-number">3</span> Step 1: Data Preparation</h2>
<section id="download-the-example-data" class="level3" data-number="3.1">
<h3 data-number="3.1" class="anchored" data-anchor-id="download-the-example-data"><span class="header-section-number">3.1</span> Download the Example Data</h3>
<p>The 1000 Genomes ethnic subset is available from the BigDataStatMeth supplementary materials:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(BigDataStatMeth)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gdsfmt)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rhdf5)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Download genomic data (GDS format)</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">download.file</span>(</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">url =</span> <span class="fu">paste0</span>(<span class="st">"https://raw.githubusercontent.com/isglobal-brge/"</span>,</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>               <span class="st">"Supplementary-Material/master/Pelegri-Siso_2025/"</span>,</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>               <span class="st">"application_examples/PCA/data/1000G_ethnic.zip"</span>),</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">destfile =</span> <span class="st">"1000G_ethnic.zip"</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="fu">unzip</span>(<span class="st">"1000G_ethnic.zip"</span>)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Download phenotype data (population labels)</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>pheno_url <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"https://raw.githubusercontent.com/isglobal-brge/"</span>,</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"Supplementary-Material/master/Pelegri-Siso_2025/"</span>,</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"application_examples/PCA/data/1000G_samples.tsv"</span>)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="fu">download.file</span>(pheno_url, <span class="at">destfile =</span> <span class="st">"1000G_samples.tsv"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>GDS Format
</div>
</div>
<div class="callout-body-container callout-body">
<p>GDS (Genomic Data Structure) is a container format commonly used for genomic data from sequencing studies. The <code>gdsfmt</code> and <code>SeqArray</code> packages provide tools to work with GDS files. We’ll convert to HDF5 because BigDataStatMeth operates on HDF5 matrices, and this conversion pattern applies to any genomic data source.</p>
</div>
</div>
</section>
<section id="convert-gds-to-hdf5" class="level3" data-number="3.2">
<h3 data-number="3.2" class="anchored" data-anchor-id="convert-gds-to-hdf5"><span class="header-section-number">3.2</span> Convert GDS to HDF5</h3>
<p>Genomic data often arrives in specialized formats (GDS, VCF, PLINK). BigDataStatMeth needs numeric matrices in HDF5 format, so conversion is the first step:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Open GDS file</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>gds_file <span class="ot">&lt;-</span> <span class="st">"1000G_ethnic.gds"</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>gds <span class="ot">&lt;-</span> <span class="fu">openfn.gds</span>(gds_file)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract genotype matrix</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>geno_node <span class="ot">&lt;-</span> <span class="fu">index.gdsn</span>(gds, <span class="st">"genotype"</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>genotype <span class="ot">&lt;-</span> <span class="fu">read.gdsn</span>(geno_node)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract sample and variant identifiers</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>sample_ids <span class="ot">&lt;-</span> <span class="fu">read.gdsn</span>(<span class="fu">index.gdsn</span>(gds, <span class="st">"sample.id"</span>))</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>snp_ids <span class="ot">&lt;-</span> <span class="fu">read.gdsn</span>(<span class="fu">index.gdsn</span>(gds, <span class="st">"snp.rs.id"</span>))</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign meaningful row and column names</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(genotype) <span class="ot">&lt;-</span> sample_ids</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(genotype) <span class="ot">&lt;-</span> snp_ids</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Close GDS file</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="fu">closefn.gds</span>(gds)</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>genotype <span class="ot">&lt;-</span> genotype[<span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>,]</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Check dimensions before proceeding</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Genotype matrix dimensions:</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Genotype matrix dimensions:</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Samples:"</span>, <span class="fu">nrow</span>(genotype), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Samples: 1000 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  SNPs:"</span>, <span class="fu">ncol</span>(genotype), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  SNPs: 78322 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Missing data:"</span>, </span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sprintf</span>(<span class="st">"%.2f%%"</span>, <span class="fu">sum</span>(<span class="fu">is.na</span>(genotype))<span class="sc">/</span><span class="fu">length</span>(genotype)<span class="sc">*</span><span class="dv">100</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Missing data: 0.00% </code></pre>
</div>
</div>
<p>Now convert to HDF5, organizing logically for subsequent analyses:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create HDF5 file with organized structure</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>pca_file <span class="ot">&lt;-</span> <span class="st">"1000G_pca_analysis.hdf5"</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="fu">bdCreate_hdf5_matrix</span>(</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> pca_file,</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">object =</span> genotype,</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">group =</span> <span class="st">"raw_data"</span>,</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">dataset =</span> <span class="st">"genotypes"</span>,</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">transp =</span> <span class="cn">FALSE</span>,  <span class="co"># Keep samples as rows, SNPs as columns</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">overwriteFile =</span> <span class="cn">TRUE</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>$fn
[1] "1000G_pca_analysis.hdf5"

$ds
[1] "raw_data/genotypes"</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"✓ HDF5 file created:"</span>, pca_file, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>✓ HDF5 file created: 1000G_pca_analysis.hdf5 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">h5ls</span>(pca_file)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>                          group                name       otype   dclass
0                             /            raw_data   H5I_GROUP         
1                     /raw_data .genotypes_dimnames   H5I_GROUP         
2 /raw_data/.genotypes_dimnames                   1 H5I_DATASET COMPOUND
3 /raw_data/.genotypes_dimnames                   2 H5I_DATASET COMPOUND
4                     /raw_data           genotypes H5I_DATASET  INTEGER
           dim
0             
1             
2         2504
3        78322
4 2504 x 78322</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>Organizing Your HDF5 File
</div>
</div>
<div class="callout-body-container callout-body">
<p>We create a <code>/raw_data/</code> group for the original genotypes. Subsequent QC steps will create <code>/quality_control/</code> for filtered data, and <code>/analysis/pca/</code> for results. This mirrors a typical analysis workflow and keeps intermediate steps traceable. If you need to rerun QC with different thresholds, raw data remains untouched.</p>
</div>
</div>
<hr>
</section>
</section>
<section id="step-2-quality-control" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="step-2-quality-control"><span class="header-section-number">4</span> Step 2: Quality Control</h2>
<section id="remove-low-quality-samples" class="level3" data-number="4.1">
<h3 data-number="4.1" class="anchored" data-anchor-id="remove-low-quality-samples"><span class="header-section-number">4.1</span> Remove Low-Quality Samples</h3>
<p>Samples with excessive missing data often indicate technical problems (poor DNA quality, sequencing failures). We filter samples before variant-level QC:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove samples with &gt;5% missing data</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>sample_qc <span class="ot">&lt;-</span> <span class="fu">bdRemovelowdata_hdf5</span>(</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> pca_file,</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">group =</span> <span class="st">"raw_data"</span>,</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">dataset =</span> <span class="st">"genotypes"</span>,</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">outgroup =</span> <span class="st">"quality_control"</span>,</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">outdataset =</span> <span class="st">"samples_qc"</span>,</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">bycols =</span> <span class="cn">FALSE</span>,  <span class="co"># Operate on rows (samples)</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">pcent =</span> <span class="fl">0.05</span>,</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">overwrite =</span> <span class="cn">TRUE</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Sample QC results:</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Sample QC results:</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Samples removed:"</span>, sample_qc<span class="sc">$</span>elements_removed, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Samples removed: </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Samples retained:"</span>, sample_qc<span class="sc">$</span>elements_retained, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Samples retained: </code></pre>
</div>
</div>
</section>
<section id="remove-low-frequency-and-high-missingness-snps" class="level3" data-number="4.2">
<h3 data-number="4.2" class="anchored" data-anchor-id="remove-low-frequency-and-high-missingness-snps"><span class="header-section-number">4.2</span> Remove Low-Frequency and High-Missingness SNPs</h3>
<p>Rare variants (low minor allele frequency) provide little information for PCA and can introduce noise. Similarly, SNPs with high missingness are unreliable:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove SNPs with &gt;5% missing data</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>snp_missing_qc <span class="ot">&lt;-</span> <span class="fu">bdRemovelowdata_hdf5</span>(</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> pca_file,</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">group =</span> <span class="st">"quality_control"</span>,</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">dataset =</span> <span class="st">"samples_qc"</span>,</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">outgroup =</span> <span class="st">"quality_control"</span>,</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">outdataset =</span> <span class="st">"snps_missing_qc"</span>,</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">bycols =</span> <span class="cn">TRUE</span>,  <span class="co"># Operate on columns (SNPs)</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">pcent =</span> <span class="fl">0.05</span>,</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">overwrite =</span> <span class="cn">TRUE</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"SNP missingness QC:</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>SNP missingness QC:</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  SNPs removed:"</span>, snp_missing_qc<span class="sc">$</span>elements_removed, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  SNPs removed: </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  SNPs retained:"</span>, snp_missing_qc<span class="sc">$</span>elements_retained, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  SNPs retained: </code></pre>
</div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove SNPs with MAF &lt; 5%</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>maf_qc <span class="ot">&lt;-</span> <span class="fu">bdRemoveMAF_hdf5</span>(</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> pca_file,</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">group =</span> <span class="st">"quality_control"</span>,</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">dataset =</span> <span class="st">"snps_missing_qc"</span>,</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">outgroup =</span> <span class="st">"quality_control"</span>,</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">outdataset =</span> <span class="st">"snps_qc_complete"</span>,</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">maf =</span> <span class="fl">0.05</span>,</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">bycols =</span> <span class="cn">TRUE</span>,</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">blocksize =</span> <span class="dv">1000</span>,</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">overwrite =</span> <span class="cn">TRUE</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"MAF QC:</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>MAF QC:</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  SNPs removed:"</span>, maf_qc<span class="sc">$</span>elements_removed, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  SNPs removed: </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  SNPs retained:"</span>, maf_qc<span class="sc">$</span>elements_retained, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  SNPs retained: </code></pre>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span>QC Ordering Matters
</div>
</div>
<div class="callout-body-container callout-body">
<p>We filter samples first, then SNP missingness, then MAF. Why this order?</p>
<ol type="1">
<li><strong>Samples first:</strong> Removing low-quality samples changes allele frequencies and missingness calculations for SNPs</li>
<li><strong>Missingness before MAF:</strong> SNPs with high missingness have unreliable allele frequency estimates</li>
<li><strong>MAF last:</strong> After removing missing data, MAF calculations are accurate</li>
</ol>
<p>Reversing this order produces different results. The standard practice is sample → missingness → MAF.</p>
</div>
</div>
</section>
<section id="impute-remaining-missing-data" class="level3" data-number="4.3">
<h3 data-number="4.3" class="anchored" data-anchor-id="impute-remaining-missing-data"><span class="header-section-number">4.3</span> Impute Remaining Missing Data</h3>
<p>After QC, remaining missingness is typically &lt;1-2%. Simple mean imputation suffices for this low level:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Impute missing values with column (SNP) means</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="fu">bdImputeSNPs_hdf5</span>(</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> pca_file,</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">group =</span> <span class="st">"quality_control"</span>,</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">dataset =</span> <span class="st">"snps_qc_complete"</span>,</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">bycols =</span> <span class="cn">TRUE</span>,</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">outgroup =</span> <span class="st">"quality_control"</span>,</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">outdataset =</span> <span class="st">"genotypes_imputed"</span>,</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">overwrite =</span> <span class="cn">TRUE</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>$fn
[1] "1000G_pca_analysis.hdf5"

$ds
[1] "quality_control/snps_qc_complete"</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"✓ Missing data imputed</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>✓ Missing data imputed</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify no missing data remains</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>h5file <span class="ot">&lt;-</span> <span class="fu">H5Fopen</span>(pca_file)</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>imputed_data <span class="ot">&lt;-</span> h5file<span class="sc">$</span>quality_control<span class="sc">$</span>genotypes_imputed</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Missing values remaining:"</span>, <span class="fu">sum</span>(<span class="fu">is.na</span>(imputed_data[<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>])), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Missing values remaining: 0 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">H5Fclose</span>(h5file)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<hr>
</section>
</section>
<section id="step-3-perform-pca" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="step-3-perform-pca"><span class="header-section-number">5</span> Step 3: Perform PCA</h2>
<section id="understanding-the-parameters" class="level3" data-number="5.1">
<h3 data-number="5.1" class="anchored" data-anchor-id="understanding-the-parameters"><span class="header-section-number">5.1</span> Understanding the Parameters</h3>
<p>PCA on large matrices uses hierarchical block-wise SVD. Key parameters:</p>
<ul>
<li><strong>k:</strong> Number of blocks to partition the matrix into</li>
<li><strong>q:</strong> Number of hierarchical levels</li>
<li><strong>Components:</strong> How many PCs to compute (typically 10-50)</li>
<li><strong>Centering:</strong> Almost always TRUE for PCA</li>
<li><strong>Scaling:</strong> Usually FALSE for SNP data (all same units)</li>
</ul>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform block-wise PCA</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>pca_result <span class="ot">&lt;-</span> <span class="fu">bdPCA_hdf5</span>(</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> pca_file,</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">group =</span> <span class="st">"quality_control"</span>,</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">dataset =</span> <span class="st">"genotypes_imputed"</span>,</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">k =</span> <span class="dv">4</span>,            <span class="co"># 4 blocks balances memory and speed</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">q =</span> <span class="dv">1</span>,            <span class="co"># 1 level sufficient for this data size</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">bcenter =</span> <span class="cn">TRUE</span>,   <span class="co"># Center SNPs (subtract column means)</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">bscale =</span> <span class="cn">FALSE</span>,   <span class="co"># Don't scale (SNPs same units)</span></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">ncomponents =</span> <span class="dv">20</span>, <span class="co"># Compute first 20 PCs</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">threads =</span> <span class="dv">4</span>,      <span class="co"># Use 4 threads (adjust to your CPU)</span></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">overwrite =</span> <span class="cn">TRUE</span></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"✓ PCA complete</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>✓ PCA complete</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Computational Considerations
</div>
</div>
<div class="callout-body-container callout-body">
<p>For this dataset (~2500 samples × ~80,000 SNPs after QC): - <strong>Memory usage:</strong> Peak ~4-6 GB with k=4 - <strong>Computation time:</strong> ~2-5 minutes on modern CPU - <strong>Threads:</strong> Diminishing returns beyond physical cores</p>
<p>Larger datasets (50,000 samples × 500,000 SNPs) might need k=8-16 and q=2 for reasonable memory usage.</p>
</div>
</div>
<hr>
</section>
</section>
<section id="step-4-extract-and-examine-results" class="level2" data-number="6">
<h2 data-number="6" class="anchored" data-anchor-id="step-4-extract-and-examine-results"><span class="header-section-number">6</span> Step 4: Extract and Examine Results</h2>
<section id="load-pca-components" class="level3" data-number="6.1">
<h3 data-number="6.1" class="anchored" data-anchor-id="load-pca-components"><span class="header-section-number">6.1</span> Load PCA Components</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Open file to access PCA results</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>h5file <span class="ot">&lt;-</span> <span class="fu">H5Fopen</span>(pca_file)</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract components (the principal components themselves)</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>pcs <span class="ot">&lt;-</span> h5file<span class="sc">$</span>PCA<span class="sc">$</span>genotypes_imputed<span class="sc">$</span>components</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>pcs <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(pcs)</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(pcs) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"PC"</span>, <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(pcs))</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Add sample IDs</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>sample_names <span class="ot">&lt;-</span> h5file<span class="sc">$</span>raw_data<span class="sc">$</span>.genotypes_dimnames<span class="sc">$</span><span class="st">`</span><span class="at">1</span><span class="st">`</span>[,<span class="dv">1</span>]</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>pcs<span class="sc">$</span>sample_id <span class="ot">&lt;-</span> sample_names[<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(pcs)]  <span class="co"># Account for samples removed in QC</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract variance explained</span></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>variance_prop <span class="ot">&lt;-</span> h5file<span class="sc">$</span>PCA<span class="sc">$</span>genotypes_imputed<span class="sc">$</span>variance[,<span class="dv">1</span>]</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a><span class="fu">H5Fclose</span>(h5file)</span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Preview principal components</span></span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">First 5 samples, first 5 PCs:</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
First 5 samples, first 5 PCs:</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(pcs[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>])  <span class="co"># First 5 PCs + sample_id</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>         PC1        PC2       PC3        PC4        PC5       PC6
1 -0.2853922 -1.3649065 0.6454470  1.1533012 -1.2112287 0.3623916
2 -0.7943544 -0.8494820 1.2276331 -1.9259606 -1.1051614 0.2707729
3 -0.4685347 -0.8840233 0.4830970  1.7655353  1.1815834 0.2693867
4 -0.2310929 -1.0369896 0.2354575 -0.2605435 -0.8110573 0.3939840
5 -0.3307356 -1.0352414 0.5485452 -0.6088280 -0.4052957 2.0210173</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Variance explained summary</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Variance explained by each PC:</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Variance explained by each PC:</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>variance_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">PC =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(variance_prop),</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">Variance =</span> <span class="fu">sprintf</span>(<span class="st">"%.2f%%"</span>, variance_prop),</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">Cumulative =</span> <span class="fu">sprintf</span>(<span class="st">"%.2f%%"</span>, <span class="fu">cumsum</span>(variance_prop))</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(variance_df[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, ])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>   PC Variance Cumulative
1   1   10.37%     10.37%
2   2    5.36%     15.73%
3   3    1.96%     17.69%
4   4    1.29%     18.98%
5   5    1.20%     20.18%
6   6    1.04%     21.22%
7   7    0.98%     22.20%
8   8    0.96%     23.16%
9   9    0.93%     24.09%
10 10    0.90%     24.99%</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>Interpreting Variance Explained
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>For population structure PCA:</strong> - PC1-PC2 typically explain 2-5% each for global ancestry - PC1-PC10 together often explain 10-20% - Low variance per PC is expected - population structure is subtle</p>
<p><strong>Red flags:</strong> - PC1 &gt;50%: Possible batch effect or technical artifact - PC1-10 &lt;5% total: Either very homogeneous population or too much noise - Sudden drop after PC1: Might indicate strong population stratification</p>
<p>For this 1000 Genomes data, expect PC1 ~3-5% (continental ancestry) and PC2 ~2-3% (finer structure).</p>
</div>
</div>
<hr>
</section>
</section>
<section id="step-5-visualize-population-structure" class="level2" data-number="7">
<h2 data-number="7" class="anchored" data-anchor-id="step-5-visualize-population-structure"><span class="header-section-number">7</span> Step 5: Visualize Population Structure</h2>
<section id="merge-with-population-labels" class="level3" data-number="7.1">
<h3 data-number="7.1" class="anchored" data-anchor-id="merge-with-population-labels"><span class="header-section-number">7.1</span> Merge with Population Labels</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Load population information</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>pheno <span class="ot">&lt;-</span> <span class="fu">read_delim</span>(</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"1000G_samples.tsv"</span>,</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">delim =</span> <span class="st">"</span><span class="sc">\t</span><span class="st">"</span>,</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">show_col_types =</span> <span class="cn">FALSE</span></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge PCs with phenotype data</span></span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>pca_data <span class="ot">&lt;-</span> pcs <span class="sc">%&gt;%</span></span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(pheno, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"sample_id"</span> <span class="ot">=</span> <span class="st">"Sample name"</span>))</span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Check merge success</span></span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Samples with population labels:"</span>, </span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(pca_data<span class="sc">$</span><span class="st">`</span><span class="at">Superpopulation code</span><span class="st">`</span>)), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Samples with population labels: 1000 </code></pre>
</div>
</div>
</section>
<section id="create-pca-plot" class="level3" data-number="7.2">
<h3 data-number="7.2" class="anchored" data-anchor-id="create-pca-plot"><span class="header-section-number">7.2</span> Create PCA Plot</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Define population colors</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>pop_colors <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"AFR"</span> <span class="ot">=</span> <span class="st">"#E41A1C"</span>,  <span class="co"># African - Red</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"AMR"</span> <span class="ot">=</span> <span class="st">"#377EB8"</span>,  <span class="co"># American - Blue</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"EAS"</span> <span class="ot">=</span> <span class="st">"#4DAF4A"</span>,  <span class="co"># East Asian - Green</span></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">"EUR"</span> <span class="ot">=</span> <span class="st">"#984EA3"</span>,  <span class="co"># European - Purple</span></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">"SAS"</span> <span class="ot">=</span> <span class="st">"#FF7F00"</span>   <span class="co"># South Asian - Orange</span></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Create PCA plot</span></span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>pca_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(</span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>  pca_data, </span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> PC1, <span class="at">y =</span> PC2, <span class="at">color =</span> <span class="st">`</span><span class="at">Superpopulation code</span><span class="st">`</span>)</span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">2</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(</span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> pop_colors,</span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Ancestry"</span>,</span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(</span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a>      <span class="st">"AFR"</span> <span class="ot">=</span> <span class="st">"African"</span>,</span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a>      <span class="st">"AMR"</span> <span class="ot">=</span> <span class="st">"American"</span>, </span>
<span id="cb53-24"><a href="#cb53-24" aria-hidden="true" tabindex="-1"></a>      <span class="st">"EAS"</span> <span class="ot">=</span> <span class="st">"East Asian"</span>,</span>
<span id="cb53-25"><a href="#cb53-25" aria-hidden="true" tabindex="-1"></a>      <span class="st">"EUR"</span> <span class="ot">=</span> <span class="st">"European"</span>,</span>
<span id="cb53-26"><a href="#cb53-26" aria-hidden="true" tabindex="-1"></a>      <span class="st">"SAS"</span> <span class="ot">=</span> <span class="st">"South Asian"</span></span>
<span id="cb53-27"><a href="#cb53-27" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb53-28"><a href="#cb53-28" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb53-29"><a href="#cb53-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb53-30"><a href="#cb53-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Population Structure in 1000 Genomes Project"</span>,</span>
<span id="cb53-31"><a href="#cb53-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"PCA reveals continental ancestry patterns"</span>,</span>
<span id="cb53-32"><a href="#cb53-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">sprintf</span>(<span class="st">"PC1 (%.2f%% variance)"</span>, variance_prop[<span class="dv">1</span>] <span class="sc">*</span> <span class="dv">100</span>),</span>
<span id="cb53-33"><a href="#cb53-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">sprintf</span>(<span class="st">"PC2 (%.2f%% variance)"</span>, variance_prop[<span class="dv">2</span>] <span class="sc">*</span> <span class="dv">100</span>)</span>
<span id="cb53-34"><a href="#cb53-34" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb53-35"><a href="#cb53-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb53-36"><a href="#cb53-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb53-37"><a href="#cb53-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb53-38"><a href="#cb53-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb53-39"><a href="#cb53-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">color =</span> <span class="st">"gray40"</span>),</span>
<span id="cb53-40"><a href="#cb53-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb53-41"><a href="#cb53-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>()</span>
<span id="cb53-42"><a href="#cb53-42" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb53-43"><a href="#cb53-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-44"><a href="#cb53-44" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(pca_plot)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="implementing-pca_files/figure-html/pca-plot-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Save plot</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"pca_population_structure.png"</span>,</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>  pca_plot,</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">width =</span> <span class="dv">10</span>,</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">height =</span> <span class="dv">7</span>,</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">dpi =</span> <span class="dv">300</span></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"✓ Plot saved to pca_population_structure.png</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>✓ Plot saved to pca_population_structure.png</code></pre>
</div>
</div>
</section>
<section id="scree-plot-for-variance" class="level3" data-number="7.3">
<h3 data-number="7.3" class="anchored" data-anchor-id="scree-plot-for-variance"><span class="header-section-number">7.3</span> Scree Plot for Variance</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare data for scree plot</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>n_show <span class="ot">&lt;-</span> <span class="fu">min</span>(<span class="dv">20</span>, <span class="fu">length</span>(variance_prop))</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>scree_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">PC =</span> <span class="dv">1</span><span class="sc">:</span>n_show,</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">Variance =</span> variance_prop[<span class="dv">1</span><span class="sc">:</span>n_show] <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Create scree plot</span></span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>scree_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(scree_data, <span class="fu">aes</span>(<span class="at">x =</span> PC, <span class="at">y =</span> Variance)) <span class="sc">+</span></span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"steelblue"</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">"steelblue"</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Scree Plot: Variance Explained by Principal Components"</span>,</span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Principal Component"</span>,</span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Variance Explained (%)"</span></span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>()</span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb56-23"><a href="#cb56-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">1</span>, n_show, <span class="at">by =</span> <span class="dv">2</span>))</span>
<span id="cb56-24"><a href="#cb56-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-25"><a href="#cb56-25" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(scree_plot)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="implementing-pca_files/figure-html/scree-plot-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"pca_scree_plot.png"</span>,</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>  scree_plot,</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">width =</span> <span class="dv">8</span>,</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">height =</span> <span class="dv">6</span>,</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">dpi =</span> <span class="dv">300</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<hr>
</section>
</section>
<section id="step-6-export-results" class="level2" data-number="8">
<h2 data-number="8" class="anchored" data-anchor-id="step-6-export-results"><span class="header-section-number">8</span> Step 6: Export Results</h2>
<section id="save-principal-components-for-downstream-analysis" class="level3" data-number="8.1">
<h3 data-number="8.1" class="anchored" data-anchor-id="save-principal-components-for-downstream-analysis"><span class="header-section-number">8.1</span> Save Principal Components for Downstream Analysis</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Export first 10 PCs for association testing</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>pcs_export <span class="ot">&lt;-</span> pcs[, <span class="fu">c</span>(<span class="st">"sample_id"</span>, <span class="fu">paste0</span>(<span class="st">"PC"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>))]</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a><span class="fu">write.table</span>(</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>  pcs_export,</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"principal_components_1000G.txt"</span>,</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">sep =</span> <span class="st">"</span><span class="sc">\t</span><span class="st">"</span>,</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">row.names =</span> <span class="cn">FALSE</span>,</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">quote =</span> <span class="cn">FALSE</span></span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"✓ Principal components exported to principal_components_1000G.txt</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>✓ Principal components exported to principal_components_1000G.txt</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Samples:"</span>, <span class="fu">nrow</span>(pcs_export), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Samples: 1000 </code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  PCs included: 10</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  PCs included: 10</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Using PCs in Downstream Analyses
</div>
</div>
<div class="callout-body-container callout-body">
<p>These PCs can be included as covariates in:</p>
<ul>
<li><strong>GWAS:</strong> Adjust for population stratification</li>
<li><strong>Expression QTL mapping:</strong> Control for ancestry</li>
<li><strong>Polygenic risk scores:</strong> Account for population structure</li>
<li><strong>Clustering:</strong> Define ancestry-matched subcohorts</li>
</ul>
<p>Standard practice uses PC1-10, though some studies include PC1-20 for fine-scale structure.</p>
</div>
</div>
<hr>
</section>
</section>
<section id="interactive-exercise" class="level2 exercise" data-number="9">
<h2 class="exercise anchored" data-number="9" data-anchor-id="interactive-exercise"><span class="header-section-number">9</span> Interactive Exercise</h2>
<section id="practice-optimizing-pca-for-your-data" class="level3" data-number="9.1">
<h3 data-number="9.1" class="anchored" data-anchor-id="practice-optimizing-pca-for-your-data"><span class="header-section-number">9.1</span> Practice: Optimizing PCA for Your Data</h3>
<p>Understanding how parameters affect computation helps you optimize analyses for your specific datasets and hardware.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Exercise: Try different parameter combinations</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Scenario 1: Larger dataset (memory-constrained)</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a><span class="co"># You have 50,000 samples × 500,000 SNPs, 32 GB RAM</span></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a><span class="fu">bdPCA_hdf5</span>(</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> your_file,</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">group =</span> <span class="st">"qc"</span>,</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">dataset =</span> <span class="st">"genotypes"</span>,</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">k =</span> <span class="dv">16</span>,          <span class="co"># More blocks to reduce memory</span></span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">q =</span> <span class="dv">2</span>,           <span class="co"># Two levels for hierarchical processing</span></span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">components =</span> <span class="dv">10</span>,</span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">threads =</span> <span class="dv">8</span></span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Scenario 2: Small dataset (speed-focused)</span></span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a><span class="co"># You have 1,000 samples × 10,000 SNPs, plenty of RAM</span></span>
<span id="cb64-17"><a href="#cb64-17" aria-hidden="true" tabindex="-1"></a><span class="fu">bdPCA_hdf5</span>(</span>
<span id="cb64-18"><a href="#cb64-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> your_file,</span>
<span id="cb64-19"><a href="#cb64-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">group =</span> <span class="st">"qc"</span>,</span>
<span id="cb64-20"><a href="#cb64-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">dataset =</span> <span class="st">"genotypes"</span>,</span>
<span id="cb64-21"><a href="#cb64-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">k =</span> <span class="dv">2</span>,           <span class="co"># Fewer blocks (less overhead)</span></span>
<span id="cb64-22"><a href="#cb64-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">q =</span> <span class="dv">1</span>,           <span class="co"># Single level</span></span>
<span id="cb64-23"><a href="#cb64-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">components =</span> <span class="dv">20</span>,</span>
<span id="cb64-24"><a href="#cb64-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">threads =</span> <span class="dv">4</span></span>
<span id="cb64-25"><a href="#cb64-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb64-26"><a href="#cb64-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-27"><a href="#cb64-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Question: How does changing k affect your analysis?</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>Reflection Questions
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>1. Parameter Selection:</strong> - For your data size, what k value balances memory and speed? - How do you decide between q=1 vs.&nbsp;q=2? - When would you compute 50 PCs instead of 20?</p>
<p><strong>2. Quality Control Impact:</strong> - What if you skip MAF filtering? More noise, or more information? - How aggressive should missingness thresholds be? - When might you use different QC for different analyses?</p>
<p><strong>3. Interpreting Results:</strong> - PC1 explains 4% of variance. Is that good or bad? - You see a cluster separate from all populations. What might it be? - PCs correlate with sequencing batch. How do you handle this?</p>
<p><strong>4. Computational Scaling:</strong> - Your dataset doubles in size. How do parameters change? - You have limited RAM but many CPU cores. Optimize for what? - Accuracy vs.&nbsp;speed - when does each matter more?</p>
<p><strong>5. Biological vs.&nbsp;Technical Structure:</strong> - How do you distinguish ancestry from batch effects? - Should you remove outliers before PCA or after? - When do you trust what the PCA shows?</p>
<p>Experiment with different settings on this dataset. Note how computation time, memory usage, and results change. This builds intuition for optimizing real analyses.</p>
</div>
</div>
<hr>
</section>
</section>
<section id="key-takeaways" class="level2 key-concept" data-number="10">
<h2 class="key-concept anchored" data-number="10" data-anchor-id="key-takeaways"><span class="header-section-number">10</span> Key Takeaways</h2>
<p>Let’s consolidate what you’ve learned about implementing PCA on large-scale genomic data using BigDataStatMeth.</p>
<section id="essential-concepts" class="level3" data-number="10.1">
<h3 data-number="10.1" class="anchored" data-anchor-id="essential-concepts"><span class="header-section-number">10.1</span> Essential Concepts</h3>
<p><strong>PCA on genomic data serves specific purposes</strong> that differ from general dimensionality reduction. In genomics, PCA primarily identifies population structure and batch effects rather than reducing features for modeling. PC1-PC2 capture continental ancestry, PC3-PC10 capture finer population structure, and later PCs often reflect technical artifacts. Understanding these purposes guides interpretation - low variance explained isn’t a problem, it’s expected when analyzing subtle population differences.</p>
<p><strong>Quality control determines PCA validity</strong> more than the PCA algorithm itself. Running PCA on un-QC’d data produces results that look mathematically correct but are scientifically meaningless. Remove low-quality samples first (they distort allele frequencies), then filter SNPs by missingness (high-missing SNPs are unreliable), then remove rare variants (low MAF adds noise). This ordering matters - sample QC affects SNP metrics, so samples must be filtered before SNP-level QC. Skipping or reordering these steps produces different, less reliable results.</p>
<p><strong>Block-wise PCA enables analyses that traditional methods cannot handle.</strong> Standard R functions (<code>prcomp()</code>, <code>svd()</code>) require loading entire matrices into memory, failing when data exceeds RAM. BigDataStatMeth’s block-wise approach processes data in chunks, enabling PCA on datasets that are 10× or 100× larger than available memory. For the 1000 Genomes data (2-3 GB), this might seem unnecessary on modern workstations, but for whole-genome sequencing cohorts (50,000 samples × 10 million variants = 4 TB), block-wise processing becomes essential, not optional.</p>
<p><strong>Centering is mandatory, scaling is context-dependent.</strong> Centering (subtracting column means) removes the origin from the data cloud, ensuring PC1 doesn’t just capture mean differences between SNPs. This is universally necessary for interpretable PCA. Scaling (dividing by standard deviations) equalizes variance across features, which helps when features have different units (mixing expression and metabolites) but obscures real biological variance differences in SNP data. For genomic PCA, center but don’t scale. For multi-omic integration, both centering and scaling may be needed.</p>
<p><strong>Variance explained in population PCA is low by design.</strong> Seeing PC1 explain only 3-5% of total variance doesn’t indicate failure - it reflects biological reality. Human genetic variation is highly dimensional with many independent signals. Population structure is real but subtle compared to individual genetic variation. If PC1 explained 50% of variance in human genomic data, something is seriously wrong (likely a technical artifact, not biology). Low variance per component with clear population clustering indicates successful, valid PCA.</p>
<p><strong>Parameter choice balances memory, speed, and accuracy.</strong> The <code>k</code> parameter (number of blocks) controls memory usage: larger k = less memory per block but more I/O overhead. The <code>q</code> parameter (hierarchy levels) determines how blocks are combined: q=1 works for moderate data, q=2 needed for very large matrices. The <code>threads</code> parameter enables parallelization but shows diminishing returns beyond physical CPU cores. For typical genomic analyses, k=4-8, q=1, and threads matching your cores provides good performance without extensive tuning.</p>
<p><strong>PCA results require biological validation, not just statistical assessment.</strong> Mathematically perfect PCA can still be biologically meaningless. Validate by checking: Do populations cluster as expected? Do PCs correlate with known ancestry? Are there unexpected outliers (sequencing failures, sample swaps)? Does PC1 correlate with sequencing batch (technical artifact)? Statistical metrics (variance explained, eigenvalue ratios) tell you if PCA worked; biological validation tells you if results are meaningful.</p>
</section>
<section id="when-to-use-this-workflow" class="level3" data-number="10.2">
<h3 data-number="10.2" class="anchored" data-anchor-id="when-to-use-this-workflow"><span class="header-section-number">10.2</span> When to Use This Workflow</h3>
<p>Understanding when this comprehensive PCA workflow helps versus when simpler approaches suffice guides efficient analysis design.</p>
<p>✅ <strong>Use this workflow when:</strong></p>
<ul>
<li><p><strong>Dataset size exceeds comfortable RAM limits</strong> - When traditional PCA fails with memory errors, or when loading data takes minutes, block-wise processing becomes necessary. Rule of thumb: if your data matrix is &gt;30% of available RAM, use BigDataStatMeth’s approach to avoid memory issues during computation.</p></li>
<li><p><strong>You’re analyzing genomic data for publication</strong> - The comprehensive QC → imputation → PCA → validation pipeline produces defensible, reproducible results. Reviewers expect proper QC, and this workflow documents every step. The organized HDF5 structure preserves intermediate results for supplementary materials or reanalysis with different parameters.</p></li>
<li><p><strong>Population structure matters for your analysis</strong> - GWAS, rare variant analysis, and selection scans all require proper ancestry adjustment. This workflow identifies population structure reliably, providing covariates for downstream association tests. Skipping proper PCA leads to false positive associations driven by population stratification.</p></li>
<li><p><strong>You need to optimize for available resources</strong> - The parameterized approach (k, q, threads) lets you tune for your specific hardware. With limited RAM but many cores, increase k and threads. With ample RAM but slow disk, decrease k to minimize I/O. This flexibility enables analysis on hardware ranging from laptops to HPC clusters.</p></li>
<li><p><strong>The analysis will be extended or repeated</strong> - If you’ll add more samples, reanalyze with updated QC thresholds, or apply the same pipeline to multiple cohorts, having a documented workflow saves enormous time. Copy the structure, adjust file paths and parameters, execute. The HDF5 organization makes extending analyses straightforward.</p></li>
</ul>
<p>✅ <strong>Adapt this workflow when:</strong></p>
<ul>
<li><p><strong>Analyzing different omic types</strong> - Transcriptomics data needs log-transformation before PCA. Methylation data might need beta to M-value conversion. Proteomics might need scaling due to different abundance ranges. The workflow structure (QC → transformation → PCA → validation) remains constant, but specific operations change to match data characteristics.</p></li>
<li><p><strong>Different QC stringency needed</strong> - Exploratory analyses tolerate more missingness and lower MAF than definitive GWAS. Imputation-based association tests need stricter QC than burden tests. Adjust thresholds (5% missingness vs.&nbsp;10%, MAF 0.01 vs.&nbsp;0.05) to match analysis goals and acceptable false discovery rates.</p></li>
<li><p><strong>Computational constraints vary</strong> - On a laptop with 8 GB RAM, use k=16, q=2, process in smaller blocks. On a server with 256 GB RAM, use k=2-4, q=1, minimize overhead. The algorithm is the same, only parameters change to match available resources.</p></li>
</ul>
<p>❌ <strong>Simpler approaches work better when:</strong></p>
<ul>
<li><p><strong>Data easily fits in memory</strong> - If <code>prcomp(scale(data))</code> works without issues, use it. Base R PCA is well-tested, well-documented, and integrates seamlessly with the broader R ecosystem. Don’t add HDF5 complexity when traditional methods suffice.</p></li>
<li><p><strong>Quality control already performed</strong> - If analyzing published data (like HapMap, 1000 Genomes processed files), extensive QC is redundant. These datasets are already filtered, imputed, and quality-controlled. Load, run PCA, interpret results. Don’t re-QC already-QC’d data.</p></li>
<li><p><strong>Exploratory analysis on subsets</strong> - For quick exploration of chromosome 22 or a 1% random sample, simple approaches are faster. Extract subset, run standard PCA, visualize, iterate. Use this workflow when transitioning from exploration to production analysis on the full dataset.</p></li>
<li><p><strong>No population structure expected</strong> - Analyzing inbred lines, cell cultures, or known-homogeneous populations doesn’t need population structure PCA. The analysis might still be useful for quality control (identifying outliers) but doesn’t serve its primary purpose of ancestry adjustment.</p></li>
</ul>
<p>The key principle is matching workflow complexity to analysis needs and data scale. Large-scale genomic studies requiring QC, population structure identification, and resource optimization benefit from this comprehensive approach. Small-scale, exploratory, or already-QC’d analyses are better served by simpler methods.</p>
<hr>
</section>
</section>
<section id="next-steps" class="level2" data-number="11">
<h2 data-number="11" class="anchored" data-anchor-id="next-steps"><span class="header-section-number">11</span> Next Steps</h2>
<p><strong>Explore related workflows:</strong></p>
<ul>
<li><a href="../workflows/implementing-cca.html">Implementing CCA</a> - Multi-omic integration using canonical correlation</li>
<li><a href="../workflows/cross-platform.html">Cross-Platform Workflows</a> - Using PCA results in Python and C++</li>
</ul>
<p><strong>Extend this analysis:</strong></p>
<ul>
<li>Perform association tests using PCs as covariates</li>
<li>Calculate genomic relationship matrices from PCs</li>
<li>Identify population-specific outliers for closer inspection</li>
<li>Compare PCA with other dimensionality reduction methods (UMAP, t-SNE)</li>
</ul>
<p><strong>Optimize for your data:</strong></p>
<ul>
<li>Test different k, q, threads to find optimal settings</li>
<li>Try different QC thresholds for different analysis types</li>
<li>Explore ancestry-informative marker selection before PCA</li>
<li>Implement cross-validation for PCA stability assessment</li>
</ul>
<hr>
</section>
<section id="cleanup" class="level2" data-number="12">
<h2 data-number="12" class="anchored" data-anchor-id="cleanup"><span class="header-section-number">12</span> Cleanup</h2>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Close any open HDF5 connections</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="fu">h5closeAll</span>()</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: Keep generated files for future reference</span></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a><span class="co"># - 1000G_pca_analysis.hdf5: Complete analysis with all steps</span></span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a><span class="co"># - pca_population_structure.png: Publication plot</span></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a><span class="co"># - principal_components_1000G.txt: Covariates for downstream use</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/isglobal-brge\.github\.io\/BigDataStatMeth\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
            // target, if specified
            link.setAttribute("target", "_blank");
            if (link.getAttribute("rel") === null) {
              link.setAttribute("rel", "noopener");
            }
            // default icon
            link.classList.add("external");
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb66" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Implementing PCA"</span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a><span class="an">subtitle:</span><span class="co"> "Principal Component Analysis on Large-Scale Genomic Data"</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a><span class="fu">## Overview</span></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>Principal Component Analysis (PCA) is fundamental in genomics for identifying population structure, detecting batch effects, and reducing dimensionality before association tests. This workflow demonstrates a complete PCA implementation on real-world scale genomic data using BigDataStatMeth, from raw GDS files through quality control to publication-quality visualizations.</span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>Unlike tutorial examples with synthetic data, this workflow uses realistic dataset dimensions (hundreds of thousands of variants, thousands of samples) and addresses practical challenges you'll face with real data: file format conversions, multi-step quality control, computational optimization, and result interpretation. Think of this as the blueprint for your actual genomic PCA analyses.</span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a>::: {.learning-objectives}</span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a><span class="fu">### What You'll Learn</span></span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a>By the end of this workflow, you will:</span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Convert GDS (Genomic Data Structure) files to HDF5 format for analysis</span>
<span id="cb66-18"><a href="#cb66-18" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Apply comprehensive quality control for genomic data</span>
<span id="cb66-19"><a href="#cb66-19" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Perform block-wise PCA on datasets too large for memory</span>
<span id="cb66-20"><a href="#cb66-20" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Optimize computational parameters for your hardware</span>
<span id="cb66-21"><a href="#cb66-21" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Interpret variance explained and principal component loadings</span>
<span id="cb66-22"><a href="#cb66-22" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Create publication-quality PCA plots showing population structure</span>
<span id="cb66-23"><a href="#cb66-23" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Export results for downstream analyses</span>
<span id="cb66-24"><a href="#cb66-24" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Understand when and why each processing step matters</span>
<span id="cb66-25"><a href="#cb66-25" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb66-26"><a href="#cb66-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-27"><a href="#cb66-27" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb66-28"><a href="#cb66-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-29"><a href="#cb66-29" aria-hidden="true" tabindex="-1"></a><span class="fu">## The Dataset</span></span>
<span id="cb66-30"><a href="#cb66-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-31"><a href="#cb66-31" aria-hidden="true" tabindex="-1"></a>We'll analyze the 1000 Genomes Project data, which provides genetic variants from diverse human populations. This represents a realistic scale for many genomic studies:</span>
<span id="cb66-32"><a href="#cb66-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-33"><a href="#cb66-33" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Samples:** 2,504 individuals from 26 populations</span>
<span id="cb66-34"><a href="#cb66-34" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Variants:** ~800,000 SNPs after standard QC</span>
<span id="cb66-35"><a href="#cb66-35" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**File size:** ~2-3 GB in GDS format</span>
<span id="cb66-36"><a href="#cb66-36" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Analysis goal:** Identify continental ancestry structure</span>
<span id="cb66-37"><a href="#cb66-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-38"><a href="#cb66-38" aria-hidden="true" tabindex="-1"></a>This dataset is small enough to complete on a workstation but large enough that naive approaches (loading everything into memory, using standard R PCA) become problematic. It perfectly illustrates when and why BigDataStatMeth becomes necessary.</span>
<span id="cb66-39"><a href="#cb66-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-40"><a href="#cb66-40" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb66-41"><a href="#cb66-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-42"><a href="#cb66-42" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 1: Data Preparation</span></span>
<span id="cb66-43"><a href="#cb66-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-44"><a href="#cb66-44" aria-hidden="true" tabindex="-1"></a><span class="fu">### Download the Example Data</span></span>
<span id="cb66-45"><a href="#cb66-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-46"><a href="#cb66-46" aria-hidden="true" tabindex="-1"></a>The 1000 Genomes ethnic subset is available from the BigDataStatMeth supplementary materials:</span>
<span id="cb66-47"><a href="#cb66-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-48"><a href="#cb66-48" aria-hidden="true" tabindex="-1"></a><span class="in">```{r download-data, eval=TRUE}</span></span>
<span id="cb66-49"><a href="#cb66-49" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(BigDataStatMeth)</span>
<span id="cb66-50"><a href="#cb66-50" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gdsfmt)</span>
<span id="cb66-51"><a href="#cb66-51" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rhdf5)</span>
<span id="cb66-52"><a href="#cb66-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-53"><a href="#cb66-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Download genomic data (GDS format)</span></span>
<span id="cb66-54"><a href="#cb66-54" aria-hidden="true" tabindex="-1"></a><span class="fu">download.file</span>(</span>
<span id="cb66-55"><a href="#cb66-55" aria-hidden="true" tabindex="-1"></a>  <span class="at">url =</span> <span class="fu">paste0</span>(<span class="st">"https://raw.githubusercontent.com/isglobal-brge/"</span>,</span>
<span id="cb66-56"><a href="#cb66-56" aria-hidden="true" tabindex="-1"></a>               <span class="st">"Supplementary-Material/master/Pelegri-Siso_2025/"</span>,</span>
<span id="cb66-57"><a href="#cb66-57" aria-hidden="true" tabindex="-1"></a>               <span class="st">"application_examples/PCA/data/1000G_ethnic.zip"</span>),</span>
<span id="cb66-58"><a href="#cb66-58" aria-hidden="true" tabindex="-1"></a>  <span class="at">destfile =</span> <span class="st">"1000G_ethnic.zip"</span></span>
<span id="cb66-59"><a href="#cb66-59" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb66-60"><a href="#cb66-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-61"><a href="#cb66-61" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract</span></span>
<span id="cb66-62"><a href="#cb66-62" aria-hidden="true" tabindex="-1"></a><span class="fu">unzip</span>(<span class="st">"1000G_ethnic.zip"</span>)</span>
<span id="cb66-63"><a href="#cb66-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-64"><a href="#cb66-64" aria-hidden="true" tabindex="-1"></a><span class="co"># Download phenotype data (population labels)</span></span>
<span id="cb66-65"><a href="#cb66-65" aria-hidden="true" tabindex="-1"></a>pheno_url <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"https://raw.githubusercontent.com/isglobal-brge/"</span>,</span>
<span id="cb66-66"><a href="#cb66-66" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"Supplementary-Material/master/Pelegri-Siso_2025/"</span>,</span>
<span id="cb66-67"><a href="#cb66-67" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"application_examples/PCA/data/1000G_samples.tsv"</span>)</span>
<span id="cb66-68"><a href="#cb66-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-69"><a href="#cb66-69" aria-hidden="true" tabindex="-1"></a><span class="fu">download.file</span>(pheno_url, <span class="at">destfile =</span> <span class="st">"1000G_samples.tsv"</span>)</span>
<span id="cb66-70"><a href="#cb66-70" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-71"><a href="#cb66-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-72"><a href="#cb66-72" aria-hidden="true" tabindex="-1"></a>::: {.callout-note}</span>
<span id="cb66-73"><a href="#cb66-73" aria-hidden="true" tabindex="-1"></a><span class="fu">## GDS Format</span></span>
<span id="cb66-74"><a href="#cb66-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-75"><a href="#cb66-75" aria-hidden="true" tabindex="-1"></a>GDS (Genomic Data Structure) is a container format commonly used for genomic data from sequencing studies. The <span class="in">`gdsfmt`</span> and <span class="in">`SeqArray`</span> packages provide tools to work with GDS files. We'll convert to HDF5 because BigDataStatMeth operates on HDF5 matrices, and this conversion pattern applies to any genomic data source.</span>
<span id="cb66-76"><a href="#cb66-76" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb66-77"><a href="#cb66-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-78"><a href="#cb66-78" aria-hidden="true" tabindex="-1"></a><span class="fu">### Convert GDS to HDF5</span></span>
<span id="cb66-79"><a href="#cb66-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-80"><a href="#cb66-80" aria-hidden="true" tabindex="-1"></a>Genomic data often arrives in specialized formats (GDS, VCF, PLINK). BigDataStatMeth needs numeric matrices in HDF5 format, so conversion is the first step:</span>
<span id="cb66-81"><a href="#cb66-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-82"><a href="#cb66-82" aria-hidden="true" tabindex="-1"></a><span class="in">```{r convert-gds, eval=TRUE}</span></span>
<span id="cb66-83"><a href="#cb66-83" aria-hidden="true" tabindex="-1"></a><span class="co"># Open GDS file</span></span>
<span id="cb66-84"><a href="#cb66-84" aria-hidden="true" tabindex="-1"></a>gds_file <span class="ot">&lt;-</span> <span class="st">"1000G_ethnic.gds"</span></span>
<span id="cb66-85"><a href="#cb66-85" aria-hidden="true" tabindex="-1"></a>gds <span class="ot">&lt;-</span> <span class="fu">openfn.gds</span>(gds_file)</span>
<span id="cb66-86"><a href="#cb66-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-87"><a href="#cb66-87" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract genotype matrix</span></span>
<span id="cb66-88"><a href="#cb66-88" aria-hidden="true" tabindex="-1"></a>geno_node <span class="ot">&lt;-</span> <span class="fu">index.gdsn</span>(gds, <span class="st">"genotype"</span>)</span>
<span id="cb66-89"><a href="#cb66-89" aria-hidden="true" tabindex="-1"></a>genotype <span class="ot">&lt;-</span> <span class="fu">read.gdsn</span>(geno_node)</span>
<span id="cb66-90"><a href="#cb66-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-91"><a href="#cb66-91" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract sample and variant identifiers</span></span>
<span id="cb66-92"><a href="#cb66-92" aria-hidden="true" tabindex="-1"></a>sample_ids <span class="ot">&lt;-</span> <span class="fu">read.gdsn</span>(<span class="fu">index.gdsn</span>(gds, <span class="st">"sample.id"</span>))</span>
<span id="cb66-93"><a href="#cb66-93" aria-hidden="true" tabindex="-1"></a>snp_ids <span class="ot">&lt;-</span> <span class="fu">read.gdsn</span>(<span class="fu">index.gdsn</span>(gds, <span class="st">"snp.rs.id"</span>))</span>
<span id="cb66-94"><a href="#cb66-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-95"><a href="#cb66-95" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign meaningful row and column names</span></span>
<span id="cb66-96"><a href="#cb66-96" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(genotype) <span class="ot">&lt;-</span> sample_ids</span>
<span id="cb66-97"><a href="#cb66-97" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(genotype) <span class="ot">&lt;-</span> snp_ids</span>
<span id="cb66-98"><a href="#cb66-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-99"><a href="#cb66-99" aria-hidden="true" tabindex="-1"></a><span class="co"># Close GDS file</span></span>
<span id="cb66-100"><a href="#cb66-100" aria-hidden="true" tabindex="-1"></a><span class="fu">closefn.gds</span>(gds)</span>
<span id="cb66-101"><a href="#cb66-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-102"><a href="#cb66-102" aria-hidden="true" tabindex="-1"></a>genotype <span class="ot">&lt;-</span> genotype[<span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>,]</span>
<span id="cb66-103"><a href="#cb66-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-104"><a href="#cb66-104" aria-hidden="true" tabindex="-1"></a><span class="co"># Check dimensions before proceeding</span></span>
<span id="cb66-105"><a href="#cb66-105" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Genotype matrix dimensions:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb66-106"><a href="#cb66-106" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Samples:"</span>, <span class="fu">nrow</span>(genotype), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb66-107"><a href="#cb66-107" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  SNPs:"</span>, <span class="fu">ncol</span>(genotype), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb66-108"><a href="#cb66-108" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Missing data:"</span>, </span>
<span id="cb66-109"><a href="#cb66-109" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sprintf</span>(<span class="st">"%.2f%%"</span>, <span class="fu">sum</span>(<span class="fu">is.na</span>(genotype))<span class="sc">/</span><span class="fu">length</span>(genotype)<span class="sc">*</span><span class="dv">100</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb66-110"><a href="#cb66-110" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-111"><a href="#cb66-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-112"><a href="#cb66-112" aria-hidden="true" tabindex="-1"></a>Now convert to HDF5, organizing logically for subsequent analyses:</span>
<span id="cb66-113"><a href="#cb66-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-114"><a href="#cb66-114" aria-hidden="true" tabindex="-1"></a><span class="in">```{r create-hdf5, eval=TRUE}</span></span>
<span id="cb66-115"><a href="#cb66-115" aria-hidden="true" tabindex="-1"></a><span class="co"># Create HDF5 file with organized structure</span></span>
<span id="cb66-116"><a href="#cb66-116" aria-hidden="true" tabindex="-1"></a>pca_file <span class="ot">&lt;-</span> <span class="st">"1000G_pca_analysis.hdf5"</span></span>
<span id="cb66-117"><a href="#cb66-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-118"><a href="#cb66-118" aria-hidden="true" tabindex="-1"></a><span class="fu">bdCreate_hdf5_matrix</span>(</span>
<span id="cb66-119"><a href="#cb66-119" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> pca_file,</span>
<span id="cb66-120"><a href="#cb66-120" aria-hidden="true" tabindex="-1"></a>  <span class="at">object =</span> genotype,</span>
<span id="cb66-121"><a href="#cb66-121" aria-hidden="true" tabindex="-1"></a>  <span class="at">group =</span> <span class="st">"raw_data"</span>,</span>
<span id="cb66-122"><a href="#cb66-122" aria-hidden="true" tabindex="-1"></a>  <span class="at">dataset =</span> <span class="st">"genotypes"</span>,</span>
<span id="cb66-123"><a href="#cb66-123" aria-hidden="true" tabindex="-1"></a>  <span class="at">transp =</span> <span class="cn">FALSE</span>,  <span class="co"># Keep samples as rows, SNPs as columns</span></span>
<span id="cb66-124"><a href="#cb66-124" aria-hidden="true" tabindex="-1"></a>  <span class="at">overwriteFile =</span> <span class="cn">TRUE</span></span>
<span id="cb66-125"><a href="#cb66-125" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb66-126"><a href="#cb66-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-127"><a href="#cb66-127" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"✓ HDF5 file created:"</span>, pca_file, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb66-128"><a href="#cb66-128" aria-hidden="true" tabindex="-1"></a><span class="fu">h5ls</span>(pca_file)</span>
<span id="cb66-129"><a href="#cb66-129" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-130"><a href="#cb66-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-131"><a href="#cb66-131" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip}</span>
<span id="cb66-132"><a href="#cb66-132" aria-hidden="true" tabindex="-1"></a><span class="fu">## Organizing Your HDF5 File</span></span>
<span id="cb66-133"><a href="#cb66-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-134"><a href="#cb66-134" aria-hidden="true" tabindex="-1"></a>We create a <span class="in">`/raw_data/`</span> group for the original genotypes. Subsequent QC steps will create <span class="in">`/quality_control/`</span> for filtered data, and <span class="in">`/analysis/pca/`</span> for results. This mirrors a typical analysis workflow and keeps intermediate steps traceable. If you need to rerun QC with different thresholds, raw data remains untouched.</span>
<span id="cb66-135"><a href="#cb66-135" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb66-136"><a href="#cb66-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-137"><a href="#cb66-137" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb66-138"><a href="#cb66-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-139"><a href="#cb66-139" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 2: Quality Control</span></span>
<span id="cb66-140"><a href="#cb66-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-141"><a href="#cb66-141" aria-hidden="true" tabindex="-1"></a><span class="fu">### Remove Low-Quality Samples</span></span>
<span id="cb66-142"><a href="#cb66-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-143"><a href="#cb66-143" aria-hidden="true" tabindex="-1"></a>Samples with excessive missing data often indicate technical problems (poor DNA quality, sequencing failures). We filter samples before variant-level QC:</span>
<span id="cb66-144"><a href="#cb66-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-145"><a href="#cb66-145" aria-hidden="true" tabindex="-1"></a><span class="in">```{r qc-samples, eval=TRUE}</span></span>
<span id="cb66-146"><a href="#cb66-146" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove samples with &gt;5% missing data</span></span>
<span id="cb66-147"><a href="#cb66-147" aria-hidden="true" tabindex="-1"></a>sample_qc <span class="ot">&lt;-</span> <span class="fu">bdRemovelowdata_hdf5</span>(</span>
<span id="cb66-148"><a href="#cb66-148" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> pca_file,</span>
<span id="cb66-149"><a href="#cb66-149" aria-hidden="true" tabindex="-1"></a>  <span class="at">group =</span> <span class="st">"raw_data"</span>,</span>
<span id="cb66-150"><a href="#cb66-150" aria-hidden="true" tabindex="-1"></a>  <span class="at">dataset =</span> <span class="st">"genotypes"</span>,</span>
<span id="cb66-151"><a href="#cb66-151" aria-hidden="true" tabindex="-1"></a>  <span class="at">outgroup =</span> <span class="st">"quality_control"</span>,</span>
<span id="cb66-152"><a href="#cb66-152" aria-hidden="true" tabindex="-1"></a>  <span class="at">outdataset =</span> <span class="st">"samples_qc"</span>,</span>
<span id="cb66-153"><a href="#cb66-153" aria-hidden="true" tabindex="-1"></a>  <span class="at">bycols =</span> <span class="cn">FALSE</span>,  <span class="co"># Operate on rows (samples)</span></span>
<span id="cb66-154"><a href="#cb66-154" aria-hidden="true" tabindex="-1"></a>  <span class="at">pcent =</span> <span class="fl">0.05</span>,</span>
<span id="cb66-155"><a href="#cb66-155" aria-hidden="true" tabindex="-1"></a>  <span class="at">overwrite =</span> <span class="cn">TRUE</span></span>
<span id="cb66-156"><a href="#cb66-156" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb66-157"><a href="#cb66-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-158"><a href="#cb66-158" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Sample QC results:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb66-159"><a href="#cb66-159" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Samples removed:"</span>, sample_qc<span class="sc">$</span>elements_removed, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb66-160"><a href="#cb66-160" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Samples retained:"</span>, sample_qc<span class="sc">$</span>elements_retained, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb66-161"><a href="#cb66-161" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-162"><a href="#cb66-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-163"><a href="#cb66-163" aria-hidden="true" tabindex="-1"></a><span class="fu">### Remove Low-Frequency and High-Missingness SNPs</span></span>
<span id="cb66-164"><a href="#cb66-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-165"><a href="#cb66-165" aria-hidden="true" tabindex="-1"></a>Rare variants (low minor allele frequency) provide little information for PCA and can introduce noise. Similarly, SNPs with high missingness are unreliable:</span>
<span id="cb66-166"><a href="#cb66-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-167"><a href="#cb66-167" aria-hidden="true" tabindex="-1"></a><span class="in">```{r qc-snps-missing, eval=TRUE}</span></span>
<span id="cb66-168"><a href="#cb66-168" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove SNPs with &gt;5% missing data</span></span>
<span id="cb66-169"><a href="#cb66-169" aria-hidden="true" tabindex="-1"></a>snp_missing_qc <span class="ot">&lt;-</span> <span class="fu">bdRemovelowdata_hdf5</span>(</span>
<span id="cb66-170"><a href="#cb66-170" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> pca_file,</span>
<span id="cb66-171"><a href="#cb66-171" aria-hidden="true" tabindex="-1"></a>  <span class="at">group =</span> <span class="st">"quality_control"</span>,</span>
<span id="cb66-172"><a href="#cb66-172" aria-hidden="true" tabindex="-1"></a>  <span class="at">dataset =</span> <span class="st">"samples_qc"</span>,</span>
<span id="cb66-173"><a href="#cb66-173" aria-hidden="true" tabindex="-1"></a>  <span class="at">outgroup =</span> <span class="st">"quality_control"</span>,</span>
<span id="cb66-174"><a href="#cb66-174" aria-hidden="true" tabindex="-1"></a>  <span class="at">outdataset =</span> <span class="st">"snps_missing_qc"</span>,</span>
<span id="cb66-175"><a href="#cb66-175" aria-hidden="true" tabindex="-1"></a>  <span class="at">bycols =</span> <span class="cn">TRUE</span>,  <span class="co"># Operate on columns (SNPs)</span></span>
<span id="cb66-176"><a href="#cb66-176" aria-hidden="true" tabindex="-1"></a>  <span class="at">pcent =</span> <span class="fl">0.05</span>,</span>
<span id="cb66-177"><a href="#cb66-177" aria-hidden="true" tabindex="-1"></a>  <span class="at">overwrite =</span> <span class="cn">TRUE</span></span>
<span id="cb66-178"><a href="#cb66-178" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb66-179"><a href="#cb66-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-180"><a href="#cb66-180" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"SNP missingness QC:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb66-181"><a href="#cb66-181" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  SNPs removed:"</span>, snp_missing_qc<span class="sc">$</span>elements_removed, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb66-182"><a href="#cb66-182" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  SNPs retained:"</span>, snp_missing_qc<span class="sc">$</span>elements_retained, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb66-183"><a href="#cb66-183" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-184"><a href="#cb66-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-185"><a href="#cb66-185" aria-hidden="true" tabindex="-1"></a><span class="in">```{r qc-snps-maf, eval=TRUE}</span></span>
<span id="cb66-186"><a href="#cb66-186" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove SNPs with MAF &lt; 5%</span></span>
<span id="cb66-187"><a href="#cb66-187" aria-hidden="true" tabindex="-1"></a>maf_qc <span class="ot">&lt;-</span> <span class="fu">bdRemoveMAF_hdf5</span>(</span>
<span id="cb66-188"><a href="#cb66-188" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> pca_file,</span>
<span id="cb66-189"><a href="#cb66-189" aria-hidden="true" tabindex="-1"></a>  <span class="at">group =</span> <span class="st">"quality_control"</span>,</span>
<span id="cb66-190"><a href="#cb66-190" aria-hidden="true" tabindex="-1"></a>  <span class="at">dataset =</span> <span class="st">"snps_missing_qc"</span>,</span>
<span id="cb66-191"><a href="#cb66-191" aria-hidden="true" tabindex="-1"></a>  <span class="at">outgroup =</span> <span class="st">"quality_control"</span>,</span>
<span id="cb66-192"><a href="#cb66-192" aria-hidden="true" tabindex="-1"></a>  <span class="at">outdataset =</span> <span class="st">"snps_qc_complete"</span>,</span>
<span id="cb66-193"><a href="#cb66-193" aria-hidden="true" tabindex="-1"></a>  <span class="at">maf =</span> <span class="fl">0.05</span>,</span>
<span id="cb66-194"><a href="#cb66-194" aria-hidden="true" tabindex="-1"></a>  <span class="at">bycols =</span> <span class="cn">TRUE</span>,</span>
<span id="cb66-195"><a href="#cb66-195" aria-hidden="true" tabindex="-1"></a>  <span class="at">blocksize =</span> <span class="dv">1000</span>,</span>
<span id="cb66-196"><a href="#cb66-196" aria-hidden="true" tabindex="-1"></a>  <span class="at">overwrite =</span> <span class="cn">TRUE</span></span>
<span id="cb66-197"><a href="#cb66-197" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb66-198"><a href="#cb66-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-199"><a href="#cb66-199" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"MAF QC:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb66-200"><a href="#cb66-200" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  SNPs removed:"</span>, maf_qc<span class="sc">$</span>elements_removed, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb66-201"><a href="#cb66-201" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  SNPs retained:"</span>, maf_qc<span class="sc">$</span>elements_retained, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb66-202"><a href="#cb66-202" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-203"><a href="#cb66-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-204"><a href="#cb66-204" aria-hidden="true" tabindex="-1"></a>::: {.callout-important}</span>
<span id="cb66-205"><a href="#cb66-205" aria-hidden="true" tabindex="-1"></a><span class="fu">## QC Ordering Matters</span></span>
<span id="cb66-206"><a href="#cb66-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-207"><a href="#cb66-207" aria-hidden="true" tabindex="-1"></a>We filter samples first, then SNP missingness, then MAF. Why this order?</span>
<span id="cb66-208"><a href="#cb66-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-209"><a href="#cb66-209" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Samples first:** Removing low-quality samples changes allele frequencies and missingness calculations for SNPs</span>
<span id="cb66-210"><a href="#cb66-210" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Missingness before MAF:** SNPs with high missingness have unreliable allele frequency estimates</span>
<span id="cb66-211"><a href="#cb66-211" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**MAF last:** After removing missing data, MAF calculations are accurate</span>
<span id="cb66-212"><a href="#cb66-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-213"><a href="#cb66-213" aria-hidden="true" tabindex="-1"></a>Reversing this order produces different results. The standard practice is sample → missingness → MAF.</span>
<span id="cb66-214"><a href="#cb66-214" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb66-215"><a href="#cb66-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-216"><a href="#cb66-216" aria-hidden="true" tabindex="-1"></a><span class="fu">### Impute Remaining Missing Data</span></span>
<span id="cb66-217"><a href="#cb66-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-218"><a href="#cb66-218" aria-hidden="true" tabindex="-1"></a>After QC, remaining missingness is typically &lt;1-2%. Simple mean imputation suffices for this low level:</span>
<span id="cb66-219"><a href="#cb66-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-220"><a href="#cb66-220" aria-hidden="true" tabindex="-1"></a><span class="in">```{r impute, eval=TRUE}</span></span>
<span id="cb66-221"><a href="#cb66-221" aria-hidden="true" tabindex="-1"></a><span class="co"># Impute missing values with column (SNP) means</span></span>
<span id="cb66-222"><a href="#cb66-222" aria-hidden="true" tabindex="-1"></a><span class="fu">bdImputeSNPs_hdf5</span>(</span>
<span id="cb66-223"><a href="#cb66-223" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> pca_file,</span>
<span id="cb66-224"><a href="#cb66-224" aria-hidden="true" tabindex="-1"></a>  <span class="at">group =</span> <span class="st">"quality_control"</span>,</span>
<span id="cb66-225"><a href="#cb66-225" aria-hidden="true" tabindex="-1"></a>  <span class="at">dataset =</span> <span class="st">"snps_qc_complete"</span>,</span>
<span id="cb66-226"><a href="#cb66-226" aria-hidden="true" tabindex="-1"></a>  <span class="at">bycols =</span> <span class="cn">TRUE</span>,</span>
<span id="cb66-227"><a href="#cb66-227" aria-hidden="true" tabindex="-1"></a>  <span class="at">outgroup =</span> <span class="st">"quality_control"</span>,</span>
<span id="cb66-228"><a href="#cb66-228" aria-hidden="true" tabindex="-1"></a>  <span class="at">outdataset =</span> <span class="st">"genotypes_imputed"</span>,</span>
<span id="cb66-229"><a href="#cb66-229" aria-hidden="true" tabindex="-1"></a>  <span class="at">overwrite =</span> <span class="cn">TRUE</span></span>
<span id="cb66-230"><a href="#cb66-230" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb66-231"><a href="#cb66-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-232"><a href="#cb66-232" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"✓ Missing data imputed</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb66-233"><a href="#cb66-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-234"><a href="#cb66-234" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify no missing data remains</span></span>
<span id="cb66-235"><a href="#cb66-235" aria-hidden="true" tabindex="-1"></a>h5file <span class="ot">&lt;-</span> <span class="fu">H5Fopen</span>(pca_file)</span>
<span id="cb66-236"><a href="#cb66-236" aria-hidden="true" tabindex="-1"></a>imputed_data <span class="ot">&lt;-</span> h5file<span class="sc">$</span>quality_control<span class="sc">$</span>genotypes_imputed</span>
<span id="cb66-237"><a href="#cb66-237" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Missing values remaining:"</span>, <span class="fu">sum</span>(<span class="fu">is.na</span>(imputed_data[<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>])), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb66-238"><a href="#cb66-238" aria-hidden="true" tabindex="-1"></a><span class="fu">H5Fclose</span>(h5file)</span>
<span id="cb66-239"><a href="#cb66-239" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-240"><a href="#cb66-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-241"><a href="#cb66-241" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb66-242"><a href="#cb66-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-243"><a href="#cb66-243" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 3: Perform PCA</span></span>
<span id="cb66-244"><a href="#cb66-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-245"><a href="#cb66-245" aria-hidden="true" tabindex="-1"></a><span class="fu">### Understanding the Parameters</span></span>
<span id="cb66-246"><a href="#cb66-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-247"><a href="#cb66-247" aria-hidden="true" tabindex="-1"></a>PCA on large matrices uses hierarchical block-wise SVD. Key parameters:</span>
<span id="cb66-248"><a href="#cb66-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-249"><a href="#cb66-249" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**k:** Number of blocks to partition the matrix into</span>
<span id="cb66-250"><a href="#cb66-250" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**q:** Number of hierarchical levels</span>
<span id="cb66-251"><a href="#cb66-251" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Components:** How many PCs to compute (typically 10-50)</span>
<span id="cb66-252"><a href="#cb66-252" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Centering:** Almost always TRUE for PCA</span>
<span id="cb66-253"><a href="#cb66-253" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Scaling:** Usually FALSE for SNP data (all same units)</span>
<span id="cb66-254"><a href="#cb66-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-255"><a href="#cb66-255" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pca-analysis, eval=TRUE}</span></span>
<span id="cb66-256"><a href="#cb66-256" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform block-wise PCA</span></span>
<span id="cb66-257"><a href="#cb66-257" aria-hidden="true" tabindex="-1"></a>pca_result <span class="ot">&lt;-</span> <span class="fu">bdPCA_hdf5</span>(</span>
<span id="cb66-258"><a href="#cb66-258" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> pca_file,</span>
<span id="cb66-259"><a href="#cb66-259" aria-hidden="true" tabindex="-1"></a>  <span class="at">group =</span> <span class="st">"quality_control"</span>,</span>
<span id="cb66-260"><a href="#cb66-260" aria-hidden="true" tabindex="-1"></a>  <span class="at">dataset =</span> <span class="st">"genotypes_imputed"</span>,</span>
<span id="cb66-261"><a href="#cb66-261" aria-hidden="true" tabindex="-1"></a>  <span class="at">k =</span> <span class="dv">4</span>,            <span class="co"># 4 blocks balances memory and speed</span></span>
<span id="cb66-262"><a href="#cb66-262" aria-hidden="true" tabindex="-1"></a>  <span class="at">q =</span> <span class="dv">1</span>,            <span class="co"># 1 level sufficient for this data size</span></span>
<span id="cb66-263"><a href="#cb66-263" aria-hidden="true" tabindex="-1"></a>  <span class="at">bcenter =</span> <span class="cn">TRUE</span>,   <span class="co"># Center SNPs (subtract column means)</span></span>
<span id="cb66-264"><a href="#cb66-264" aria-hidden="true" tabindex="-1"></a>  <span class="at">bscale =</span> <span class="cn">FALSE</span>,   <span class="co"># Don't scale (SNPs same units)</span></span>
<span id="cb66-265"><a href="#cb66-265" aria-hidden="true" tabindex="-1"></a>  <span class="at">ncomponents =</span> <span class="dv">20</span>, <span class="co"># Compute first 20 PCs</span></span>
<span id="cb66-266"><a href="#cb66-266" aria-hidden="true" tabindex="-1"></a>  <span class="at">threads =</span> <span class="dv">4</span>,      <span class="co"># Use 4 threads (adjust to your CPU)</span></span>
<span id="cb66-267"><a href="#cb66-267" aria-hidden="true" tabindex="-1"></a>  <span class="at">overwrite =</span> <span class="cn">TRUE</span></span>
<span id="cb66-268"><a href="#cb66-268" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb66-269"><a href="#cb66-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-270"><a href="#cb66-270" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"✓ PCA complete</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb66-271"><a href="#cb66-271" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-272"><a href="#cb66-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-273"><a href="#cb66-273" aria-hidden="true" tabindex="-1"></a>::: {.callout-note}</span>
<span id="cb66-274"><a href="#cb66-274" aria-hidden="true" tabindex="-1"></a><span class="fu">## Computational Considerations</span></span>
<span id="cb66-275"><a href="#cb66-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-276"><a href="#cb66-276" aria-hidden="true" tabindex="-1"></a>For this dataset (~2500 samples × ~80,000 SNPs after QC):</span>
<span id="cb66-277"><a href="#cb66-277" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Memory usage:** Peak ~4-6 GB with k=4</span>
<span id="cb66-278"><a href="#cb66-278" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Computation time:** ~2-5 minutes on modern CPU</span>
<span id="cb66-279"><a href="#cb66-279" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Threads:** Diminishing returns beyond physical cores</span>
<span id="cb66-280"><a href="#cb66-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-281"><a href="#cb66-281" aria-hidden="true" tabindex="-1"></a>Larger datasets (50,000 samples × 500,000 SNPs) might need k=8-16 and q=2 for reasonable memory usage.</span>
<span id="cb66-282"><a href="#cb66-282" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb66-283"><a href="#cb66-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-284"><a href="#cb66-284" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb66-285"><a href="#cb66-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-286"><a href="#cb66-286" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 4: Extract and Examine Results</span></span>
<span id="cb66-287"><a href="#cb66-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-288"><a href="#cb66-288" aria-hidden="true" tabindex="-1"></a><span class="fu">### Load PCA Components</span></span>
<span id="cb66-289"><a href="#cb66-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-290"><a href="#cb66-290" aria-hidden="true" tabindex="-1"></a><span class="in">```{r extract-results, eval=TRUE}</span></span>
<span id="cb66-291"><a href="#cb66-291" aria-hidden="true" tabindex="-1"></a><span class="co"># Open file to access PCA results</span></span>
<span id="cb66-292"><a href="#cb66-292" aria-hidden="true" tabindex="-1"></a>h5file <span class="ot">&lt;-</span> <span class="fu">H5Fopen</span>(pca_file)</span>
<span id="cb66-293"><a href="#cb66-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-294"><a href="#cb66-294" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract components (the principal components themselves)</span></span>
<span id="cb66-295"><a href="#cb66-295" aria-hidden="true" tabindex="-1"></a>pcs <span class="ot">&lt;-</span> h5file<span class="sc">$</span>PCA<span class="sc">$</span>genotypes_imputed<span class="sc">$</span>components</span>
<span id="cb66-296"><a href="#cb66-296" aria-hidden="true" tabindex="-1"></a>pcs <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(pcs)</span>
<span id="cb66-297"><a href="#cb66-297" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(pcs) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"PC"</span>, <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(pcs))</span>
<span id="cb66-298"><a href="#cb66-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-299"><a href="#cb66-299" aria-hidden="true" tabindex="-1"></a><span class="co"># Add sample IDs</span></span>
<span id="cb66-300"><a href="#cb66-300" aria-hidden="true" tabindex="-1"></a>sample_names <span class="ot">&lt;-</span> h5file<span class="sc">$</span>raw_data<span class="sc">$</span>.genotypes_dimnames<span class="sc">$</span><span class="st">`</span><span class="at">1</span><span class="st">`</span>[,<span class="dv">1</span>]</span>
<span id="cb66-301"><a href="#cb66-301" aria-hidden="true" tabindex="-1"></a>pcs<span class="sc">$</span>sample_id <span class="ot">&lt;-</span> sample_names[<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(pcs)]  <span class="co"># Account for samples removed in QC</span></span>
<span id="cb66-302"><a href="#cb66-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-303"><a href="#cb66-303" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract variance explained</span></span>
<span id="cb66-304"><a href="#cb66-304" aria-hidden="true" tabindex="-1"></a>variance_prop <span class="ot">&lt;-</span> h5file<span class="sc">$</span>PCA<span class="sc">$</span>genotypes_imputed<span class="sc">$</span>variance[,<span class="dv">1</span>]</span>
<span id="cb66-305"><a href="#cb66-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-306"><a href="#cb66-306" aria-hidden="true" tabindex="-1"></a><span class="fu">H5Fclose</span>(h5file)</span>
<span id="cb66-307"><a href="#cb66-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-308"><a href="#cb66-308" aria-hidden="true" tabindex="-1"></a><span class="co"># Preview principal components</span></span>
<span id="cb66-309"><a href="#cb66-309" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">First 5 samples, first 5 PCs:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb66-310"><a href="#cb66-310" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(pcs[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>])  <span class="co"># First 5 PCs + sample_id</span></span>
<span id="cb66-311"><a href="#cb66-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-312"><a href="#cb66-312" aria-hidden="true" tabindex="-1"></a><span class="co"># Variance explained summary</span></span>
<span id="cb66-313"><a href="#cb66-313" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Variance explained by each PC:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb66-314"><a href="#cb66-314" aria-hidden="true" tabindex="-1"></a>variance_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb66-315"><a href="#cb66-315" aria-hidden="true" tabindex="-1"></a>  <span class="at">PC =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(variance_prop),</span>
<span id="cb66-316"><a href="#cb66-316" aria-hidden="true" tabindex="-1"></a>  <span class="at">Variance =</span> <span class="fu">sprintf</span>(<span class="st">"%.2f%%"</span>, variance_prop),</span>
<span id="cb66-317"><a href="#cb66-317" aria-hidden="true" tabindex="-1"></a>  <span class="at">Cumulative =</span> <span class="fu">sprintf</span>(<span class="st">"%.2f%%"</span>, <span class="fu">cumsum</span>(variance_prop))</span>
<span id="cb66-318"><a href="#cb66-318" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb66-319"><a href="#cb66-319" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(variance_df[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, ])</span>
<span id="cb66-320"><a href="#cb66-320" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-321"><a href="#cb66-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-322"><a href="#cb66-322" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip}</span>
<span id="cb66-323"><a href="#cb66-323" aria-hidden="true" tabindex="-1"></a><span class="fu">## Interpreting Variance Explained</span></span>
<span id="cb66-324"><a href="#cb66-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-325"><a href="#cb66-325" aria-hidden="true" tabindex="-1"></a>**For population structure PCA:**</span>
<span id="cb66-326"><a href="#cb66-326" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>PC1-PC2 typically explain 2-5% each for global ancestry</span>
<span id="cb66-327"><a href="#cb66-327" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>PC1-PC10 together often explain 10-20%</span>
<span id="cb66-328"><a href="#cb66-328" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Low variance per PC is expected - population structure is subtle</span>
<span id="cb66-329"><a href="#cb66-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-330"><a href="#cb66-330" aria-hidden="true" tabindex="-1"></a>**Red flags:**</span>
<span id="cb66-331"><a href="#cb66-331" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>PC1 &gt;50%: Possible batch effect or technical artifact</span>
<span id="cb66-332"><a href="#cb66-332" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>PC1-10 &lt;5% total: Either very homogeneous population or too much noise</span>
<span id="cb66-333"><a href="#cb66-333" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Sudden drop after PC1: Might indicate strong population stratification</span>
<span id="cb66-334"><a href="#cb66-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-335"><a href="#cb66-335" aria-hidden="true" tabindex="-1"></a>For this 1000 Genomes data, expect PC1 ~3-5% (continental ancestry) and PC2 ~2-3% (finer structure).</span>
<span id="cb66-336"><a href="#cb66-336" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb66-337"><a href="#cb66-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-338"><a href="#cb66-338" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb66-339"><a href="#cb66-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-340"><a href="#cb66-340" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 5: Visualize Population Structure</span></span>
<span id="cb66-341"><a href="#cb66-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-342"><a href="#cb66-342" aria-hidden="true" tabindex="-1"></a><span class="fu">### Merge with Population Labels</span></span>
<span id="cb66-343"><a href="#cb66-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-344"><a href="#cb66-344" aria-hidden="true" tabindex="-1"></a><span class="in">```{r merge-phenotypes, eval=TRUE}</span></span>
<span id="cb66-345"><a href="#cb66-345" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb66-346"><a href="#cb66-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-347"><a href="#cb66-347" aria-hidden="true" tabindex="-1"></a><span class="co"># Load population information</span></span>
<span id="cb66-348"><a href="#cb66-348" aria-hidden="true" tabindex="-1"></a>pheno <span class="ot">&lt;-</span> <span class="fu">read_delim</span>(</span>
<span id="cb66-349"><a href="#cb66-349" aria-hidden="true" tabindex="-1"></a>  <span class="st">"1000G_samples.tsv"</span>,</span>
<span id="cb66-350"><a href="#cb66-350" aria-hidden="true" tabindex="-1"></a>  <span class="at">delim =</span> <span class="st">"</span><span class="sc">\t</span><span class="st">"</span>,</span>
<span id="cb66-351"><a href="#cb66-351" aria-hidden="true" tabindex="-1"></a>  <span class="at">show_col_types =</span> <span class="cn">FALSE</span></span>
<span id="cb66-352"><a href="#cb66-352" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb66-353"><a href="#cb66-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-354"><a href="#cb66-354" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge PCs with phenotype data</span></span>
<span id="cb66-355"><a href="#cb66-355" aria-hidden="true" tabindex="-1"></a>pca_data <span class="ot">&lt;-</span> pcs <span class="sc">%&gt;%</span></span>
<span id="cb66-356"><a href="#cb66-356" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(pheno, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"sample_id"</span> <span class="ot">=</span> <span class="st">"Sample name"</span>))</span>
<span id="cb66-357"><a href="#cb66-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-358"><a href="#cb66-358" aria-hidden="true" tabindex="-1"></a><span class="co"># Check merge success</span></span>
<span id="cb66-359"><a href="#cb66-359" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Samples with population labels:"</span>, </span>
<span id="cb66-360"><a href="#cb66-360" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(pca_data<span class="sc">$</span><span class="st">`</span><span class="at">Superpopulation code</span><span class="st">`</span>)), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb66-361"><a href="#cb66-361" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-362"><a href="#cb66-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-363"><a href="#cb66-363" aria-hidden="true" tabindex="-1"></a><span class="fu">### Create PCA Plot</span></span>
<span id="cb66-364"><a href="#cb66-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-365"><a href="#cb66-365" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pca-plot, eval=TRUE}</span></span>
<span id="cb66-366"><a href="#cb66-366" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb66-367"><a href="#cb66-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-368"><a href="#cb66-368" aria-hidden="true" tabindex="-1"></a><span class="co"># Define population colors</span></span>
<span id="cb66-369"><a href="#cb66-369" aria-hidden="true" tabindex="-1"></a>pop_colors <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb66-370"><a href="#cb66-370" aria-hidden="true" tabindex="-1"></a>  <span class="st">"AFR"</span> <span class="ot">=</span> <span class="st">"#E41A1C"</span>,  <span class="co"># African - Red</span></span>
<span id="cb66-371"><a href="#cb66-371" aria-hidden="true" tabindex="-1"></a>  <span class="st">"AMR"</span> <span class="ot">=</span> <span class="st">"#377EB8"</span>,  <span class="co"># American - Blue</span></span>
<span id="cb66-372"><a href="#cb66-372" aria-hidden="true" tabindex="-1"></a>  <span class="st">"EAS"</span> <span class="ot">=</span> <span class="st">"#4DAF4A"</span>,  <span class="co"># East Asian - Green</span></span>
<span id="cb66-373"><a href="#cb66-373" aria-hidden="true" tabindex="-1"></a>  <span class="st">"EUR"</span> <span class="ot">=</span> <span class="st">"#984EA3"</span>,  <span class="co"># European - Purple</span></span>
<span id="cb66-374"><a href="#cb66-374" aria-hidden="true" tabindex="-1"></a>  <span class="st">"SAS"</span> <span class="ot">=</span> <span class="st">"#FF7F00"</span>   <span class="co"># South Asian - Orange</span></span>
<span id="cb66-375"><a href="#cb66-375" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb66-376"><a href="#cb66-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-377"><a href="#cb66-377" aria-hidden="true" tabindex="-1"></a><span class="co"># Create PCA plot</span></span>
<span id="cb66-378"><a href="#cb66-378" aria-hidden="true" tabindex="-1"></a>pca_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(</span>
<span id="cb66-379"><a href="#cb66-379" aria-hidden="true" tabindex="-1"></a>  pca_data, </span>
<span id="cb66-380"><a href="#cb66-380" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> PC1, <span class="at">y =</span> PC2, <span class="at">color =</span> <span class="st">`</span><span class="at">Superpopulation code</span><span class="st">`</span>)</span>
<span id="cb66-381"><a href="#cb66-381" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb66-382"><a href="#cb66-382" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">2</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb66-383"><a href="#cb66-383" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(</span>
<span id="cb66-384"><a href="#cb66-384" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> pop_colors,</span>
<span id="cb66-385"><a href="#cb66-385" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Ancestry"</span>,</span>
<span id="cb66-386"><a href="#cb66-386" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(</span>
<span id="cb66-387"><a href="#cb66-387" aria-hidden="true" tabindex="-1"></a>      <span class="st">"AFR"</span> <span class="ot">=</span> <span class="st">"African"</span>,</span>
<span id="cb66-388"><a href="#cb66-388" aria-hidden="true" tabindex="-1"></a>      <span class="st">"AMR"</span> <span class="ot">=</span> <span class="st">"American"</span>, </span>
<span id="cb66-389"><a href="#cb66-389" aria-hidden="true" tabindex="-1"></a>      <span class="st">"EAS"</span> <span class="ot">=</span> <span class="st">"East Asian"</span>,</span>
<span id="cb66-390"><a href="#cb66-390" aria-hidden="true" tabindex="-1"></a>      <span class="st">"EUR"</span> <span class="ot">=</span> <span class="st">"European"</span>,</span>
<span id="cb66-391"><a href="#cb66-391" aria-hidden="true" tabindex="-1"></a>      <span class="st">"SAS"</span> <span class="ot">=</span> <span class="st">"South Asian"</span></span>
<span id="cb66-392"><a href="#cb66-392" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb66-393"><a href="#cb66-393" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb66-394"><a href="#cb66-394" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb66-395"><a href="#cb66-395" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Population Structure in 1000 Genomes Project"</span>,</span>
<span id="cb66-396"><a href="#cb66-396" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"PCA reveals continental ancestry patterns"</span>,</span>
<span id="cb66-397"><a href="#cb66-397" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">sprintf</span>(<span class="st">"PC1 (%.2f%% variance)"</span>, variance_prop[<span class="dv">1</span>] <span class="sc">*</span> <span class="dv">100</span>),</span>
<span id="cb66-398"><a href="#cb66-398" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">sprintf</span>(<span class="st">"PC2 (%.2f%% variance)"</span>, variance_prop[<span class="dv">2</span>] <span class="sc">*</span> <span class="dv">100</span>)</span>
<span id="cb66-399"><a href="#cb66-399" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb66-400"><a href="#cb66-400" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb66-401"><a href="#cb66-401" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb66-402"><a href="#cb66-402" aria-hidden="true" tabindex="-1"></a>    <span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb66-403"><a href="#cb66-403" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb66-404"><a href="#cb66-404" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">color =</span> <span class="st">"gray40"</span>),</span>
<span id="cb66-405"><a href="#cb66-405" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb66-406"><a href="#cb66-406" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>()</span>
<span id="cb66-407"><a href="#cb66-407" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb66-408"><a href="#cb66-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-409"><a href="#cb66-409" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(pca_plot)</span>
<span id="cb66-410"><a href="#cb66-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-411"><a href="#cb66-411" aria-hidden="true" tabindex="-1"></a><span class="co"># Save plot</span></span>
<span id="cb66-412"><a href="#cb66-412" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(</span>
<span id="cb66-413"><a href="#cb66-413" aria-hidden="true" tabindex="-1"></a>  <span class="st">"pca_population_structure.png"</span>,</span>
<span id="cb66-414"><a href="#cb66-414" aria-hidden="true" tabindex="-1"></a>  pca_plot,</span>
<span id="cb66-415"><a href="#cb66-415" aria-hidden="true" tabindex="-1"></a>  <span class="at">width =</span> <span class="dv">10</span>,</span>
<span id="cb66-416"><a href="#cb66-416" aria-hidden="true" tabindex="-1"></a>  <span class="at">height =</span> <span class="dv">7</span>,</span>
<span id="cb66-417"><a href="#cb66-417" aria-hidden="true" tabindex="-1"></a>  <span class="at">dpi =</span> <span class="dv">300</span></span>
<span id="cb66-418"><a href="#cb66-418" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb66-419"><a href="#cb66-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-420"><a href="#cb66-420" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"✓ Plot saved to pca_population_structure.png</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb66-421"><a href="#cb66-421" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-422"><a href="#cb66-422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-423"><a href="#cb66-423" aria-hidden="true" tabindex="-1"></a><span class="fu">### Scree Plot for Variance</span></span>
<span id="cb66-424"><a href="#cb66-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-425"><a href="#cb66-425" aria-hidden="true" tabindex="-1"></a><span class="in">```{r scree-plot, eval=TRUE}</span></span>
<span id="cb66-426"><a href="#cb66-426" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare data for scree plot</span></span>
<span id="cb66-427"><a href="#cb66-427" aria-hidden="true" tabindex="-1"></a>n_show <span class="ot">&lt;-</span> <span class="fu">min</span>(<span class="dv">20</span>, <span class="fu">length</span>(variance_prop))</span>
<span id="cb66-428"><a href="#cb66-428" aria-hidden="true" tabindex="-1"></a>scree_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb66-429"><a href="#cb66-429" aria-hidden="true" tabindex="-1"></a>  <span class="at">PC =</span> <span class="dv">1</span><span class="sc">:</span>n_show,</span>
<span id="cb66-430"><a href="#cb66-430" aria-hidden="true" tabindex="-1"></a>  <span class="at">Variance =</span> variance_prop[<span class="dv">1</span><span class="sc">:</span>n_show] <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb66-431"><a href="#cb66-431" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb66-432"><a href="#cb66-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-433"><a href="#cb66-433" aria-hidden="true" tabindex="-1"></a><span class="co"># Create scree plot</span></span>
<span id="cb66-434"><a href="#cb66-434" aria-hidden="true" tabindex="-1"></a>scree_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(scree_data, <span class="fu">aes</span>(<span class="at">x =</span> PC, <span class="at">y =</span> Variance)) <span class="sc">+</span></span>
<span id="cb66-435"><a href="#cb66-435" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"steelblue"</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb66-436"><a href="#cb66-436" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">"steelblue"</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb66-437"><a href="#cb66-437" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb66-438"><a href="#cb66-438" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Scree Plot: Variance Explained by Principal Components"</span>,</span>
<span id="cb66-439"><a href="#cb66-439" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Principal Component"</span>,</span>
<span id="cb66-440"><a href="#cb66-440" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Variance Explained (%)"</span></span>
<span id="cb66-441"><a href="#cb66-441" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb66-442"><a href="#cb66-442" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb66-443"><a href="#cb66-443" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb66-444"><a href="#cb66-444" aria-hidden="true" tabindex="-1"></a>    <span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb66-445"><a href="#cb66-445" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb66-446"><a href="#cb66-446" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>()</span>
<span id="cb66-447"><a href="#cb66-447" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb66-448"><a href="#cb66-448" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">1</span>, n_show, <span class="at">by =</span> <span class="dv">2</span>))</span>
<span id="cb66-449"><a href="#cb66-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-450"><a href="#cb66-450" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(scree_plot)</span>
<span id="cb66-451"><a href="#cb66-451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-452"><a href="#cb66-452" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(</span>
<span id="cb66-453"><a href="#cb66-453" aria-hidden="true" tabindex="-1"></a>  <span class="st">"pca_scree_plot.png"</span>,</span>
<span id="cb66-454"><a href="#cb66-454" aria-hidden="true" tabindex="-1"></a>  scree_plot,</span>
<span id="cb66-455"><a href="#cb66-455" aria-hidden="true" tabindex="-1"></a>  <span class="at">width =</span> <span class="dv">8</span>,</span>
<span id="cb66-456"><a href="#cb66-456" aria-hidden="true" tabindex="-1"></a>  <span class="at">height =</span> <span class="dv">6</span>,</span>
<span id="cb66-457"><a href="#cb66-457" aria-hidden="true" tabindex="-1"></a>  <span class="at">dpi =</span> <span class="dv">300</span></span>
<span id="cb66-458"><a href="#cb66-458" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb66-459"><a href="#cb66-459" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-460"><a href="#cb66-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-461"><a href="#cb66-461" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb66-462"><a href="#cb66-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-463"><a href="#cb66-463" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 6: Export Results</span></span>
<span id="cb66-464"><a href="#cb66-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-465"><a href="#cb66-465" aria-hidden="true" tabindex="-1"></a><span class="fu">### Save Principal Components for Downstream Analysis</span></span>
<span id="cb66-466"><a href="#cb66-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-467"><a href="#cb66-467" aria-hidden="true" tabindex="-1"></a><span class="in">```{r export-results, eval=TRUE}</span></span>
<span id="cb66-468"><a href="#cb66-468" aria-hidden="true" tabindex="-1"></a><span class="co"># Export first 10 PCs for association testing</span></span>
<span id="cb66-469"><a href="#cb66-469" aria-hidden="true" tabindex="-1"></a>pcs_export <span class="ot">&lt;-</span> pcs[, <span class="fu">c</span>(<span class="st">"sample_id"</span>, <span class="fu">paste0</span>(<span class="st">"PC"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>))]</span>
<span id="cb66-470"><a href="#cb66-470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-471"><a href="#cb66-471" aria-hidden="true" tabindex="-1"></a><span class="fu">write.table</span>(</span>
<span id="cb66-472"><a href="#cb66-472" aria-hidden="true" tabindex="-1"></a>  pcs_export,</span>
<span id="cb66-473"><a href="#cb66-473" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"principal_components_1000G.txt"</span>,</span>
<span id="cb66-474"><a href="#cb66-474" aria-hidden="true" tabindex="-1"></a>  <span class="at">sep =</span> <span class="st">"</span><span class="sc">\t</span><span class="st">"</span>,</span>
<span id="cb66-475"><a href="#cb66-475" aria-hidden="true" tabindex="-1"></a>  <span class="at">row.names =</span> <span class="cn">FALSE</span>,</span>
<span id="cb66-476"><a href="#cb66-476" aria-hidden="true" tabindex="-1"></a>  <span class="at">quote =</span> <span class="cn">FALSE</span></span>
<span id="cb66-477"><a href="#cb66-477" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb66-478"><a href="#cb66-478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-479"><a href="#cb66-479" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"✓ Principal components exported to principal_components_1000G.txt</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb66-480"><a href="#cb66-480" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  Samples:"</span>, <span class="fu">nrow</span>(pcs_export), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb66-481"><a href="#cb66-481" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  PCs included: 10</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb66-482"><a href="#cb66-482" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-483"><a href="#cb66-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-484"><a href="#cb66-484" aria-hidden="true" tabindex="-1"></a>::: {.callout-note}</span>
<span id="cb66-485"><a href="#cb66-485" aria-hidden="true" tabindex="-1"></a><span class="fu">## Using PCs in Downstream Analyses</span></span>
<span id="cb66-486"><a href="#cb66-486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-487"><a href="#cb66-487" aria-hidden="true" tabindex="-1"></a>These PCs can be included as covariates in:</span>
<span id="cb66-488"><a href="#cb66-488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-489"><a href="#cb66-489" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**GWAS:** Adjust for population stratification</span>
<span id="cb66-490"><a href="#cb66-490" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Expression QTL mapping:** Control for ancestry</span>
<span id="cb66-491"><a href="#cb66-491" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Polygenic risk scores:** Account for population structure</span>
<span id="cb66-492"><a href="#cb66-492" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Clustering:** Define ancestry-matched subcohorts</span>
<span id="cb66-493"><a href="#cb66-493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-494"><a href="#cb66-494" aria-hidden="true" tabindex="-1"></a>Standard practice uses PC1-10, though some studies include PC1-20 for fine-scale structure.</span>
<span id="cb66-495"><a href="#cb66-495" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb66-496"><a href="#cb66-496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-497"><a href="#cb66-497" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb66-498"><a href="#cb66-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-499"><a href="#cb66-499" aria-hidden="true" tabindex="-1"></a><span class="fu">## Interactive Exercise {.exercise}</span></span>
<span id="cb66-500"><a href="#cb66-500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-501"><a href="#cb66-501" aria-hidden="true" tabindex="-1"></a><span class="fu">### Practice: Optimizing PCA for Your Data</span></span>
<span id="cb66-502"><a href="#cb66-502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-503"><a href="#cb66-503" aria-hidden="true" tabindex="-1"></a>Understanding how parameters affect computation helps you optimize analyses for your specific datasets and hardware.</span>
<span id="cb66-504"><a href="#cb66-504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-507"><a href="#cb66-507" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb66-508"><a href="#cb66-508" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb66-509"><a href="#cb66-509" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-510"><a href="#cb66-510" aria-hidden="true" tabindex="-1"></a><span class="co"># Exercise: Try different parameter combinations</span></span>
<span id="cb66-511"><a href="#cb66-511" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-512"><a href="#cb66-512" aria-hidden="true" tabindex="-1"></a><span class="co"># Scenario 1: Larger dataset (memory-constrained)</span></span>
<span id="cb66-513"><a href="#cb66-513" aria-hidden="true" tabindex="-1"></a><span class="co"># You have 50,000 samples × 500,000 SNPs, 32 GB RAM</span></span>
<span id="cb66-514"><a href="#cb66-514" aria-hidden="true" tabindex="-1"></a><span class="fu">bdPCA_hdf5</span>(</span>
<span id="cb66-515"><a href="#cb66-515" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> your_file,</span>
<span id="cb66-516"><a href="#cb66-516" aria-hidden="true" tabindex="-1"></a>  <span class="at">group =</span> <span class="st">"qc"</span>,</span>
<span id="cb66-517"><a href="#cb66-517" aria-hidden="true" tabindex="-1"></a>  <span class="at">dataset =</span> <span class="st">"genotypes"</span>,</span>
<span id="cb66-518"><a href="#cb66-518" aria-hidden="true" tabindex="-1"></a>  <span class="at">k =</span> <span class="dv">16</span>,          <span class="co"># More blocks to reduce memory</span></span>
<span id="cb66-519"><a href="#cb66-519" aria-hidden="true" tabindex="-1"></a>  <span class="at">q =</span> <span class="dv">2</span>,           <span class="co"># Two levels for hierarchical processing</span></span>
<span id="cb66-520"><a href="#cb66-520" aria-hidden="true" tabindex="-1"></a>  <span class="at">components =</span> <span class="dv">10</span>,</span>
<span id="cb66-521"><a href="#cb66-521" aria-hidden="true" tabindex="-1"></a>  <span class="at">threads =</span> <span class="dv">8</span></span>
<span id="cb66-522"><a href="#cb66-522" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb66-523"><a href="#cb66-523" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-524"><a href="#cb66-524" aria-hidden="true" tabindex="-1"></a><span class="co"># Scenario 2: Small dataset (speed-focused)</span></span>
<span id="cb66-525"><a href="#cb66-525" aria-hidden="true" tabindex="-1"></a><span class="co"># You have 1,000 samples × 10,000 SNPs, plenty of RAM</span></span>
<span id="cb66-526"><a href="#cb66-526" aria-hidden="true" tabindex="-1"></a><span class="fu">bdPCA_hdf5</span>(</span>
<span id="cb66-527"><a href="#cb66-527" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> your_file,</span>
<span id="cb66-528"><a href="#cb66-528" aria-hidden="true" tabindex="-1"></a>  <span class="at">group =</span> <span class="st">"qc"</span>,</span>
<span id="cb66-529"><a href="#cb66-529" aria-hidden="true" tabindex="-1"></a>  <span class="at">dataset =</span> <span class="st">"genotypes"</span>,</span>
<span id="cb66-530"><a href="#cb66-530" aria-hidden="true" tabindex="-1"></a>  <span class="at">k =</span> <span class="dv">2</span>,           <span class="co"># Fewer blocks (less overhead)</span></span>
<span id="cb66-531"><a href="#cb66-531" aria-hidden="true" tabindex="-1"></a>  <span class="at">q =</span> <span class="dv">1</span>,           <span class="co"># Single level</span></span>
<span id="cb66-532"><a href="#cb66-532" aria-hidden="true" tabindex="-1"></a>  <span class="at">components =</span> <span class="dv">20</span>,</span>
<span id="cb66-533"><a href="#cb66-533" aria-hidden="true" tabindex="-1"></a>  <span class="at">threads =</span> <span class="dv">4</span></span>
<span id="cb66-534"><a href="#cb66-534" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb66-535"><a href="#cb66-535" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-536"><a href="#cb66-536" aria-hidden="true" tabindex="-1"></a><span class="co"># Question: How does changing k affect your analysis?</span></span>
<span id="cb66-537"><a href="#cb66-537" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb66-538"><a href="#cb66-538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-539"><a href="#cb66-539" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip}</span>
<span id="cb66-540"><a href="#cb66-540" aria-hidden="true" tabindex="-1"></a><span class="fu">### Reflection Questions</span></span>
<span id="cb66-541"><a href="#cb66-541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-542"><a href="#cb66-542" aria-hidden="true" tabindex="-1"></a>**1. Parameter Selection:**</span>
<span id="cb66-543"><a href="#cb66-543" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>For your data size, what k value balances memory and speed?</span>
<span id="cb66-544"><a href="#cb66-544" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>How do you decide between q=1 vs. q=2?</span>
<span id="cb66-545"><a href="#cb66-545" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>When would you compute 50 PCs instead of 20?</span>
<span id="cb66-546"><a href="#cb66-546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-547"><a href="#cb66-547" aria-hidden="true" tabindex="-1"></a>**2. Quality Control Impact:**</span>
<span id="cb66-548"><a href="#cb66-548" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>What if you skip MAF filtering? More noise, or more information?</span>
<span id="cb66-549"><a href="#cb66-549" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>How aggressive should missingness thresholds be?</span>
<span id="cb66-550"><a href="#cb66-550" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>When might you use different QC for different analyses?</span>
<span id="cb66-551"><a href="#cb66-551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-552"><a href="#cb66-552" aria-hidden="true" tabindex="-1"></a>**3. Interpreting Results:**</span>
<span id="cb66-553"><a href="#cb66-553" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>PC1 explains 4% of variance. Is that good or bad?</span>
<span id="cb66-554"><a href="#cb66-554" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>You see a cluster separate from all populations. What might it be?</span>
<span id="cb66-555"><a href="#cb66-555" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>PCs correlate with sequencing batch. How do you handle this?</span>
<span id="cb66-556"><a href="#cb66-556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-557"><a href="#cb66-557" aria-hidden="true" tabindex="-1"></a>**4. Computational Scaling:**</span>
<span id="cb66-558"><a href="#cb66-558" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Your dataset doubles in size. How do parameters change?</span>
<span id="cb66-559"><a href="#cb66-559" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>You have limited RAM but many CPU cores. Optimize for what?</span>
<span id="cb66-560"><a href="#cb66-560" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Accuracy vs. speed - when does each matter more?</span>
<span id="cb66-561"><a href="#cb66-561" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-562"><a href="#cb66-562" aria-hidden="true" tabindex="-1"></a>**5. Biological vs. Technical Structure:**</span>
<span id="cb66-563"><a href="#cb66-563" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>How do you distinguish ancestry from batch effects?</span>
<span id="cb66-564"><a href="#cb66-564" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>Should you remove outliers before PCA or after?</span>
<span id="cb66-565"><a href="#cb66-565" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>When do you trust what the PCA shows?</span>
<span id="cb66-566"><a href="#cb66-566" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-567"><a href="#cb66-567" aria-hidden="true" tabindex="-1"></a>Experiment with different settings on this dataset. Note how computation time, memory usage, and results change. This builds intuition for optimizing real analyses.</span>
<span id="cb66-568"><a href="#cb66-568" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb66-569"><a href="#cb66-569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-570"><a href="#cb66-570" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb66-571"><a href="#cb66-571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-572"><a href="#cb66-572" aria-hidden="true" tabindex="-1"></a><span class="fu">## Key Takeaways {.key-concept}</span></span>
<span id="cb66-573"><a href="#cb66-573" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-574"><a href="#cb66-574" aria-hidden="true" tabindex="-1"></a>Let's consolidate what you've learned about implementing PCA on large-scale genomic data using BigDataStatMeth.</span>
<span id="cb66-575"><a href="#cb66-575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-576"><a href="#cb66-576" aria-hidden="true" tabindex="-1"></a><span class="fu">### Essential Concepts</span></span>
<span id="cb66-577"><a href="#cb66-577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-578"><a href="#cb66-578" aria-hidden="true" tabindex="-1"></a>**PCA on genomic data serves specific purposes** that differ from general dimensionality reduction. In genomics, PCA primarily identifies population structure and batch effects rather than reducing features for modeling. PC1-PC2 capture continental ancestry, PC3-PC10 capture finer population structure, and later PCs often reflect technical artifacts. Understanding these purposes guides interpretation - low variance explained isn't a problem, it's expected when analyzing subtle population differences.</span>
<span id="cb66-579"><a href="#cb66-579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-580"><a href="#cb66-580" aria-hidden="true" tabindex="-1"></a>**Quality control determines PCA validity** more than the PCA algorithm itself. Running PCA on un-QC'd data produces results that look mathematically correct but are scientifically meaningless. Remove low-quality samples first (they distort allele frequencies), then filter SNPs by missingness (high-missing SNPs are unreliable), then remove rare variants (low MAF adds noise). This ordering matters - sample QC affects SNP metrics, so samples must be filtered before SNP-level QC. Skipping or reordering these steps produces different, less reliable results.</span>
<span id="cb66-581"><a href="#cb66-581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-582"><a href="#cb66-582" aria-hidden="true" tabindex="-1"></a>**Block-wise PCA enables analyses that traditional methods cannot handle.** Standard R functions (<span class="in">`prcomp()`</span>, <span class="in">`svd()`</span>) require loading entire matrices into memory, failing when data exceeds RAM. BigDataStatMeth's block-wise approach processes data in chunks, enabling PCA on datasets that are 10× or 100× larger than available memory. For the 1000 Genomes data (2-3 GB), this might seem unnecessary on modern workstations, but for whole-genome sequencing cohorts (50,000 samples × 10 million variants = 4 TB), block-wise processing becomes essential, not optional.</span>
<span id="cb66-583"><a href="#cb66-583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-584"><a href="#cb66-584" aria-hidden="true" tabindex="-1"></a>**Centering is mandatory, scaling is context-dependent.** Centering (subtracting column means) removes the origin from the data cloud, ensuring PC1 doesn't just capture mean differences between SNPs. This is universally necessary for interpretable PCA. Scaling (dividing by standard deviations) equalizes variance across features, which helps when features have different units (mixing expression and metabolites) but obscures real biological variance differences in SNP data. For genomic PCA, center but don't scale. For multi-omic integration, both centering and scaling may be needed.</span>
<span id="cb66-585"><a href="#cb66-585" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-586"><a href="#cb66-586" aria-hidden="true" tabindex="-1"></a>**Variance explained in population PCA is low by design.** Seeing PC1 explain only 3-5% of total variance doesn't indicate failure - it reflects biological reality. Human genetic variation is highly dimensional with many independent signals. Population structure is real but subtle compared to individual genetic variation. If PC1 explained 50% of variance in human genomic data, something is seriously wrong (likely a technical artifact, not biology). Low variance per component with clear population clustering indicates successful, valid PCA.</span>
<span id="cb66-587"><a href="#cb66-587" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-588"><a href="#cb66-588" aria-hidden="true" tabindex="-1"></a>**Parameter choice balances memory, speed, and accuracy.** The <span class="in">`k`</span> parameter (number of blocks) controls memory usage: larger k = less memory per block but more I/O overhead. The <span class="in">`q`</span> parameter (hierarchy levels) determines how blocks are combined: q=1 works for moderate data, q=2 needed for very large matrices. The <span class="in">`threads`</span> parameter enables parallelization but shows diminishing returns beyond physical CPU cores. For typical genomic analyses, k=4-8, q=1, and threads matching your cores provides good performance without extensive tuning.</span>
<span id="cb66-589"><a href="#cb66-589" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-590"><a href="#cb66-590" aria-hidden="true" tabindex="-1"></a>**PCA results require biological validation, not just statistical assessment.** Mathematically perfect PCA can still be biologically meaningless. Validate by checking: Do populations cluster as expected? Do PCs correlate with known ancestry? Are there unexpected outliers (sequencing failures, sample swaps)? Does PC1 correlate with sequencing batch (technical artifact)? Statistical metrics (variance explained, eigenvalue ratios) tell you if PCA worked; biological validation tells you if results are meaningful.</span>
<span id="cb66-591"><a href="#cb66-591" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-592"><a href="#cb66-592" aria-hidden="true" tabindex="-1"></a><span class="fu">### When to Use This Workflow</span></span>
<span id="cb66-593"><a href="#cb66-593" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-594"><a href="#cb66-594" aria-hidden="true" tabindex="-1"></a>Understanding when this comprehensive PCA workflow helps versus when simpler approaches suffice guides efficient analysis design.</span>
<span id="cb66-595"><a href="#cb66-595" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-596"><a href="#cb66-596" aria-hidden="true" tabindex="-1"></a>✅ **Use this workflow when:**</span>
<span id="cb66-597"><a href="#cb66-597" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-598"><a href="#cb66-598" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Dataset size exceeds comfortable RAM limits** - When traditional PCA fails with memory errors, or when loading data takes minutes, block-wise processing becomes necessary. Rule of thumb: if your data matrix is &gt;30% of available RAM, use BigDataStatMeth's approach to avoid memory issues during computation.</span>
<span id="cb66-599"><a href="#cb66-599" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-600"><a href="#cb66-600" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**You're analyzing genomic data for publication** - The comprehensive QC → imputation → PCA → validation pipeline produces defensible, reproducible results. Reviewers expect proper QC, and this workflow documents every step. The organized HDF5 structure preserves intermediate results for supplementary materials or reanalysis with different parameters.</span>
<span id="cb66-601"><a href="#cb66-601" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-602"><a href="#cb66-602" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Population structure matters for your analysis** - GWAS, rare variant analysis, and selection scans all require proper ancestry adjustment. This workflow identifies population structure reliably, providing covariates for downstream association tests. Skipping proper PCA leads to false positive associations driven by population stratification.</span>
<span id="cb66-603"><a href="#cb66-603" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-604"><a href="#cb66-604" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**You need to optimize for available resources** - The parameterized approach (k, q, threads) lets you tune for your specific hardware. With limited RAM but many cores, increase k and threads. With ample RAM but slow disk, decrease k to minimize I/O. This flexibility enables analysis on hardware ranging from laptops to HPC clusters.</span>
<span id="cb66-605"><a href="#cb66-605" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-606"><a href="#cb66-606" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**The analysis will be extended or repeated** - If you'll add more samples, reanalyze with updated QC thresholds, or apply the same pipeline to multiple cohorts, having a documented workflow saves enormous time. Copy the structure, adjust file paths and parameters, execute. The HDF5 organization makes extending analyses straightforward.</span>
<span id="cb66-607"><a href="#cb66-607" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-608"><a href="#cb66-608" aria-hidden="true" tabindex="-1"></a>✅ **Adapt this workflow when:**</span>
<span id="cb66-609"><a href="#cb66-609" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-610"><a href="#cb66-610" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Analyzing different omic types** - Transcriptomics data needs log-transformation before PCA. Methylation data might need beta to M-value conversion. Proteomics might need scaling due to different abundance ranges. The workflow structure (QC → transformation → PCA → validation) remains constant, but specific operations change to match data characteristics.</span>
<span id="cb66-611"><a href="#cb66-611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-612"><a href="#cb66-612" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Different QC stringency needed** - Exploratory analyses tolerate more missingness and lower MAF than definitive GWAS. Imputation-based association tests need stricter QC than burden tests. Adjust thresholds (5% missingness vs. 10%, MAF 0.01 vs. 0.05) to match analysis goals and acceptable false discovery rates.</span>
<span id="cb66-613"><a href="#cb66-613" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-614"><a href="#cb66-614" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Computational constraints vary** - On a laptop with 8 GB RAM, use k=16, q=2, process in smaller blocks. On a server with 256 GB RAM, use k=2-4, q=1, minimize overhead. The algorithm is the same, only parameters change to match available resources.</span>
<span id="cb66-615"><a href="#cb66-615" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-616"><a href="#cb66-616" aria-hidden="true" tabindex="-1"></a>❌ **Simpler approaches work better when:**</span>
<span id="cb66-617"><a href="#cb66-617" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-618"><a href="#cb66-618" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Data easily fits in memory** - If <span class="in">`prcomp(scale(data))`</span> works without issues, use it. Base R PCA is well-tested, well-documented, and integrates seamlessly with the broader R ecosystem. Don't add HDF5 complexity when traditional methods suffice.</span>
<span id="cb66-619"><a href="#cb66-619" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-620"><a href="#cb66-620" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Quality control already performed** - If analyzing published data (like HapMap, 1000 Genomes processed files), extensive QC is redundant. These datasets are already filtered, imputed, and quality-controlled. Load, run PCA, interpret results. Don't re-QC already-QC'd data.</span>
<span id="cb66-621"><a href="#cb66-621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-622"><a href="#cb66-622" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Exploratory analysis on subsets** - For quick exploration of chromosome 22 or a 1% random sample, simple approaches are faster. Extract subset, run standard PCA, visualize, iterate. Use this workflow when transitioning from exploration to production analysis on the full dataset.</span>
<span id="cb66-623"><a href="#cb66-623" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-624"><a href="#cb66-624" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**No population structure expected** - Analyzing inbred lines, cell cultures, or known-homogeneous populations doesn't need population structure PCA. The analysis might still be useful for quality control (identifying outliers) but doesn't serve its primary purpose of ancestry adjustment.</span>
<span id="cb66-625"><a href="#cb66-625" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-626"><a href="#cb66-626" aria-hidden="true" tabindex="-1"></a>The key principle is matching workflow complexity to analysis needs and data scale. Large-scale genomic studies requiring QC, population structure identification, and resource optimization benefit from this comprehensive approach. Small-scale, exploratory, or already-QC'd analyses are better served by simpler methods.</span>
<span id="cb66-627"><a href="#cb66-627" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-628"><a href="#cb66-628" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb66-629"><a href="#cb66-629" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-630"><a href="#cb66-630" aria-hidden="true" tabindex="-1"></a><span class="fu">## Next Steps</span></span>
<span id="cb66-631"><a href="#cb66-631" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-632"><a href="#cb66-632" aria-hidden="true" tabindex="-1"></a>**Explore related workflows:**</span>
<span id="cb66-633"><a href="#cb66-633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-634"><a href="#cb66-634" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Implementing CCA</span><span class="co">](implementing-cca.qmd)</span> - Multi-omic integration using canonical correlation</span>
<span id="cb66-635"><a href="#cb66-635" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Cross-Platform Workflows</span><span class="co">](cross-platform.qmd)</span> - Using PCA results in Python and C++</span>
<span id="cb66-636"><a href="#cb66-636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-637"><a href="#cb66-637" aria-hidden="true" tabindex="-1"></a>**Extend this analysis:**</span>
<span id="cb66-638"><a href="#cb66-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-639"><a href="#cb66-639" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Perform association tests using PCs as covariates</span>
<span id="cb66-640"><a href="#cb66-640" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Calculate genomic relationship matrices from PCs</span>
<span id="cb66-641"><a href="#cb66-641" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Identify population-specific outliers for closer inspection</span>
<span id="cb66-642"><a href="#cb66-642" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Compare PCA with other dimensionality reduction methods (UMAP, t-SNE)</span>
<span id="cb66-643"><a href="#cb66-643" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-644"><a href="#cb66-644" aria-hidden="true" tabindex="-1"></a>**Optimize for your data:**</span>
<span id="cb66-645"><a href="#cb66-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-646"><a href="#cb66-646" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Test different k, q, threads to find optimal settings</span>
<span id="cb66-647"><a href="#cb66-647" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Try different QC thresholds for different analysis types</span>
<span id="cb66-648"><a href="#cb66-648" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Explore ancestry-informative marker selection before PCA</span>
<span id="cb66-649"><a href="#cb66-649" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Implement cross-validation for PCA stability assessment</span>
<span id="cb66-650"><a href="#cb66-650" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-651"><a href="#cb66-651" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb66-652"><a href="#cb66-652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-653"><a href="#cb66-653" aria-hidden="true" tabindex="-1"></a><span class="fu">## Cleanup</span></span>
<span id="cb66-654"><a href="#cb66-654" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-655"><a href="#cb66-655" aria-hidden="true" tabindex="-1"></a><span class="in">```{r cleanup, eval=TRUE}</span></span>
<span id="cb66-656"><a href="#cb66-656" aria-hidden="true" tabindex="-1"></a><span class="co"># Close any open HDF5 connections</span></span>
<span id="cb66-657"><a href="#cb66-657" aria-hidden="true" tabindex="-1"></a><span class="fu">h5closeAll</span>()</span>
<span id="cb66-658"><a href="#cb66-658" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-659"><a href="#cb66-659" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: Keep generated files for future reference</span></span>
<span id="cb66-660"><a href="#cb66-660" aria-hidden="true" tabindex="-1"></a><span class="co"># - 1000G_pca_analysis.hdf5: Complete analysis with all steps</span></span>
<span id="cb66-661"><a href="#cb66-661" aria-hidden="true" tabindex="-1"></a><span class="co"># - pca_population_structure.png: Publication plot</span></span>
<span id="cb66-662"><a href="#cb66-662" aria-hidden="true" tabindex="-1"></a><span class="co"># - principal_components_1000G.txt: Covariates for downstream use</span></span>
<span id="cb66-663"><a href="#cb66-663" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>© 2025 BigDataStatMeth - ISGlobal BRGE</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/isglobal-brge/BigDataStatMeth/edit/main/workflows/implementing-pca.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/isglobal-brge/BigDataStatMeth/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/isglobal-brge/BigDataStatMeth">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item">
 License: GPL-3
  </li>  
</ul>
    </div>
  </div>
</footer>




<script src="../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>