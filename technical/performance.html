<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Performance Optimization – BigDataStatMeth</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../assets/favicon.png" rel="icon" type="image/png">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-065a5179aebd64318d7ea99d77b64a9e.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark-969ddfa49e00a70eb3423444dbc81f6c.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-065a5179aebd64318d7ea99d77b64a9e.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-d0f1cdce0779274a5ec1152cd33adb41.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark-d6747531eee53fd58085a197f3afc013.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-d0f1cdce0779274a5ec1152cd33adb41.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>html{ scroll-behavior: smooth; }</style>
<meta name="mermaid-theme" content="default">
<script src="../site_libs/quarto-diagram/mermaid.min.js"></script>
<script src="../site_libs/quarto-diagram/mermaid-init.js"></script>
<link href="../site_libs/quarto-diagram/mermaid.css" rel="stylesheet">


<link rel="stylesheet" href="../assets/css/custom.css">
</head>

<body class="nav-fixed quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../assets/images/logo.png" alt="" class="navbar-logo light-content">
    <img src="../assets/images/logo.png" alt="" class="navbar-logo dark-content">
    </a>
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">BigDataStatMeth</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-fundamentals" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Fundamentals</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-fundamentals">    
        <li>
    <a class="dropdown-item" href="../fundamentals/big-data-problem.html">
 <span class="dropdown-text">The Big Data Problem</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../fundamentals/understanding-hdf5.html">
 <span class="dropdown-text">Understanding HDF5</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../fundamentals/blockwise-computing.html">
 <span class="dropdown-text">Block-Wise Computing</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../fundamentals/linear-algebra.html">
 <span class="dropdown-text">Linear Algebra Essentials</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-tutorials" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Tutorials</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-tutorials">    
        <li>
    <a class="dropdown-item" href="../tutorials/getting-started.html">
 <span class="dropdown-text">Getting Started</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../tutorials/working-hdf5-matrices.html">
 <span class="dropdown-text">Working with HDF5 Matrices</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../tutorials/first-analysis.html">
 <span class="dropdown-text">Your First Analysis</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-workflows" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Workflows</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-workflows">    
        <li>
    <a class="dropdown-item" href="../workflows/implementing-pca.html">
 <span class="dropdown-text">Implementing PCA</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../workflows/implementing-cca.html">
 <span class="dropdown-text">Implementing CCA</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../workflows/cross-platform.html">
 <span class="dropdown-text">Cross-Platform Workflows</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-developing-methods" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Developing Methods</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-developing-methods">    
        <li>
    <a class="dropdown-item" href="../developing-methods/cca-r-implementation.html">
 <span class="dropdown-text">CCA in R</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../developing-methods/cca-cpp-implementation.html">
 <span class="dropdown-text">CCA in C++</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-api-reference" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">API Reference</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-api-reference">    
        <li>
    <a class="dropdown-item" href="../api-reference/r/index.html">
 <span class="dropdown-text">R Functions</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../api-reference/cpp/index.html">
 <span class="dropdown-text">C++ API</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link active" href="../technical/performance.html" aria-current="page"> 
<span class="menu-text">Technical</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/isglobal-brge/BigDataStatMeth"> <i class="bi bi-github" role="img" aria-label="GitHub">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://cran.r-project.org/package=BigDataStatMeth"> 
<span class="menu-text">CRAN</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview"><span class="header-section-number">1</span> Overview</a>
  <ul class="collapse">
  <li><a href="#what-youll-learn" id="toc-what-youll-learn" class="nav-link" data-scroll-target="#what-youll-learn"><span class="header-section-number">1.1</span> What You’ll Learn</a></li>
  </ul></li>
  <li><a href="#understanding-the-three-constraints" id="toc-understanding-the-three-constraints" class="nav-link" data-scroll-target="#understanding-the-three-constraints"><span class="header-section-number">2</span> Understanding the Three Constraints</a>
  <ul class="collapse">
  <li><a href="#memory-vs-speed" id="toc-memory-vs-speed" class="nav-link" data-scroll-target="#memory-vs-speed"><span class="header-section-number">2.1</span> Memory vs Speed</a></li>
  <li><a href="#speed-vs-accuracy" id="toc-speed-vs-accuracy" class="nav-link" data-scroll-target="#speed-vs-accuracy"><span class="header-section-number">2.2</span> Speed vs Accuracy</a></li>
  <li><a href="#memory-vs-accuracy" id="toc-memory-vs-accuracy" class="nav-link" data-scroll-target="#memory-vs-accuracy"><span class="header-section-number">2.3</span> Memory vs Accuracy</a></li>
  </ul></li>
  <li><a href="#quick-start-decision-tree" id="toc-quick-start-decision-tree" class="nav-link" data-scroll-target="#quick-start-decision-tree"><span class="header-section-number">3</span> Quick Start: Decision Tree</a></li>
  <li><a href="#key-parameters-deep-dive" id="toc-key-parameters-deep-dive" class="nav-link" data-scroll-target="#key-parameters-deep-dive"><span class="header-section-number">4</span> Key Parameters Deep Dive</a>
  <ul class="collapse">
  <li><a href="#block-size-the-k-parameter" id="toc-block-size-the-k-parameter" class="nav-link" data-scroll-target="#block-size-the-k-parameter"><span class="header-section-number">4.1</span> Block Size: The k Parameter</a></li>
  <li><a href="#hierarchy-levels-the-q-parameter" id="toc-hierarchy-levels-the-q-parameter" class="nav-link" data-scroll-target="#hierarchy-levels-the-q-parameter"><span class="header-section-number">4.2</span> Hierarchy Levels: The q Parameter</a></li>
  <li><a href="#thread-count-parallel-processing" id="toc-thread-count-parallel-processing" class="nav-link" data-scroll-target="#thread-count-parallel-processing"><span class="header-section-number">4.3</span> Thread Count: Parallel Processing</a></li>
  <li><a href="#hdf5-chunk-size" id="toc-hdf5-chunk-size" class="nav-link" data-scroll-target="#hdf5-chunk-size"><span class="header-section-number">4.4</span> HDF5 Chunk Size</a></li>
  </ul></li>
  <li><a href="#profiling-finding-the-bottleneck" id="toc-profiling-finding-the-bottleneck" class="nav-link" data-scroll-target="#profiling-finding-the-bottleneck"><span class="header-section-number">5</span> Profiling: Finding the Bottleneck</a>
  <ul class="collapse">
  <li><a href="#why-profile-first" id="toc-why-profile-first" class="nav-link" data-scroll-target="#why-profile-first"><span class="header-section-number">5.1</span> Why Profile First</a></li>
  <li><a href="#basic-timing-with-system.time" id="toc-basic-timing-with-system.time" class="nav-link" data-scroll-target="#basic-timing-with-system.time"><span class="header-section-number">5.2</span> Basic Timing with system.time()</a></li>
  <li><a href="#detailed-profiling-with-rprof" id="toc-detailed-profiling-with-rprof" class="nav-link" data-scroll-target="#detailed-profiling-with-rprof"><span class="header-section-number">5.3</span> Detailed Profiling with Rprof()</a></li>
  <li><a href="#visual-profiling-with-profvis" id="toc-visual-profiling-with-profvis" class="nav-link" data-scroll-target="#visual-profiling-with-profvis"><span class="header-section-number">5.4</span> Visual Profiling with profvis</a></li>
  </ul></li>
  <li><a href="#optimization-workflows" id="toc-optimization-workflows" class="nav-link" data-scroll-target="#optimization-workflows"><span class="header-section-number">6</span> Optimization Workflows</a>
  <ul class="collapse">
  <li><a href="#memory-constrained-environment" id="toc-memory-constrained-environment" class="nav-link" data-scroll-target="#memory-constrained-environment"><span class="header-section-number">6.1</span> Memory-Constrained Environment</a></li>
  <li><a href="#speed-constrained-environment" id="toc-speed-constrained-environment" class="nav-link" data-scroll-target="#speed-constrained-environment"><span class="header-section-number">6.2</span> Speed-Constrained Environment</a></li>
  <li><a href="#balanced-optimization-iterative-tuning" id="toc-balanced-optimization-iterative-tuning" class="nav-link" data-scroll-target="#balanced-optimization-iterative-tuning"><span class="header-section-number">6.3</span> Balanced Optimization: Iterative Tuning</a></li>
  </ul></li>
  <li><a href="#common-performance-pitfalls" id="toc-common-performance-pitfalls" class="nav-link" data-scroll-target="#common-performance-pitfalls"><span class="header-section-number">7</span> Common Performance Pitfalls</a>
  <ul class="collapse">
  <li><a href="#pitfall-1-excessive-blocking" id="toc-pitfall-1-excessive-blocking" class="nav-link" data-scroll-target="#pitfall-1-excessive-blocking"><span class="header-section-number">7.1</span> Pitfall 1: Excessive Blocking</a></li>
  <li><a href="#pitfall-2-thread-oversubscription" id="toc-pitfall-2-thread-oversubscription" class="nav-link" data-scroll-target="#pitfall-2-thread-oversubscription"><span class="header-section-number">7.2</span> Pitfall 2: Thread Oversubscription</a></li>
  <li><a href="#pitfall-3-redundant-operations" id="toc-pitfall-3-redundant-operations" class="nav-link" data-scroll-target="#pitfall-3-redundant-operations"><span class="header-section-number">7.3</span> Pitfall 3: Redundant Operations</a></li>
  </ul></li>
  <li><a href="#benchmarking-measuring-real-performance" id="toc-benchmarking-measuring-real-performance" class="nav-link" data-scroll-target="#benchmarking-measuring-real-performance"><span class="header-section-number">8</span> Benchmarking: Measuring Real Performance</a>
  <ul class="collapse">
  <li><a href="#systematic-benchmarking-framework" id="toc-systematic-benchmarking-framework" class="nav-link" data-scroll-target="#systematic-benchmarking-framework"><span class="header-section-number">8.1</span> Systematic Benchmarking Framework</a></li>
  <li><a href="#visualizing-performance" id="toc-visualizing-performance" class="nav-link" data-scroll-target="#visualizing-performance"><span class="header-section-number">8.2</span> Visualizing Performance</a></li>
  <li><a href="#interpreting-benchmarks" id="toc-interpreting-benchmarks" class="nav-link" data-scroll-target="#interpreting-benchmarks"><span class="header-section-number">8.3</span> Interpreting Benchmarks</a></li>
  </ul></li>
  <li><a href="#real-world-case-study-1000-genomes-pca" id="toc-real-world-case-study-1000-genomes-pca" class="nav-link" data-scroll-target="#real-world-case-study-1000-genomes-pca"><span class="header-section-number">9</span> Real-World Case Study: 1000 Genomes PCA</a>
  <ul class="collapse">
  <li><a href="#initial-baseline" id="toc-initial-baseline" class="nav-link" data-scroll-target="#initial-baseline"><span class="header-section-number">9.1</span> Initial Baseline</a></li>
  <li><a href="#profile-to-identify-bottlenecks" id="toc-profile-to-identify-bottlenecks" class="nav-link" data-scroll-target="#profile-to-identify-bottlenecks"><span class="header-section-number">9.2</span> Profile to Identify Bottlenecks</a></li>
  <li><a href="#optimization-1-reduce-block-count" id="toc-optimization-1-reduce-block-count" class="nav-link" data-scroll-target="#optimization-1-reduce-block-count"><span class="header-section-number">9.3</span> Optimization 1: Reduce Block Count</a></li>
  <li><a href="#optimization-2-increase-threading" id="toc-optimization-2-increase-threading" class="nav-link" data-scroll-target="#optimization-2-increase-threading"><span class="header-section-number">9.4</span> Optimization 2: Increase Threading</a></li>
  <li><a href="#optimization-3-pre-normalize-data" id="toc-optimization-3-pre-normalize-data" class="nav-link" data-scroll-target="#optimization-3-pre-normalize-data"><span class="header-section-number">9.5</span> Optimization 3: Pre-normalize Data</a></li>
  <li><a href="#verification-of-correctness" id="toc-verification-of-correctness" class="nav-link" data-scroll-target="#verification-of-correctness"><span class="header-section-number">9.6</span> Verification of Correctness</a></li>
  <li><a href="#final-configuration-summary" id="toc-final-configuration-summary" class="nav-link" data-scroll-target="#final-configuration-summary"><span class="header-section-number">9.7</span> Final Configuration Summary</a></li>
  </ul></li>
  <li><a href="#interactive-exercise" id="toc-interactive-exercise" class="nav-link" data-scroll-target="#interactive-exercise"><span class="header-section-number">10</span> Interactive Exercise</a>
  <ul class="collapse">
  <li><a href="#apply-optimization-to-your-data" id="toc-apply-optimization-to-your-data" class="nav-link" data-scroll-target="#apply-optimization-to-your-data"><span class="header-section-number">10.1</span> Apply Optimization to Your Data</a></li>
  </ul></li>
  <li><a href="#key-takeaways" id="toc-key-takeaways" class="nav-link" data-scroll-target="#key-takeaways"><span class="header-section-number">11</span> Key Takeaways</a></li>
  <li><a href="#next-steps" id="toc-next-steps" class="nav-link" data-scroll-target="#next-steps"><span class="header-section-number">12</span> Next Steps</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/isglobal-brge/BigDataStatMeth/edit/main/technical/performance.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/isglobal-brge/BigDataStatMeth/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">


<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Performance Optimization</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
<p class="subtitle lead">Benchmarks and Tuning Strategies for Large-Scale Analysis</p>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="overview" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="overview"><span class="header-section-number">1</span> Overview</h2>
<p>Performance optimization in BigDataStatMeth requires understanding a fundamental truth: you cannot simultaneously maximize speed, minimize memory usage, and maintain perfect numerical accuracy. Every optimization decision involves tradeoffs, and the “best” configuration depends entirely on your specific constraints—hardware limitations, dataset characteristics, and analysis requirements.</p>
<p>Consider a common scenario: you have a 100GB dataset and need to perform PCA. One configuration processes it in 10 minutes using 8GB RAM. Another finishes in 5 minutes but requires 64GB RAM. Which is “better”? If you only have 16GB available, the second configuration is impossible—the first configuration is objectively superior for your situation. If you have 128GB RAM but are analyzing hundreds of datasets, the 5-minute option saves hours of total computation time. Neither configuration is universally optimal; context determines the right choice.</p>
<p>This guide teaches you to make these decisions systematically. You’ll learn to identify where your computation spends time (profiling), understand how parameters affect performance (tuning), and recognize when you’re fighting fundamental limitations (bottlenecks). The goal isn’t to memorize optimal parameter values—those don’t exist—but to develop intuition for balancing constraints in your specific environment.</p>
<p>The strategies here apply broadly across BigDataStatMeth’s operations: PCA, SVD, CCA, matrix operations, statistical tests. While optimal values vary by dataset and hardware, the underlying principles remain constant. Master these principles, and you can optimize any workflow.</p>
<section id="what-youll-learn" class="level3 learning-objectives" data-number="1.1">
<h3 data-number="1.1" class="anchored" data-anchor-id="what-youll-learn"><span class="header-section-number">1.1</span> What You’ll Learn</h3>
<ul>
<li>Identify performance bottlenecks in your workflows using profiling tools</li>
<li>Understand how block size (k, q) controls the memory-speed tradeoff</li>
<li>Tune thread counts while recognizing parallelization limits</li>
<li>Optimize HDF5 chunk sizes to match your access patterns</li>
<li>Balance numerical accuracy against computational efficiency</li>
<li>Recognize fundamental bottlenecks (I/O, memory bandwidth, Amdahl’s law)</li>
<li>Make informed optimization decisions based on your constraints</li>
<li>Benchmark systematically to measure actual improvements</li>
</ul>
</section>
<hr>
</section>
<section id="understanding-the-three-constraints" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="understanding-the-three-constraints"><span class="header-section-number">2</span> Understanding the Three Constraints</h2>
<p>Every optimization navigates three competing constraints. Understanding why these constraints conflict helps you make better tradeoff decisions.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">flowchart LR
    A[Memory] &lt;--&gt; B[Speed]
    B &lt;--&gt; C[Accuracy]
    C &lt;--&gt; A
    
    style A fill:#e8f6e8
    style B fill:#e7f3ff
    style C fill:#fff8e1
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<section id="memory-vs-speed" class="level3" data-number="2.1">
<h3 data-number="2.1" class="anchored" data-anchor-id="memory-vs-speed"><span class="header-section-number">2.1</span> Memory vs Speed</h3>
<p>Block-wise computing divides matrices into smaller pieces to control memory usage. Smaller blocks mean lower peak memory—you can process datasets much larger than your RAM. But smaller blocks come with costs: more operations to combine results, more HDF5 reads/writes, more overhead from setup and coordination.</p>
<p>Think of it like moving furniture. Disassembling a table into many small pieces lets you fit it through doorways (memory constraint), but assembly and disassembly take time (speed penalty). Keeping the table intact is faster but requires a truck large enough to carry it whole (memory requirement). The optimal approach depends on what size “truck” (RAM) you have available.</p>
<p>Mathematically, if you double the number of blocks (k), you roughly halve peak memory usage but may increase computation time by 20-50% depending on the operation. For pure computation (matrix multiplication, SVD), the overhead is lower. For I/O-heavy operations (reading data, writing results), overhead dominates.</p>
</section>
<section id="speed-vs-accuracy" class="level3" data-number="2.2">
<h3 data-number="2.2" class="anchored" data-anchor-id="speed-vs-accuracy"><span class="header-section-number">2.2</span> Speed vs Accuracy</h3>
<p>Some algorithms offer approximate solutions faster than exact solutions. Block-wise SVD, for example, can compute fewer iterations to converge faster, accepting slightly lower precision in singular values. For exploratory data analysis—visualizing principal components, identifying outliers, getting a general sense of data structure—high precision matters less than rapid iteration. You’re happy with “close enough” if it lets you test ten parameter combinations instead of one.</p>
<p>For publication-quality results, accuracy cannot be compromised. The difference between a singular value of 42.157 and 42.154 might seem trivial, but reviewers and reproducibility standards demand exact, verifiable computations. In these cases, you accept longer computation times to guarantee numerical precision.</p>
<p>BigDataStatMeth defaults to conservative, accurate algorithms. When speed matters more than the last decimal place, you can adjust—but always verify results remain scientifically valid for your purposes.</p>
</section>
<section id="memory-vs-accuracy" class="level3" data-number="2.3">
<h3 data-number="2.3" class="anchored" data-anchor-id="memory-vs-accuracy"><span class="header-section-number">2.3</span> Memory vs Accuracy</h3>
<p>This constraint is subtler and less obvious. Extreme block sizes can affect numerical stability. Very small blocks (dozens of rows) may create ill-conditioned subproblems—matrices where numerical algorithms struggle with rounding errors. Very large blocks approaching memory limits may cause intermittent failures when memory fragmentation prevents allocation despite “enough” RAM theoretically existing.</p>
<p>The practical guidance: stay in reasonable ranges. Blocks with 1,000-10,000 rows typically work well. Below 500 rows per block, watch for numerical warnings. Above 50,000 rows per block, ensure you have substantial memory headroom. BigDataStatMeth’s algorithms handle edge cases, but respecting these guidelines avoids potential issues.</p>
<hr>
</section>
</section>
<section id="quick-start-decision-tree" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="quick-start-decision-tree"><span class="header-section-number">3</span> Quick Start: Decision Tree</h2>
<p>Before diving into theory, here’s a practical decision tree for choosing starting configurations. These values aren’t optimal—they’re reasonable starting points based on common scenarios. Always profile and tune for your specific case.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">flowchart TD
    Start[Start: Choose Configuration] --&gt; DataSize{Dataset Size?}
    
    DataSize --&gt;|&lt; 10 GB| Small[Small Dataset]
    DataSize --&gt;|10-100 GB| Medium[Medium Dataset]
    DataSize --&gt;|&gt; 100 GB| Large[Large Dataset]
    
    Small --&gt; SmallMem{Available RAM?}
    SmallMem --&gt;|&gt; 16 GB| SmallConfig[k=2, q=1&lt;br/&gt;threads=4]
    SmallMem --&gt;|&lt; 16 GB| SmallConfigMem[k=4, q=1&lt;br/&gt;threads=2]
    
    Medium --&gt; MediumMem{Available RAM?}
    MediumMem --&gt;|&gt; 32 GB| MediumConfig[k=4, q=1&lt;br/&gt;threads=8]
    MediumMem --&gt;|16-32 GB| MediumConfigMed[k=8, q=1&lt;br/&gt;threads=4]
    MediumMem --&gt;|&lt; 16 GB| MediumConfigLow[k=16, q=2&lt;br/&gt;threads=2]
    
    Large --&gt; LargeMem{Available RAM?}
    LargeMem --&gt;|&gt; 64 GB| LargeConfig[k=8, q=2&lt;br/&gt;threads=8]
    LargeMem --&gt;|&lt; 64 GB| LargeConfigMem[k=32, q=2&lt;br/&gt;threads=4]
    
    SmallConfig --&gt; Profile[Profile &amp; Tune Iteratively]
    SmallConfigMem --&gt; Profile
    MediumConfig --&gt; Profile
    MediumConfigMed --&gt; Profile
    MediumConfigLow --&gt; Profile
    LargeConfig --&gt; Profile
    LargeConfigMem --&gt; Profile
    
    style Start fill:#f0f8ff
    style Profile fill:#e8f6e8
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<p><strong>How to use this tree:</strong></p>
<p>Start by estimating your dataset size in GB: <code>(rows × cols × 8 bytes) / (1024^3)</code>. Then follow the tree based on your available RAM. The resulting k, q, and threads values are starting points—safe configurations unlikely to crash but not necessarily optimal. After establishing this baseline, profile to identify bottlenecks and tune iteratively.</p>
<p>For example, if you have a 50GB dataset and 32GB RAM, the tree suggests k=8, q=1, threads=8. This configuration splits data into 8 blocks (each ~6.25GB), processes in a single hierarchy level, and uses 8 threads. Peak memory usage will be roughly 8-10GB (safe for 32GB RAM), and 8 threads should parallelize well on modern CPUs. But your specific data might benefit from k=4 (fewer blocks, faster) or k=16 (more blocks if memory pressure appears). The tree gets you started; profiling reveals improvements.</p>
<hr>
</section>
<section id="key-parameters-deep-dive" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="key-parameters-deep-dive"><span class="header-section-number">4</span> Key Parameters Deep Dive</h2>
<section id="block-size-the-k-parameter" class="level3" data-number="4.1">
<h3 data-number="4.1" class="anchored" data-anchor-id="block-size-the-k-parameter"><span class="header-section-number">4.1</span> Block Size: The k Parameter</h3>
<p>The k parameter fundamentally controls BigDataStatMeth’s memory-speed tradeoff. Understanding k deeply helps you tune confidently.</p>
<p><strong>What k does mechanically:</strong> For a matrix with n rows, setting k=4 creates 4 blocks of approximately n/4 rows each (the last block may be slightly larger if n doesn’t divide evenly). Each block is processed sequentially or in parallel depending on the operation. Results from blocks are combined—summed, stacked, or merged—to produce final output.</p>
<p><strong>Memory impact:</strong> Peak memory usage equals approximately the size of the largest block plus overhead for intermediate results. If your matrix is 100,000 rows × 20,000 columns (16GB), setting k=4 creates blocks of ~25,000 × 20,000 (4GB each). Peak usage will be roughly 5-6GB (one block + overhead). Doubling k to 8 halves block size to 2GB and reduces peak memory to 3-4GB. This linear relationship makes memory management straightforward: if hitting memory limits, double k.</p>
<p><strong>Speed impact:</strong> More blocks mean more operations. Consider matrix multiplication: A × B with A split into 4 blocks requires 4 block multiplications then combining results. With 8 blocks, you need 8 block multiplications. Pure computation time increases roughly linearly with k. But I/O time (reading from HDF5, writing results) also increases—more blocks mean more separate read/write operations, each with overhead. For operations where I/O dominates (simple additions, subtractions), doubling k might increase total time by 80-100%. For computation-heavy operations (SVD, matrix inversion), time increases by 20-40%.</p>
<p><strong>Choosing k strategically:</strong></p>
<p>Start with this formula:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate reasonable k based on available memory</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>dataset_size_gb <span class="ot">&lt;-</span> (n_rows <span class="sc">*</span> n_cols <span class="sc">*</span> <span class="dv">8</span>) <span class="sc">/</span> (<span class="dv">1024</span><span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>available_gb <span class="ot">&lt;-</span> <span class="dv">16</span>  <span class="co"># Your available RAM</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>safety_factor <span class="ot">&lt;-</span> <span class="fl">0.7</span>  <span class="co"># Use 70% of available RAM (headroom for overhead)</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>k_minimum <span class="ot">&lt;-</span> <span class="fu">ceiling</span>(dataset_size_gb <span class="sc">/</span> (available_gb <span class="sc">*</span> safety_factor))</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>k_safe <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="dv">2</span>, k_minimum)  <span class="co"># Never use k=1 (no blocking benefits)</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Recommended k:"</span>, k_safe, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>This formula ensures your blocks fit comfortably in memory. But you might adjust:</p>
<ul>
<li><strong>If memory is abundant:</strong> Reduce k below the calculated value for speed</li>
<li><strong>If computation is very slow:</strong> Try k/2 to reduce overhead (if memory allows)</li>
<li><strong>If memory pressure appears:</strong> Increase k to provide more headroom</li>
<li><strong>If using many threads:</strong> Ensure k ≥ threads (otherwise threads sit idle)</li>
</ul>
<p><strong>Guidelines by use case:</strong></p>
<table class="caption-top table">
<colgroup>
<col style="width: 27%">
<col style="width: 41%">
<col style="width: 30%">
</colgroup>
<thead>
<tr class="header">
<th>Scenario</th>
<th>Recommended k</th>
<th>Reasoning</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Exploratory analysis, abundant RAM</td>
<td>k = 2-4</td>
<td>Minimize overhead, iterate quickly</td>
</tr>
<tr class="even">
<td>Production analysis, moderate RAM</td>
<td>k = 8-16</td>
<td>Balance memory safety and speed</td>
</tr>
<tr class="odd">
<td>Memory-constrained server</td>
<td>k = 16-32</td>
<td>Guarantee successful completion</td>
</tr>
<tr class="even">
<td>Repeated analysis on same data</td>
<td>k = 4-8</td>
<td>Moderate value, tune based on profiling</td>
</tr>
</tbody>
</table>
<p>Remember: these are starting points. Profile your actual workflow to find your optimal k.</p>
</section>
<section id="hierarchy-levels-the-q-parameter" class="level3" data-number="4.2">
<h3 data-number="4.2" class="anchored" data-anchor-id="hierarchy-levels-the-q-parameter"><span class="header-section-number">4.2</span> Hierarchy Levels: The q Parameter</h3>
<p>The q parameter controls hierarchy depth in multi-level algorithms, primarily block-wise SVD. Understanding when hierarchy helps requires grasping how block results combine.</p>
<p><strong>Single-level (q=1) approach:</strong> Compute SVD on each of k blocks independently, producing k sets of singular vectors. Then combine all k results simultaneously—stack the k vectors, compute SVD of the combined matrix. This final SVD operates on a k×p matrix where p is the number of retained components. For k=8 and p=50, the final SVD processes an 8×50 matrix—tiny, fast.</p>
<p><strong>Two-level (q=2) approach:</strong> Compute SVD on each of k blocks (first level). Group results into pairs or quadruplets, compute SVD on each group (second level). Finally, combine group results (top level). For k=16, first level produces 16 results, second level combines these into 4 intermediate results, top level combines those 4 into final output.</p>
<p><strong>When does hierarchy help?</strong></p>
<p>Hierarchy reduces peak memory during combination. With q=1 and k=32, combining 32 results simultaneously might require substantial memory—allocating arrays for 32 matrices, stacking them, computing SVD. With q=2, you combine 32 results in groups of 4 (8 groups), then combine 8 intermediate results—peak memory is lower because you never hold all 32 original results simultaneously.</p>
<p>The cost: more intermediate operations. Two-level hierarchy does roughly 1.3-1.5× as much computation as single-level. Three-level increases this to 1.5-2×. Unless memory-constrained, extra computation isn’t worthwhile.</p>
<p><strong>Decision guide:</strong></p>
<ul>
<li><strong>q=1:</strong> Default for k ≤ 8, or when memory isn’t limiting</li>
<li><strong>q=2:</strong> Use when k &gt; 8 AND memory is tight (less than 2× block size available)</li>
<li><strong>q&gt;2:</strong> Rarely needed; only for extreme cases with k &gt; 32 and severe memory limits</li>
</ul>
<p>Example decision: You have k=16 blocks and 16GB RAM. Each block uses ~3GB. With q=1, combining 16 results needs perhaps 6GB peak (manageable). With q=2, peak is ~4GB (safer but slower). If your system has 32GB RAM, q=1 is fine—extra headroom makes hierarchy unnecessary. If RAM is exactly 16GB and other processes use 8GB, q=2 provides safety margin.</p>
</section>
<section id="thread-count-parallel-processing" class="level3" data-number="4.3">
<h3 data-number="4.3" class="anchored" data-anchor-id="thread-count-parallel-processing"><span class="header-section-number">4.3</span> Thread Count: Parallel Processing</h3>
<p>Threading enables processing multiple blocks simultaneously, dramatically reducing wall-clock time. But effective threading requires understanding both software parallelism and hardware limitations.</p>
<p><strong>How BigDataStatMeth uses threads:</strong> When you specify threads=4, eligible operations distribute work across 4 CPU cores. For block-wise operations, different blocks compute in parallel—while core 1 processes block 1, core 2 handles block 2, etc. For matrix operations using BLAS/LAPACK (multiplication, decompositions), underlying libraries may parallelize internally. Not all operations parallelize equally: some are inherently sequential, others embarrassingly parallel.</p>
<p><strong>Why more threads isn’t always better:</strong></p>
<p>This is crucial to understand. Adding threads only helps when:</p>
<ol type="1">
<li><strong>Operations are parallelizable:</strong> Sequential algorithms gain nothing from threads</li>
<li><strong>Enough independent work exists:</strong> With k=4 blocks and threads=8, 4 threads sit idle</li>
<li><strong>Computation dominates I/O:</strong> If most time is disk access, parallel computation doesn’t help</li>
<li><strong>Memory bandwidth suffices:</strong> Multiple cores reading simultaneously can saturate bandwidth</li>
<li><strong>CPU cores are available:</strong> Oversubscription (more threads than cores) causes thrashing</li>
</ol>
<p><strong>Understanding bottlenecks:</strong> Three fundamental bottlenecks limit threading efficiency:</p>
<p><strong>I/O Bottleneck:</strong> Hard drives (even SSDs) have finite bandwidth. If 4 threads each try to read 1GB/second from a disk with 2GB/second total bandwidth, they compete—each gets only 500MB/second. Adding more threads doesn’t increase total bandwidth; it just divides it further. This is why simple operations (addition, scaling) often show poor threading efficiency—computation is fast, but reading data from HDF5 is slow. All threads wait for I/O.</p>
<p><strong>Memory Bandwidth Bottleneck:</strong> Modern CPUs are fast, but RAM is comparatively slow. If 8 threads each try to read 8GB/second from RAM with 25GB/second total bandwidth, they get ~3GB/second each—less than needed. Memory-intensive operations (large matrix multiplications, cache-unfriendly access patterns) can saturate memory bandwidth. Adding more threads can actually slow things down by increasing cache misses and memory contention.</p>
<p><strong>Amdahl’s Law (Inherent Sequentiality):</strong> Some parts of algorithms cannot parallelize. If 20% of your computation is inherently sequential, maximum possible speedup is 5× regardless of thread count. With 4 threads, you might achieve 3.2× speedup (80% of theoretical maximum). With 8 threads, maybe 3.8× speedup—adding 4 threads gave only 0.6× improvement because sequential portions dominate.</p>
<p><strong>Measuring threading efficiency:</strong></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(microbenchmark)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Measure speedup with different thread counts</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>mb <span class="ot">&lt;-</span> <span class="fu">microbenchmark</span>(</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">t1 =</span> <span class="fu">bdSVD_hdf5</span>(<span class="st">"data.hdf5"</span>, <span class="st">"data"</span>, <span class="st">"matrix"</span>, <span class="at">k=</span><span class="dv">8</span>, <span class="at">threads=</span><span class="dv">1</span>),</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">t2 =</span> <span class="fu">bdSVD_hdf5</span>(<span class="st">"data.hdf5"</span>, <span class="st">"data"</span>, <span class="st">"matrix"</span>, <span class="at">k=</span><span class="dv">8</span>, <span class="at">threads=</span><span class="dv">2</span>),</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">t4 =</span> <span class="fu">bdSVD_hdf5</span>(<span class="st">"data.hdf5"</span>, <span class="st">"data"</span>, <span class="st">"matrix"</span>, <span class="at">k=</span><span class="dv">8</span>, <span class="at">threads=</span><span class="dv">4</span>),</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">t8 =</span> <span class="fu">bdSVD_hdf5</span>(<span class="st">"data.hdf5"</span>, <span class="st">"data"</span>, <span class="st">"matrix"</span>, <span class="at">k=</span><span class="dv">8</span>, <span class="at">threads=</span><span class="dv">8</span>),</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">times =</span> <span class="dv">3</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate speedup and efficiency</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>times <span class="ot">&lt;-</span> <span class="fu">summary</span>(mb)<span class="sc">$</span>median</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>speedup <span class="ot">&lt;-</span> times[<span class="dv">1</span>] <span class="sc">/</span> times</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>efficiency <span class="ot">&lt;-</span> speedup <span class="sc">/</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">8</span>)</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">data.frame</span>(</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">threads =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">8</span>),</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">time_sec =</span> <span class="fu">round</span>(times, <span class="dv">2</span>),</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">speedup =</span> <span class="fu">round</span>(speedup, <span class="dv">2</span>),</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">efficiency =</span> <span class="fu">round</span>(efficiency, <span class="dv">2</span>)</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong>Interpreting efficiency:</strong></p>
<ul>
<li><strong>90-100% efficiency:</strong> Ideal scaling, rare in practice</li>
<li><strong>70-90% efficiency:</strong> Excellent scaling, computation dominates</li>
<li><strong>50-70% efficiency:</strong> Good scaling, acceptable for most use cases</li>
<li><strong>30-50% efficiency:</strong> Moderate scaling, likely hitting I/O or memory bandwidth</li>
<li><strong>&lt;30% efficiency:</strong> Poor scaling, fundamental bottleneck exists</li>
</ul>
<p>If you see 4 threads achieving only 1.5× speedup (37% efficiency), investigate:</p>
<ul>
<li>Is operation I/O-heavy? (Check if system time &gt;&gt; user time)</li>
<li>Is memory bandwidth saturated? (Monitor with tools like <code>htop</code> or <code>iostat</code>)</li>
<li>Is BLAS library already parallel? (Check with <code>sessionInfo()</code>)</li>
<li>Are blocks too small? (Very small blocks have high overhead relative to computation)</li>
</ul>
<p><strong>Practical thread guidelines:</strong></p>
<table class="caption-top table">
<colgroup>
<col style="width: 27%">
<col style="width: 51%">
<col style="width: 21%">
</colgroup>
<thead>
<tr class="header">
<th>Hardware</th>
<th>Recommended Threads</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Laptop (4 cores)</td>
<td>threads = 2-4</td>
<td>Use all cores unless thermal throttling appears</td>
</tr>
<tr class="even">
<td>Workstation (8-16 cores)</td>
<td>threads = 4-8</td>
<td>Start with half, increase if efficiency good</td>
</tr>
<tr class="odd">
<td>Shared server (32+ cores)</td>
<td>threads = n_cores / n_users</td>
<td>Be considerate of others</td>
</tr>
<tr class="even">
<td>Cloud instance (variable)</td>
<td>threads = physical_cores</td>
<td>Avoid hyperthreads for consistency</td>
</tr>
<tr class="odd">
<td>High-memory, low-core</td>
<td>threads = n_cores</td>
<td>CPU-bound, use all available</td>
</tr>
</tbody>
</table>
<p><strong>BLAS library interaction:</strong></p>
<p>BigDataStatMeth uses BLAS/LAPACK for matrix operations. Some BLAS implementations (Intel MKL, OpenBLAS) are multi-threaded by default. If BLAS uses 4 threads and you specify threads=4, you may have 16 total threads (4 × 4), causing oversubscription.</p>
<p>Check BLAS configuration:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Look for BLAS/LAPACK implementation</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co"># If using OpenBLAS or MKL, they may be threaded</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Limit BLAS threads if needed (Linux/Mac)</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="fu">Sys.setenv</span>(<span class="at">OPENBLAS_NUM_THREADS =</span> <span class="dv">1</span>)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="fu">Sys.setenv</span>(<span class="at">MKL_NUM_THREADS =</span> <span class="dv">1</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>If BLAS is single-threaded (reference BLAS), BigDataStatMeth’s threading provides all parallelism. If BLAS is multi-threaded, consider reducing BigDataStatMeth threads to avoid oversubscription.</p>
</section>
<section id="hdf5-chunk-size" class="level3" data-number="4.4">
<h3 data-number="4.4" class="anchored" data-anchor-id="hdf5-chunk-size"><span class="header-section-number">4.4</span> HDF5 Chunk Size</h3>
<p>HDF5 stores data in chunks—contiguous blocks on disk. Chunk size dramatically affects I/O performance but is set when creating datasets, not when computing. If you control dataset creation (via <code>bdCreate_hdf5_matrix</code>), chunk size becomes a key optimization lever.</p>
<p><strong>How chunking affects I/O:</strong> When you read a single element from HDF5, the entire chunk containing it loads into memory. Read 100 elements scattered across 100 different chunks, and HDF5 performs 100 disk seeks, loading 100 chunks. Read 100 elements all in one chunk, and HDF5 performs 1 disk seek, loading 1 chunk. Sequential access to well-chunked data is fast; random access to poorly-chunked data is slow.</p>
<p><strong>BigDataStatMeth access patterns:</strong></p>
<p>Most BigDataStatMeth operations access data in rectangular blocks—reading several rows and all columns, or all rows and several columns. Optimal chunking aligns chunks with typical access blocks.</p>
<ul>
<li><strong>Row-wise operations</strong> (processing samples): Chunk by rows. If reading 1,000 rows at a time, chunk size ~1,000 rows × all columns</li>
<li><strong>Column-wise operations</strong> (processing features): Chunk by columns. If reading 100 columns at a time, chunk size ~all rows × 100 columns</li>
<li><strong>Block operations</strong> (typical for BigDataStatMeth): Square-ish chunks work well. For 100,000 × 10,000 matrix read in blocks of 10,000 × 10,000, use 10,000 × 10,000 chunks</li>
</ul>
<p><strong>Chunk size guidelines:</strong></p>
<ol type="1">
<li><p><strong>Target 1-10 MB chunks:</strong> Very small chunks (&lt;100 KB) have excessive overhead. Very large chunks (&gt;100 MB) waste space and time loading unused data.</p></li>
<li><p><strong>Match access pattern:</strong> If you always read full rows, make chunks span full rows. If you read columns, span full columns.</p></li>
<li><p><strong>Consider compression:</strong> Larger chunks compress better (more data for compression algorithms to find patterns). If using compression, prefer larger chunks (5-10 MB).</p></li>
<li><p><strong>Balance with cache:</strong> Chunks should fit comfortably in CPU cache (L3 cache often 8-16 MB). Chunks larger than cache cause cache thrashing.</p></li>
</ol>
<p><strong>Example chunking decisions:</strong></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Genomics: 50,000 samples × 500,000 SNPs</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Typical access: process 5,000 samples at a time (row-wise)</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">bdCreate_hdf5_matrix</span>(</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> <span class="st">"genomics.hdf5"</span>,</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">object =</span> genotype_matrix,</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">group =</span> <span class="st">"data"</span>,</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">dataset =</span> <span class="st">"snps"</span>,</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">chunk_rows =</span> <span class="dv">5000</span>,      <span class="co"># Matches block size</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">chunk_cols =</span> <span class="dv">500000</span>     <span class="co"># All columns</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Gene expression: 100 samples × 20,000 genes</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Typical access: analyze all samples for subset of genes (column-wise)</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="fu">bdCreate_hdf5_matrix</span>(</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> <span class="st">"expression.hdf5"</span>,</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">object =</span> expression_matrix,</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">group =</span> <span class="st">"data"</span>,</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">dataset =</span> <span class="st">"genes"</span>,</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">chunk_rows =</span> <span class="dv">100</span>,       <span class="co"># All samples</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">chunk_cols =</span> <span class="dv">2000</span>       <span class="co"># ~10 chunks column-wise</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a><span class="co"># General matrix: 10,000 × 10,000</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Typical access: square blocks</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a><span class="fu">bdCreate_hdf5_matrix</span>(</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> <span class="st">"matrix.hdf5"</span>,</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">object =</span> large_matrix,</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">group =</span> <span class="st">"data"</span>,</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">dataset =</span> <span class="st">"values"</span>,</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">chunk_rows =</span> <span class="dv">1000</span>,      <span class="co"># Square chunks</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">chunk_cols =</span> <span class="dv">1000</span>       <span class="co"># ~100 total chunks</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong>When chunk size matters most:</strong></p>
<ul>
<li>Very large datasets (&gt;10 GB) where I/O is significant fraction of time</li>
<li>Repeated access to same data (poor chunking penalizes every access)</li>
<li>Network storage (NFS, cloud) where disk seeks are expensive</li>
<li>Compression enabled (larger chunks compress better)</li>
</ul>
<p><strong>When chunk size matters less:</strong></p>
<ul>
<li>Small datasets (&lt;1 GB) that fit entirely in cache</li>
<li>Single-pass operations (read once, compute, done)</li>
<li>Local SSD storage where seeks are cheap</li>
<li>Computation-heavy operations where I/O is &lt;10% of time</li>
</ul>
<p>If profiling shows system time (I/O) is &gt;30% of elapsed time, investigate chunking. Otherwise, default chunking is likely fine.</p>
<hr>
</section>
</section>
<section id="profiling-finding-the-bottleneck" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="profiling-finding-the-bottleneck"><span class="header-section-number">5</span> Profiling: Finding the Bottleneck</h2>
<p>Before optimizing, you must identify where time actually goes. Optimizing the wrong part of your code wastes effort and provides minimal benefit. Profiling reveals the truth.</p>
<section id="why-profile-first" class="level3" data-number="5.1">
<h3 data-number="5.1" class="anchored" data-anchor-id="why-profile-first"><span class="header-section-number">5.1</span> Why Profile First</h3>
<p>Intuition about bottlenecks is often wrong. You might assume SVD computation dominates, but profiling reveals 60% of time is normalization. You might think I/O is the problem, but profiling shows memory allocation overhead. Without measurement, optimization is guesswork.</p>
<p>The profiling workflow:</p>
<ol type="1">
<li><strong>Establish baseline:</strong> Run with conservative parameters, measure total time</li>
<li><strong>Profile:</strong> Identify which operations consume time</li>
<li><strong>Prioritize:</strong> Focus on operations using &gt;20% of total time</li>
<li><strong>Optimize:</strong> Tune those specific operations</li>
<li><strong>Verify:</strong> Ensure optimization helped and results remain correct</li>
<li><strong>Repeat:</strong> Profile again to find next bottleneck</li>
</ol>
</section>
<section id="basic-timing-with-system.time" class="level3" data-number="5.2">
<h3 data-number="5.2" class="anchored" data-anchor-id="basic-timing-with-system.time"><span class="header-section-number">5.2</span> Basic Timing with system.time()</h3>
<p>The simplest profiling tool is <code>system.time()</code>:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>timing <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">bdPCA_hdf5</span>(</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> <span class="st">"genomics.hdf5"</span>,</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"data"</span>,</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">dataset =</span> <span class="st">"genotypes"</span>,</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">k =</span> <span class="dv">8</span>,</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">q =</span> <span class="dv">1</span>,</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">threads =</span> <span class="dv">4</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(timing)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="co">#    user  system elapsed </span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="co">#  45.231   2.109  12.847</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong>Interpreting the output:</strong></p>
<ul>
<li><p><strong>user:</strong> CPU time spent in R code and user-level functions. This is “computation time”—the sum of all CPU time across all threads. With 4 threads, user time can exceed elapsed time (4 threads × 10 seconds = 40 seconds user time in 10 seconds elapsed).</p></li>
<li><p><strong>system:</strong> CPU time spent in system calls—primarily I/O (reading/writing files), memory allocation, and inter-process communication. High system time indicates I/O or memory management overhead.</p></li>
<li><p><strong>elapsed:</strong> Wall-clock time—what you experience. This is total time from start to finish, regardless of threading.</p></li>
</ul>
<p><strong>Common patterns and what they mean:</strong></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Pattern 1: user &gt;&gt; elapsed (e.g., user=45, elapsed=13)</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Good parallelization! 4 threads did 45 seconds of work in 13 seconds</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Speedup: 45/13 = 3.46× with 4 threads (87% efficiency)</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Pattern 2: system high (e.g., user=20, system=15, elapsed=35)</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="co"># I/O bottleneck! System time (15s) is 43% of elapsed time</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Solution: Optimize HDF5 chunk size, use faster storage, or cache data</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Pattern 3: elapsed &gt;&gt; user + system (e.g., user=10, system=2, elapsed=40)</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Waiting for something! CPU idle most of the time</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Possible causes: disk very slow, network storage, memory swapping</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Check: iostat, iotop, or system monitor during execution</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Pattern 4: user ≈ elapsed, threads=4 (e.g., user=15, elapsed=14)</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="co"># No parallelization benefit! Work is sequential or I/O-bound</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Solution: Reduce threads (they're not helping), optimize sequential portions</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="detailed-profiling-with-rprof" class="level3" data-number="5.3">
<h3 data-number="5.3" class="anchored" data-anchor-id="detailed-profiling-with-rprof"><span class="header-section-number">5.3</span> Detailed Profiling with Rprof()</h3>
<p>For deeper insight, use <code>Rprof()</code> to identify which specific functions consume time:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Start profiling</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">Rprof</span>(<span class="st">"pca_profile.out"</span>, <span class="at">memory.profiling =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Run your analysis</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">bdPCA_hdf5</span>(</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> <span class="st">"large_data.hdf5"</span>,</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">group =</span> <span class="st">"data"</span>,</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">dataset =</span> <span class="st">"matrix"</span>,</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">k =</span> <span class="dv">16</span>,</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">q =</span> <span class="dv">2</span>,</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">threads =</span> <span class="dv">8</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Stop profiling</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="fu">Rprof</span>(<span class="cn">NULL</span>)</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Analyze results</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>profile_summary <span class="ot">&lt;-</span> <span class="fu">summaryRprof</span>(<span class="st">"pca_profile.out"</span>)</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Print time spent in each function</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(profile_summary<span class="sc">$</span>by.self)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong>Example output and interpretation:</strong></p>
<pre><code>           self.time self.pct total.time total.pct
bdSVD_hdf5      24.5     48.5       35.2      69.8
bdNormalize     12.3     24.4       12.8      25.4
h5read           8.2     16.3        8.2      16.3
crossprod        3.1      6.1        3.1       6.1</code></pre>
<p>This output tells a clear story:</p>
<ul>
<li><strong>bdSVD_hdf5 (48.5% self time):</strong> SVD computation dominates—this is the primary optimization target</li>
<li><strong>bdNormalize (24.4% self time):</strong> Normalization takes 1/4 of total time—consider pre-normalizing if running multiple analyses</li>
<li><strong>h5read (16.3% self time):</strong> I/O is significant but not dominant—chunking optimization might help but won’t transform performance</li>
<li><strong>crossprod (6.1% self time):</strong> Minor contributor—optimizing this won’t noticeably improve total time</li>
</ul>
<p><strong>Memory profiling insights:</strong></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Memory allocation by function</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(profile_summary<span class="sc">$</span>by.total[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="fu">c</span>(<span class="st">"total.time"</span>, <span class="st">"mem.total"</span>)])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Shows which functions allocate most memory. High memory allocation indicates where increasing k (more blocks) would help most.</p>
</section>
<section id="visual-profiling-with-profvis" class="level3" data-number="5.4">
<h3 data-number="5.4" class="anchored" data-anchor-id="visual-profiling-with-profvis"><span class="header-section-number">5.4</span> Visual Profiling with profvis</h3>
<p>For interactive exploration, <code>profvis</code> provides flamegraphs showing time distribution visually:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(profvis)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="fu">profvis</span>({</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bdSVD_hdf5</span>(</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> <span class="st">"data.hdf5"</span>,</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"data"</span>,</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">dataset =</span> <span class="st">"matrix"</span>,</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">k =</span> <span class="dv">8</span>,</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">threads =</span> <span class="dv">4</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>The interactive visualization shows:</p>
<ul>
<li><strong>Horizontal axis:</strong> Time from start to finish</li>
<li><strong>Vertical axis:</strong> Call stack (functions calling functions)</li>
<li><strong>Width of bars:</strong> Time spent in each function</li>
<li><strong>Colors:</strong> Different colors for different code sections</li>
</ul>
<p>Click on bars to zoom in, hover to see details. Look for:</p>
<ul>
<li><strong>Wide bars:</strong> Functions consuming significant time (optimization targets)</li>
<li><strong>Deep stacks:</strong> Many nested function calls (potential overhead)</li>
<li><strong>Memory spikes:</strong> Sudden memory allocations (candidates for blocking)</li>
</ul>
<hr>
</section>
</section>
<section id="optimization-workflows" class="level2" data-number="6">
<h2 data-number="6" class="anchored" data-anchor-id="optimization-workflows"><span class="header-section-number">6</span> Optimization Workflows</h2>
<p>Different bottlenecks require different optimization strategies. These workflows guide you through systematic tuning.</p>
<section id="memory-constrained-environment" class="level3" data-number="6.1">
<h3 data-number="6.1" class="anchored" data-anchor-id="memory-constrained-environment"><span class="header-section-number">6.1</span> Memory-Constrained Environment</h3>
<p><strong>Symptoms you’re memory-constrained:</strong></p>
<ul>
<li>Frequent swapping (system very slow, disk activity constant)</li>
<li>“Cannot allocate vector of size X” errors</li>
<li>R crashes with memory-related errors</li>
<li>System monitor shows RAM usage at 95-100%</li>
</ul>
<p><strong>The optimization strategy:</strong></p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">flowchart TD
    A[Memory Issues Detected] --&gt; B[Increase k by 2x]
    B --&gt; C{Issues resolved?}
    C --&gt;|Yes| H[Success: Monitor future runs]
    C --&gt;|No| D[Add hierarchy: q=2]
    D --&gt; E{Issues resolved?}
    E --&gt;|Yes| H
    E --&gt;|No| F[Reduce threads by half]
    F --&gt; G{Issues resolved?}
    G --&gt;|Yes| H
    G --&gt;|No| I[Process in stages OR&lt;br/&gt;upgrade hardware]
    
    style A fill:#ffe8e8
    style H fill:#e8f6e8
    style I fill:#fff8e1
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<p><strong>Step-by-step implementation:</strong></p>
<p><strong>Step 1: Increase block count (k)</strong></p>
<p>Doubling k halves memory usage. If currently using k=4 and hitting memory limits, try k=8:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Original configuration (memory issues)</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">bdPCA_hdf5</span>(</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> <span class="st">"large_data.hdf5"</span>,</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">group =</span> <span class="st">"data"</span>,</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">dataset =</span> <span class="st">"matrix"</span>,</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">k =</span> <span class="dv">4</span>,</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">q =</span> <span class="dv">1</span>,</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">threads =</span> <span class="dv">4</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Error or very slow due to swapping</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Optimized: Double k</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">bdPCA_hdf5</span>(</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> <span class="st">"large_data.hdf5"</span>,</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">group =</span> <span class="st">"data"</span>,</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">dataset =</span> <span class="st">"matrix"</span>,</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">k =</span> <span class="dv">8</span>,    <span class="co"># Doubled</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">q =</span> <span class="dv">1</span>,</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">threads =</span> <span class="dv">4</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Should complete successfully, though slower</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong>Step 2: Add hierarchy if still problematic</strong></p>
<p>If k=8 still causes issues, add q=2 to reduce peak memory during combination:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">bdPCA_hdf5</span>(</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> <span class="st">"large_data.hdf5"</span>,</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">group =</span> <span class="st">"data"</span>,</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">dataset =</span> <span class="st">"matrix"</span>,</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">k =</span> <span class="dv">8</span>,</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">q =</span> <span class="dv">2</span>,    <span class="co"># Added hierarchy</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">threads =</span> <span class="dv">4</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong>Step 3: Reduce threading if memory pressure persists</strong></p>
<p>More threads means more blocks loaded simultaneously. Reducing threads decreases parallel memory pressure:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">bdPCA_hdf5</span>(</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> <span class="st">"large_data.hdf5"</span>,</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">group =</span> <span class="st">"data"</span>,</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">dataset =</span> <span class="st">"matrix"</span>,</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">k =</span> <span class="dv">8</span>,</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">q =</span> <span class="dv">2</span>,</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">threads =</span> <span class="dv">2</span>    <span class="co"># Reduced from 4</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong>Step 4: Process in stages</strong></p>
<p>If still problematic, break analysis into smaller stages, writing intermediate results to HDF5:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Stage 1: Normalize (writes to HDF5)</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">bdNormalize_hdf5</span>(</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> <span class="st">"large_data.hdf5"</span>,</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">group =</span> <span class="st">"data"</span>,</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">dataset =</span> <span class="st">"matrix"</span>,</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">bcenter =</span> <span class="cn">TRUE</span>,</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">bscale =</span> <span class="cn">FALSE</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Stage 2: QR decomposition (done internally, writes to HDF5)</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Stage 3: SVD on reduced data (smaller working set)</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">bdPCA_hdf5</span>(</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> <span class="st">"large_data.hdf5"</span>,</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">group =</span> <span class="st">"NORMALIZED/data"</span>,</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">dataset =</span> <span class="st">"matrix"</span>,</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">bcenter =</span> <span class="cn">FALSE</span>,  <span class="co"># Already normalized</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">bscale =</span> <span class="cn">FALSE</span>,</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">k =</span> <span class="dv">8</span>,</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">q =</span> <span class="dv">2</span>,</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">threads =</span> <span class="dv">2</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Each stage has smaller peak memory than attempting everything at once.</p>
</section>
<section id="speed-constrained-environment" class="level3" data-number="6.2">
<h3 data-number="6.2" class="anchored" data-anchor-id="speed-constrained-environment"><span class="header-section-number">6.2</span> Speed-Constrained Environment</h3>
<p><strong>Symptoms you’re speed-constrained:</strong></p>
<ul>
<li>Computation takes too long for your workflow</li>
<li>Memory usage is well below capacity (30-50% of available RAM)</li>
<li>Waiting for results interrupts iterative analysis</li>
<li>System monitor shows RAM available but computation slow</li>
</ul>
<p><strong>The optimization strategy:</strong></p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">flowchart TD
    A[Speed Issues Detected] --&gt; B[Check memory usage]
    B --&gt; C{RAM &lt; 70% used?}
    C --&gt;|Yes| D[Decrease k by half]
    D --&gt; E{Faster?}
    E --&gt;|Yes| F[Increase threads]
    F --&gt; G{Faster?}
    G --&gt;|Yes| J[Optimize HDF5 chunking]
    C --&gt;|No| H[Memory limiting speed&lt;br/&gt;Use balanced approach]
    E --&gt;|No| I[Check I/O bottleneck]
    G --&gt;|No| K[Check parallelization limits]
    J --&gt; L[Success: Optimal configuration]
    
    style A fill:#fff8e1
    style L fill:#e8f6e8
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<p><strong>Step-by-step implementation:</strong></p>
<p><strong>Step 1: Reduce block count if memory allows</strong></p>
<p>Fewer blocks mean less overhead. If memory usage is low, try reducing k:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Current: Slow but plenty of RAM available</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">bdPCA_hdf5</span>(<span class="st">"data.hdf5"</span>, <span class="st">"data"</span>, <span class="st">"matrix"</span>, </span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>                     <span class="at">k=</span><span class="dv">8</span>, <span class="at">threads=</span><span class="dv">4</span>)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Elapsed: 45 seconds, RAM usage: 8GB / 32GB available</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Optimized: Fewer blocks</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">bdPCA_hdf5</span>(<span class="st">"data.hdf5"</span>, <span class="st">"data"</span>, <span class="st">"matrix"</span>,</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>                     <span class="at">k=</span><span class="dv">4</span>, <span class="at">threads=</span><span class="dv">4</span>)  <span class="co"># Halved k</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Elapsed: 28 seconds (38% faster)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong>Step 2: Increase thread count</strong></p>
<p>More threads reduce wall-clock time for parallelizable operations:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check available cores</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>n_cores <span class="ot">&lt;-</span> parallel<span class="sc">::</span><span class="fu">detectCores</span>()</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Available cores:"</span>, n_cores, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Use more threads</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">bdPCA_hdf5</span>(<span class="st">"data.hdf5"</span>, <span class="st">"data"</span>, <span class="st">"matrix"</span>,</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>                     <span class="at">k=</span><span class="dv">4</span>, <span class="at">threads=</span>n_cores)</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Measure speedup vs fewer threads</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Monitor efficiency—if adding threads provides minimal speedup, you’ve hit a bottleneck (I/O, memory bandwidth, or Amdahl’s law).</p>
<p><strong>Step 3: Pre-normalize data</strong></p>
<p>If running multiple analyses on the same data, normalize once and reuse:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Normalize once</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">bdNormalize_hdf5</span>(<span class="st">"data.hdf5"</span>, <span class="st">"data"</span>, <span class="st">"matrix"</span>,</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">bcenter=</span><span class="cn">TRUE</span>, <span class="at">bscale=</span><span class="cn">FALSE</span>)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Run analyses without re-normalizing</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (param <span class="cf">in</span> parameter_grid) {</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">bdPCA_hdf5</span>(</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> <span class="st">"data.hdf5"</span>,</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"NORMALIZED/data"</span>,</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">dataset =</span> <span class="st">"matrix"</span>,</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">bcenter =</span> <span class="cn">FALSE</span>,  <span class="co"># Skip normalization</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">bscale =</span> <span class="cn">FALSE</span>,</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">k =</span> <span class="dv">4</span>,</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">threads =</span> <span class="dv">8</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Other parameters vary</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Process result</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>This eliminates redundant normalization across runs, saving 20-40% of time in iterative workflows.</p>
<p><strong>Step 4: Optimize HDF5 chunk size</strong></p>
<p>If profiling shows significant I/O time, recreate dataset with optimal chunking:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Read existing data</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>original_data <span class="ot">&lt;-</span> <span class="fu">h5read</span>(<span class="st">"data.hdf5"</span>, <span class="st">"data/matrix"</span>)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Recreate with optimized chunks</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="fu">bdCreate_hdf5_matrix</span>(</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> <span class="st">"data_optimized.hdf5"</span>,</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">object =</span> original_data,</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">group =</span> <span class="st">"data"</span>,</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">dataset =</span> <span class="st">"matrix"</span>,</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">chunk_rows =</span> <span class="fu">nrow</span>(original_data) <span class="sc">/</span> <span class="dv">4</span>,  <span class="co"># Match k=4</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">chunk_cols =</span> <span class="fu">ncol</span>(original_data),</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">compression =</span> <span class="dv">0</span>  <span class="co"># Disable compression for max speed</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Use optimized dataset</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">bdPCA_hdf5</span>(<span class="st">"data_optimized.hdf5"</span>, <span class="st">"data"</span>, <span class="st">"matrix"</span>,</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>                     <span class="at">k=</span><span class="dv">4</span>, <span class="at">threads=</span><span class="dv">8</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Optimal chunking can reduce I/O time by 50-80% for I/O-heavy operations.</p>
</section>
<section id="balanced-optimization-iterative-tuning" class="level3" data-number="6.3">
<h3 data-number="6.3" class="anchored" data-anchor-id="balanced-optimization-iterative-tuning"><span class="header-section-number">6.3</span> Balanced Optimization: Iterative Tuning</h3>
<p>When neither memory nor speed is catastrophically limiting, tune iteratively to find the sweet spot:</p>
<p><strong>Phase 1: Establish baseline</strong></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Conservative configuration (guaranteed to work)</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Testing baseline configuration...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>baseline_time <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  baseline_result <span class="ot">&lt;-</span> <span class="fu">bdPCA_hdf5</span>(</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> <span class="st">"data.hdf5"</span>,</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"data"</span>,</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">dataset =</span> <span class="st">"matrix"</span>,</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">k =</span> <span class="dv">8</span>,</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">q =</span> <span class="dv">1</span>,</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">threads =</span> <span class="dv">2</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Baseline time:"</span>, baseline_time[<span class="st">"elapsed"</span>], <span class="st">"seconds</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Peak memory: Check system monitor</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong>Phase 2: Test reduced blocking</strong></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Testing k=4 (fewer blocks)...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>test1_time <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  test1_result <span class="ot">&lt;-</span> <span class="fu">bdPCA_hdf5</span>(</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> <span class="st">"data.hdf5"</span>,</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"data"</span>,</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">dataset =</span> <span class="st">"matrix"</span>,</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">k =</span> <span class="dv">4</span>,  <span class="co"># Halved</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">q =</span> <span class="dv">1</span>,</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">threads =</span> <span class="dv">2</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>improvement1 <span class="ot">&lt;-</span> (baseline_time[<span class="st">"elapsed"</span>] <span class="sc">-</span> test1_time[<span class="st">"elapsed"</span>]) <span class="sc">/</span> </span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>                baseline_time[<span class="st">"elapsed"</span>] <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"k=4 time:"</span>, test1_time[<span class="st">"elapsed"</span>], <span class="st">"seconds</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Improvement:"</span>, <span class="fu">round</span>(improvement1, <span class="dv">1</span>), <span class="st">"%</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong>Phase 3: Test increased threading</strong></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Testing threads=4 (more parallelism)...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>test2_time <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  test2_result <span class="ot">&lt;-</span> <span class="fu">bdPCA_hdf5</span>(</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> <span class="st">"data.hdf5"</span>,</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"data"</span>,</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">dataset =</span> <span class="st">"matrix"</span>,</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">k =</span> <span class="dv">4</span>,</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">q =</span> <span class="dv">1</span>,</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">threads =</span> <span class="dv">4</span>  <span class="co"># Doubled</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>improvement2 <span class="ot">&lt;-</span> (test1_time[<span class="st">"elapsed"</span>] <span class="sc">-</span> test2_time[<span class="st">"elapsed"</span>]) <span class="sc">/</span> </span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>                test1_time[<span class="st">"elapsed"</span>] <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"threads=4 time:"</span>, test2_time[<span class="st">"elapsed"</span>], <span class="st">"seconds</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Additional improvement:"</span>, <span class="fu">round</span>(improvement2, <span class="dv">1</span>), <span class="st">"%</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong>Phase 4: Verify and select</strong></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify results match baseline</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Verifying correctness...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="fu">all.equal</span>(</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  baseline_result<span class="sc">$</span>components[,<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>],</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  test2_result<span class="sc">$</span>components[,<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>],</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">tolerance =</span> <span class="fl">1e-10</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Choose best configuration</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>configurations <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">config =</span> <span class="fu">c</span>(<span class="st">"Baseline"</span>, <span class="st">"k=4"</span>, <span class="st">"k=4,t=4"</span>),</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">time =</span> <span class="fu">c</span>(baseline_time[<span class="st">"elapsed"</span>], </span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>           test1_time[<span class="st">"elapsed"</span>],</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>           test2_time[<span class="st">"elapsed"</span>]),</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">speedup =</span> <span class="fu">c</span>(<span class="fl">1.0</span>,</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>              baseline_time[<span class="st">"elapsed"</span>] <span class="sc">/</span> test1_time[<span class="st">"elapsed"</span>],</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>              baseline_time[<span class="st">"elapsed"</span>] <span class="sc">/</span> test2_time[<span class="st">"elapsed"</span>])</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(configurations)</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Recommended configuration: k=4, threads=4</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>This systematic approach finds good configurations without exhaustive testing.</p>
<hr>
</section>
</section>
<section id="common-performance-pitfalls" class="level2" data-number="7">
<h2 data-number="7" class="anchored" data-anchor-id="common-performance-pitfalls"><span class="header-section-number">7</span> Common Performance Pitfalls</h2>
<p>Experience reveals recurring mistakes that degrade performance. Recognizing these patterns helps you avoid them.</p>
<section id="pitfall-1-excessive-blocking" class="level3" data-number="7.1">
<h3 data-number="7.1" class="anchored" data-anchor-id="pitfall-1-excessive-blocking"><span class="header-section-number">7.1</span> Pitfall 1: Excessive Blocking</h3>
<p><strong>Symptom:</strong> Computation is very slow despite low memory usage (30-40% of RAM used).</p>
<p><strong>Cause:</strong> Block count (k) is much larger than necessary, creating excessive overhead from operations and I/O.</p>
<p><strong>Why this happens:</strong> Overly conservative memory estimates or copying someone else’s configuration without adapting to your hardware.</p>
<p><strong>Example:</strong></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Poor configuration</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">bdSVD_hdf5</span>(<span class="st">"data.hdf5"</span>, <span class="st">"data"</span>, <span class="st">"small"</span>, <span class="at">k=</span><span class="dv">32</span>)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="co">#   elapsed: 45 seconds</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Dataset: 10,000×5,000 (400 MB)</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Available RAM: 16 GB (plenty of headroom!)</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Good configuration</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">bdSVD_hdf5</span>(<span class="st">"data.hdf5"</span>, <span class="st">"data"</span>, <span class="st">"small"</span>, <span class="at">k=</span><span class="dv">2</span>)</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a><span class="co">#   elapsed: 8 seconds (82% faster)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong>Fix:</strong> Calculate appropriate k based on actual memory needs:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate dataset size</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>n_rows <span class="ot">&lt;-</span> <span class="dv">10000</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>n_cols <span class="ot">&lt;-</span> <span class="dv">5000</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>dataset_size_gb <span class="ot">&lt;-</span> (n_rows <span class="sc">*</span> n_cols <span class="sc">*</span> <span class="dv">8</span>) <span class="sc">/</span> (<span class="dv">1024</span><span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Dataset size:"</span>, <span class="fu">round</span>(dataset_size_gb, <span class="dv">2</span>), <span class="st">"GB</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Available RAM</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>available_gb <span class="ot">&lt;-</span> <span class="dv">16</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>k_needed <span class="ot">&lt;-</span> <span class="fu">ceiling</span>(dataset_size_gb <span class="sc">/</span> (available_gb <span class="sc">*</span> <span class="fl">0.5</span>))</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Minimum k needed:"</span>, k_needed, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Recommended k:"</span>, <span class="fu">max</span>(<span class="dv">2</span>, k_needed), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong>Rule:</strong> Use smallest k that keeps memory usage comfortably below limits (60-70% of RAM).</p>
<hr>
</section>
<section id="pitfall-2-thread-oversubscription" class="level3" data-number="7.2">
<h3 data-number="7.2" class="anchored" data-anchor-id="pitfall-2-thread-oversubscription"><span class="header-section-number">7.2</span> Pitfall 2: Thread Oversubscription</h3>
<p><strong>Symptom:</strong> Adding more threads doesn’t improve performance or actually makes it worse.</p>
<p><strong>Cause:</strong> More threads than physical CPU cores, causing context switching overhead and cache thrashing.</p>
<p><strong>Why this happens:</strong> Confusing physical cores with hyperthreads/logical cores, or assuming “more threads = more speed.”</p>
<p><strong>Example:</strong></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># System: 4 physical cores (8 hyperthreads)</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Poor: threads=16 (4× oversubscription)</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">bdPCA_hdf5</span>(<span class="st">"data.hdf5"</span>, <span class="st">"data"</span>, <span class="st">"matrix"</span>, </span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>                       <span class="at">k=</span><span class="dv">8</span>, <span class="at">threads=</span><span class="dv">16</span>)</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="co">#   elapsed: 25 seconds</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Context switching overhead, cache thrashing</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Good: threads=4 (matches physical cores)</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">bdPCA_hdf5</span>(<span class="st">"data.hdf5"</span>, <span class="st">"data"</span>, <span class="st">"matrix"</span>,</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>                       <span class="at">k=</span><span class="dv">8</span>, <span class="at">threads=</span><span class="dv">4</span>)</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a><span class="co">#   elapsed: 12 seconds (52% faster)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong>Understanding the problem:</strong> When threads exceed physical cores, the operating system rapidly switches between them (context switching). Each switch: saves one thread’s state, loads another’s state, invalidates CPU caches. With 16 threads on 4 cores, each core switches between 4 threads. Switching costs accumulate, and cache efficiency plummets—data constantly evicted before use.</p>
<p><strong>Fix:</strong> Match threads to physical cores:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Find physical cores (not hyperthreads)</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>n_physical <span class="ot">&lt;-</span> parallel<span class="sc">::</span><span class="fu">detectCores</span>(<span class="at">logical =</span> <span class="cn">FALSE</span>)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Physical cores:"</span>, n_physical, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Use physical cores as upper bound</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>optimal_threads <span class="ot">&lt;-</span> <span class="fu">min</span>(n_physical, <span class="dv">8</span>)  <span class="co"># Cap at 8 for safety</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong>Additional check—BLAS threading:</strong></p>
<p>Some BLAS libraries (MKL, OpenBLAS) use threading internally. If BLAS uses 4 threads and you specify threads=4 in BigDataStatMeth, you have 4×4=16 threads—oversubscription even with 16 physical cores.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check BLAS configuration</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Look for "BLAS: " line</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="co"># If multi-threaded BLAS, limit BigDataStatMeth threads</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="fu">Sys.setenv</span>(<span class="at">OPENBLAS_NUM_THREADS =</span> <span class="dv">1</span>)  <span class="co"># Disable BLAS threading</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="co"># OR</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Use fewer BigDataStatMeth threads to account for BLAS threading</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<hr>
</section>
<section id="pitfall-3-redundant-operations" class="level3" data-number="7.3">
<h3 data-number="7.3" class="anchored" data-anchor-id="pitfall-3-redundant-operations"><span class="header-section-number">7.3</span> Pitfall 3: Redundant Operations</h3>
<p><strong>Symptom:</strong> Repeated analyses (parameter sweeps, cross-validation) each take the same amount of time, including time for operations that don’t change between runs.</p>
<p><strong>Cause:</strong> Not leveraging HDF5’s persistence to reuse computed results.</p>
<p><strong>Why this happens:</strong> Treating each analysis as independent rather than recognizing shared computations.</p>
<p><strong>Example:</strong></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Poor: Normalize every iteration</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>parameter_values <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">50</span>)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (n_components <span class="cf">in</span> parameter_values) {</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">bdPCA_hdf5</span>(</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> <span class="st">"data.hdf5"</span>,</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"data"</span>,</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">dataset =</span> <span class="st">"raw"</span>,</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">bcenter =</span> <span class="cn">TRUE</span>,   <span class="co"># Normalizes every iteration</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">bscale =</span> <span class="cn">TRUE</span>,</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">k =</span> <span class="dv">4</span>,</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># n_components varies</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Process result</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Total time: 5 × (normalization + PCA) = 5 × 60s = 300s</span></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Good: Normalize once, reuse</span></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a><span class="fu">bdNormalize_hdf5</span>(</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> <span class="st">"data.hdf5"</span>,</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">group =</span> <span class="st">"data"</span>,</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">dataset =</span> <span class="st">"raw"</span>,</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">bcenter =</span> <span class="cn">TRUE</span>,</span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">bscale =</span> <span class="cn">TRUE</span></span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (n_components <span class="cf">in</span> parameter_values) {</span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">bdPCA_hdf5</span>(</span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> <span class="st">"data.hdf5"</span>,</span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"NORMALIZED/data"</span>,  <span class="co"># Pre-normalized</span></span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">dataset =</span> <span class="st">"raw"</span>,</span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">bcenter =</span> <span class="cn">FALSE</span>,  <span class="co"># Skip normalization</span></span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">bscale =</span> <span class="cn">FALSE</span>,</span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">k =</span> <span class="dv">4</span>,</span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># n_components varies</span></span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Process result</span></span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Total time: normalization + 5 × PCA = 50s + 5×10s = 100s (67% faster)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong>Understanding the savings:</strong> If normalization takes 20% of total time and you run 10 analyses, normalizing once saves 9/10 × 20% = 18% of total workflow time. For workflows with hundreds of runs (bootstrapping, cross-validation), savings multiply dramatically.</p>
<p><strong>Fix strategy:</strong></p>
<ol type="1">
<li>Identify operations that don’t change between runs</li>
<li>Perform them once, store results in HDF5</li>
<li>Reuse stored results in subsequent runs</li>
</ol>
<p>Applies to normalization, QR decomposition (for CCA), centering, scaling—any operation deterministic and shared across runs.</p>
<hr>
</section>
</section>
<section id="benchmarking-measuring-real-performance" class="level2" data-number="8">
<h2 data-number="8" class="anchored" data-anchor-id="benchmarking-measuring-real-performance"><span class="header-section-number">8</span> Benchmarking: Measuring Real Performance</h2>
<p>To validate optimizations, benchmark systematically with real data and hardware. The following framework provides structure for comprehensive performance testing.</p>
<section id="systematic-benchmarking-framework" class="level3" data-number="8.1">
<h3 data-number="8.1" class="anchored" data-anchor-id="systematic-benchmarking-framework"><span class="header-section-number">8.1</span> Systematic Benchmarking Framework</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(microbenchmark)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Define configurations to test</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>test_configs <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">k =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">8</span>, <span class="dv">16</span>),</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">threads =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">8</span>),</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Run each configuration multiple times</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">seq_len</span>(<span class="fu">nrow</span>(test_configs)), <span class="cf">function</span>(i) {</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>  cfg <span class="ot">&lt;-</span> test_configs[i, ]</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Testing k="</span>, cfg<span class="sc">$</span>k, <span class="st">", threads="</span>, cfg<span class="sc">$</span>threads, <span class="st">"...</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep=</span><span class="st">""</span>)</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>  timing <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bdSVD_hdf5</span>(</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">file =</span> <span class="st">"benchmark_data.hdf5"</span>,</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">group =</span> <span class="st">"data"</span>,</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">dataset =</span> <span class="st">"matrix"</span>,</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">k =</span> cfg<span class="sc">$</span>k,</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">threads =</span> cfg<span class="sc">$</span>threads,</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">bcenter =</span> <span class="cn">TRUE</span>,</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">bscale =</span> <span class="cn">FALSE</span></span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">k =</span> cfg<span class="sc">$</span>k,</span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">threads =</span> cfg<span class="sc">$</span>threads,</span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">user =</span> timing[[<span class="st">"user"</span>]],</span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">system =</span> timing[[<span class="st">"system"</span>]],</span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">elapsed =</span> timing[[<span class="st">"elapsed"</span>]]</span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a>benchmark_df <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, results)</span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Analyze results</span></span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Benchmark Results:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb29-41"><a href="#cb29-41" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(benchmark_df)</span>
<span id="cb29-42"><a href="#cb29-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-43"><a href="#cb29-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Find optimal configuration</span></span>
<span id="cb29-44"><a href="#cb29-44" aria-hidden="true" tabindex="-1"></a>optimal_idx <span class="ot">&lt;-</span> <span class="fu">which.min</span>(benchmark_df<span class="sc">$</span>elapsed)</span>
<span id="cb29-45"><a href="#cb29-45" aria-hidden="true" tabindex="-1"></a>optimal <span class="ot">&lt;-</span> benchmark_df[optimal_idx, ]</span>
<span id="cb29-46"><a href="#cb29-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-47"><a href="#cb29-47" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Optimal configuration:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb29-48"><a href="#cb29-48" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  k ="</span>, optimal<span class="sc">$</span>k, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb29-49"><a href="#cb29-49" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  threads ="</span>, optimal<span class="sc">$</span>threads, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb29-50"><a href="#cb29-50" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  elapsed time ="</span>, <span class="fu">round</span>(optimal<span class="sc">$</span>elapsed, <span class="dv">2</span>), <span class="st">"seconds</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="visualizing-performance" class="level3" data-number="8.2">
<h3 data-number="8.2" class="anchored" data-anchor-id="visualizing-performance"><span class="header-section-number">8.2</span> Visualizing Performance</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot: k vs time for each thread count</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(benchmark_df, <span class="fu">aes</span>(<span class="at">x=</span>k, <span class="at">y=</span>elapsed, <span class="at">color=</span><span class="fu">factor</span>(threads))) <span class="sc">+</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">size=</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size=</span><span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_log2</span>(<span class="at">breaks=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">4</span>,<span class="dv">8</span>,<span class="dv">16</span>)) <span class="sc">+</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_brewer</span>(<span class="at">palette=</span><span class="st">"Set1"</span>, <span class="at">name=</span><span class="st">"Threads"</span>) <span class="sc">+</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">title=</span><span class="st">"SVD Performance: Block Size vs Thread Count"</span>,</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle=</span><span class="fu">paste</span>(<span class="st">"Dataset:"</span>, nrow, <span class="st">"×"</span>, ncol, <span class="st">"- Hardware:"</span>, RAM, <span class="st">"GB RAM"</span>),</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">x=</span><span class="st">"Number of Blocks (k)"</span>,</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">y=</span><span class="st">"Elapsed Time (seconds)"</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size=</span><span class="dv">14</span>) <span class="sc">+</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"right"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="interpreting-benchmarks" class="level3" data-number="8.3">
<h3 data-number="8.3" class="anchored" data-anchor-id="interpreting-benchmarks"><span class="header-section-number">8.3</span> Interpreting Benchmarks</h3>
<p><strong>Look for these patterns:</strong></p>
<ol type="1">
<li><p><strong>Optimal k:</strong> Time decreases as k decreases, then levels off or increases. The minimum is your optimal k for this dataset/hardware combination.</p></li>
<li><p><strong>Threading efficiency:</strong> Compare times across thread counts for fixed k. If doubling threads doesn’t halve time, you’re hitting parallelization limits.</p></li>
<li><p><strong>Interaction effects:</strong> Sometimes optimal k changes with thread count. With few threads, smaller k is best (less overhead). With many threads, larger k helps (more blocks to parallelize).</p></li>
</ol>
<p><strong>Example interpretation:</strong></p>
<pre><code>k=2,  threads=1: 48.3s
k=2,  threads=4: 14.2s  (speedup: 3.4×, efficiency: 85%)
k=8,  threads=4: 18.7s
k=16, threads=4: 26.1s

Conclusion: k=2 optimal (data fits in memory), threads=4 good efficiency</code></pre>
<hr>
</section>
</section>
<section id="real-world-case-study-1000-genomes-pca" class="level2" data-number="9">
<h2 data-number="9" class="anchored" data-anchor-id="real-world-case-study-1000-genomes-pca"><span class="header-section-number">9</span> Real-World Case Study: 1000 Genomes PCA</h2>
<p>Let’s walk through complete optimization of a real analysis: PCA on 1000 Genomes data.</p>
<p><strong>Dataset:</strong> 2,504 samples × 500 genes from 1000 Genomes Project<br>
<strong>Hardware:</strong> Standard workstation (16 GB RAM, 4 physical cores)<br>
<strong>Goal:</strong> Optimize PCA to minimize analysis time while ensuring correctness</p>
<section id="initial-baseline" class="level3" data-number="9.1">
<h3 data-number="9.1" class="anchored" data-anchor-id="initial-baseline"><span class="header-section-number">9.1</span> Initial Baseline</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Conservative starting configuration</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== Baseline Configuration ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>baseline_time <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  baseline <span class="ot">&lt;-</span> <span class="fu">bdPCA_hdf5</span>(</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> <span class="st">"1000G.hdf5"</span>,</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"data"</span>,</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">dataset =</span> <span class="st">"genotypes"</span>,</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">bcenter =</span> <span class="cn">TRUE</span>,</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">bscale =</span> <span class="cn">FALSE</span>,</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">k =</span> <span class="dv">8</span>,    <span class="co"># Conservative blocking</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">q =</span> <span class="dv">1</span>,</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">threads =</span> <span class="dv">2</span>  <span class="co"># Conservative threading</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Elapsed time:"</span>, baseline_time[<span class="st">"elapsed"</span>], <span class="st">"seconds</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"User time:"</span>, baseline_time[<span class="st">"user"</span>], <span class="st">"seconds</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"System time:"</span>, baseline_time[<span class="st">"system"</span>], <span class="st">"seconds</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Typical output:</span></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a><span class="co">#   Elapsed time: 23.45 seconds</span></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a><span class="co">#   User time: 41.23 seconds</span></span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a><span class="co">#   System time: 3.12 seconds</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong>Initial observations:</strong></p>
<ul>
<li>User time &gt;&gt; elapsed time: Parallelization working (2 threads doing ~1.8× work)</li>
<li>System time moderate (~13% of elapsed): I/O not dominant but noticeable</li>
<li>Memory usage: ~4 GB peak (plenty of headroom with 16 GB available)</li>
</ul>
</section>
<section id="profile-to-identify-bottlenecks" class="level3" data-number="9.2">
<h3 data-number="9.2" class="anchored" data-anchor-id="profile-to-identify-bottlenecks"><span class="header-section-number">9.2</span> Profile to Identify Bottlenecks</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== Profiling to Find Bottlenecks ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="fu">Rprof</span>(<span class="st">"pca_profile.out"</span>)</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="fu">bdPCA_hdf5</span>(</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> <span class="st">"1000G.hdf5"</span>,</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">group =</span> <span class="st">"data"</span>,</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">dataset =</span> <span class="st">"genotypes"</span>,</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">bcenter =</span> <span class="cn">TRUE</span>,</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">bscale =</span> <span class="cn">FALSE</span>,</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">k =</span> <span class="dv">8</span>,</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">q =</span> <span class="dv">1</span>,</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">threads =</span> <span class="dv">2</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a><span class="fu">Rprof</span>(<span class="cn">NULL</span>)</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Analyze profile</span></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>profile <span class="ot">&lt;-</span> <span class="fu">summaryRprof</span>(<span class="st">"pca_profile.out"</span>)</span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(profile<span class="sc">$</span>by.self[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>,])</span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Typical output shows:</span></span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a><span class="co">#   bdSVD_hdf5:      60% of time (primary bottleneck)</span></span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a><span class="co">#   bdNormalize:     25% of time (opportunity for pre-computation)</span></span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a><span class="co">#   h5read:          12% of time (I/O overhead)</span></span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a><span class="co">#   Other:           3% of time</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong>Bottleneck identified:</strong> SVD computation dominates (60%), normalization is significant (25%), I/O is noticeable (12%).</p>
<p><strong>Optimization strategy based on profiling:</strong></p>
<ol type="1">
<li>Reduce k to speed up SVD (we have memory headroom)</li>
<li>Increase threads to parallelize SVD better (4 cores available)</li>
<li>Pre-normalize data to eliminate repeated normalization</li>
<li>Consider HDF5 chunking if I/O remains problematic after other optimizations</li>
</ol>
</section>
<section id="optimization-1-reduce-block-count" class="level3" data-number="9.3">
<h3 data-number="9.3" class="anchored" data-anchor-id="optimization-1-reduce-block-count"><span class="header-section-number">9.3</span> Optimization 1: Reduce Block Count</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== Optimization 1: Reduce k ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>opt1_time <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  opt1 <span class="ot">&lt;-</span> <span class="fu">bdPCA_hdf5</span>(</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> <span class="st">"1000G.hdf5"</span>,</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"data"</span>,</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">dataset =</span> <span class="st">"genotypes"</span>,</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">bcenter =</span> <span class="cn">TRUE</span>,</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">bscale =</span> <span class="cn">FALSE</span>,</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">k =</span> <span class="dv">4</span>,    <span class="co"># Halved from 8</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">q =</span> <span class="dv">1</span>,</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">threads =</span> <span class="dv">2</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Elapsed time:"</span>, opt1_time[<span class="st">"elapsed"</span>], <span class="st">"seconds</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>improvement1 <span class="ot">&lt;-</span> (baseline_time[<span class="st">"elapsed"</span>] <span class="sc">-</span> opt1_time[<span class="st">"elapsed"</span>]) <span class="sc">/</span> </span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>                baseline_time[<span class="st">"elapsed"</span>] <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Improvement:"</span>, <span class="fu">round</span>(improvement1, <span class="dv">1</span>), <span class="st">"%</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Typical output:</span></span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a><span class="co">#   Elapsed time: 18.32 seconds</span></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a><span class="co">#   Improvement: 21.9%</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong>Why this helped:</strong> Reducing from k=8 to k=4 halves the number of block operations. SVD on 4 blocks is faster than SVD on 8 blocks. Memory usage increased from 4GB to 6GB—well within our 16GB capacity.</p>
</section>
<section id="optimization-2-increase-threading" class="level3" data-number="9.4">
<h3 data-number="9.4" class="anchored" data-anchor-id="optimization-2-increase-threading"><span class="header-section-number">9.4</span> Optimization 2: Increase Threading</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== Optimization 2: Increase threads ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>opt2_time <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  opt2 <span class="ot">&lt;-</span> <span class="fu">bdPCA_hdf5</span>(</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> <span class="st">"1000G.hdf5"</span>,</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"data"</span>,</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">dataset =</span> <span class="st">"genotypes"</span>,</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">bcenter =</span> <span class="cn">TRUE</span>,</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">bscale =</span> <span class="cn">FALSE</span>,</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">k =</span> <span class="dv">4</span>,</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">q =</span> <span class="dv">1</span>,</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">threads =</span> <span class="dv">4</span>  <span class="co"># Doubled from 2</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Elapsed time:"</span>, opt2_time[<span class="st">"elapsed"</span>], <span class="st">"seconds</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>improvement2 <span class="ot">&lt;-</span> (opt1_time[<span class="st">"elapsed"</span>] <span class="sc">-</span> opt2_time[<span class="st">"elapsed"</span>]) <span class="sc">/</span> </span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>                opt1_time[<span class="st">"elapsed"</span>] <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Additional improvement:"</span>, <span class="fu">round</span>(improvement2, <span class="dv">1</span>), <span class="st">"%</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>total_improvement <span class="ot">&lt;-</span> (baseline_time[<span class="st">"elapsed"</span>] <span class="sc">-</span> opt2_time[<span class="st">"elapsed"</span>]) <span class="sc">/</span> </span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>                     baseline_time[<span class="st">"elapsed"</span>] <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Total improvement vs baseline:"</span>, <span class="fu">round</span>(total_improvement, <span class="dv">1</span>), <span class="st">"%</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate threading efficiency</span></span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>speedup <span class="ot">&lt;-</span> opt1_time[<span class="st">"elapsed"</span>] <span class="sc">/</span> opt2_time[<span class="st">"elapsed"</span>]</span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>efficiency <span class="ot">&lt;-</span> speedup <span class="sc">/</span> <span class="dv">2</span>  <span class="co"># Doubled threads</span></span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Threading efficiency:"</span>, <span class="fu">round</span>(efficiency <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>), <span class="st">"%</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Typical output:</span></span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a><span class="co">#   Elapsed time: 12.84 seconds</span></span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a><span class="co">#   Additional improvement: 29.9%</span></span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a><span class="co">#   Total improvement vs baseline: 45.3%</span></span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a><span class="co">#   Threading efficiency: 71.2%</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong>Why this helped:</strong> With k=4, we have 4 blocks that can compute in parallel. Using 4 threads (matching our 4 physical cores) provides good parallelization. Efficiency of 71% is solid—some overhead from coordination and I/O, but most computation parallelizes well.</p>
</section>
<section id="optimization-3-pre-normalize-data" class="level3" data-number="9.5">
<h3 data-number="9.5" class="anchored" data-anchor-id="optimization-3-pre-normalize-data"><span class="header-section-number">9.5</span> Optimization 3: Pre-normalize Data</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== Optimization 3: Pre-normalize ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Normalize once</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>norm_time <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bdNormalize_hdf5</span>(</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> <span class="st">"1000G.hdf5"</span>,</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"data"</span>,</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">dataset =</span> <span class="st">"genotypes"</span>,</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">bcenter =</span> <span class="cn">TRUE</span>,</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">bscale =</span> <span class="cn">FALSE</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Normalization time (one-time cost):"</span>, norm_time[<span class="st">"elapsed"</span>], <span class="st">"seconds</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Run PCA on pre-normalized data</span></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>opt3_time <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>  opt3 <span class="ot">&lt;-</span> <span class="fu">bdPCA_hdf5</span>(</span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> <span class="st">"1000G.hdf5"</span>,</span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"NORMALIZED/data"</span>,</span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">dataset =</span> <span class="st">"genotypes"</span>,</span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">bcenter =</span> <span class="cn">FALSE</span>,  <span class="co"># Already normalized</span></span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">bscale =</span> <span class="cn">FALSE</span>,</span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">k =</span> <span class="dv">4</span>,</span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">q =</span> <span class="dv">1</span>,</span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">threads =</span> <span class="dv">4</span></span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-30"><a href="#cb36-30" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"PCA time (using pre-normalized):"</span>, opt3_time[<span class="st">"elapsed"</span>], <span class="st">"seconds</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb36-31"><a href="#cb36-31" aria-hidden="true" tabindex="-1"></a>improvement3 <span class="ot">&lt;-</span> (opt2_time[<span class="st">"elapsed"</span>] <span class="sc">-</span> opt3_time[<span class="st">"elapsed"</span>]) <span class="sc">/</span> </span>
<span id="cb36-32"><a href="#cb36-32" aria-hidden="true" tabindex="-1"></a>                opt2_time[<span class="st">"elapsed"</span>] <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb36-33"><a href="#cb36-33" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Additional improvement:"</span>, <span class="fu">round</span>(improvement3, <span class="dv">1</span>), <span class="st">"%</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb36-34"><a href="#cb36-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-35"><a href="#cb36-35" aria-hidden="true" tabindex="-1"></a>final_improvement <span class="ot">&lt;-</span> (baseline_time[<span class="st">"elapsed"</span>] <span class="sc">-</span> opt3_time[<span class="st">"elapsed"</span>]) <span class="sc">/</span> </span>
<span id="cb36-36"><a href="#cb36-36" aria-hidden="true" tabindex="-1"></a>                     baseline_time[<span class="st">"elapsed"</span>] <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb36-37"><a href="#cb36-37" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"FINAL improvement vs baseline:"</span>, <span class="fu">round</span>(final_improvement, <span class="dv">1</span>), <span class="st">"%</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb36-38"><a href="#cb36-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-39"><a href="#cb36-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Typical output:</span></span>
<span id="cb36-40"><a href="#cb36-40" aria-hidden="true" tabindex="-1"></a><span class="co">#   Normalization time: 4.23 seconds</span></span>
<span id="cb36-41"><a href="#cb36-41" aria-hidden="true" tabindex="-1"></a><span class="co">#   PCA time: 9.18 seconds</span></span>
<span id="cb36-42"><a href="#cb36-42" aria-hidden="true" tabindex="-1"></a><span class="co">#   Additional improvement: 28.5%</span></span>
<span id="cb36-43"><a href="#cb36-43" aria-hidden="true" tabindex="-1"></a><span class="co">#   FINAL improvement vs baseline: 60.9%</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong>Why this helped:</strong> Profiling showed normalization consumed 25% of time. By pre-normalizing, we eliminate that 25% from each subsequent PCA run. If running only once, the one-time normalization cost negates some benefit. But for multiple runs (common in parameter tuning, cross-validation), savings multiply.</p>
<p><strong>Amortized analysis:</strong> If running 10 PCAs with different parameters:</p>
<ul>
<li>Without pre-normalization: 10 × 12.84s = 128.4s total</li>
<li>With pre-normalization: 4.23s + 10 × 9.18s = 96.0s total (25% faster)</li>
</ul>
<p>For 100 runs: 4.23s + 100 × 9.18s = 922s vs 1284s (28% faster)</p>
</section>
<section id="verification-of-correctness" class="level3" data-number="9.6">
<h3 data-number="9.6" class="anchored" data-anchor-id="verification-of-correctness"><span class="header-section-number">9.6</span> Verification of Correctness</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== Verifying Correctness ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare principal components</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>pc_match <span class="ot">&lt;-</span> <span class="fu">all.equal</span>(</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>  baseline<span class="sc">$</span>components[, <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>],</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>  opt3<span class="sc">$</span>components[, <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>],</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">tolerance =</span> <span class="fl">1e-10</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Principal components match:"</span>, pc_match, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare variance explained</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>var_match <span class="ot">&lt;-</span> <span class="fu">all.equal</span>(</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>  baseline<span class="sc">$</span>variance_prop[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>],</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>  opt3<span class="sc">$</span>variance_prop[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>],</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">tolerance =</span> <span class="fl">1e-10</span></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Variance explained matches:"</span>, var_match, <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Typical output:</span></span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a><span class="co">#   Principal components match: TRUE</span></span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a><span class="co">#   Variance explained matches: TRUE</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong>Critical step:</strong> Always verify optimization doesn’t change results. Numerical differences within tolerance (1e-10) are acceptable—floating-point arithmetic isn’t perfectly deterministic. But results should be essentially identical.</p>
</section>
<section id="final-configuration-summary" class="level3" data-number="9.7">
<h3 data-number="9.7" class="anchored" data-anchor-id="final-configuration-summary"><span class="header-section-number">9.7</span> Final Configuration Summary</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== Final Optimization Summary ===</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>summary_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">Configuration =</span> <span class="fu">c</span>(<span class="st">"Baseline"</span>, <span class="st">"Opt1: k=4"</span>, <span class="st">"Opt2: +threads"</span>, <span class="st">"Opt3: +prenorm"</span>),</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">Time_seconds =</span> <span class="fu">c</span>(</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    baseline_time[<span class="st">"elapsed"</span>],</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>    opt1_time[<span class="st">"elapsed"</span>],</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>    opt2_time[<span class="st">"elapsed"</span>],</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>    opt3_time[<span class="st">"elapsed"</span>]</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">Speedup =</span> <span class="fu">c</span>(</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>    <span class="fl">1.0</span>,</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>    baseline_time[<span class="st">"elapsed"</span>] <span class="sc">/</span> opt1_time[<span class="st">"elapsed"</span>],</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>    baseline_time[<span class="st">"elapsed"</span>] <span class="sc">/</span> opt2_time[<span class="st">"elapsed"</span>],</span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>    baseline_time[<span class="st">"elapsed"</span>] <span class="sc">/</span> opt3_time[<span class="st">"elapsed"</span>]</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">Config_details =</span> <span class="fu">c</span>(</span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"k=8, threads=2"</span>,</span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"k=4, threads=2"</span>,</span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"k=4, threads=4"</span>,</span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"k=4, threads=4, prenorm"</span></span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(summary_df)</span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Final configuration:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  - Pre-normalize data once</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  - k = 4 (balance speed/memory)</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  - threads = 4 (match physical cores)</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  - Result: 60.9% faster than baseline</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  - Verified: Results identical to baseline</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong>Key lessons from case study:</strong></p>
<ol type="1">
<li><strong>Profile identified the right targets:</strong> Without profiling, we might have optimized I/O (only 12% of time) instead of SVD (60% of time)</li>
<li><strong>Incremental optimization works:</strong> Each step provided measurable benefit (22%, 30%, 29%)</li>
<li><strong>Memory headroom enabled speed:</strong> Having 16GB for a 2GB dataset let us reduce k aggressively</li>
<li><strong>Pre-computation pays off:</strong> One-time normalization cost amortizes over multiple runs</li>
<li><strong>Verification is essential:</strong> Always confirm results unchanged after optimization</li>
</ol>
<hr>
</section>
</section>
<section id="interactive-exercise" class="level2 exercise" data-number="10">
<h2 class="exercise anchored" data-number="10" data-anchor-id="interactive-exercise"><span class="header-section-number">10</span> Interactive Exercise</h2>
<section id="apply-optimization-to-your-data" class="level3" data-number="10.1">
<h3 data-number="10.1" class="anchored" data-anchor-id="apply-optimization-to-your-data"><span class="header-section-number">10.1</span> Apply Optimization to Your Data</h3>
<p>Use this exercise to practice optimization on your own datasets:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ==========================================</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Exercise 1: Baseline Measurement</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ==========================================</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Exercise 1: Establishing Baseline</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"----------------------------------</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: Replace with your actual file, group, dataset</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>your_file <span class="ot">&lt;-</span> <span class="st">"your_data.hdf5"</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>your_group <span class="ot">&lt;-</span> <span class="st">"your_group"</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>your_dataset <span class="ot">&lt;-</span> <span class="st">"your_dataset"</span></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>baseline_time <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>  baseline_result <span class="ot">&lt;-</span> <span class="fu">bdPCA_hdf5</span>(</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> your_file,</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> your_group,</span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">dataset =</span> your_dataset,</span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">k =</span> <span class="dv">4</span>,</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">threads =</span> <span class="dv">2</span></span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Baseline time:"</span>, <span class="fu">round</span>(baseline_time[<span class="st">"elapsed"</span>], <span class="dv">2</span>), <span class="st">"seconds</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"User time:"</span>, <span class="fu">round</span>(baseline_time[<span class="st">"user"</span>], <span class="dv">2</span>), <span class="st">"seconds</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"System time:"</span>, <span class="fu">round</span>(baseline_time[<span class="st">"system"</span>], <span class="dv">2</span>), <span class="st">"seconds</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a><span class="co"># ==========================================</span></span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Exercise 2: Test Different k Values</span></span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true" tabindex="-1"></a><span class="co"># ==========================================</span></span>
<span id="cb39-30"><a href="#cb39-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-31"><a href="#cb39-31" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Exercise 2: Testing Block Sizes (k)</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb39-32"><a href="#cb39-32" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"------------------------------------</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb39-33"><a href="#cb39-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-34"><a href="#cb39-34" aria-hidden="true" tabindex="-1"></a>k_values <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">8</span>, <span class="dv">16</span>)</span>
<span id="cb39-35"><a href="#cb39-35" aria-hidden="true" tabindex="-1"></a>k_times <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">length</span>(k_values))</span>
<span id="cb39-36"><a href="#cb39-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-37"><a href="#cb39-37" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(k_values)) {</span>
<span id="cb39-38"><a href="#cb39-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Testing k ="</span>, k_values[i], <span class="st">"... "</span>)</span>
<span id="cb39-39"><a href="#cb39-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb39-40"><a href="#cb39-40" aria-hidden="true" tabindex="-1"></a>  t <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb39-41"><a href="#cb39-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bdPCA_hdf5</span>(your_file, your_group, your_dataset,</span>
<span id="cb39-42"><a href="#cb39-42" aria-hidden="true" tabindex="-1"></a>               <span class="at">k=</span>k_values[i], <span class="at">threads=</span><span class="dv">2</span>)</span>
<span id="cb39-43"><a href="#cb39-43" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb39-44"><a href="#cb39-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb39-45"><a href="#cb39-45" aria-hidden="true" tabindex="-1"></a>  k_times[i] <span class="ot">&lt;-</span> t[<span class="st">"elapsed"</span>]</span>
<span id="cb39-46"><a href="#cb39-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">round</span>(k_times[i], <span class="dv">2</span>), <span class="st">"seconds</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb39-47"><a href="#cb39-47" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb39-48"><a href="#cb39-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-49"><a href="#cb39-49" aria-hidden="true" tabindex="-1"></a><span class="co"># Find optimal k</span></span>
<span id="cb39-50"><a href="#cb39-50" aria-hidden="true" tabindex="-1"></a>optimal_k <span class="ot">&lt;-</span> k_values[<span class="fu">which.min</span>(k_times)]</span>
<span id="cb39-51"><a href="#cb39-51" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Optimal k:"</span>, optimal_k, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb39-52"><a href="#cb39-52" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Best time:"</span>, <span class="fu">round</span>(<span class="fu">min</span>(k_times), <span class="dv">2</span>), <span class="st">"seconds</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb39-53"><a href="#cb39-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-54"><a href="#cb39-54" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot k vs time</span></span>
<span id="cb39-55"><a href="#cb39-55" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(k_values, k_times, <span class="at">type=</span><span class="st">"b"</span>, <span class="at">pch=</span><span class="dv">19</span>,</span>
<span id="cb39-56"><a href="#cb39-56" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab=</span><span class="st">"Number of Blocks (k)"</span>, <span class="at">ylab=</span><span class="st">"Time (seconds)"</span>,</span>
<span id="cb39-57"><a href="#cb39-57" aria-hidden="true" tabindex="-1"></a>     <span class="at">main=</span><span class="st">"Impact of Block Size on Performance"</span>,</span>
<span id="cb39-58"><a href="#cb39-58" aria-hidden="true" tabindex="-1"></a>     <span class="at">col=</span><span class="st">"blue"</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb39-59"><a href="#cb39-59" aria-hidden="true" tabindex="-1"></a><span class="fu">grid</span>()</span>
<span id="cb39-60"><a href="#cb39-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-61"><a href="#cb39-61" aria-hidden="true" tabindex="-1"></a><span class="co"># ==========================================</span></span>
<span id="cb39-62"><a href="#cb39-62" aria-hidden="true" tabindex="-1"></a><span class="co"># Exercise 3: Test Different Thread Counts</span></span>
<span id="cb39-63"><a href="#cb39-63" aria-hidden="true" tabindex="-1"></a><span class="co"># ==========================================</span></span>
<span id="cb39-64"><a href="#cb39-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-65"><a href="#cb39-65" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Exercise 3: Testing Thread Counts</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb39-66"><a href="#cb39-66" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"----------------------------------</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb39-67"><a href="#cb39-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-68"><a href="#cb39-68" aria-hidden="true" tabindex="-1"></a>thread_values <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">8</span>)</span>
<span id="cb39-69"><a href="#cb39-69" aria-hidden="true" tabindex="-1"></a>thread_times <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">length</span>(thread_values))</span>
<span id="cb39-70"><a href="#cb39-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-71"><a href="#cb39-71" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(thread_values)) {</span>
<span id="cb39-72"><a href="#cb39-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Testing threads ="</span>, thread_values[i], <span class="st">"... "</span>)</span>
<span id="cb39-73"><a href="#cb39-73" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb39-74"><a href="#cb39-74" aria-hidden="true" tabindex="-1"></a>  t <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb39-75"><a href="#cb39-75" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bdPCA_hdf5</span>(your_file, your_group, your_dataset,</span>
<span id="cb39-76"><a href="#cb39-76" aria-hidden="true" tabindex="-1"></a>               <span class="at">k=</span>optimal_k, <span class="at">threads=</span>thread_values[i])</span>
<span id="cb39-77"><a href="#cb39-77" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb39-78"><a href="#cb39-78" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb39-79"><a href="#cb39-79" aria-hidden="true" tabindex="-1"></a>  thread_times[i] <span class="ot">&lt;-</span> t[<span class="st">"elapsed"</span>]</span>
<span id="cb39-80"><a href="#cb39-80" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">round</span>(thread_times[i], <span class="dv">2</span>), <span class="st">"seconds</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb39-81"><a href="#cb39-81" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb39-82"><a href="#cb39-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-83"><a href="#cb39-83" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate speedup and efficiency</span></span>
<span id="cb39-84"><a href="#cb39-84" aria-hidden="true" tabindex="-1"></a>speedup <span class="ot">&lt;-</span> thread_times[<span class="dv">1</span>] <span class="sc">/</span> thread_times</span>
<span id="cb39-85"><a href="#cb39-85" aria-hidden="true" tabindex="-1"></a>efficiency <span class="ot">&lt;-</span> speedup <span class="sc">/</span> thread_values</span>
<span id="cb39-86"><a href="#cb39-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-87"><a href="#cb39-87" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Threading Analysis:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb39-88"><a href="#cb39-88" aria-hidden="true" tabindex="-1"></a>results_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb39-89"><a href="#cb39-89" aria-hidden="true" tabindex="-1"></a>  <span class="at">Threads =</span> thread_values,</span>
<span id="cb39-90"><a href="#cb39-90" aria-hidden="true" tabindex="-1"></a>  <span class="at">Time =</span> <span class="fu">round</span>(thread_times, <span class="dv">2</span>),</span>
<span id="cb39-91"><a href="#cb39-91" aria-hidden="true" tabindex="-1"></a>  <span class="at">Speedup =</span> <span class="fu">round</span>(speedup, <span class="dv">2</span>),</span>
<span id="cb39-92"><a href="#cb39-92" aria-hidden="true" tabindex="-1"></a>  <span class="at">Efficiency =</span> <span class="fu">paste0</span>(<span class="fu">round</span>(efficiency <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>), <span class="st">"%"</span>)</span>
<span id="cb39-93"><a href="#cb39-93" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb39-94"><a href="#cb39-94" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(results_df)</span>
<span id="cb39-95"><a href="#cb39-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-96"><a href="#cb39-96" aria-hidden="true" tabindex="-1"></a><span class="co"># ==========================================</span></span>
<span id="cb39-97"><a href="#cb39-97" aria-hidden="true" tabindex="-1"></a><span class="co"># Exercise 4: Measure Memory Usage</span></span>
<span id="cb39-98"><a href="#cb39-98" aria-hidden="true" tabindex="-1"></a><span class="co"># ==========================================</span></span>
<span id="cb39-99"><a href="#cb39-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-100"><a href="#cb39-100" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Exercise 4: Memory Usage by Configuration</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb39-101"><a href="#cb39-101" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"-------------------------------------------</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb39-102"><a href="#cb39-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-103"><a href="#cb39-103" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pryr)</span>
<span id="cb39-104"><a href="#cb39-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-105"><a href="#cb39-105" aria-hidden="true" tabindex="-1"></a>measure_memory <span class="ot">&lt;-</span> <span class="cf">function</span>(k_val) {</span>
<span id="cb39-106"><a href="#cb39-106" aria-hidden="true" tabindex="-1"></a>  mem_before <span class="ot">&lt;-</span> <span class="fu">mem_used</span>()</span>
<span id="cb39-107"><a href="#cb39-107" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb39-108"><a href="#cb39-108" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bdPCA_hdf5</span>(your_file, your_group, your_dataset,</span>
<span id="cb39-109"><a href="#cb39-109" aria-hidden="true" tabindex="-1"></a>             <span class="at">k=</span>k_val, <span class="at">threads=</span><span class="dv">2</span>)</span>
<span id="cb39-110"><a href="#cb39-110" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb39-111"><a href="#cb39-111" aria-hidden="true" tabindex="-1"></a>  mem_after <span class="ot">&lt;-</span> <span class="fu">mem_used</span>()</span>
<span id="cb39-112"><a href="#cb39-112" aria-hidden="true" tabindex="-1"></a>  (mem_after <span class="sc">-</span> mem_before) <span class="sc">/</span> <span class="dv">1024</span><span class="sc">^</span><span class="dv">2</span>  <span class="co"># Convert to MB</span></span>
<span id="cb39-113"><a href="#cb39-113" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb39-114"><a href="#cb39-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-115"><a href="#cb39-115" aria-hidden="true" tabindex="-1"></a>memory_usage <span class="ot">&lt;-</span> <span class="fu">sapply</span>(k_values, measure_memory)</span>
<span id="cb39-116"><a href="#cb39-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-117"><a href="#cb39-117" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Memory Usage by k:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb39-118"><a href="#cb39-118" aria-hidden="true" tabindex="-1"></a>mem_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb39-119"><a href="#cb39-119" aria-hidden="true" tabindex="-1"></a>  <span class="at">k =</span> k_values,</span>
<span id="cb39-120"><a href="#cb39-120" aria-hidden="true" tabindex="-1"></a>  <span class="at">Memory_MB =</span> <span class="fu">round</span>(memory_usage, <span class="dv">1</span>)</span>
<span id="cb39-121"><a href="#cb39-121" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb39-122"><a href="#cb39-122" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(mem_df)</span>
<span id="cb39-123"><a href="#cb39-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-124"><a href="#cb39-124" aria-hidden="true" tabindex="-1"></a><span class="co"># ==========================================</span></span>
<span id="cb39-125"><a href="#cb39-125" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary and Recommendations</span></span>
<span id="cb39-126"><a href="#cb39-126" aria-hidden="true" tabindex="-1"></a><span class="co"># ==========================================</span></span>
<span id="cb39-127"><a href="#cb39-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-128"><a href="#cb39-128" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">========================================</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb39-129"><a href="#cb39-129" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"OPTIMIZATION SUMMARY</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb39-130"><a href="#cb39-130" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"========================================</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb39-131"><a href="#cb39-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-132"><a href="#cb39-132" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Baseline configuration: k=4, threads=2</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb39-133"><a href="#cb39-133" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Baseline time:"</span>, <span class="fu">round</span>(baseline_time[<span class="st">"elapsed"</span>], <span class="dv">2</span>), <span class="st">"seconds</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb39-134"><a href="#cb39-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-135"><a href="#cb39-135" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Optimal configuration:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb39-136"><a href="#cb39-136" aria-hidden="true" tabindex="-1"></a>optimal_threads <span class="ot">&lt;-</span> thread_values[<span class="fu">which.min</span>(thread_times)]</span>
<span id="cb39-137"><a href="#cb39-137" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  k ="</span>, optimal_k, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb39-138"><a href="#cb39-138" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  threads ="</span>, optimal_threads, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb39-139"><a href="#cb39-139" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  time ="</span>, <span class="fu">round</span>(<span class="fu">min</span>(thread_times), <span class="dv">2</span>), <span class="st">"seconds</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb39-140"><a href="#cb39-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-141"><a href="#cb39-141" aria-hidden="true" tabindex="-1"></a>improvement <span class="ot">&lt;-</span> (baseline_time[<span class="st">"elapsed"</span>] <span class="sc">-</span> <span class="fu">min</span>(thread_times)) <span class="sc">/</span> </span>
<span id="cb39-142"><a href="#cb39-142" aria-hidden="true" tabindex="-1"></a>               baseline_time[<span class="st">"elapsed"</span>] <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb39-143"><a href="#cb39-143" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Improvement:"</span>, <span class="fu">round</span>(improvement, <span class="dv">1</span>), <span class="st">"%</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb39-144"><a href="#cb39-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-145"><a href="#cb39-145" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Threading efficiency:"</span>, </span>
<span id="cb39-146"><a href="#cb39-146" aria-hidden="true" tabindex="-1"></a>    <span class="fu">round</span>(efficiency[<span class="fu">which.min</span>(thread_times)] <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>), <span class="st">"%</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb39-147"><a href="#cb39-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-148"><a href="#cb39-148" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (efficiency[<span class="fu">which.min</span>(thread_times)] <span class="sc">&lt;</span> <span class="fl">0.5</span>) {</span>
<span id="cb39-149"><a href="#cb39-149" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Note: Threading efficiency &lt;50% suggests bottleneck</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb39-150"><a href="#cb39-150" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Possible causes: I/O limitation, memory bandwidth, or BLAS threading</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb39-151"><a href="#cb39-151" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>Reflection Questions
</div>
</div>
<div class="callout-body-container callout-body">
<p>After completing the exercises, consider:</p>
<p><strong>About k (block size):</strong></p>
<ul>
<li>How does k affect time in your data? Is relationship linear?</li>
<li>What’s the memory usage at your optimal k? Could you use smaller k?</li>
<li>Does optimal k change with different thread counts?</li>
</ul>
<p><strong>About threading:</strong></p>
<ul>
<li>What speedup did you achieve with maximum threads?</li>
<li>What’s your threading efficiency? Is it &gt;50%?</li>
<li>If efficiency is low, what bottleneck might exist? (Check user vs system time)</li>
</ul>
<p><strong>About your workflow:</strong></p>
<ul>
<li>Could you pre-normalize to save time in repeated runs?</li>
<li>Is I/O (system time) significant? (&gt;20% of elapsed time?)</li>
<li>Would different HDF5 chunking help if I/O is high?</li>
<li>What’s the best tradeoff for your specific needs?</li>
</ul>
<p><strong>Decision making:</strong></p>
<ul>
<li>Which configuration would you use for production? Why?</li>
<li>How would your choice change if RAM was limited?</li>
<li>How would your choice change if speed was critical?</li>
<li>What evidence supports your configuration choice?</li>
</ul>
</div>
</div>
<hr>
</section>
</section>
<section id="key-takeaways" class="level2 key-concept" data-number="11">
<h2 class="key-concept anchored" data-number="11" data-anchor-id="key-takeaways"><span class="header-section-number">11</span> Key Takeaways</h2>
<p>Let’s consolidate essential principles that guide effective performance optimization.</p>
<p><strong>Optimization is about tradeoffs, not absolutes.</strong> There’s no universally “best” configuration—optimal settings depend on your dataset size, available hardware, and whether memory or speed limits you more. Understanding why these tradeoffs exist helps you make intelligent decisions for your specific situation. When memory is tight, accept slower computation with more blocking. When speed matters and memory is abundant, minimize blocking for faster execution.</p>
<p><strong>Profile before optimizing.</strong> Intuition about bottlenecks is frequently wrong. You might assume I/O dominates when actually computation takes 80% of time, or vice versa. Profiling with <code>system.time()</code>, <code>Rprof()</code>, or <code>profvis</code> reveals where time actually goes. Focus optimization effort on operations consuming &gt;20% of total time—optimizing minor contributors wastes effort with minimal benefit.</p>
<p><strong>Block size (k) controls the fundamental memory-speed tradeoff.</strong> Smaller k means fewer, larger blocks—faster but more RAM required. Larger k means many small blocks—slower but memory-efficient. Start with k that uses 50-70% of available RAM. If hitting memory limits, increase k. If memory usage is low and speed matters, decrease k. The relationship is roughly linear: doubling k halves memory usage and increases time by 20-50% depending on operation intensity.</p>
<p><strong>Threading scales only when operations parallelize.</strong> More threads help when work divides independently (processing blocks in parallel, parallel BLAS operations). Threading doesn’t help when operations are sequential, I/O-bound, or memory-bandwidth-limited. If 4 threads provide &lt;2× speedup compared to 1 thread, you’ve hit a fundamental bottleneck—adding more threads won’t help. Common bottlenecks: disk I/O (all threads wait for disk), memory bandwidth (all threads compete for RAM access), Amdahl’s law (inherent sequential portions limit parallelism).</p>
<p><strong>HDF5 chunk size affects I/O performance dramatically.</strong> Optimal chunking aligns chunks with your access patterns—row-wise chunks for row-wise operations, column-wise chunks for column-wise operations. Target 1-10 MB chunks that match typical block sizes. If profiling shows high system time (&gt;30% of elapsed time), investigate chunk size. Proper chunking can reduce I/O time by 50-80% for I/O-heavy operations.</p>
<p><strong>Leverage HDF5 persistence to avoid redundant computation.</strong> Operations like normalization, centering, and scaling are deterministic—same input always produces same output. Compute these operations once, store results in HDF5, and reuse them in subsequent analyses. For workflows with repeated analyses (parameter sweeps, cross-validation, bootstrapping), pre-computation saves enormous time. A one-time normalization cost amortizes over hundreds of runs.</p>
<p><strong>Always verify correctness after optimization.</strong> Faster incorrect results are worse than slower correct results. After each optimization, verify results match baseline within numerical tolerance. Test with <code>all.equal(result1, result2, tolerance=1e-10)</code>. If results differ beyond floating-point noise, optimization introduced a bug—revert and investigate.</p>
<p><strong>Iterate systematically.</strong> Start with conservative configuration guaranteed to complete successfully. Profile to identify bottlenecks. Optimize the biggest bottleneck. Measure improvement. Verify correctness. Repeat. Change one parameter at a time so you know what helped. Keep what works, revert what doesn’t. Document your final configuration and the reasoning behind it.</p>
<hr>
</section>
<section id="next-steps" class="level2" data-number="12">
<h2 data-number="12" class="anchored" data-anchor-id="next-steps"><span class="header-section-number">12</span> Next Steps</h2>
<p><strong>Apply to your data:</strong></p>
<ul>
<li>Profile your current workflows to identify where time goes</li>
<li>Experiment with different k and thread values systematically</li>
<li>Measure actual improvements—don’t assume</li>
<li>Verify results remain correct after each optimization</li>
</ul>
<p><strong>Explore advanced optimization:</strong></p>
<ul>
<li>Study how different operations scale (SVD vs matrix multiplication vs statistical tests)</li>
<li>Experiment with HDF5 chunking if I/O is your bottleneck</li>
<li>Consider hybrid strategies: pre-compute expensive operations, cache intermediate results</li>
<li>Learn about your BLAS library configuration (single-threaded vs multi-threaded)</li>
</ul>
<p><strong>Deepen understanding:</strong></p>
<ul>
<li>Read about <a href="../fundamentals/blockwise-computing.html">Block-wise Computing</a> mathematical foundations</li>
<li>Explore <a href="../fundamentals/understanding-hdf5.html">HDF5 storage</a> optimization in detail</li>
<li>Study <a href="../developing-methods/cca-r-implementation.html">CCA implementation</a> as complex workflow example</li>
<li>Review BigDataStatMeth paper for algorithmic details and theoretical analysis</li>
</ul>
<p><strong>Share knowledge:</strong></p>
<ul>
<li>Document configurations that work well for your datasets and hardware</li>
<li>Share benchmarking results with colleagues analyzing similar data</li>
<li>Contribute performance findings to the community</li>
<li>Help others optimize their workflows based on your experience</li>
</ul>
<p>Performance optimization is empirical and iterative. What works for one dataset on one machine might not work for another dataset on different hardware. The principles here provide a systematic framework for discovering what works in your environment. Apply them methodically, measure carefully, and you’ll achieve substantial improvements in your BigDataStatMeth workflows.</p>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/isglobal-brge\.github\.io\/BigDataStatMeth\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
            // target, if specified
            link.setAttribute("target", "_blank");
            if (link.getAttribute("rel") === null) {
              link.setAttribute("rel", "noopener");
            }
            // default icon
            link.classList.add("external");
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb40" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Performance Optimization"</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="an">subtitle:</span><span class="co"> "Benchmarks and Tuning Strategies for Large-Scale Analysis"</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="fu">## Overview</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>Performance optimization in BigDataStatMeth requires understanding a fundamental truth: you cannot simultaneously maximize speed, minimize memory usage, and maintain perfect numerical accuracy. Every optimization decision involves tradeoffs, and the "best" configuration depends entirely on your specific constraints—hardware limitations, dataset characteristics, and analysis requirements.</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>Consider a common scenario: you have a 100GB dataset and need to perform PCA. One configuration processes it in 10 minutes using 8GB RAM. Another finishes in 5 minutes but requires 64GB RAM. Which is "better"? If you only have 16GB available, the second configuration is impossible—the first configuration is objectively superior for your situation. If you have 128GB RAM but are analyzing hundreds of datasets, the 5-minute option saves hours of total computation time. Neither configuration is universally optimal; context determines the right choice.</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>This guide teaches you to make these decisions systematically. You'll learn to identify where your computation spends time (profiling), understand how parameters affect performance (tuning), and recognize when you're fighting fundamental limitations (bottlenecks). The goal isn't to memorize optimal parameter values—those don't exist—but to develop intuition for balancing constraints in your specific environment.</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>The strategies here apply broadly across BigDataStatMeth's operations: PCA, SVD, CCA, matrix operations, statistical tests. While optimal values vary by dataset and hardware, the underlying principles remain constant. Master these principles, and you can optimize any workflow.</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>::: {.learning-objectives}</span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a><span class="fu">### What You'll Learn</span></span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Identify performance bottlenecks in your workflows using profiling tools</span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Understand how block size (k, q) controls the memory-speed tradeoff</span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Tune thread counts while recognizing parallelization limits</span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Optimize HDF5 chunk sizes to match your access patterns</span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Balance numerical accuracy against computational efficiency</span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Recognize fundamental bottlenecks (I/O, memory bandwidth, Amdahl's law)</span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Make informed optimization decisions based on your constraints</span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Benchmark systematically to measure actual improvements</span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a><span class="fu">## Understanding the Three Constraints</span></span>
<span id="cb40-32"><a href="#cb40-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-33"><a href="#cb40-33" aria-hidden="true" tabindex="-1"></a>Every optimization navigates three competing constraints. Understanding why these constraints conflict helps you make better tradeoff decisions.</span>
<span id="cb40-34"><a href="#cb40-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-37"><a href="#cb40-37" aria-hidden="true" tabindex="-1"></a><span class="in">```{mermaid}</span></span>
<span id="cb40-38"><a href="#cb40-38" aria-hidden="true" tabindex="-1"></a>flowchart LR</span>
<span id="cb40-39"><a href="#cb40-39" aria-hidden="true" tabindex="-1"></a>    A[Memory] &lt;--&gt; B[Speed]</span>
<span id="cb40-40"><a href="#cb40-40" aria-hidden="true" tabindex="-1"></a>    B &lt;--&gt; C[Accuracy]</span>
<span id="cb40-41"><a href="#cb40-41" aria-hidden="true" tabindex="-1"></a>    C &lt;--&gt; A</span>
<span id="cb40-42"><a href="#cb40-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-43"><a href="#cb40-43" aria-hidden="true" tabindex="-1"></a>    style A fill:<span class="co">#e8f6e8</span></span>
<span id="cb40-44"><a href="#cb40-44" aria-hidden="true" tabindex="-1"></a>    style B fill:<span class="co">#e7f3ff</span></span>
<span id="cb40-45"><a href="#cb40-45" aria-hidden="true" tabindex="-1"></a>    style C fill:<span class="co">#fff8e1</span></span>
<span id="cb40-46"><a href="#cb40-46" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-47"><a href="#cb40-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-48"><a href="#cb40-48" aria-hidden="true" tabindex="-1"></a><span class="fu">### Memory vs Speed</span></span>
<span id="cb40-49"><a href="#cb40-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-50"><a href="#cb40-50" aria-hidden="true" tabindex="-1"></a>Block-wise computing divides matrices into smaller pieces to control memory usage. Smaller blocks mean lower peak memory—you can process datasets much larger than your RAM. But smaller blocks come with costs: more operations to combine results, more HDF5 reads/writes, more overhead from setup and coordination.</span>
<span id="cb40-51"><a href="#cb40-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-52"><a href="#cb40-52" aria-hidden="true" tabindex="-1"></a>Think of it like moving furniture. Disassembling a table into many small pieces lets you fit it through doorways (memory constraint), but assembly and disassembly take time (speed penalty). Keeping the table intact is faster but requires a truck large enough to carry it whole (memory requirement). The optimal approach depends on what size "truck" (RAM) you have available.</span>
<span id="cb40-53"><a href="#cb40-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-54"><a href="#cb40-54" aria-hidden="true" tabindex="-1"></a>Mathematically, if you double the number of blocks (k), you roughly halve peak memory usage but may increase computation time by 20-50% depending on the operation. For pure computation (matrix multiplication, SVD), the overhead is lower. For I/O-heavy operations (reading data, writing results), overhead dominates.</span>
<span id="cb40-55"><a href="#cb40-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-56"><a href="#cb40-56" aria-hidden="true" tabindex="-1"></a><span class="fu">### Speed vs Accuracy</span></span>
<span id="cb40-57"><a href="#cb40-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-58"><a href="#cb40-58" aria-hidden="true" tabindex="-1"></a>Some algorithms offer approximate solutions faster than exact solutions. Block-wise SVD, for example, can compute fewer iterations to converge faster, accepting slightly lower precision in singular values. For exploratory data analysis—visualizing principal components, identifying outliers, getting a general sense of data structure—high precision matters less than rapid iteration. You're happy with "close enough" if it lets you test ten parameter combinations instead of one.</span>
<span id="cb40-59"><a href="#cb40-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-60"><a href="#cb40-60" aria-hidden="true" tabindex="-1"></a>For publication-quality results, accuracy cannot be compromised. The difference between a singular value of 42.157 and 42.154 might seem trivial, but reviewers and reproducibility standards demand exact, verifiable computations. In these cases, you accept longer computation times to guarantee numerical precision.</span>
<span id="cb40-61"><a href="#cb40-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-62"><a href="#cb40-62" aria-hidden="true" tabindex="-1"></a>BigDataStatMeth defaults to conservative, accurate algorithms. When speed matters more than the last decimal place, you can adjust—but always verify results remain scientifically valid for your purposes.</span>
<span id="cb40-63"><a href="#cb40-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-64"><a href="#cb40-64" aria-hidden="true" tabindex="-1"></a><span class="fu">### Memory vs Accuracy</span></span>
<span id="cb40-65"><a href="#cb40-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-66"><a href="#cb40-66" aria-hidden="true" tabindex="-1"></a>This constraint is subtler and less obvious. Extreme block sizes can affect numerical stability. Very small blocks (dozens of rows) may create ill-conditioned subproblems—matrices where numerical algorithms struggle with rounding errors. Very large blocks approaching memory limits may cause intermittent failures when memory fragmentation prevents allocation despite "enough" RAM theoretically existing.</span>
<span id="cb40-67"><a href="#cb40-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-68"><a href="#cb40-68" aria-hidden="true" tabindex="-1"></a>The practical guidance: stay in reasonable ranges. Blocks with 1,000-10,000 rows typically work well. Below 500 rows per block, watch for numerical warnings. Above 50,000 rows per block, ensure you have substantial memory headroom. BigDataStatMeth's algorithms handle edge cases, but respecting these guidelines avoids potential issues.</span>
<span id="cb40-69"><a href="#cb40-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-70"><a href="#cb40-70" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb40-71"><a href="#cb40-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-72"><a href="#cb40-72" aria-hidden="true" tabindex="-1"></a><span class="fu">## Quick Start: Decision Tree</span></span>
<span id="cb40-73"><a href="#cb40-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-74"><a href="#cb40-74" aria-hidden="true" tabindex="-1"></a>Before diving into theory, here's a practical decision tree for choosing starting configurations. These values aren't optimal—they're reasonable starting points based on common scenarios. Always profile and tune for your specific case.</span>
<span id="cb40-75"><a href="#cb40-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-78"><a href="#cb40-78" aria-hidden="true" tabindex="-1"></a><span class="in">```{mermaid}</span></span>
<span id="cb40-79"><a href="#cb40-79" aria-hidden="true" tabindex="-1"></a>flowchart TD</span>
<span id="cb40-80"><a href="#cb40-80" aria-hidden="true" tabindex="-1"></a>    Start[Start: Choose Configuration] --&gt; DataSize{Dataset Size?}</span>
<span id="cb40-81"><a href="#cb40-81" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-82"><a href="#cb40-82" aria-hidden="true" tabindex="-1"></a>    DataSize --&gt;|&lt; <span class="dv">10</span> GB| Small[Small Dataset]</span>
<span id="cb40-83"><a href="#cb40-83" aria-hidden="true" tabindex="-1"></a>    DataSize --&gt;|<span class="dv">10-100</span> GB| Medium[Medium Dataset]</span>
<span id="cb40-84"><a href="#cb40-84" aria-hidden="true" tabindex="-1"></a>    DataSize --&gt;|&gt; <span class="dv">100</span> GB| Large[Large Dataset]</span>
<span id="cb40-85"><a href="#cb40-85" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-86"><a href="#cb40-86" aria-hidden="true" tabindex="-1"></a>    Small --&gt; SmallMem{Available RAM?}</span>
<span id="cb40-87"><a href="#cb40-87" aria-hidden="true" tabindex="-1"></a>    SmallMem --&gt;|&gt; <span class="dv">16</span> GB| SmallConfig[k=<span class="dv">2</span>, q=<span class="dv">1</span>&lt;br/&gt;threads=<span class="dv">4</span>]</span>
<span id="cb40-88"><a href="#cb40-88" aria-hidden="true" tabindex="-1"></a>    SmallMem --&gt;|&lt; <span class="dv">16</span> GB| SmallConfigMem[k=<span class="dv">4</span>, q=<span class="dv">1</span>&lt;br/&gt;threads=<span class="dv">2</span>]</span>
<span id="cb40-89"><a href="#cb40-89" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-90"><a href="#cb40-90" aria-hidden="true" tabindex="-1"></a>    Medium --&gt; MediumMem{Available RAM?}</span>
<span id="cb40-91"><a href="#cb40-91" aria-hidden="true" tabindex="-1"></a>    MediumMem --&gt;|&gt; <span class="dv">32</span> GB| MediumConfig[k=<span class="dv">4</span>, q=<span class="dv">1</span>&lt;br/&gt;threads=<span class="dv">8</span>]</span>
<span id="cb40-92"><a href="#cb40-92" aria-hidden="true" tabindex="-1"></a>    MediumMem --&gt;|<span class="dv">16-32</span> GB| MediumConfigMed[k=<span class="dv">8</span>, q=<span class="dv">1</span>&lt;br/&gt;threads=<span class="dv">4</span>]</span>
<span id="cb40-93"><a href="#cb40-93" aria-hidden="true" tabindex="-1"></a>    MediumMem --&gt;|&lt; <span class="dv">16</span> GB| MediumConfigLow[k=<span class="dv">16</span>, q=<span class="dv">2</span>&lt;br/&gt;threads=<span class="dv">2</span>]</span>
<span id="cb40-94"><a href="#cb40-94" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-95"><a href="#cb40-95" aria-hidden="true" tabindex="-1"></a>    Large --&gt; LargeMem{Available RAM?}</span>
<span id="cb40-96"><a href="#cb40-96" aria-hidden="true" tabindex="-1"></a>    LargeMem --&gt;|&gt; <span class="dv">64</span> GB| LargeConfig[k=<span class="dv">8</span>, q=<span class="dv">2</span>&lt;br/&gt;threads=<span class="dv">8</span>]</span>
<span id="cb40-97"><a href="#cb40-97" aria-hidden="true" tabindex="-1"></a>    LargeMem --&gt;|&lt; <span class="dv">64</span> GB| LargeConfigMem[k=<span class="dv">32</span>, q=<span class="dv">2</span>&lt;br/&gt;threads=<span class="dv">4</span>]</span>
<span id="cb40-98"><a href="#cb40-98" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-99"><a href="#cb40-99" aria-hidden="true" tabindex="-1"></a>    SmallConfig --&gt; Profile[Profile &amp; Tune Iteratively]</span>
<span id="cb40-100"><a href="#cb40-100" aria-hidden="true" tabindex="-1"></a>    SmallConfigMem --&gt; Profile</span>
<span id="cb40-101"><a href="#cb40-101" aria-hidden="true" tabindex="-1"></a>    MediumConfig --&gt; Profile</span>
<span id="cb40-102"><a href="#cb40-102" aria-hidden="true" tabindex="-1"></a>    MediumConfigMed --&gt; Profile</span>
<span id="cb40-103"><a href="#cb40-103" aria-hidden="true" tabindex="-1"></a>    MediumConfigLow --&gt; Profile</span>
<span id="cb40-104"><a href="#cb40-104" aria-hidden="true" tabindex="-1"></a>    LargeConfig --&gt; Profile</span>
<span id="cb40-105"><a href="#cb40-105" aria-hidden="true" tabindex="-1"></a>    LargeConfigMem --&gt; Profile</span>
<span id="cb40-106"><a href="#cb40-106" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-107"><a href="#cb40-107" aria-hidden="true" tabindex="-1"></a>    style Start fill:<span class="co">#f0f8ff</span></span>
<span id="cb40-108"><a href="#cb40-108" aria-hidden="true" tabindex="-1"></a>    style Profile fill:<span class="co">#e8f6e8</span></span>
<span id="cb40-109"><a href="#cb40-109" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-110"><a href="#cb40-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-111"><a href="#cb40-111" aria-hidden="true" tabindex="-1"></a>**How to use this tree:**</span>
<span id="cb40-112"><a href="#cb40-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-113"><a href="#cb40-113" aria-hidden="true" tabindex="-1"></a>Start by estimating your dataset size in GB: <span class="in">`(rows × cols × 8 bytes) / (1024^3)`</span>. Then follow the tree based on your available RAM. The resulting k, q, and threads values are starting points—safe configurations unlikely to crash but not necessarily optimal. After establishing this baseline, profile to identify bottlenecks and tune iteratively.</span>
<span id="cb40-114"><a href="#cb40-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-115"><a href="#cb40-115" aria-hidden="true" tabindex="-1"></a>For example, if you have a 50GB dataset and 32GB RAM, the tree suggests k=8, q=1, threads=8. This configuration splits data into 8 blocks (each ~6.25GB), processes in a single hierarchy level, and uses 8 threads. Peak memory usage will be roughly 8-10GB (safe for 32GB RAM), and 8 threads should parallelize well on modern CPUs. But your specific data might benefit from k=4 (fewer blocks, faster) or k=16 (more blocks if memory pressure appears). The tree gets you started; profiling reveals improvements.</span>
<span id="cb40-116"><a href="#cb40-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-117"><a href="#cb40-117" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb40-118"><a href="#cb40-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-119"><a href="#cb40-119" aria-hidden="true" tabindex="-1"></a><span class="fu">## Key Parameters Deep Dive</span></span>
<span id="cb40-120"><a href="#cb40-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-121"><a href="#cb40-121" aria-hidden="true" tabindex="-1"></a><span class="fu">### Block Size: The k Parameter</span></span>
<span id="cb40-122"><a href="#cb40-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-123"><a href="#cb40-123" aria-hidden="true" tabindex="-1"></a>The k parameter fundamentally controls BigDataStatMeth's memory-speed tradeoff. Understanding k deeply helps you tune confidently.</span>
<span id="cb40-124"><a href="#cb40-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-125"><a href="#cb40-125" aria-hidden="true" tabindex="-1"></a>**What k does mechanically:** For a matrix with n rows, setting k=4 creates 4 blocks of approximately n/4 rows each (the last block may be slightly larger if n doesn't divide evenly). Each block is processed sequentially or in parallel depending on the operation. Results from blocks are combined—summed, stacked, or merged—to produce final output.</span>
<span id="cb40-126"><a href="#cb40-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-127"><a href="#cb40-127" aria-hidden="true" tabindex="-1"></a>**Memory impact:** Peak memory usage equals approximately the size of the largest block plus overhead for intermediate results. If your matrix is 100,000 rows × 20,000 columns (16GB), setting k=4 creates blocks of ~25,000 × 20,000 (4GB each). Peak usage will be roughly 5-6GB (one block + overhead). Doubling k to 8 halves block size to 2GB and reduces peak memory to 3-4GB. This linear relationship makes memory management straightforward: if hitting memory limits, double k.</span>
<span id="cb40-128"><a href="#cb40-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-129"><a href="#cb40-129" aria-hidden="true" tabindex="-1"></a>**Speed impact:** More blocks mean more operations. Consider matrix multiplication: A × B with A split into 4 blocks requires 4 block multiplications then combining results. With 8 blocks, you need 8 block multiplications. Pure computation time increases roughly linearly with k. But I/O time (reading from HDF5, writing results) also increases—more blocks mean more separate read/write operations, each with overhead. For operations where I/O dominates (simple additions, subtractions), doubling k might increase total time by 80-100%. For computation-heavy operations (SVD, matrix inversion), time increases by 20-40%.</span>
<span id="cb40-130"><a href="#cb40-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-131"><a href="#cb40-131" aria-hidden="true" tabindex="-1"></a>**Choosing k strategically:**</span>
<span id="cb40-132"><a href="#cb40-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-133"><a href="#cb40-133" aria-hidden="true" tabindex="-1"></a>Start with this formula:</span>
<span id="cb40-134"><a href="#cb40-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-135"><a href="#cb40-135" aria-hidden="true" tabindex="-1"></a><span class="in">```r</span></span>
<span id="cb40-136"><a href="#cb40-136" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate reasonable k based on available memory</span></span>
<span id="cb40-137"><a href="#cb40-137" aria-hidden="true" tabindex="-1"></a>dataset_size_gb <span class="ot">&lt;-</span> (n_rows <span class="sc">*</span> n_cols <span class="sc">*</span> <span class="dv">8</span>) <span class="sc">/</span> (<span class="dv">1024</span><span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb40-138"><a href="#cb40-138" aria-hidden="true" tabindex="-1"></a>available_gb <span class="ot">&lt;-</span> <span class="dv">16</span>  <span class="co"># Your available RAM</span></span>
<span id="cb40-139"><a href="#cb40-139" aria-hidden="true" tabindex="-1"></a>safety_factor <span class="ot">&lt;-</span> <span class="fl">0.7</span>  <span class="co"># Use 70% of available RAM (headroom for overhead)</span></span>
<span id="cb40-140"><a href="#cb40-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-141"><a href="#cb40-141" aria-hidden="true" tabindex="-1"></a>k_minimum <span class="ot">&lt;-</span> <span class="fu">ceiling</span>(dataset_size_gb <span class="sc">/</span> (available_gb <span class="sc">*</span> safety_factor))</span>
<span id="cb40-142"><a href="#cb40-142" aria-hidden="true" tabindex="-1"></a>k_safe <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="dv">2</span>, k_minimum)  <span class="co"># Never use k=1 (no blocking benefits)</span></span>
<span id="cb40-143"><a href="#cb40-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-144"><a href="#cb40-144" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Recommended k:"</span>, k_safe, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-145"><a href="#cb40-145" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-146"><a href="#cb40-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-147"><a href="#cb40-147" aria-hidden="true" tabindex="-1"></a>This formula ensures your blocks fit comfortably in memory. But you might adjust:</span>
<span id="cb40-148"><a href="#cb40-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-149"><a href="#cb40-149" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**If memory is abundant:** Reduce k below the calculated value for speed</span>
<span id="cb40-150"><a href="#cb40-150" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**If computation is very slow:** Try k/2 to reduce overhead (if memory allows)</span>
<span id="cb40-151"><a href="#cb40-151" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**If memory pressure appears:** Increase k to provide more headroom</span>
<span id="cb40-152"><a href="#cb40-152" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**If using many threads:** Ensure k ≥ threads (otherwise threads sit idle)</span>
<span id="cb40-153"><a href="#cb40-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-154"><a href="#cb40-154" aria-hidden="true" tabindex="-1"></a>**Guidelines by use case:**</span>
<span id="cb40-155"><a href="#cb40-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-156"><a href="#cb40-156" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Scenario <span class="pp">|</span> Recommended k <span class="pp">|</span> Reasoning <span class="pp">|</span></span>
<span id="cb40-157"><a href="#cb40-157" aria-hidden="true" tabindex="-1"></a><span class="pp">|----------|---------------|-----------|</span></span>
<span id="cb40-158"><a href="#cb40-158" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Exploratory analysis, abundant RAM <span class="pp">|</span> k = 2-4 <span class="pp">|</span> Minimize overhead, iterate quickly <span class="pp">|</span></span>
<span id="cb40-159"><a href="#cb40-159" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Production analysis, moderate RAM <span class="pp">|</span> k = 8-16 <span class="pp">|</span> Balance memory safety and speed <span class="pp">|</span></span>
<span id="cb40-160"><a href="#cb40-160" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Memory-constrained server <span class="pp">|</span> k = 16-32 <span class="pp">|</span> Guarantee successful completion <span class="pp">|</span></span>
<span id="cb40-161"><a href="#cb40-161" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Repeated analysis on same data <span class="pp">|</span> k = 4-8 <span class="pp">|</span> Moderate value, tune based on profiling <span class="pp">|</span></span>
<span id="cb40-162"><a href="#cb40-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-163"><a href="#cb40-163" aria-hidden="true" tabindex="-1"></a>Remember: these are starting points. Profile your actual workflow to find your optimal k.</span>
<span id="cb40-164"><a href="#cb40-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-165"><a href="#cb40-165" aria-hidden="true" tabindex="-1"></a><span class="fu">### Hierarchy Levels: The q Parameter</span></span>
<span id="cb40-166"><a href="#cb40-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-167"><a href="#cb40-167" aria-hidden="true" tabindex="-1"></a>The q parameter controls hierarchy depth in multi-level algorithms, primarily block-wise SVD. Understanding when hierarchy helps requires grasping how block results combine.</span>
<span id="cb40-168"><a href="#cb40-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-169"><a href="#cb40-169" aria-hidden="true" tabindex="-1"></a>**Single-level (q=1) approach:** Compute SVD on each of k blocks independently, producing k sets of singular vectors. Then combine all k results simultaneously—stack the k vectors, compute SVD of the combined matrix. This final SVD operates on a k×p matrix where p is the number of retained components. For k=8 and p=50, the final SVD processes an 8×50 matrix—tiny, fast.</span>
<span id="cb40-170"><a href="#cb40-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-171"><a href="#cb40-171" aria-hidden="true" tabindex="-1"></a>**Two-level (q=2) approach:** Compute SVD on each of k blocks (first level). Group results into pairs or quadruplets, compute SVD on each group (second level). Finally, combine group results (top level). For k=16, first level produces 16 results, second level combines these into 4 intermediate results, top level combines those 4 into final output.</span>
<span id="cb40-172"><a href="#cb40-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-173"><a href="#cb40-173" aria-hidden="true" tabindex="-1"></a>**When does hierarchy help?**</span>
<span id="cb40-174"><a href="#cb40-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-175"><a href="#cb40-175" aria-hidden="true" tabindex="-1"></a>Hierarchy reduces peak memory during combination. With q=1 and k=32, combining 32 results simultaneously might require substantial memory—allocating arrays for 32 matrices, stacking them, computing SVD. With q=2, you combine 32 results in groups of 4 (8 groups), then combine 8 intermediate results—peak memory is lower because you never hold all 32 original results simultaneously.</span>
<span id="cb40-176"><a href="#cb40-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-177"><a href="#cb40-177" aria-hidden="true" tabindex="-1"></a>The cost: more intermediate operations. Two-level hierarchy does roughly 1.3-1.5× as much computation as single-level. Three-level increases this to 1.5-2×. Unless memory-constrained, extra computation isn't worthwhile.</span>
<span id="cb40-178"><a href="#cb40-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-179"><a href="#cb40-179" aria-hidden="true" tabindex="-1"></a>**Decision guide:**</span>
<span id="cb40-180"><a href="#cb40-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-181"><a href="#cb40-181" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**q=1:** Default for k ≤ 8, or when memory isn't limiting</span>
<span id="cb40-182"><a href="#cb40-182" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**q=2:** Use when k &gt; 8 AND memory is tight (less than 2× block size available)</span>
<span id="cb40-183"><a href="#cb40-183" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**q&gt;2:** Rarely needed; only for extreme cases with k &gt; 32 and severe memory limits</span>
<span id="cb40-184"><a href="#cb40-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-185"><a href="#cb40-185" aria-hidden="true" tabindex="-1"></a>Example decision: You have k=16 blocks and 16GB RAM. Each block uses ~3GB. With q=1, combining 16 results needs perhaps 6GB peak (manageable). With q=2, peak is ~4GB (safer but slower). If your system has 32GB RAM, q=1 is fine—extra headroom makes hierarchy unnecessary. If RAM is exactly 16GB and other processes use 8GB, q=2 provides safety margin.</span>
<span id="cb40-186"><a href="#cb40-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-187"><a href="#cb40-187" aria-hidden="true" tabindex="-1"></a><span class="fu">### Thread Count: Parallel Processing</span></span>
<span id="cb40-188"><a href="#cb40-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-189"><a href="#cb40-189" aria-hidden="true" tabindex="-1"></a>Threading enables processing multiple blocks simultaneously, dramatically reducing wall-clock time. But effective threading requires understanding both software parallelism and hardware limitations.</span>
<span id="cb40-190"><a href="#cb40-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-191"><a href="#cb40-191" aria-hidden="true" tabindex="-1"></a>**How BigDataStatMeth uses threads:** When you specify threads=4, eligible operations distribute work across 4 CPU cores. For block-wise operations, different blocks compute in parallel—while core 1 processes block 1, core 2 handles block 2, etc. For matrix operations using BLAS/LAPACK (multiplication, decompositions), underlying libraries may parallelize internally. Not all operations parallelize equally: some are inherently sequential, others embarrassingly parallel.</span>
<span id="cb40-192"><a href="#cb40-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-193"><a href="#cb40-193" aria-hidden="true" tabindex="-1"></a>**Why more threads isn't always better:**</span>
<span id="cb40-194"><a href="#cb40-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-195"><a href="#cb40-195" aria-hidden="true" tabindex="-1"></a>This is crucial to understand. Adding threads only helps when:</span>
<span id="cb40-196"><a href="#cb40-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-197"><a href="#cb40-197" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Operations are parallelizable:** Sequential algorithms gain nothing from threads</span>
<span id="cb40-198"><a href="#cb40-198" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Enough independent work exists:** With k=4 blocks and threads=8, 4 threads sit idle</span>
<span id="cb40-199"><a href="#cb40-199" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Computation dominates I/O:** If most time is disk access, parallel computation doesn't help</span>
<span id="cb40-200"><a href="#cb40-200" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Memory bandwidth suffices:** Multiple cores reading simultaneously can saturate bandwidth</span>
<span id="cb40-201"><a href="#cb40-201" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>**CPU cores are available:** Oversubscription (more threads than cores) causes thrashing</span>
<span id="cb40-202"><a href="#cb40-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-203"><a href="#cb40-203" aria-hidden="true" tabindex="-1"></a>**Understanding bottlenecks:** Three fundamental bottlenecks limit threading efficiency:</span>
<span id="cb40-204"><a href="#cb40-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-205"><a href="#cb40-205" aria-hidden="true" tabindex="-1"></a>**I/O Bottleneck:** Hard drives (even SSDs) have finite bandwidth. If 4 threads each try to read 1GB/second from a disk with 2GB/second total bandwidth, they compete—each gets only 500MB/second. Adding more threads doesn't increase total bandwidth; it just divides it further. This is why simple operations (addition, scaling) often show poor threading efficiency—computation is fast, but reading data from HDF5 is slow. All threads wait for I/O.</span>
<span id="cb40-206"><a href="#cb40-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-207"><a href="#cb40-207" aria-hidden="true" tabindex="-1"></a>**Memory Bandwidth Bottleneck:** Modern CPUs are fast, but RAM is comparatively slow. If 8 threads each try to read 8GB/second from RAM with 25GB/second total bandwidth, they get ~3GB/second each—less than needed. Memory-intensive operations (large matrix multiplications, cache-unfriendly access patterns) can saturate memory bandwidth. Adding more threads can actually slow things down by increasing cache misses and memory contention.</span>
<span id="cb40-208"><a href="#cb40-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-209"><a href="#cb40-209" aria-hidden="true" tabindex="-1"></a>**Amdahl's Law (Inherent Sequentiality):** Some parts of algorithms cannot parallelize. If 20% of your computation is inherently sequential, maximum possible speedup is 5× regardless of thread count. With 4 threads, you might achieve 3.2× speedup (80% of theoretical maximum). With 8 threads, maybe 3.8× speedup—adding 4 threads gave only 0.6× improvement because sequential portions dominate.</span>
<span id="cb40-210"><a href="#cb40-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-211"><a href="#cb40-211" aria-hidden="true" tabindex="-1"></a>**Measuring threading efficiency:**</span>
<span id="cb40-212"><a href="#cb40-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-213"><a href="#cb40-213" aria-hidden="true" tabindex="-1"></a><span class="in">```r</span></span>
<span id="cb40-214"><a href="#cb40-214" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(microbenchmark)</span>
<span id="cb40-215"><a href="#cb40-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-216"><a href="#cb40-216" aria-hidden="true" tabindex="-1"></a><span class="co"># Measure speedup with different thread counts</span></span>
<span id="cb40-217"><a href="#cb40-217" aria-hidden="true" tabindex="-1"></a>mb <span class="ot">&lt;-</span> <span class="fu">microbenchmark</span>(</span>
<span id="cb40-218"><a href="#cb40-218" aria-hidden="true" tabindex="-1"></a>  <span class="at">t1 =</span> <span class="fu">bdSVD_hdf5</span>(<span class="st">"data.hdf5"</span>, <span class="st">"data"</span>, <span class="st">"matrix"</span>, <span class="at">k=</span><span class="dv">8</span>, <span class="at">threads=</span><span class="dv">1</span>),</span>
<span id="cb40-219"><a href="#cb40-219" aria-hidden="true" tabindex="-1"></a>  <span class="at">t2 =</span> <span class="fu">bdSVD_hdf5</span>(<span class="st">"data.hdf5"</span>, <span class="st">"data"</span>, <span class="st">"matrix"</span>, <span class="at">k=</span><span class="dv">8</span>, <span class="at">threads=</span><span class="dv">2</span>),</span>
<span id="cb40-220"><a href="#cb40-220" aria-hidden="true" tabindex="-1"></a>  <span class="at">t4 =</span> <span class="fu">bdSVD_hdf5</span>(<span class="st">"data.hdf5"</span>, <span class="st">"data"</span>, <span class="st">"matrix"</span>, <span class="at">k=</span><span class="dv">8</span>, <span class="at">threads=</span><span class="dv">4</span>),</span>
<span id="cb40-221"><a href="#cb40-221" aria-hidden="true" tabindex="-1"></a>  <span class="at">t8 =</span> <span class="fu">bdSVD_hdf5</span>(<span class="st">"data.hdf5"</span>, <span class="st">"data"</span>, <span class="st">"matrix"</span>, <span class="at">k=</span><span class="dv">8</span>, <span class="at">threads=</span><span class="dv">8</span>),</span>
<span id="cb40-222"><a href="#cb40-222" aria-hidden="true" tabindex="-1"></a>  <span class="at">times =</span> <span class="dv">3</span></span>
<span id="cb40-223"><a href="#cb40-223" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-224"><a href="#cb40-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-225"><a href="#cb40-225" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate speedup and efficiency</span></span>
<span id="cb40-226"><a href="#cb40-226" aria-hidden="true" tabindex="-1"></a>times <span class="ot">&lt;-</span> <span class="fu">summary</span>(mb)<span class="sc">$</span>median</span>
<span id="cb40-227"><a href="#cb40-227" aria-hidden="true" tabindex="-1"></a>speedup <span class="ot">&lt;-</span> times[<span class="dv">1</span>] <span class="sc">/</span> times</span>
<span id="cb40-228"><a href="#cb40-228" aria-hidden="true" tabindex="-1"></a>efficiency <span class="ot">&lt;-</span> speedup <span class="sc">/</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">8</span>)</span>
<span id="cb40-229"><a href="#cb40-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-230"><a href="#cb40-230" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">data.frame</span>(</span>
<span id="cb40-231"><a href="#cb40-231" aria-hidden="true" tabindex="-1"></a>  <span class="at">threads =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">8</span>),</span>
<span id="cb40-232"><a href="#cb40-232" aria-hidden="true" tabindex="-1"></a>  <span class="at">time_sec =</span> <span class="fu">round</span>(times, <span class="dv">2</span>),</span>
<span id="cb40-233"><a href="#cb40-233" aria-hidden="true" tabindex="-1"></a>  <span class="at">speedup =</span> <span class="fu">round</span>(speedup, <span class="dv">2</span>),</span>
<span id="cb40-234"><a href="#cb40-234" aria-hidden="true" tabindex="-1"></a>  <span class="at">efficiency =</span> <span class="fu">round</span>(efficiency, <span class="dv">2</span>)</span>
<span id="cb40-235"><a href="#cb40-235" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb40-236"><a href="#cb40-236" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-237"><a href="#cb40-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-238"><a href="#cb40-238" aria-hidden="true" tabindex="-1"></a>**Interpreting efficiency:**</span>
<span id="cb40-239"><a href="#cb40-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-240"><a href="#cb40-240" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**90-100% efficiency:** Ideal scaling, rare in practice</span>
<span id="cb40-241"><a href="#cb40-241" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**70-90% efficiency:** Excellent scaling, computation dominates</span>
<span id="cb40-242"><a href="#cb40-242" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**50-70% efficiency:** Good scaling, acceptable for most use cases</span>
<span id="cb40-243"><a href="#cb40-243" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**30-50% efficiency:** Moderate scaling, likely hitting I/O or memory bandwidth</span>
<span id="cb40-244"><a href="#cb40-244" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**&lt;30% efficiency:** Poor scaling, fundamental bottleneck exists</span>
<span id="cb40-245"><a href="#cb40-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-246"><a href="#cb40-246" aria-hidden="true" tabindex="-1"></a>If you see 4 threads achieving only 1.5× speedup (37% efficiency), investigate:</span>
<span id="cb40-247"><a href="#cb40-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-248"><a href="#cb40-248" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Is operation I/O-heavy? (Check if system time &gt;&gt; user time)</span>
<span id="cb40-249"><a href="#cb40-249" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Is memory bandwidth saturated? (Monitor with tools like <span class="in">`htop`</span> or <span class="in">`iostat`</span>)</span>
<span id="cb40-250"><a href="#cb40-250" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Is BLAS library already parallel? (Check with <span class="in">`sessionInfo()`</span>)</span>
<span id="cb40-251"><a href="#cb40-251" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Are blocks too small? (Very small blocks have high overhead relative to computation)</span>
<span id="cb40-252"><a href="#cb40-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-253"><a href="#cb40-253" aria-hidden="true" tabindex="-1"></a>**Practical thread guidelines:**</span>
<span id="cb40-254"><a href="#cb40-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-255"><a href="#cb40-255" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Hardware <span class="pp">|</span> Recommended Threads <span class="pp">|</span> Notes <span class="pp">|</span></span>
<span id="cb40-256"><a href="#cb40-256" aria-hidden="true" tabindex="-1"></a><span class="pp">|----------|-------------------|--------|</span></span>
<span id="cb40-257"><a href="#cb40-257" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Laptop (4 cores) <span class="pp">|</span> threads = 2-4 <span class="pp">|</span> Use all cores unless thermal throttling appears <span class="pp">|</span></span>
<span id="cb40-258"><a href="#cb40-258" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Workstation (8-16 cores) <span class="pp">|</span> threads = 4-8 <span class="pp">|</span> Start with half, increase if efficiency good <span class="pp">|</span></span>
<span id="cb40-259"><a href="#cb40-259" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Shared server (32+ cores) <span class="pp">|</span> threads = n_cores / n_users <span class="pp">|</span> Be considerate of others <span class="pp">|</span></span>
<span id="cb40-260"><a href="#cb40-260" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Cloud instance (variable) <span class="pp">|</span> threads = physical_cores <span class="pp">|</span> Avoid hyperthreads for consistency <span class="pp">|</span></span>
<span id="cb40-261"><a href="#cb40-261" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> High-memory, low-core <span class="pp">|</span> threads = n_cores <span class="pp">|</span> CPU-bound, use all available <span class="pp">|</span></span>
<span id="cb40-262"><a href="#cb40-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-263"><a href="#cb40-263" aria-hidden="true" tabindex="-1"></a>**BLAS library interaction:**</span>
<span id="cb40-264"><a href="#cb40-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-265"><a href="#cb40-265" aria-hidden="true" tabindex="-1"></a>BigDataStatMeth uses BLAS/LAPACK for matrix operations. Some BLAS implementations (Intel MKL, OpenBLAS) are multi-threaded by default. If BLAS uses 4 threads and you specify threads=4, you may have 16 total threads (4 × 4), causing oversubscription.</span>
<span id="cb40-266"><a href="#cb40-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-267"><a href="#cb40-267" aria-hidden="true" tabindex="-1"></a>Check BLAS configuration:</span>
<span id="cb40-268"><a href="#cb40-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-269"><a href="#cb40-269" aria-hidden="true" tabindex="-1"></a><span class="in">```r</span></span>
<span id="cb40-270"><a href="#cb40-270" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span>
<span id="cb40-271"><a href="#cb40-271" aria-hidden="true" tabindex="-1"></a><span class="co"># Look for BLAS/LAPACK implementation</span></span>
<span id="cb40-272"><a href="#cb40-272" aria-hidden="true" tabindex="-1"></a><span class="co"># If using OpenBLAS or MKL, they may be threaded</span></span>
<span id="cb40-273"><a href="#cb40-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-274"><a href="#cb40-274" aria-hidden="true" tabindex="-1"></a><span class="co"># Limit BLAS threads if needed (Linux/Mac)</span></span>
<span id="cb40-275"><a href="#cb40-275" aria-hidden="true" tabindex="-1"></a><span class="fu">Sys.setenv</span>(<span class="at">OPENBLAS_NUM_THREADS =</span> <span class="dv">1</span>)</span>
<span id="cb40-276"><a href="#cb40-276" aria-hidden="true" tabindex="-1"></a><span class="fu">Sys.setenv</span>(<span class="at">MKL_NUM_THREADS =</span> <span class="dv">1</span>)</span>
<span id="cb40-277"><a href="#cb40-277" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-278"><a href="#cb40-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-279"><a href="#cb40-279" aria-hidden="true" tabindex="-1"></a>If BLAS is single-threaded (reference BLAS), BigDataStatMeth's threading provides all parallelism. If BLAS is multi-threaded, consider reducing BigDataStatMeth threads to avoid oversubscription.</span>
<span id="cb40-280"><a href="#cb40-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-281"><a href="#cb40-281" aria-hidden="true" tabindex="-1"></a><span class="fu">### HDF5 Chunk Size</span></span>
<span id="cb40-282"><a href="#cb40-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-283"><a href="#cb40-283" aria-hidden="true" tabindex="-1"></a>HDF5 stores data in chunks—contiguous blocks on disk. Chunk size dramatically affects I/O performance but is set when creating datasets, not when computing. If you control dataset creation (via <span class="in">`bdCreate_hdf5_matrix`</span>), chunk size becomes a key optimization lever.</span>
<span id="cb40-284"><a href="#cb40-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-285"><a href="#cb40-285" aria-hidden="true" tabindex="-1"></a>**How chunking affects I/O:** When you read a single element from HDF5, the entire chunk containing it loads into memory. Read 100 elements scattered across 100 different chunks, and HDF5 performs 100 disk seeks, loading 100 chunks. Read 100 elements all in one chunk, and HDF5 performs 1 disk seek, loading 1 chunk. Sequential access to well-chunked data is fast; random access to poorly-chunked data is slow.</span>
<span id="cb40-286"><a href="#cb40-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-287"><a href="#cb40-287" aria-hidden="true" tabindex="-1"></a>**BigDataStatMeth access patterns:**</span>
<span id="cb40-288"><a href="#cb40-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-289"><a href="#cb40-289" aria-hidden="true" tabindex="-1"></a>Most BigDataStatMeth operations access data in rectangular blocks—reading several rows and all columns, or all rows and several columns. Optimal chunking aligns chunks with typical access blocks.</span>
<span id="cb40-290"><a href="#cb40-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-291"><a href="#cb40-291" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Row-wise operations** (processing samples): Chunk by rows. If reading 1,000 rows at a time, chunk size ~1,000 rows × all columns</span>
<span id="cb40-292"><a href="#cb40-292" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Column-wise operations** (processing features): Chunk by columns. If reading 100 columns at a time, chunk size ~all rows × 100 columns</span>
<span id="cb40-293"><a href="#cb40-293" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Block operations** (typical for BigDataStatMeth): Square-ish chunks work well. For 100,000 × 10,000 matrix read in blocks of 10,000 × 10,000, use 10,000 × 10,000 chunks</span>
<span id="cb40-294"><a href="#cb40-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-295"><a href="#cb40-295" aria-hidden="true" tabindex="-1"></a>**Chunk size guidelines:**</span>
<span id="cb40-296"><a href="#cb40-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-297"><a href="#cb40-297" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Target 1-10 MB chunks:** Very small chunks (&lt;100 KB) have excessive overhead. Very large chunks (&gt;100 MB) waste space and time loading unused data.</span>
<span id="cb40-298"><a href="#cb40-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-299"><a href="#cb40-299" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Match access pattern:** If you always read full rows, make chunks span full rows. If you read columns, span full columns.</span>
<span id="cb40-300"><a href="#cb40-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-301"><a href="#cb40-301" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Consider compression:** Larger chunks compress better (more data for compression algorithms to find patterns). If using compression, prefer larger chunks (5-10 MB).</span>
<span id="cb40-302"><a href="#cb40-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-303"><a href="#cb40-303" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Balance with cache:** Chunks should fit comfortably in CPU cache (L3 cache often 8-16 MB). Chunks larger than cache cause cache thrashing.</span>
<span id="cb40-304"><a href="#cb40-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-305"><a href="#cb40-305" aria-hidden="true" tabindex="-1"></a>**Example chunking decisions:**</span>
<span id="cb40-306"><a href="#cb40-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-307"><a href="#cb40-307" aria-hidden="true" tabindex="-1"></a><span class="in">```r</span></span>
<span id="cb40-308"><a href="#cb40-308" aria-hidden="true" tabindex="-1"></a><span class="co"># Genomics: 50,000 samples × 500,000 SNPs</span></span>
<span id="cb40-309"><a href="#cb40-309" aria-hidden="true" tabindex="-1"></a><span class="co"># Typical access: process 5,000 samples at a time (row-wise)</span></span>
<span id="cb40-310"><a href="#cb40-310" aria-hidden="true" tabindex="-1"></a><span class="fu">bdCreate_hdf5_matrix</span>(</span>
<span id="cb40-311"><a href="#cb40-311" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> <span class="st">"genomics.hdf5"</span>,</span>
<span id="cb40-312"><a href="#cb40-312" aria-hidden="true" tabindex="-1"></a>  <span class="at">object =</span> genotype_matrix,</span>
<span id="cb40-313"><a href="#cb40-313" aria-hidden="true" tabindex="-1"></a>  <span class="at">group =</span> <span class="st">"data"</span>,</span>
<span id="cb40-314"><a href="#cb40-314" aria-hidden="true" tabindex="-1"></a>  <span class="at">dataset =</span> <span class="st">"snps"</span>,</span>
<span id="cb40-315"><a href="#cb40-315" aria-hidden="true" tabindex="-1"></a>  <span class="at">chunk_rows =</span> <span class="dv">5000</span>,      <span class="co"># Matches block size</span></span>
<span id="cb40-316"><a href="#cb40-316" aria-hidden="true" tabindex="-1"></a>  <span class="at">chunk_cols =</span> <span class="dv">500000</span>     <span class="co"># All columns</span></span>
<span id="cb40-317"><a href="#cb40-317" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-318"><a href="#cb40-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-319"><a href="#cb40-319" aria-hidden="true" tabindex="-1"></a><span class="co"># Gene expression: 100 samples × 20,000 genes</span></span>
<span id="cb40-320"><a href="#cb40-320" aria-hidden="true" tabindex="-1"></a><span class="co"># Typical access: analyze all samples for subset of genes (column-wise)</span></span>
<span id="cb40-321"><a href="#cb40-321" aria-hidden="true" tabindex="-1"></a><span class="fu">bdCreate_hdf5_matrix</span>(</span>
<span id="cb40-322"><a href="#cb40-322" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> <span class="st">"expression.hdf5"</span>,</span>
<span id="cb40-323"><a href="#cb40-323" aria-hidden="true" tabindex="-1"></a>  <span class="at">object =</span> expression_matrix,</span>
<span id="cb40-324"><a href="#cb40-324" aria-hidden="true" tabindex="-1"></a>  <span class="at">group =</span> <span class="st">"data"</span>,</span>
<span id="cb40-325"><a href="#cb40-325" aria-hidden="true" tabindex="-1"></a>  <span class="at">dataset =</span> <span class="st">"genes"</span>,</span>
<span id="cb40-326"><a href="#cb40-326" aria-hidden="true" tabindex="-1"></a>  <span class="at">chunk_rows =</span> <span class="dv">100</span>,       <span class="co"># All samples</span></span>
<span id="cb40-327"><a href="#cb40-327" aria-hidden="true" tabindex="-1"></a>  <span class="at">chunk_cols =</span> <span class="dv">2000</span>       <span class="co"># ~10 chunks column-wise</span></span>
<span id="cb40-328"><a href="#cb40-328" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-329"><a href="#cb40-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-330"><a href="#cb40-330" aria-hidden="true" tabindex="-1"></a><span class="co"># General matrix: 10,000 × 10,000</span></span>
<span id="cb40-331"><a href="#cb40-331" aria-hidden="true" tabindex="-1"></a><span class="co"># Typical access: square blocks</span></span>
<span id="cb40-332"><a href="#cb40-332" aria-hidden="true" tabindex="-1"></a><span class="fu">bdCreate_hdf5_matrix</span>(</span>
<span id="cb40-333"><a href="#cb40-333" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> <span class="st">"matrix.hdf5"</span>,</span>
<span id="cb40-334"><a href="#cb40-334" aria-hidden="true" tabindex="-1"></a>  <span class="at">object =</span> large_matrix,</span>
<span id="cb40-335"><a href="#cb40-335" aria-hidden="true" tabindex="-1"></a>  <span class="at">group =</span> <span class="st">"data"</span>,</span>
<span id="cb40-336"><a href="#cb40-336" aria-hidden="true" tabindex="-1"></a>  <span class="at">dataset =</span> <span class="st">"values"</span>,</span>
<span id="cb40-337"><a href="#cb40-337" aria-hidden="true" tabindex="-1"></a>  <span class="at">chunk_rows =</span> <span class="dv">1000</span>,      <span class="co"># Square chunks</span></span>
<span id="cb40-338"><a href="#cb40-338" aria-hidden="true" tabindex="-1"></a>  <span class="at">chunk_cols =</span> <span class="dv">1000</span>       <span class="co"># ~100 total chunks</span></span>
<span id="cb40-339"><a href="#cb40-339" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-340"><a href="#cb40-340" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-341"><a href="#cb40-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-342"><a href="#cb40-342" aria-hidden="true" tabindex="-1"></a>**When chunk size matters most:**</span>
<span id="cb40-343"><a href="#cb40-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-344"><a href="#cb40-344" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Very large datasets (&gt;10 GB) where I/O is significant fraction of time</span>
<span id="cb40-345"><a href="#cb40-345" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Repeated access to same data (poor chunking penalizes every access)</span>
<span id="cb40-346"><a href="#cb40-346" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Network storage (NFS, cloud) where disk seeks are expensive</span>
<span id="cb40-347"><a href="#cb40-347" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Compression enabled (larger chunks compress better)</span>
<span id="cb40-348"><a href="#cb40-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-349"><a href="#cb40-349" aria-hidden="true" tabindex="-1"></a>**When chunk size matters less:**</span>
<span id="cb40-350"><a href="#cb40-350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-351"><a href="#cb40-351" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Small datasets (&lt;1 GB) that fit entirely in cache</span>
<span id="cb40-352"><a href="#cb40-352" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Single-pass operations (read once, compute, done)</span>
<span id="cb40-353"><a href="#cb40-353" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Local SSD storage where seeks are cheap</span>
<span id="cb40-354"><a href="#cb40-354" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Computation-heavy operations where I/O is &lt;10% of time</span>
<span id="cb40-355"><a href="#cb40-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-356"><a href="#cb40-356" aria-hidden="true" tabindex="-1"></a>If profiling shows system time (I/O) is &gt;30% of elapsed time, investigate chunking. Otherwise, default chunking is likely fine.</span>
<span id="cb40-357"><a href="#cb40-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-358"><a href="#cb40-358" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb40-359"><a href="#cb40-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-360"><a href="#cb40-360" aria-hidden="true" tabindex="-1"></a><span class="fu">## Profiling: Finding the Bottleneck</span></span>
<span id="cb40-361"><a href="#cb40-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-362"><a href="#cb40-362" aria-hidden="true" tabindex="-1"></a>Before optimizing, you must identify where time actually goes. Optimizing the wrong part of your code wastes effort and provides minimal benefit. Profiling reveals the truth.</span>
<span id="cb40-363"><a href="#cb40-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-364"><a href="#cb40-364" aria-hidden="true" tabindex="-1"></a><span class="fu">### Why Profile First</span></span>
<span id="cb40-365"><a href="#cb40-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-366"><a href="#cb40-366" aria-hidden="true" tabindex="-1"></a>Intuition about bottlenecks is often wrong. You might assume SVD computation dominates, but profiling reveals 60% of time is normalization. You might think I/O is the problem, but profiling shows memory allocation overhead. Without measurement, optimization is guesswork.</span>
<span id="cb40-367"><a href="#cb40-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-368"><a href="#cb40-368" aria-hidden="true" tabindex="-1"></a>The profiling workflow:</span>
<span id="cb40-369"><a href="#cb40-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-370"><a href="#cb40-370" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Establish baseline:** Run with conservative parameters, measure total time</span>
<span id="cb40-371"><a href="#cb40-371" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Profile:** Identify which operations consume time</span>
<span id="cb40-372"><a href="#cb40-372" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Prioritize:** Focus on operations using &gt;20% of total time</span>
<span id="cb40-373"><a href="#cb40-373" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Optimize:** Tune those specific operations</span>
<span id="cb40-374"><a href="#cb40-374" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>**Verify:** Ensure optimization helped and results remain correct</span>
<span id="cb40-375"><a href="#cb40-375" aria-hidden="true" tabindex="-1"></a><span class="ss">6. </span>**Repeat:** Profile again to find next bottleneck</span>
<span id="cb40-376"><a href="#cb40-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-377"><a href="#cb40-377" aria-hidden="true" tabindex="-1"></a><span class="fu">### Basic Timing with system.time()</span></span>
<span id="cb40-378"><a href="#cb40-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-379"><a href="#cb40-379" aria-hidden="true" tabindex="-1"></a>The simplest profiling tool is <span class="in">`system.time()`</span>:</span>
<span id="cb40-380"><a href="#cb40-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-381"><a href="#cb40-381" aria-hidden="true" tabindex="-1"></a><span class="in">```r</span></span>
<span id="cb40-382"><a href="#cb40-382" aria-hidden="true" tabindex="-1"></a>timing <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb40-383"><a href="#cb40-383" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">bdPCA_hdf5</span>(</span>
<span id="cb40-384"><a href="#cb40-384" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> <span class="st">"genomics.hdf5"</span>,</span>
<span id="cb40-385"><a href="#cb40-385" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"data"</span>,</span>
<span id="cb40-386"><a href="#cb40-386" aria-hidden="true" tabindex="-1"></a>    <span class="at">dataset =</span> <span class="st">"genotypes"</span>,</span>
<span id="cb40-387"><a href="#cb40-387" aria-hidden="true" tabindex="-1"></a>    <span class="at">k =</span> <span class="dv">8</span>,</span>
<span id="cb40-388"><a href="#cb40-388" aria-hidden="true" tabindex="-1"></a>    <span class="at">q =</span> <span class="dv">1</span>,</span>
<span id="cb40-389"><a href="#cb40-389" aria-hidden="true" tabindex="-1"></a>    <span class="at">threads =</span> <span class="dv">4</span></span>
<span id="cb40-390"><a href="#cb40-390" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb40-391"><a href="#cb40-391" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb40-392"><a href="#cb40-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-393"><a href="#cb40-393" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(timing)</span>
<span id="cb40-394"><a href="#cb40-394" aria-hidden="true" tabindex="-1"></a><span class="co">#    user  system elapsed </span></span>
<span id="cb40-395"><a href="#cb40-395" aria-hidden="true" tabindex="-1"></a><span class="co">#  45.231   2.109  12.847</span></span>
<span id="cb40-396"><a href="#cb40-396" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-397"><a href="#cb40-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-398"><a href="#cb40-398" aria-hidden="true" tabindex="-1"></a>**Interpreting the output:**</span>
<span id="cb40-399"><a href="#cb40-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-400"><a href="#cb40-400" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**user:** CPU time spent in R code and user-level functions. This is "computation time"—the sum of all CPU time across all threads. With 4 threads, user time can exceed elapsed time (4 threads × 10 seconds = 40 seconds user time in 10 seconds elapsed).</span>
<span id="cb40-401"><a href="#cb40-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-402"><a href="#cb40-402" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**system:** CPU time spent in system calls—primarily I/O (reading/writing files), memory allocation, and inter-process communication. High system time indicates I/O or memory management overhead.</span>
<span id="cb40-403"><a href="#cb40-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-404"><a href="#cb40-404" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**elapsed:** Wall-clock time—what you experience. This is total time from start to finish, regardless of threading.</span>
<span id="cb40-405"><a href="#cb40-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-406"><a href="#cb40-406" aria-hidden="true" tabindex="-1"></a>**Common patterns and what they mean:**</span>
<span id="cb40-407"><a href="#cb40-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-408"><a href="#cb40-408" aria-hidden="true" tabindex="-1"></a><span class="in">```r</span></span>
<span id="cb40-409"><a href="#cb40-409" aria-hidden="true" tabindex="-1"></a><span class="co"># Pattern 1: user &gt;&gt; elapsed (e.g., user=45, elapsed=13)</span></span>
<span id="cb40-410"><a href="#cb40-410" aria-hidden="true" tabindex="-1"></a><span class="co"># Good parallelization! 4 threads did 45 seconds of work in 13 seconds</span></span>
<span id="cb40-411"><a href="#cb40-411" aria-hidden="true" tabindex="-1"></a><span class="co"># Speedup: 45/13 = 3.46× with 4 threads (87% efficiency)</span></span>
<span id="cb40-412"><a href="#cb40-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-413"><a href="#cb40-413" aria-hidden="true" tabindex="-1"></a><span class="co"># Pattern 2: system high (e.g., user=20, system=15, elapsed=35)</span></span>
<span id="cb40-414"><a href="#cb40-414" aria-hidden="true" tabindex="-1"></a><span class="co"># I/O bottleneck! System time (15s) is 43% of elapsed time</span></span>
<span id="cb40-415"><a href="#cb40-415" aria-hidden="true" tabindex="-1"></a><span class="co"># Solution: Optimize HDF5 chunk size, use faster storage, or cache data</span></span>
<span id="cb40-416"><a href="#cb40-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-417"><a href="#cb40-417" aria-hidden="true" tabindex="-1"></a><span class="co"># Pattern 3: elapsed &gt;&gt; user + system (e.g., user=10, system=2, elapsed=40)</span></span>
<span id="cb40-418"><a href="#cb40-418" aria-hidden="true" tabindex="-1"></a><span class="co"># Waiting for something! CPU idle most of the time</span></span>
<span id="cb40-419"><a href="#cb40-419" aria-hidden="true" tabindex="-1"></a><span class="co"># Possible causes: disk very slow, network storage, memory swapping</span></span>
<span id="cb40-420"><a href="#cb40-420" aria-hidden="true" tabindex="-1"></a><span class="co"># Check: iostat, iotop, or system monitor during execution</span></span>
<span id="cb40-421"><a href="#cb40-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-422"><a href="#cb40-422" aria-hidden="true" tabindex="-1"></a><span class="co"># Pattern 4: user ≈ elapsed, threads=4 (e.g., user=15, elapsed=14)</span></span>
<span id="cb40-423"><a href="#cb40-423" aria-hidden="true" tabindex="-1"></a><span class="co"># No parallelization benefit! Work is sequential or I/O-bound</span></span>
<span id="cb40-424"><a href="#cb40-424" aria-hidden="true" tabindex="-1"></a><span class="co"># Solution: Reduce threads (they're not helping), optimize sequential portions</span></span>
<span id="cb40-425"><a href="#cb40-425" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-426"><a href="#cb40-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-427"><a href="#cb40-427" aria-hidden="true" tabindex="-1"></a><span class="fu">### Detailed Profiling with Rprof()</span></span>
<span id="cb40-428"><a href="#cb40-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-429"><a href="#cb40-429" aria-hidden="true" tabindex="-1"></a>For deeper insight, use <span class="in">`Rprof()`</span> to identify which specific functions consume time:</span>
<span id="cb40-430"><a href="#cb40-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-431"><a href="#cb40-431" aria-hidden="true" tabindex="-1"></a><span class="in">```r</span></span>
<span id="cb40-432"><a href="#cb40-432" aria-hidden="true" tabindex="-1"></a><span class="co"># Start profiling</span></span>
<span id="cb40-433"><a href="#cb40-433" aria-hidden="true" tabindex="-1"></a><span class="fu">Rprof</span>(<span class="st">"pca_profile.out"</span>, <span class="at">memory.profiling =</span> <span class="cn">TRUE</span>)</span>
<span id="cb40-434"><a href="#cb40-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-435"><a href="#cb40-435" aria-hidden="true" tabindex="-1"></a><span class="co"># Run your analysis</span></span>
<span id="cb40-436"><a href="#cb40-436" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">bdPCA_hdf5</span>(</span>
<span id="cb40-437"><a href="#cb40-437" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> <span class="st">"large_data.hdf5"</span>,</span>
<span id="cb40-438"><a href="#cb40-438" aria-hidden="true" tabindex="-1"></a>  <span class="at">group =</span> <span class="st">"data"</span>,</span>
<span id="cb40-439"><a href="#cb40-439" aria-hidden="true" tabindex="-1"></a>  <span class="at">dataset =</span> <span class="st">"matrix"</span>,</span>
<span id="cb40-440"><a href="#cb40-440" aria-hidden="true" tabindex="-1"></a>  <span class="at">k =</span> <span class="dv">16</span>,</span>
<span id="cb40-441"><a href="#cb40-441" aria-hidden="true" tabindex="-1"></a>  <span class="at">q =</span> <span class="dv">2</span>,</span>
<span id="cb40-442"><a href="#cb40-442" aria-hidden="true" tabindex="-1"></a>  <span class="at">threads =</span> <span class="dv">8</span></span>
<span id="cb40-443"><a href="#cb40-443" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-444"><a href="#cb40-444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-445"><a href="#cb40-445" aria-hidden="true" tabindex="-1"></a><span class="co"># Stop profiling</span></span>
<span id="cb40-446"><a href="#cb40-446" aria-hidden="true" tabindex="-1"></a><span class="fu">Rprof</span>(<span class="cn">NULL</span>)</span>
<span id="cb40-447"><a href="#cb40-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-448"><a href="#cb40-448" aria-hidden="true" tabindex="-1"></a><span class="co"># Analyze results</span></span>
<span id="cb40-449"><a href="#cb40-449" aria-hidden="true" tabindex="-1"></a>profile_summary <span class="ot">&lt;-</span> <span class="fu">summaryRprof</span>(<span class="st">"pca_profile.out"</span>)</span>
<span id="cb40-450"><a href="#cb40-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-451"><a href="#cb40-451" aria-hidden="true" tabindex="-1"></a><span class="co"># Print time spent in each function</span></span>
<span id="cb40-452"><a href="#cb40-452" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(profile_summary<span class="sc">$</span>by.self)</span>
<span id="cb40-453"><a href="#cb40-453" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-454"><a href="#cb40-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-455"><a href="#cb40-455" aria-hidden="true" tabindex="-1"></a>**Example output and interpretation:**</span>
<span id="cb40-456"><a href="#cb40-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-457"><a href="#cb40-457" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-458"><a href="#cb40-458" aria-hidden="true" tabindex="-1"></a><span class="in">           self.time self.pct total.time total.pct</span></span>
<span id="cb40-459"><a href="#cb40-459" aria-hidden="true" tabindex="-1"></a><span class="in">bdSVD_hdf5      24.5     48.5       35.2      69.8</span></span>
<span id="cb40-460"><a href="#cb40-460" aria-hidden="true" tabindex="-1"></a><span class="in">bdNormalize     12.3     24.4       12.8      25.4</span></span>
<span id="cb40-461"><a href="#cb40-461" aria-hidden="true" tabindex="-1"></a><span class="in">h5read           8.2     16.3        8.2      16.3</span></span>
<span id="cb40-462"><a href="#cb40-462" aria-hidden="true" tabindex="-1"></a><span class="in">crossprod        3.1      6.1        3.1       6.1</span></span>
<span id="cb40-463"><a href="#cb40-463" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-464"><a href="#cb40-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-465"><a href="#cb40-465" aria-hidden="true" tabindex="-1"></a>This output tells a clear story:</span>
<span id="cb40-466"><a href="#cb40-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-467"><a href="#cb40-467" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**bdSVD_hdf5 (48.5% self time):** SVD computation dominates—this is the primary optimization target</span>
<span id="cb40-468"><a href="#cb40-468" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**bdNormalize (24.4% self time):** Normalization takes 1/4 of total time—consider pre-normalizing if running multiple analyses</span>
<span id="cb40-469"><a href="#cb40-469" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**h5read (16.3% self time):** I/O is significant but not dominant—chunking optimization might help but won't transform performance</span>
<span id="cb40-470"><a href="#cb40-470" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**crossprod (6.1% self time):** Minor contributor—optimizing this won't noticeably improve total time</span>
<span id="cb40-471"><a href="#cb40-471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-472"><a href="#cb40-472" aria-hidden="true" tabindex="-1"></a>**Memory profiling insights:**</span>
<span id="cb40-473"><a href="#cb40-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-474"><a href="#cb40-474" aria-hidden="true" tabindex="-1"></a><span class="in">```r</span></span>
<span id="cb40-475"><a href="#cb40-475" aria-hidden="true" tabindex="-1"></a><span class="co"># Memory allocation by function</span></span>
<span id="cb40-476"><a href="#cb40-476" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(profile_summary<span class="sc">$</span>by.total[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="fu">c</span>(<span class="st">"total.time"</span>, <span class="st">"mem.total"</span>)])</span>
<span id="cb40-477"><a href="#cb40-477" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-478"><a href="#cb40-478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-479"><a href="#cb40-479" aria-hidden="true" tabindex="-1"></a>Shows which functions allocate most memory. High memory allocation indicates where increasing k (more blocks) would help most.</span>
<span id="cb40-480"><a href="#cb40-480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-481"><a href="#cb40-481" aria-hidden="true" tabindex="-1"></a><span class="fu">### Visual Profiling with profvis</span></span>
<span id="cb40-482"><a href="#cb40-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-483"><a href="#cb40-483" aria-hidden="true" tabindex="-1"></a>For interactive exploration, <span class="in">`profvis`</span> provides flamegraphs showing time distribution visually:</span>
<span id="cb40-484"><a href="#cb40-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-485"><a href="#cb40-485" aria-hidden="true" tabindex="-1"></a><span class="in">```r</span></span>
<span id="cb40-486"><a href="#cb40-486" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(profvis)</span>
<span id="cb40-487"><a href="#cb40-487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-488"><a href="#cb40-488" aria-hidden="true" tabindex="-1"></a><span class="fu">profvis</span>({</span>
<span id="cb40-489"><a href="#cb40-489" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bdSVD_hdf5</span>(</span>
<span id="cb40-490"><a href="#cb40-490" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> <span class="st">"data.hdf5"</span>,</span>
<span id="cb40-491"><a href="#cb40-491" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"data"</span>,</span>
<span id="cb40-492"><a href="#cb40-492" aria-hidden="true" tabindex="-1"></a>    <span class="at">dataset =</span> <span class="st">"matrix"</span>,</span>
<span id="cb40-493"><a href="#cb40-493" aria-hidden="true" tabindex="-1"></a>    <span class="at">k =</span> <span class="dv">8</span>,</span>
<span id="cb40-494"><a href="#cb40-494" aria-hidden="true" tabindex="-1"></a>    <span class="at">threads =</span> <span class="dv">4</span></span>
<span id="cb40-495"><a href="#cb40-495" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb40-496"><a href="#cb40-496" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb40-497"><a href="#cb40-497" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-498"><a href="#cb40-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-499"><a href="#cb40-499" aria-hidden="true" tabindex="-1"></a>The interactive visualization shows:</span>
<span id="cb40-500"><a href="#cb40-500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-501"><a href="#cb40-501" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Horizontal axis:** Time from start to finish</span>
<span id="cb40-502"><a href="#cb40-502" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Vertical axis:** Call stack (functions calling functions)</span>
<span id="cb40-503"><a href="#cb40-503" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Width of bars:** Time spent in each function</span>
<span id="cb40-504"><a href="#cb40-504" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Colors:** Different colors for different code sections</span>
<span id="cb40-505"><a href="#cb40-505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-506"><a href="#cb40-506" aria-hidden="true" tabindex="-1"></a>Click on bars to zoom in, hover to see details. Look for:</span>
<span id="cb40-507"><a href="#cb40-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-508"><a href="#cb40-508" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Wide bars:** Functions consuming significant time (optimization targets)</span>
<span id="cb40-509"><a href="#cb40-509" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Deep stacks:** Many nested function calls (potential overhead)</span>
<span id="cb40-510"><a href="#cb40-510" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Memory spikes:** Sudden memory allocations (candidates for blocking)</span>
<span id="cb40-511"><a href="#cb40-511" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-512"><a href="#cb40-512" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb40-513"><a href="#cb40-513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-514"><a href="#cb40-514" aria-hidden="true" tabindex="-1"></a><span class="fu">## Optimization Workflows</span></span>
<span id="cb40-515"><a href="#cb40-515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-516"><a href="#cb40-516" aria-hidden="true" tabindex="-1"></a>Different bottlenecks require different optimization strategies. These workflows guide you through systematic tuning.</span>
<span id="cb40-517"><a href="#cb40-517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-518"><a href="#cb40-518" aria-hidden="true" tabindex="-1"></a><span class="fu">### Memory-Constrained Environment</span></span>
<span id="cb40-519"><a href="#cb40-519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-520"><a href="#cb40-520" aria-hidden="true" tabindex="-1"></a>**Symptoms you're memory-constrained:**</span>
<span id="cb40-521"><a href="#cb40-521" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-522"><a href="#cb40-522" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Frequent swapping (system very slow, disk activity constant)</span>
<span id="cb40-523"><a href="#cb40-523" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>"Cannot allocate vector of size X" errors</span>
<span id="cb40-524"><a href="#cb40-524" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>R crashes with memory-related errors</span>
<span id="cb40-525"><a href="#cb40-525" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>System monitor shows RAM usage at 95-100%</span>
<span id="cb40-526"><a href="#cb40-526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-527"><a href="#cb40-527" aria-hidden="true" tabindex="-1"></a>**The optimization strategy:**</span>
<span id="cb40-528"><a href="#cb40-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-531"><a href="#cb40-531" aria-hidden="true" tabindex="-1"></a><span class="in">```{mermaid}</span></span>
<span id="cb40-532"><a href="#cb40-532" aria-hidden="true" tabindex="-1"></a>flowchart TD</span>
<span id="cb40-533"><a href="#cb40-533" aria-hidden="true" tabindex="-1"></a>    A[Memory Issues Detected] --&gt; B[Increase k by <span class="dv">2</span>x]</span>
<span id="cb40-534"><a href="#cb40-534" aria-hidden="true" tabindex="-1"></a>    B --&gt; C{Issues resolved?}</span>
<span id="cb40-535"><a href="#cb40-535" aria-hidden="true" tabindex="-1"></a>    C --&gt;|Yes| H[Success: Monitor future runs]</span>
<span id="cb40-536"><a href="#cb40-536" aria-hidden="true" tabindex="-1"></a>    C --&gt;|No| D[Add hierarchy: q=<span class="dv">2</span>]</span>
<span id="cb40-537"><a href="#cb40-537" aria-hidden="true" tabindex="-1"></a>    D --&gt; E{Issues resolved?}</span>
<span id="cb40-538"><a href="#cb40-538" aria-hidden="true" tabindex="-1"></a>    E --&gt;|Yes| H</span>
<span id="cb40-539"><a href="#cb40-539" aria-hidden="true" tabindex="-1"></a>    E --&gt;|No| F[Reduce threads by half]</span>
<span id="cb40-540"><a href="#cb40-540" aria-hidden="true" tabindex="-1"></a>    F --&gt; G{Issues resolved?}</span>
<span id="cb40-541"><a href="#cb40-541" aria-hidden="true" tabindex="-1"></a>    G --&gt;|Yes| H</span>
<span id="cb40-542"><a href="#cb40-542" aria-hidden="true" tabindex="-1"></a>    G --&gt;|No| I[Process in stages OR&lt;br/&gt;upgrade hardware]</span>
<span id="cb40-543"><a href="#cb40-543" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-544"><a href="#cb40-544" aria-hidden="true" tabindex="-1"></a>    style A fill:<span class="co">#ffe8e8</span></span>
<span id="cb40-545"><a href="#cb40-545" aria-hidden="true" tabindex="-1"></a>    style H fill:<span class="co">#e8f6e8</span></span>
<span id="cb40-546"><a href="#cb40-546" aria-hidden="true" tabindex="-1"></a>    style I fill:<span class="co">#fff8e1</span></span>
<span id="cb40-547"><a href="#cb40-547" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-548"><a href="#cb40-548" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-549"><a href="#cb40-549" aria-hidden="true" tabindex="-1"></a>**Step-by-step implementation:**</span>
<span id="cb40-550"><a href="#cb40-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-551"><a href="#cb40-551" aria-hidden="true" tabindex="-1"></a>**Step 1: Increase block count (k)**</span>
<span id="cb40-552"><a href="#cb40-552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-553"><a href="#cb40-553" aria-hidden="true" tabindex="-1"></a>Doubling k halves memory usage. If currently using k=4 and hitting memory limits, try k=8:</span>
<span id="cb40-554"><a href="#cb40-554" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-555"><a href="#cb40-555" aria-hidden="true" tabindex="-1"></a><span class="in">```r</span></span>
<span id="cb40-556"><a href="#cb40-556" aria-hidden="true" tabindex="-1"></a><span class="co"># Original configuration (memory issues)</span></span>
<span id="cb40-557"><a href="#cb40-557" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">bdPCA_hdf5</span>(</span>
<span id="cb40-558"><a href="#cb40-558" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> <span class="st">"large_data.hdf5"</span>,</span>
<span id="cb40-559"><a href="#cb40-559" aria-hidden="true" tabindex="-1"></a>  <span class="at">group =</span> <span class="st">"data"</span>,</span>
<span id="cb40-560"><a href="#cb40-560" aria-hidden="true" tabindex="-1"></a>  <span class="at">dataset =</span> <span class="st">"matrix"</span>,</span>
<span id="cb40-561"><a href="#cb40-561" aria-hidden="true" tabindex="-1"></a>  <span class="at">k =</span> <span class="dv">4</span>,</span>
<span id="cb40-562"><a href="#cb40-562" aria-hidden="true" tabindex="-1"></a>  <span class="at">q =</span> <span class="dv">1</span>,</span>
<span id="cb40-563"><a href="#cb40-563" aria-hidden="true" tabindex="-1"></a>  <span class="at">threads =</span> <span class="dv">4</span></span>
<span id="cb40-564"><a href="#cb40-564" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-565"><a href="#cb40-565" aria-hidden="true" tabindex="-1"></a><span class="co"># Error or very slow due to swapping</span></span>
<span id="cb40-566"><a href="#cb40-566" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-567"><a href="#cb40-567" aria-hidden="true" tabindex="-1"></a><span class="co"># Optimized: Double k</span></span>
<span id="cb40-568"><a href="#cb40-568" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">bdPCA_hdf5</span>(</span>
<span id="cb40-569"><a href="#cb40-569" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> <span class="st">"large_data.hdf5"</span>,</span>
<span id="cb40-570"><a href="#cb40-570" aria-hidden="true" tabindex="-1"></a>  <span class="at">group =</span> <span class="st">"data"</span>,</span>
<span id="cb40-571"><a href="#cb40-571" aria-hidden="true" tabindex="-1"></a>  <span class="at">dataset =</span> <span class="st">"matrix"</span>,</span>
<span id="cb40-572"><a href="#cb40-572" aria-hidden="true" tabindex="-1"></a>  <span class="at">k =</span> <span class="dv">8</span>,    <span class="co"># Doubled</span></span>
<span id="cb40-573"><a href="#cb40-573" aria-hidden="true" tabindex="-1"></a>  <span class="at">q =</span> <span class="dv">1</span>,</span>
<span id="cb40-574"><a href="#cb40-574" aria-hidden="true" tabindex="-1"></a>  <span class="at">threads =</span> <span class="dv">4</span></span>
<span id="cb40-575"><a href="#cb40-575" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-576"><a href="#cb40-576" aria-hidden="true" tabindex="-1"></a><span class="co"># Should complete successfully, though slower</span></span>
<span id="cb40-577"><a href="#cb40-577" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-578"><a href="#cb40-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-579"><a href="#cb40-579" aria-hidden="true" tabindex="-1"></a>**Step 2: Add hierarchy if still problematic**</span>
<span id="cb40-580"><a href="#cb40-580" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-581"><a href="#cb40-581" aria-hidden="true" tabindex="-1"></a>If k=8 still causes issues, add q=2 to reduce peak memory during combination:</span>
<span id="cb40-582"><a href="#cb40-582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-583"><a href="#cb40-583" aria-hidden="true" tabindex="-1"></a><span class="in">```r</span></span>
<span id="cb40-584"><a href="#cb40-584" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">bdPCA_hdf5</span>(</span>
<span id="cb40-585"><a href="#cb40-585" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> <span class="st">"large_data.hdf5"</span>,</span>
<span id="cb40-586"><a href="#cb40-586" aria-hidden="true" tabindex="-1"></a>  <span class="at">group =</span> <span class="st">"data"</span>,</span>
<span id="cb40-587"><a href="#cb40-587" aria-hidden="true" tabindex="-1"></a>  <span class="at">dataset =</span> <span class="st">"matrix"</span>,</span>
<span id="cb40-588"><a href="#cb40-588" aria-hidden="true" tabindex="-1"></a>  <span class="at">k =</span> <span class="dv">8</span>,</span>
<span id="cb40-589"><a href="#cb40-589" aria-hidden="true" tabindex="-1"></a>  <span class="at">q =</span> <span class="dv">2</span>,    <span class="co"># Added hierarchy</span></span>
<span id="cb40-590"><a href="#cb40-590" aria-hidden="true" tabindex="-1"></a>  <span class="at">threads =</span> <span class="dv">4</span></span>
<span id="cb40-591"><a href="#cb40-591" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-592"><a href="#cb40-592" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-593"><a href="#cb40-593" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-594"><a href="#cb40-594" aria-hidden="true" tabindex="-1"></a>**Step 3: Reduce threading if memory pressure persists**</span>
<span id="cb40-595"><a href="#cb40-595" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-596"><a href="#cb40-596" aria-hidden="true" tabindex="-1"></a>More threads means more blocks loaded simultaneously. Reducing threads decreases parallel memory pressure:</span>
<span id="cb40-597"><a href="#cb40-597" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-598"><a href="#cb40-598" aria-hidden="true" tabindex="-1"></a><span class="in">```r</span></span>
<span id="cb40-599"><a href="#cb40-599" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">bdPCA_hdf5</span>(</span>
<span id="cb40-600"><a href="#cb40-600" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> <span class="st">"large_data.hdf5"</span>,</span>
<span id="cb40-601"><a href="#cb40-601" aria-hidden="true" tabindex="-1"></a>  <span class="at">group =</span> <span class="st">"data"</span>,</span>
<span id="cb40-602"><a href="#cb40-602" aria-hidden="true" tabindex="-1"></a>  <span class="at">dataset =</span> <span class="st">"matrix"</span>,</span>
<span id="cb40-603"><a href="#cb40-603" aria-hidden="true" tabindex="-1"></a>  <span class="at">k =</span> <span class="dv">8</span>,</span>
<span id="cb40-604"><a href="#cb40-604" aria-hidden="true" tabindex="-1"></a>  <span class="at">q =</span> <span class="dv">2</span>,</span>
<span id="cb40-605"><a href="#cb40-605" aria-hidden="true" tabindex="-1"></a>  <span class="at">threads =</span> <span class="dv">2</span>    <span class="co"># Reduced from 4</span></span>
<span id="cb40-606"><a href="#cb40-606" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-607"><a href="#cb40-607" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-608"><a href="#cb40-608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-609"><a href="#cb40-609" aria-hidden="true" tabindex="-1"></a>**Step 4: Process in stages**</span>
<span id="cb40-610"><a href="#cb40-610" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-611"><a href="#cb40-611" aria-hidden="true" tabindex="-1"></a>If still problematic, break analysis into smaller stages, writing intermediate results to HDF5:</span>
<span id="cb40-612"><a href="#cb40-612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-613"><a href="#cb40-613" aria-hidden="true" tabindex="-1"></a><span class="in">```r</span></span>
<span id="cb40-614"><a href="#cb40-614" aria-hidden="true" tabindex="-1"></a><span class="co"># Stage 1: Normalize (writes to HDF5)</span></span>
<span id="cb40-615"><a href="#cb40-615" aria-hidden="true" tabindex="-1"></a><span class="fu">bdNormalize_hdf5</span>(</span>
<span id="cb40-616"><a href="#cb40-616" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> <span class="st">"large_data.hdf5"</span>,</span>
<span id="cb40-617"><a href="#cb40-617" aria-hidden="true" tabindex="-1"></a>  <span class="at">group =</span> <span class="st">"data"</span>,</span>
<span id="cb40-618"><a href="#cb40-618" aria-hidden="true" tabindex="-1"></a>  <span class="at">dataset =</span> <span class="st">"matrix"</span>,</span>
<span id="cb40-619"><a href="#cb40-619" aria-hidden="true" tabindex="-1"></a>  <span class="at">bcenter =</span> <span class="cn">TRUE</span>,</span>
<span id="cb40-620"><a href="#cb40-620" aria-hidden="true" tabindex="-1"></a>  <span class="at">bscale =</span> <span class="cn">FALSE</span></span>
<span id="cb40-621"><a href="#cb40-621" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-622"><a href="#cb40-622" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-623"><a href="#cb40-623" aria-hidden="true" tabindex="-1"></a><span class="co"># Stage 2: QR decomposition (done internally, writes to HDF5)</span></span>
<span id="cb40-624"><a href="#cb40-624" aria-hidden="true" tabindex="-1"></a><span class="co"># Stage 3: SVD on reduced data (smaller working set)</span></span>
<span id="cb40-625"><a href="#cb40-625" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">bdPCA_hdf5</span>(</span>
<span id="cb40-626"><a href="#cb40-626" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> <span class="st">"large_data.hdf5"</span>,</span>
<span id="cb40-627"><a href="#cb40-627" aria-hidden="true" tabindex="-1"></a>  <span class="at">group =</span> <span class="st">"NORMALIZED/data"</span>,</span>
<span id="cb40-628"><a href="#cb40-628" aria-hidden="true" tabindex="-1"></a>  <span class="at">dataset =</span> <span class="st">"matrix"</span>,</span>
<span id="cb40-629"><a href="#cb40-629" aria-hidden="true" tabindex="-1"></a>  <span class="at">bcenter =</span> <span class="cn">FALSE</span>,  <span class="co"># Already normalized</span></span>
<span id="cb40-630"><a href="#cb40-630" aria-hidden="true" tabindex="-1"></a>  <span class="at">bscale =</span> <span class="cn">FALSE</span>,</span>
<span id="cb40-631"><a href="#cb40-631" aria-hidden="true" tabindex="-1"></a>  <span class="at">k =</span> <span class="dv">8</span>,</span>
<span id="cb40-632"><a href="#cb40-632" aria-hidden="true" tabindex="-1"></a>  <span class="at">q =</span> <span class="dv">2</span>,</span>
<span id="cb40-633"><a href="#cb40-633" aria-hidden="true" tabindex="-1"></a>  <span class="at">threads =</span> <span class="dv">2</span></span>
<span id="cb40-634"><a href="#cb40-634" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-635"><a href="#cb40-635" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-636"><a href="#cb40-636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-637"><a href="#cb40-637" aria-hidden="true" tabindex="-1"></a>Each stage has smaller peak memory than attempting everything at once.</span>
<span id="cb40-638"><a href="#cb40-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-639"><a href="#cb40-639" aria-hidden="true" tabindex="-1"></a><span class="fu">### Speed-Constrained Environment</span></span>
<span id="cb40-640"><a href="#cb40-640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-641"><a href="#cb40-641" aria-hidden="true" tabindex="-1"></a>**Symptoms you're speed-constrained:**</span>
<span id="cb40-642"><a href="#cb40-642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-643"><a href="#cb40-643" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Computation takes too long for your workflow</span>
<span id="cb40-644"><a href="#cb40-644" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Memory usage is well below capacity (30-50% of available RAM)</span>
<span id="cb40-645"><a href="#cb40-645" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Waiting for results interrupts iterative analysis</span>
<span id="cb40-646"><a href="#cb40-646" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>System monitor shows RAM available but computation slow</span>
<span id="cb40-647"><a href="#cb40-647" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-648"><a href="#cb40-648" aria-hidden="true" tabindex="-1"></a>**The optimization strategy:**</span>
<span id="cb40-649"><a href="#cb40-649" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-652"><a href="#cb40-652" aria-hidden="true" tabindex="-1"></a><span class="in">```{mermaid}</span></span>
<span id="cb40-653"><a href="#cb40-653" aria-hidden="true" tabindex="-1"></a>flowchart TD</span>
<span id="cb40-654"><a href="#cb40-654" aria-hidden="true" tabindex="-1"></a>    A[Speed Issues Detected] --&gt; B[Check memory usage]</span>
<span id="cb40-655"><a href="#cb40-655" aria-hidden="true" tabindex="-1"></a>    B --&gt; C{RAM &lt; <span class="dv">70</span>% used?}</span>
<span id="cb40-656"><a href="#cb40-656" aria-hidden="true" tabindex="-1"></a>    C --&gt;|Yes| D[Decrease k by half]</span>
<span id="cb40-657"><a href="#cb40-657" aria-hidden="true" tabindex="-1"></a>    D --&gt; E{Faster?}</span>
<span id="cb40-658"><a href="#cb40-658" aria-hidden="true" tabindex="-1"></a>    E --&gt;|Yes| F[Increase threads]</span>
<span id="cb40-659"><a href="#cb40-659" aria-hidden="true" tabindex="-1"></a>    F --&gt; G{Faster?}</span>
<span id="cb40-660"><a href="#cb40-660" aria-hidden="true" tabindex="-1"></a>    G --&gt;|Yes| J[Optimize HDF5 chunking]</span>
<span id="cb40-661"><a href="#cb40-661" aria-hidden="true" tabindex="-1"></a>    C --&gt;|No| H[Memory limiting speed&lt;br/&gt;Use balanced approach]</span>
<span id="cb40-662"><a href="#cb40-662" aria-hidden="true" tabindex="-1"></a>    E --&gt;|No| I[Check I/O bottleneck]</span>
<span id="cb40-663"><a href="#cb40-663" aria-hidden="true" tabindex="-1"></a>    G --&gt;|No| K[Check parallelization limits]</span>
<span id="cb40-664"><a href="#cb40-664" aria-hidden="true" tabindex="-1"></a>    J --&gt; L[Success: Optimal configuration]</span>
<span id="cb40-665"><a href="#cb40-665" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-666"><a href="#cb40-666" aria-hidden="true" tabindex="-1"></a>    style A fill:<span class="co">#fff8e1</span></span>
<span id="cb40-667"><a href="#cb40-667" aria-hidden="true" tabindex="-1"></a>    style L fill:<span class="co">#e8f6e8</span></span>
<span id="cb40-668"><a href="#cb40-668" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-669"><a href="#cb40-669" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-670"><a href="#cb40-670" aria-hidden="true" tabindex="-1"></a>**Step-by-step implementation:**</span>
<span id="cb40-671"><a href="#cb40-671" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-672"><a href="#cb40-672" aria-hidden="true" tabindex="-1"></a>**Step 1: Reduce block count if memory allows**</span>
<span id="cb40-673"><a href="#cb40-673" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-674"><a href="#cb40-674" aria-hidden="true" tabindex="-1"></a>Fewer blocks mean less overhead. If memory usage is low, try reducing k:</span>
<span id="cb40-675"><a href="#cb40-675" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-676"><a href="#cb40-676" aria-hidden="true" tabindex="-1"></a><span class="in">```r</span></span>
<span id="cb40-677"><a href="#cb40-677" aria-hidden="true" tabindex="-1"></a><span class="co"># Current: Slow but plenty of RAM available</span></span>
<span id="cb40-678"><a href="#cb40-678" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">bdPCA_hdf5</span>(<span class="st">"data.hdf5"</span>, <span class="st">"data"</span>, <span class="st">"matrix"</span>, </span>
<span id="cb40-679"><a href="#cb40-679" aria-hidden="true" tabindex="-1"></a>                     <span class="at">k=</span><span class="dv">8</span>, <span class="at">threads=</span><span class="dv">4</span>)</span>
<span id="cb40-680"><a href="#cb40-680" aria-hidden="true" tabindex="-1"></a><span class="co"># Elapsed: 45 seconds, RAM usage: 8GB / 32GB available</span></span>
<span id="cb40-681"><a href="#cb40-681" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-682"><a href="#cb40-682" aria-hidden="true" tabindex="-1"></a><span class="co"># Optimized: Fewer blocks</span></span>
<span id="cb40-683"><a href="#cb40-683" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">bdPCA_hdf5</span>(<span class="st">"data.hdf5"</span>, <span class="st">"data"</span>, <span class="st">"matrix"</span>,</span>
<span id="cb40-684"><a href="#cb40-684" aria-hidden="true" tabindex="-1"></a>                     <span class="at">k=</span><span class="dv">4</span>, <span class="at">threads=</span><span class="dv">4</span>)  <span class="co"># Halved k</span></span>
<span id="cb40-685"><a href="#cb40-685" aria-hidden="true" tabindex="-1"></a><span class="co"># Elapsed: 28 seconds (38% faster)</span></span>
<span id="cb40-686"><a href="#cb40-686" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-687"><a href="#cb40-687" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-688"><a href="#cb40-688" aria-hidden="true" tabindex="-1"></a>**Step 2: Increase thread count**</span>
<span id="cb40-689"><a href="#cb40-689" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-690"><a href="#cb40-690" aria-hidden="true" tabindex="-1"></a>More threads reduce wall-clock time for parallelizable operations:</span>
<span id="cb40-691"><a href="#cb40-691" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-692"><a href="#cb40-692" aria-hidden="true" tabindex="-1"></a><span class="in">```r</span></span>
<span id="cb40-693"><a href="#cb40-693" aria-hidden="true" tabindex="-1"></a><span class="co"># Check available cores</span></span>
<span id="cb40-694"><a href="#cb40-694" aria-hidden="true" tabindex="-1"></a>n_cores <span class="ot">&lt;-</span> parallel<span class="sc">::</span><span class="fu">detectCores</span>()</span>
<span id="cb40-695"><a href="#cb40-695" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Available cores:"</span>, n_cores, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-696"><a href="#cb40-696" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-697"><a href="#cb40-697" aria-hidden="true" tabindex="-1"></a><span class="co"># Use more threads</span></span>
<span id="cb40-698"><a href="#cb40-698" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">bdPCA_hdf5</span>(<span class="st">"data.hdf5"</span>, <span class="st">"data"</span>, <span class="st">"matrix"</span>,</span>
<span id="cb40-699"><a href="#cb40-699" aria-hidden="true" tabindex="-1"></a>                     <span class="at">k=</span><span class="dv">4</span>, <span class="at">threads=</span>n_cores)</span>
<span id="cb40-700"><a href="#cb40-700" aria-hidden="true" tabindex="-1"></a><span class="co"># Measure speedup vs fewer threads</span></span>
<span id="cb40-701"><a href="#cb40-701" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-702"><a href="#cb40-702" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-703"><a href="#cb40-703" aria-hidden="true" tabindex="-1"></a>Monitor efficiency—if adding threads provides minimal speedup, you've hit a bottleneck (I/O, memory bandwidth, or Amdahl's law).</span>
<span id="cb40-704"><a href="#cb40-704" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-705"><a href="#cb40-705" aria-hidden="true" tabindex="-1"></a>**Step 3: Pre-normalize data**</span>
<span id="cb40-706"><a href="#cb40-706" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-707"><a href="#cb40-707" aria-hidden="true" tabindex="-1"></a>If running multiple analyses on the same data, normalize once and reuse:</span>
<span id="cb40-708"><a href="#cb40-708" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-709"><a href="#cb40-709" aria-hidden="true" tabindex="-1"></a><span class="in">```r</span></span>
<span id="cb40-710"><a href="#cb40-710" aria-hidden="true" tabindex="-1"></a><span class="co"># Normalize once</span></span>
<span id="cb40-711"><a href="#cb40-711" aria-hidden="true" tabindex="-1"></a><span class="fu">bdNormalize_hdf5</span>(<span class="st">"data.hdf5"</span>, <span class="st">"data"</span>, <span class="st">"matrix"</span>,</span>
<span id="cb40-712"><a href="#cb40-712" aria-hidden="true" tabindex="-1"></a>                 <span class="at">bcenter=</span><span class="cn">TRUE</span>, <span class="at">bscale=</span><span class="cn">FALSE</span>)</span>
<span id="cb40-713"><a href="#cb40-713" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-714"><a href="#cb40-714" aria-hidden="true" tabindex="-1"></a><span class="co"># Run analyses without re-normalizing</span></span>
<span id="cb40-715"><a href="#cb40-715" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (param <span class="cf">in</span> parameter_grid) {</span>
<span id="cb40-716"><a href="#cb40-716" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">bdPCA_hdf5</span>(</span>
<span id="cb40-717"><a href="#cb40-717" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> <span class="st">"data.hdf5"</span>,</span>
<span id="cb40-718"><a href="#cb40-718" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"NORMALIZED/data"</span>,</span>
<span id="cb40-719"><a href="#cb40-719" aria-hidden="true" tabindex="-1"></a>    <span class="at">dataset =</span> <span class="st">"matrix"</span>,</span>
<span id="cb40-720"><a href="#cb40-720" aria-hidden="true" tabindex="-1"></a>    <span class="at">bcenter =</span> <span class="cn">FALSE</span>,  <span class="co"># Skip normalization</span></span>
<span id="cb40-721"><a href="#cb40-721" aria-hidden="true" tabindex="-1"></a>    <span class="at">bscale =</span> <span class="cn">FALSE</span>,</span>
<span id="cb40-722"><a href="#cb40-722" aria-hidden="true" tabindex="-1"></a>    <span class="at">k =</span> <span class="dv">4</span>,</span>
<span id="cb40-723"><a href="#cb40-723" aria-hidden="true" tabindex="-1"></a>    <span class="at">threads =</span> <span class="dv">8</span></span>
<span id="cb40-724"><a href="#cb40-724" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Other parameters vary</span></span>
<span id="cb40-725"><a href="#cb40-725" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb40-726"><a href="#cb40-726" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Process result</span></span>
<span id="cb40-727"><a href="#cb40-727" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb40-728"><a href="#cb40-728" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-729"><a href="#cb40-729" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-730"><a href="#cb40-730" aria-hidden="true" tabindex="-1"></a>This eliminates redundant normalization across runs, saving 20-40% of time in iterative workflows.</span>
<span id="cb40-731"><a href="#cb40-731" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-732"><a href="#cb40-732" aria-hidden="true" tabindex="-1"></a>**Step 4: Optimize HDF5 chunk size**</span>
<span id="cb40-733"><a href="#cb40-733" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-734"><a href="#cb40-734" aria-hidden="true" tabindex="-1"></a>If profiling shows significant I/O time, recreate dataset with optimal chunking:</span>
<span id="cb40-735"><a href="#cb40-735" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-736"><a href="#cb40-736" aria-hidden="true" tabindex="-1"></a><span class="in">```r</span></span>
<span id="cb40-737"><a href="#cb40-737" aria-hidden="true" tabindex="-1"></a><span class="co"># Read existing data</span></span>
<span id="cb40-738"><a href="#cb40-738" aria-hidden="true" tabindex="-1"></a>original_data <span class="ot">&lt;-</span> <span class="fu">h5read</span>(<span class="st">"data.hdf5"</span>, <span class="st">"data/matrix"</span>)</span>
<span id="cb40-739"><a href="#cb40-739" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-740"><a href="#cb40-740" aria-hidden="true" tabindex="-1"></a><span class="co"># Recreate with optimized chunks</span></span>
<span id="cb40-741"><a href="#cb40-741" aria-hidden="true" tabindex="-1"></a><span class="fu">bdCreate_hdf5_matrix</span>(</span>
<span id="cb40-742"><a href="#cb40-742" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> <span class="st">"data_optimized.hdf5"</span>,</span>
<span id="cb40-743"><a href="#cb40-743" aria-hidden="true" tabindex="-1"></a>  <span class="at">object =</span> original_data,</span>
<span id="cb40-744"><a href="#cb40-744" aria-hidden="true" tabindex="-1"></a>  <span class="at">group =</span> <span class="st">"data"</span>,</span>
<span id="cb40-745"><a href="#cb40-745" aria-hidden="true" tabindex="-1"></a>  <span class="at">dataset =</span> <span class="st">"matrix"</span>,</span>
<span id="cb40-746"><a href="#cb40-746" aria-hidden="true" tabindex="-1"></a>  <span class="at">chunk_rows =</span> <span class="fu">nrow</span>(original_data) <span class="sc">/</span> <span class="dv">4</span>,  <span class="co"># Match k=4</span></span>
<span id="cb40-747"><a href="#cb40-747" aria-hidden="true" tabindex="-1"></a>  <span class="at">chunk_cols =</span> <span class="fu">ncol</span>(original_data),</span>
<span id="cb40-748"><a href="#cb40-748" aria-hidden="true" tabindex="-1"></a>  <span class="at">compression =</span> <span class="dv">0</span>  <span class="co"># Disable compression for max speed</span></span>
<span id="cb40-749"><a href="#cb40-749" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-750"><a href="#cb40-750" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-751"><a href="#cb40-751" aria-hidden="true" tabindex="-1"></a><span class="co"># Use optimized dataset</span></span>
<span id="cb40-752"><a href="#cb40-752" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">bdPCA_hdf5</span>(<span class="st">"data_optimized.hdf5"</span>, <span class="st">"data"</span>, <span class="st">"matrix"</span>,</span>
<span id="cb40-753"><a href="#cb40-753" aria-hidden="true" tabindex="-1"></a>                     <span class="at">k=</span><span class="dv">4</span>, <span class="at">threads=</span><span class="dv">8</span>)</span>
<span id="cb40-754"><a href="#cb40-754" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-755"><a href="#cb40-755" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-756"><a href="#cb40-756" aria-hidden="true" tabindex="-1"></a>Optimal chunking can reduce I/O time by 50-80% for I/O-heavy operations.</span>
<span id="cb40-757"><a href="#cb40-757" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-758"><a href="#cb40-758" aria-hidden="true" tabindex="-1"></a><span class="fu">### Balanced Optimization: Iterative Tuning</span></span>
<span id="cb40-759"><a href="#cb40-759" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-760"><a href="#cb40-760" aria-hidden="true" tabindex="-1"></a>When neither memory nor speed is catastrophically limiting, tune iteratively to find the sweet spot:</span>
<span id="cb40-761"><a href="#cb40-761" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-762"><a href="#cb40-762" aria-hidden="true" tabindex="-1"></a>**Phase 1: Establish baseline**</span>
<span id="cb40-763"><a href="#cb40-763" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-764"><a href="#cb40-764" aria-hidden="true" tabindex="-1"></a><span class="in">```r</span></span>
<span id="cb40-765"><a href="#cb40-765" aria-hidden="true" tabindex="-1"></a><span class="co"># Conservative configuration (guaranteed to work)</span></span>
<span id="cb40-766"><a href="#cb40-766" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Testing baseline configuration...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-767"><a href="#cb40-767" aria-hidden="true" tabindex="-1"></a>baseline_time <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb40-768"><a href="#cb40-768" aria-hidden="true" tabindex="-1"></a>  baseline_result <span class="ot">&lt;-</span> <span class="fu">bdPCA_hdf5</span>(</span>
<span id="cb40-769"><a href="#cb40-769" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> <span class="st">"data.hdf5"</span>,</span>
<span id="cb40-770"><a href="#cb40-770" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"data"</span>,</span>
<span id="cb40-771"><a href="#cb40-771" aria-hidden="true" tabindex="-1"></a>    <span class="at">dataset =</span> <span class="st">"matrix"</span>,</span>
<span id="cb40-772"><a href="#cb40-772" aria-hidden="true" tabindex="-1"></a>    <span class="at">k =</span> <span class="dv">8</span>,</span>
<span id="cb40-773"><a href="#cb40-773" aria-hidden="true" tabindex="-1"></a>    <span class="at">q =</span> <span class="dv">1</span>,</span>
<span id="cb40-774"><a href="#cb40-774" aria-hidden="true" tabindex="-1"></a>    <span class="at">threads =</span> <span class="dv">2</span></span>
<span id="cb40-775"><a href="#cb40-775" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb40-776"><a href="#cb40-776" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb40-777"><a href="#cb40-777" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-778"><a href="#cb40-778" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Baseline time:"</span>, baseline_time[<span class="st">"elapsed"</span>], <span class="st">"seconds</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-779"><a href="#cb40-779" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Peak memory: Check system monitor</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-780"><a href="#cb40-780" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-781"><a href="#cb40-781" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-782"><a href="#cb40-782" aria-hidden="true" tabindex="-1"></a>**Phase 2: Test reduced blocking**</span>
<span id="cb40-783"><a href="#cb40-783" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-784"><a href="#cb40-784" aria-hidden="true" tabindex="-1"></a><span class="in">```r</span></span>
<span id="cb40-785"><a href="#cb40-785" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Testing k=4 (fewer blocks)...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-786"><a href="#cb40-786" aria-hidden="true" tabindex="-1"></a>test1_time <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb40-787"><a href="#cb40-787" aria-hidden="true" tabindex="-1"></a>  test1_result <span class="ot">&lt;-</span> <span class="fu">bdPCA_hdf5</span>(</span>
<span id="cb40-788"><a href="#cb40-788" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> <span class="st">"data.hdf5"</span>,</span>
<span id="cb40-789"><a href="#cb40-789" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"data"</span>,</span>
<span id="cb40-790"><a href="#cb40-790" aria-hidden="true" tabindex="-1"></a>    <span class="at">dataset =</span> <span class="st">"matrix"</span>,</span>
<span id="cb40-791"><a href="#cb40-791" aria-hidden="true" tabindex="-1"></a>    <span class="at">k =</span> <span class="dv">4</span>,  <span class="co"># Halved</span></span>
<span id="cb40-792"><a href="#cb40-792" aria-hidden="true" tabindex="-1"></a>    <span class="at">q =</span> <span class="dv">1</span>,</span>
<span id="cb40-793"><a href="#cb40-793" aria-hidden="true" tabindex="-1"></a>    <span class="at">threads =</span> <span class="dv">2</span></span>
<span id="cb40-794"><a href="#cb40-794" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb40-795"><a href="#cb40-795" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb40-796"><a href="#cb40-796" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-797"><a href="#cb40-797" aria-hidden="true" tabindex="-1"></a>improvement1 <span class="ot">&lt;-</span> (baseline_time[<span class="st">"elapsed"</span>] <span class="sc">-</span> test1_time[<span class="st">"elapsed"</span>]) <span class="sc">/</span> </span>
<span id="cb40-798"><a href="#cb40-798" aria-hidden="true" tabindex="-1"></a>                baseline_time[<span class="st">"elapsed"</span>] <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb40-799"><a href="#cb40-799" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-800"><a href="#cb40-800" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"k=4 time:"</span>, test1_time[<span class="st">"elapsed"</span>], <span class="st">"seconds</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-801"><a href="#cb40-801" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Improvement:"</span>, <span class="fu">round</span>(improvement1, <span class="dv">1</span>), <span class="st">"%</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-802"><a href="#cb40-802" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-803"><a href="#cb40-803" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-804"><a href="#cb40-804" aria-hidden="true" tabindex="-1"></a>**Phase 3: Test increased threading**</span>
<span id="cb40-805"><a href="#cb40-805" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-806"><a href="#cb40-806" aria-hidden="true" tabindex="-1"></a><span class="in">```r</span></span>
<span id="cb40-807"><a href="#cb40-807" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Testing threads=4 (more parallelism)...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-808"><a href="#cb40-808" aria-hidden="true" tabindex="-1"></a>test2_time <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb40-809"><a href="#cb40-809" aria-hidden="true" tabindex="-1"></a>  test2_result <span class="ot">&lt;-</span> <span class="fu">bdPCA_hdf5</span>(</span>
<span id="cb40-810"><a href="#cb40-810" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> <span class="st">"data.hdf5"</span>,</span>
<span id="cb40-811"><a href="#cb40-811" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"data"</span>,</span>
<span id="cb40-812"><a href="#cb40-812" aria-hidden="true" tabindex="-1"></a>    <span class="at">dataset =</span> <span class="st">"matrix"</span>,</span>
<span id="cb40-813"><a href="#cb40-813" aria-hidden="true" tabindex="-1"></a>    <span class="at">k =</span> <span class="dv">4</span>,</span>
<span id="cb40-814"><a href="#cb40-814" aria-hidden="true" tabindex="-1"></a>    <span class="at">q =</span> <span class="dv">1</span>,</span>
<span id="cb40-815"><a href="#cb40-815" aria-hidden="true" tabindex="-1"></a>    <span class="at">threads =</span> <span class="dv">4</span>  <span class="co"># Doubled</span></span>
<span id="cb40-816"><a href="#cb40-816" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb40-817"><a href="#cb40-817" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb40-818"><a href="#cb40-818" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-819"><a href="#cb40-819" aria-hidden="true" tabindex="-1"></a>improvement2 <span class="ot">&lt;-</span> (test1_time[<span class="st">"elapsed"</span>] <span class="sc">-</span> test2_time[<span class="st">"elapsed"</span>]) <span class="sc">/</span> </span>
<span id="cb40-820"><a href="#cb40-820" aria-hidden="true" tabindex="-1"></a>                test1_time[<span class="st">"elapsed"</span>] <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb40-821"><a href="#cb40-821" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-822"><a href="#cb40-822" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"threads=4 time:"</span>, test2_time[<span class="st">"elapsed"</span>], <span class="st">"seconds</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-823"><a href="#cb40-823" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Additional improvement:"</span>, <span class="fu">round</span>(improvement2, <span class="dv">1</span>), <span class="st">"%</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-824"><a href="#cb40-824" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-825"><a href="#cb40-825" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-826"><a href="#cb40-826" aria-hidden="true" tabindex="-1"></a>**Phase 4: Verify and select**</span>
<span id="cb40-827"><a href="#cb40-827" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-828"><a href="#cb40-828" aria-hidden="true" tabindex="-1"></a><span class="in">```r</span></span>
<span id="cb40-829"><a href="#cb40-829" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify results match baseline</span></span>
<span id="cb40-830"><a href="#cb40-830" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Verifying correctness...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-831"><a href="#cb40-831" aria-hidden="true" tabindex="-1"></a><span class="fu">all.equal</span>(</span>
<span id="cb40-832"><a href="#cb40-832" aria-hidden="true" tabindex="-1"></a>  baseline_result<span class="sc">$</span>components[,<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>],</span>
<span id="cb40-833"><a href="#cb40-833" aria-hidden="true" tabindex="-1"></a>  test2_result<span class="sc">$</span>components[,<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>],</span>
<span id="cb40-834"><a href="#cb40-834" aria-hidden="true" tabindex="-1"></a>  <span class="at">tolerance =</span> <span class="fl">1e-10</span></span>
<span id="cb40-835"><a href="#cb40-835" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-836"><a href="#cb40-836" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-837"><a href="#cb40-837" aria-hidden="true" tabindex="-1"></a><span class="co"># Choose best configuration</span></span>
<span id="cb40-838"><a href="#cb40-838" aria-hidden="true" tabindex="-1"></a>configurations <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb40-839"><a href="#cb40-839" aria-hidden="true" tabindex="-1"></a>  <span class="at">config =</span> <span class="fu">c</span>(<span class="st">"Baseline"</span>, <span class="st">"k=4"</span>, <span class="st">"k=4,t=4"</span>),</span>
<span id="cb40-840"><a href="#cb40-840" aria-hidden="true" tabindex="-1"></a>  <span class="at">time =</span> <span class="fu">c</span>(baseline_time[<span class="st">"elapsed"</span>], </span>
<span id="cb40-841"><a href="#cb40-841" aria-hidden="true" tabindex="-1"></a>           test1_time[<span class="st">"elapsed"</span>],</span>
<span id="cb40-842"><a href="#cb40-842" aria-hidden="true" tabindex="-1"></a>           test2_time[<span class="st">"elapsed"</span>]),</span>
<span id="cb40-843"><a href="#cb40-843" aria-hidden="true" tabindex="-1"></a>  <span class="at">speedup =</span> <span class="fu">c</span>(<span class="fl">1.0</span>,</span>
<span id="cb40-844"><a href="#cb40-844" aria-hidden="true" tabindex="-1"></a>              baseline_time[<span class="st">"elapsed"</span>] <span class="sc">/</span> test1_time[<span class="st">"elapsed"</span>],</span>
<span id="cb40-845"><a href="#cb40-845" aria-hidden="true" tabindex="-1"></a>              baseline_time[<span class="st">"elapsed"</span>] <span class="sc">/</span> test2_time[<span class="st">"elapsed"</span>])</span>
<span id="cb40-846"><a href="#cb40-846" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-847"><a href="#cb40-847" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-848"><a href="#cb40-848" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(configurations)</span>
<span id="cb40-849"><a href="#cb40-849" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-850"><a href="#cb40-850" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Recommended configuration: k=4, threads=4</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-851"><a href="#cb40-851" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-852"><a href="#cb40-852" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-853"><a href="#cb40-853" aria-hidden="true" tabindex="-1"></a>This systematic approach finds good configurations without exhaustive testing.</span>
<span id="cb40-854"><a href="#cb40-854" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-855"><a href="#cb40-855" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb40-856"><a href="#cb40-856" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-857"><a href="#cb40-857" aria-hidden="true" tabindex="-1"></a><span class="fu">## Common Performance Pitfalls</span></span>
<span id="cb40-858"><a href="#cb40-858" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-859"><a href="#cb40-859" aria-hidden="true" tabindex="-1"></a>Experience reveals recurring mistakes that degrade performance. Recognizing these patterns helps you avoid them.</span>
<span id="cb40-860"><a href="#cb40-860" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-861"><a href="#cb40-861" aria-hidden="true" tabindex="-1"></a><span class="fu">### Pitfall 1: Excessive Blocking</span></span>
<span id="cb40-862"><a href="#cb40-862" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-863"><a href="#cb40-863" aria-hidden="true" tabindex="-1"></a>**Symptom:** Computation is very slow despite low memory usage (30-40% of RAM used).</span>
<span id="cb40-864"><a href="#cb40-864" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-865"><a href="#cb40-865" aria-hidden="true" tabindex="-1"></a>**Cause:** Block count (k) is much larger than necessary, creating excessive overhead from operations and I/O.</span>
<span id="cb40-866"><a href="#cb40-866" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-867"><a href="#cb40-867" aria-hidden="true" tabindex="-1"></a>**Why this happens:** Overly conservative memory estimates or copying someone else's configuration without adapting to your hardware.</span>
<span id="cb40-868"><a href="#cb40-868" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-869"><a href="#cb40-869" aria-hidden="true" tabindex="-1"></a>**Example:**</span>
<span id="cb40-870"><a href="#cb40-870" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-871"><a href="#cb40-871" aria-hidden="true" tabindex="-1"></a><span class="in">```r</span></span>
<span id="cb40-872"><a href="#cb40-872" aria-hidden="true" tabindex="-1"></a><span class="co"># Poor configuration</span></span>
<span id="cb40-873"><a href="#cb40-873" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb40-874"><a href="#cb40-874" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">bdSVD_hdf5</span>(<span class="st">"data.hdf5"</span>, <span class="st">"data"</span>, <span class="st">"small"</span>, <span class="at">k=</span><span class="dv">32</span>)</span>
<span id="cb40-875"><a href="#cb40-875" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb40-876"><a href="#cb40-876" aria-hidden="true" tabindex="-1"></a><span class="co">#   elapsed: 45 seconds</span></span>
<span id="cb40-877"><a href="#cb40-877" aria-hidden="true" tabindex="-1"></a><span class="co"># Dataset: 10,000×5,000 (400 MB)</span></span>
<span id="cb40-878"><a href="#cb40-878" aria-hidden="true" tabindex="-1"></a><span class="co"># Available RAM: 16 GB (plenty of headroom!)</span></span>
<span id="cb40-879"><a href="#cb40-879" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-880"><a href="#cb40-880" aria-hidden="true" tabindex="-1"></a><span class="co"># Good configuration</span></span>
<span id="cb40-881"><a href="#cb40-881" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb40-882"><a href="#cb40-882" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">bdSVD_hdf5</span>(<span class="st">"data.hdf5"</span>, <span class="st">"data"</span>, <span class="st">"small"</span>, <span class="at">k=</span><span class="dv">2</span>)</span>
<span id="cb40-883"><a href="#cb40-883" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb40-884"><a href="#cb40-884" aria-hidden="true" tabindex="-1"></a><span class="co">#   elapsed: 8 seconds (82% faster)</span></span>
<span id="cb40-885"><a href="#cb40-885" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-886"><a href="#cb40-886" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-887"><a href="#cb40-887" aria-hidden="true" tabindex="-1"></a>**Fix:** Calculate appropriate k based on actual memory needs:</span>
<span id="cb40-888"><a href="#cb40-888" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-889"><a href="#cb40-889" aria-hidden="true" tabindex="-1"></a><span class="in">```r</span></span>
<span id="cb40-890"><a href="#cb40-890" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate dataset size</span></span>
<span id="cb40-891"><a href="#cb40-891" aria-hidden="true" tabindex="-1"></a>n_rows <span class="ot">&lt;-</span> <span class="dv">10000</span></span>
<span id="cb40-892"><a href="#cb40-892" aria-hidden="true" tabindex="-1"></a>n_cols <span class="ot">&lt;-</span> <span class="dv">5000</span></span>
<span id="cb40-893"><a href="#cb40-893" aria-hidden="true" tabindex="-1"></a>dataset_size_gb <span class="ot">&lt;-</span> (n_rows <span class="sc">*</span> n_cols <span class="sc">*</span> <span class="dv">8</span>) <span class="sc">/</span> (<span class="dv">1024</span><span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb40-894"><a href="#cb40-894" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Dataset size:"</span>, <span class="fu">round</span>(dataset_size_gb, <span class="dv">2</span>), <span class="st">"GB</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-895"><a href="#cb40-895" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-896"><a href="#cb40-896" aria-hidden="true" tabindex="-1"></a><span class="co"># Available RAM</span></span>
<span id="cb40-897"><a href="#cb40-897" aria-hidden="true" tabindex="-1"></a>available_gb <span class="ot">&lt;-</span> <span class="dv">16</span></span>
<span id="cb40-898"><a href="#cb40-898" aria-hidden="true" tabindex="-1"></a>k_needed <span class="ot">&lt;-</span> <span class="fu">ceiling</span>(dataset_size_gb <span class="sc">/</span> (available_gb <span class="sc">*</span> <span class="fl">0.5</span>))</span>
<span id="cb40-899"><a href="#cb40-899" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Minimum k needed:"</span>, k_needed, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-900"><a href="#cb40-900" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Recommended k:"</span>, <span class="fu">max</span>(<span class="dv">2</span>, k_needed), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-901"><a href="#cb40-901" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-902"><a href="#cb40-902" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-903"><a href="#cb40-903" aria-hidden="true" tabindex="-1"></a>**Rule:** Use smallest k that keeps memory usage comfortably below limits (60-70% of RAM).</span>
<span id="cb40-904"><a href="#cb40-904" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-905"><a href="#cb40-905" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb40-906"><a href="#cb40-906" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-907"><a href="#cb40-907" aria-hidden="true" tabindex="-1"></a><span class="fu">### Pitfall 2: Thread Oversubscription</span></span>
<span id="cb40-908"><a href="#cb40-908" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-909"><a href="#cb40-909" aria-hidden="true" tabindex="-1"></a>**Symptom:** Adding more threads doesn't improve performance or actually makes it worse.</span>
<span id="cb40-910"><a href="#cb40-910" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-911"><a href="#cb40-911" aria-hidden="true" tabindex="-1"></a>**Cause:** More threads than physical CPU cores, causing context switching overhead and cache thrashing.</span>
<span id="cb40-912"><a href="#cb40-912" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-913"><a href="#cb40-913" aria-hidden="true" tabindex="-1"></a>**Why this happens:** Confusing physical cores with hyperthreads/logical cores, or assuming "more threads = more speed."</span>
<span id="cb40-914"><a href="#cb40-914" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-915"><a href="#cb40-915" aria-hidden="true" tabindex="-1"></a>**Example:**</span>
<span id="cb40-916"><a href="#cb40-916" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-917"><a href="#cb40-917" aria-hidden="true" tabindex="-1"></a><span class="in">```r</span></span>
<span id="cb40-918"><a href="#cb40-918" aria-hidden="true" tabindex="-1"></a><span class="co"># System: 4 physical cores (8 hyperthreads)</span></span>
<span id="cb40-919"><a href="#cb40-919" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-920"><a href="#cb40-920" aria-hidden="true" tabindex="-1"></a><span class="co"># Poor: threads=16 (4× oversubscription)</span></span>
<span id="cb40-921"><a href="#cb40-921" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb40-922"><a href="#cb40-922" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">bdPCA_hdf5</span>(<span class="st">"data.hdf5"</span>, <span class="st">"data"</span>, <span class="st">"matrix"</span>, </span>
<span id="cb40-923"><a href="#cb40-923" aria-hidden="true" tabindex="-1"></a>                       <span class="at">k=</span><span class="dv">8</span>, <span class="at">threads=</span><span class="dv">16</span>)</span>
<span id="cb40-924"><a href="#cb40-924" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb40-925"><a href="#cb40-925" aria-hidden="true" tabindex="-1"></a><span class="co">#   elapsed: 25 seconds</span></span>
<span id="cb40-926"><a href="#cb40-926" aria-hidden="true" tabindex="-1"></a><span class="co"># Context switching overhead, cache thrashing</span></span>
<span id="cb40-927"><a href="#cb40-927" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-928"><a href="#cb40-928" aria-hidden="true" tabindex="-1"></a><span class="co"># Good: threads=4 (matches physical cores)</span></span>
<span id="cb40-929"><a href="#cb40-929" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb40-930"><a href="#cb40-930" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">bdPCA_hdf5</span>(<span class="st">"data.hdf5"</span>, <span class="st">"data"</span>, <span class="st">"matrix"</span>,</span>
<span id="cb40-931"><a href="#cb40-931" aria-hidden="true" tabindex="-1"></a>                       <span class="at">k=</span><span class="dv">8</span>, <span class="at">threads=</span><span class="dv">4</span>)</span>
<span id="cb40-932"><a href="#cb40-932" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb40-933"><a href="#cb40-933" aria-hidden="true" tabindex="-1"></a><span class="co">#   elapsed: 12 seconds (52% faster)</span></span>
<span id="cb40-934"><a href="#cb40-934" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-935"><a href="#cb40-935" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-936"><a href="#cb40-936" aria-hidden="true" tabindex="-1"></a>**Understanding the problem:** When threads exceed physical cores, the operating system rapidly switches between them (context switching). Each switch: saves one thread's state, loads another's state, invalidates CPU caches. With 16 threads on 4 cores, each core switches between 4 threads. Switching costs accumulate, and cache efficiency plummets—data constantly evicted before use.</span>
<span id="cb40-937"><a href="#cb40-937" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-938"><a href="#cb40-938" aria-hidden="true" tabindex="-1"></a>**Fix:** Match threads to physical cores:</span>
<span id="cb40-939"><a href="#cb40-939" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-940"><a href="#cb40-940" aria-hidden="true" tabindex="-1"></a><span class="in">```r</span></span>
<span id="cb40-941"><a href="#cb40-941" aria-hidden="true" tabindex="-1"></a><span class="co"># Find physical cores (not hyperthreads)</span></span>
<span id="cb40-942"><a href="#cb40-942" aria-hidden="true" tabindex="-1"></a>n_physical <span class="ot">&lt;-</span> parallel<span class="sc">::</span><span class="fu">detectCores</span>(<span class="at">logical =</span> <span class="cn">FALSE</span>)</span>
<span id="cb40-943"><a href="#cb40-943" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Physical cores:"</span>, n_physical, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-944"><a href="#cb40-944" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-945"><a href="#cb40-945" aria-hidden="true" tabindex="-1"></a><span class="co"># Use physical cores as upper bound</span></span>
<span id="cb40-946"><a href="#cb40-946" aria-hidden="true" tabindex="-1"></a>optimal_threads <span class="ot">&lt;-</span> <span class="fu">min</span>(n_physical, <span class="dv">8</span>)  <span class="co"># Cap at 8 for safety</span></span>
<span id="cb40-947"><a href="#cb40-947" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-948"><a href="#cb40-948" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-949"><a href="#cb40-949" aria-hidden="true" tabindex="-1"></a>**Additional check—BLAS threading:**</span>
<span id="cb40-950"><a href="#cb40-950" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-951"><a href="#cb40-951" aria-hidden="true" tabindex="-1"></a>Some BLAS libraries (MKL, OpenBLAS) use threading internally. If BLAS uses 4 threads and you specify threads=4 in BigDataStatMeth, you have 4×4=16 threads—oversubscription even with 16 physical cores.</span>
<span id="cb40-952"><a href="#cb40-952" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-953"><a href="#cb40-953" aria-hidden="true" tabindex="-1"></a><span class="in">```r</span></span>
<span id="cb40-954"><a href="#cb40-954" aria-hidden="true" tabindex="-1"></a><span class="co"># Check BLAS configuration</span></span>
<span id="cb40-955"><a href="#cb40-955" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span>
<span id="cb40-956"><a href="#cb40-956" aria-hidden="true" tabindex="-1"></a><span class="co"># Look for "BLAS: " line</span></span>
<span id="cb40-957"><a href="#cb40-957" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-958"><a href="#cb40-958" aria-hidden="true" tabindex="-1"></a><span class="co"># If multi-threaded BLAS, limit BigDataStatMeth threads</span></span>
<span id="cb40-959"><a href="#cb40-959" aria-hidden="true" tabindex="-1"></a><span class="fu">Sys.setenv</span>(<span class="at">OPENBLAS_NUM_THREADS =</span> <span class="dv">1</span>)  <span class="co"># Disable BLAS threading</span></span>
<span id="cb40-960"><a href="#cb40-960" aria-hidden="true" tabindex="-1"></a><span class="co"># OR</span></span>
<span id="cb40-961"><a href="#cb40-961" aria-hidden="true" tabindex="-1"></a><span class="co"># Use fewer BigDataStatMeth threads to account for BLAS threading</span></span>
<span id="cb40-962"><a href="#cb40-962" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-963"><a href="#cb40-963" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-964"><a href="#cb40-964" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb40-965"><a href="#cb40-965" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-966"><a href="#cb40-966" aria-hidden="true" tabindex="-1"></a><span class="fu">### Pitfall 3: Redundant Operations</span></span>
<span id="cb40-967"><a href="#cb40-967" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-968"><a href="#cb40-968" aria-hidden="true" tabindex="-1"></a>**Symptom:** Repeated analyses (parameter sweeps, cross-validation) each take the same amount of time, including time for operations that don't change between runs.</span>
<span id="cb40-969"><a href="#cb40-969" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-970"><a href="#cb40-970" aria-hidden="true" tabindex="-1"></a>**Cause:** Not leveraging HDF5's persistence to reuse computed results.</span>
<span id="cb40-971"><a href="#cb40-971" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-972"><a href="#cb40-972" aria-hidden="true" tabindex="-1"></a>**Why this happens:** Treating each analysis as independent rather than recognizing shared computations.</span>
<span id="cb40-973"><a href="#cb40-973" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-974"><a href="#cb40-974" aria-hidden="true" tabindex="-1"></a>**Example:**</span>
<span id="cb40-975"><a href="#cb40-975" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-976"><a href="#cb40-976" aria-hidden="true" tabindex="-1"></a><span class="in">```r</span></span>
<span id="cb40-977"><a href="#cb40-977" aria-hidden="true" tabindex="-1"></a><span class="co"># Poor: Normalize every iteration</span></span>
<span id="cb40-978"><a href="#cb40-978" aria-hidden="true" tabindex="-1"></a>parameter_values <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">50</span>)</span>
<span id="cb40-979"><a href="#cb40-979" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-980"><a href="#cb40-980" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (n_components <span class="cf">in</span> parameter_values) {</span>
<span id="cb40-981"><a href="#cb40-981" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">bdPCA_hdf5</span>(</span>
<span id="cb40-982"><a href="#cb40-982" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> <span class="st">"data.hdf5"</span>,</span>
<span id="cb40-983"><a href="#cb40-983" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"data"</span>,</span>
<span id="cb40-984"><a href="#cb40-984" aria-hidden="true" tabindex="-1"></a>    <span class="at">dataset =</span> <span class="st">"raw"</span>,</span>
<span id="cb40-985"><a href="#cb40-985" aria-hidden="true" tabindex="-1"></a>    <span class="at">bcenter =</span> <span class="cn">TRUE</span>,   <span class="co"># Normalizes every iteration</span></span>
<span id="cb40-986"><a href="#cb40-986" aria-hidden="true" tabindex="-1"></a>    <span class="at">bscale =</span> <span class="cn">TRUE</span>,</span>
<span id="cb40-987"><a href="#cb40-987" aria-hidden="true" tabindex="-1"></a>    <span class="at">k =</span> <span class="dv">4</span>,</span>
<span id="cb40-988"><a href="#cb40-988" aria-hidden="true" tabindex="-1"></a>    <span class="co"># n_components varies</span></span>
<span id="cb40-989"><a href="#cb40-989" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb40-990"><a href="#cb40-990" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Process result</span></span>
<span id="cb40-991"><a href="#cb40-991" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb40-992"><a href="#cb40-992" aria-hidden="true" tabindex="-1"></a><span class="co"># Total time: 5 × (normalization + PCA) = 5 × 60s = 300s</span></span>
<span id="cb40-993"><a href="#cb40-993" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-994"><a href="#cb40-994" aria-hidden="true" tabindex="-1"></a><span class="co"># Good: Normalize once, reuse</span></span>
<span id="cb40-995"><a href="#cb40-995" aria-hidden="true" tabindex="-1"></a><span class="fu">bdNormalize_hdf5</span>(</span>
<span id="cb40-996"><a href="#cb40-996" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> <span class="st">"data.hdf5"</span>,</span>
<span id="cb40-997"><a href="#cb40-997" aria-hidden="true" tabindex="-1"></a>  <span class="at">group =</span> <span class="st">"data"</span>,</span>
<span id="cb40-998"><a href="#cb40-998" aria-hidden="true" tabindex="-1"></a>  <span class="at">dataset =</span> <span class="st">"raw"</span>,</span>
<span id="cb40-999"><a href="#cb40-999" aria-hidden="true" tabindex="-1"></a>  <span class="at">bcenter =</span> <span class="cn">TRUE</span>,</span>
<span id="cb40-1000"><a href="#cb40-1000" aria-hidden="true" tabindex="-1"></a>  <span class="at">bscale =</span> <span class="cn">TRUE</span></span>
<span id="cb40-1001"><a href="#cb40-1001" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-1002"><a href="#cb40-1002" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1003"><a href="#cb40-1003" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (n_components <span class="cf">in</span> parameter_values) {</span>
<span id="cb40-1004"><a href="#cb40-1004" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">bdPCA_hdf5</span>(</span>
<span id="cb40-1005"><a href="#cb40-1005" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> <span class="st">"data.hdf5"</span>,</span>
<span id="cb40-1006"><a href="#cb40-1006" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"NORMALIZED/data"</span>,  <span class="co"># Pre-normalized</span></span>
<span id="cb40-1007"><a href="#cb40-1007" aria-hidden="true" tabindex="-1"></a>    <span class="at">dataset =</span> <span class="st">"raw"</span>,</span>
<span id="cb40-1008"><a href="#cb40-1008" aria-hidden="true" tabindex="-1"></a>    <span class="at">bcenter =</span> <span class="cn">FALSE</span>,  <span class="co"># Skip normalization</span></span>
<span id="cb40-1009"><a href="#cb40-1009" aria-hidden="true" tabindex="-1"></a>    <span class="at">bscale =</span> <span class="cn">FALSE</span>,</span>
<span id="cb40-1010"><a href="#cb40-1010" aria-hidden="true" tabindex="-1"></a>    <span class="at">k =</span> <span class="dv">4</span>,</span>
<span id="cb40-1011"><a href="#cb40-1011" aria-hidden="true" tabindex="-1"></a>    <span class="co"># n_components varies</span></span>
<span id="cb40-1012"><a href="#cb40-1012" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb40-1013"><a href="#cb40-1013" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Process result</span></span>
<span id="cb40-1014"><a href="#cb40-1014" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb40-1015"><a href="#cb40-1015" aria-hidden="true" tabindex="-1"></a><span class="co"># Total time: normalization + 5 × PCA = 50s + 5×10s = 100s (67% faster)</span></span>
<span id="cb40-1016"><a href="#cb40-1016" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-1017"><a href="#cb40-1017" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1018"><a href="#cb40-1018" aria-hidden="true" tabindex="-1"></a>**Understanding the savings:** If normalization takes 20% of total time and you run 10 analyses, normalizing once saves 9/10 × 20% = 18% of total workflow time. For workflows with hundreds of runs (bootstrapping, cross-validation), savings multiply dramatically.</span>
<span id="cb40-1019"><a href="#cb40-1019" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1020"><a href="#cb40-1020" aria-hidden="true" tabindex="-1"></a>**Fix strategy:**</span>
<span id="cb40-1021"><a href="#cb40-1021" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1022"><a href="#cb40-1022" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Identify operations that don't change between runs</span>
<span id="cb40-1023"><a href="#cb40-1023" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Perform them once, store results in HDF5</span>
<span id="cb40-1024"><a href="#cb40-1024" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Reuse stored results in subsequent runs</span>
<span id="cb40-1025"><a href="#cb40-1025" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1026"><a href="#cb40-1026" aria-hidden="true" tabindex="-1"></a>Applies to normalization, QR decomposition (for CCA), centering, scaling—any operation deterministic and shared across runs.</span>
<span id="cb40-1027"><a href="#cb40-1027" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1028"><a href="#cb40-1028" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb40-1029"><a href="#cb40-1029" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1030"><a href="#cb40-1030" aria-hidden="true" tabindex="-1"></a><span class="fu">## Benchmarking: Measuring Real Performance</span></span>
<span id="cb40-1031"><a href="#cb40-1031" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1032"><a href="#cb40-1032" aria-hidden="true" tabindex="-1"></a>To validate optimizations, benchmark systematically with real data and hardware. The following framework provides structure for comprehensive performance testing.</span>
<span id="cb40-1033"><a href="#cb40-1033" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1034"><a href="#cb40-1034" aria-hidden="true" tabindex="-1"></a><span class="fu">### Systematic Benchmarking Framework</span></span>
<span id="cb40-1035"><a href="#cb40-1035" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1036"><a href="#cb40-1036" aria-hidden="true" tabindex="-1"></a><span class="in">```r</span></span>
<span id="cb40-1037"><a href="#cb40-1037" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(microbenchmark)</span>
<span id="cb40-1038"><a href="#cb40-1038" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1039"><a href="#cb40-1039" aria-hidden="true" tabindex="-1"></a><span class="co"># Define configurations to test</span></span>
<span id="cb40-1040"><a href="#cb40-1040" aria-hidden="true" tabindex="-1"></a>test_configs <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb40-1041"><a href="#cb40-1041" aria-hidden="true" tabindex="-1"></a>  <span class="at">k =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">8</span>, <span class="dv">16</span>),</span>
<span id="cb40-1042"><a href="#cb40-1042" aria-hidden="true" tabindex="-1"></a>  <span class="at">threads =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">8</span>),</span>
<span id="cb40-1043"><a href="#cb40-1043" aria-hidden="true" tabindex="-1"></a>  <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb40-1044"><a href="#cb40-1044" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-1045"><a href="#cb40-1045" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1046"><a href="#cb40-1046" aria-hidden="true" tabindex="-1"></a><span class="co"># Run each configuration multiple times</span></span>
<span id="cb40-1047"><a href="#cb40-1047" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">seq_len</span>(<span class="fu">nrow</span>(test_configs)), <span class="cf">function</span>(i) {</span>
<span id="cb40-1048"><a href="#cb40-1048" aria-hidden="true" tabindex="-1"></a>  cfg <span class="ot">&lt;-</span> test_configs[i, ]</span>
<span id="cb40-1049"><a href="#cb40-1049" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb40-1050"><a href="#cb40-1050" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Testing k="</span>, cfg<span class="sc">$</span>k, <span class="st">", threads="</span>, cfg<span class="sc">$</span>threads, <span class="st">"...</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep=</span><span class="st">""</span>)</span>
<span id="cb40-1051"><a href="#cb40-1051" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb40-1052"><a href="#cb40-1052" aria-hidden="true" tabindex="-1"></a>  timing <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb40-1053"><a href="#cb40-1053" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bdSVD_hdf5</span>(</span>
<span id="cb40-1054"><a href="#cb40-1054" aria-hidden="true" tabindex="-1"></a>      <span class="at">file =</span> <span class="st">"benchmark_data.hdf5"</span>,</span>
<span id="cb40-1055"><a href="#cb40-1055" aria-hidden="true" tabindex="-1"></a>      <span class="at">group =</span> <span class="st">"data"</span>,</span>
<span id="cb40-1056"><a href="#cb40-1056" aria-hidden="true" tabindex="-1"></a>      <span class="at">dataset =</span> <span class="st">"matrix"</span>,</span>
<span id="cb40-1057"><a href="#cb40-1057" aria-hidden="true" tabindex="-1"></a>      <span class="at">k =</span> cfg<span class="sc">$</span>k,</span>
<span id="cb40-1058"><a href="#cb40-1058" aria-hidden="true" tabindex="-1"></a>      <span class="at">threads =</span> cfg<span class="sc">$</span>threads,</span>
<span id="cb40-1059"><a href="#cb40-1059" aria-hidden="true" tabindex="-1"></a>      <span class="at">bcenter =</span> <span class="cn">TRUE</span>,</span>
<span id="cb40-1060"><a href="#cb40-1060" aria-hidden="true" tabindex="-1"></a>      <span class="at">bscale =</span> <span class="cn">FALSE</span></span>
<span id="cb40-1061"><a href="#cb40-1061" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-1062"><a href="#cb40-1062" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb40-1063"><a href="#cb40-1063" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb40-1064"><a href="#cb40-1064" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb40-1065"><a href="#cb40-1065" aria-hidden="true" tabindex="-1"></a>    <span class="at">k =</span> cfg<span class="sc">$</span>k,</span>
<span id="cb40-1066"><a href="#cb40-1066" aria-hidden="true" tabindex="-1"></a>    <span class="at">threads =</span> cfg<span class="sc">$</span>threads,</span>
<span id="cb40-1067"><a href="#cb40-1067" aria-hidden="true" tabindex="-1"></a>    <span class="at">user =</span> timing[[<span class="st">"user"</span>]],</span>
<span id="cb40-1068"><a href="#cb40-1068" aria-hidden="true" tabindex="-1"></a>    <span class="at">system =</span> timing[[<span class="st">"system"</span>]],</span>
<span id="cb40-1069"><a href="#cb40-1069" aria-hidden="true" tabindex="-1"></a>    <span class="at">elapsed =</span> timing[[<span class="st">"elapsed"</span>]]</span>
<span id="cb40-1070"><a href="#cb40-1070" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb40-1071"><a href="#cb40-1071" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb40-1072"><a href="#cb40-1072" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1073"><a href="#cb40-1073" aria-hidden="true" tabindex="-1"></a>benchmark_df <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, results)</span>
<span id="cb40-1074"><a href="#cb40-1074" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1075"><a href="#cb40-1075" aria-hidden="true" tabindex="-1"></a><span class="co"># Analyze results</span></span>
<span id="cb40-1076"><a href="#cb40-1076" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Benchmark Results:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-1077"><a href="#cb40-1077" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(benchmark_df)</span>
<span id="cb40-1078"><a href="#cb40-1078" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1079"><a href="#cb40-1079" aria-hidden="true" tabindex="-1"></a><span class="co"># Find optimal configuration</span></span>
<span id="cb40-1080"><a href="#cb40-1080" aria-hidden="true" tabindex="-1"></a>optimal_idx <span class="ot">&lt;-</span> <span class="fu">which.min</span>(benchmark_df<span class="sc">$</span>elapsed)</span>
<span id="cb40-1081"><a href="#cb40-1081" aria-hidden="true" tabindex="-1"></a>optimal <span class="ot">&lt;-</span> benchmark_df[optimal_idx, ]</span>
<span id="cb40-1082"><a href="#cb40-1082" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1083"><a href="#cb40-1083" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Optimal configuration:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-1084"><a href="#cb40-1084" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  k ="</span>, optimal<span class="sc">$</span>k, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-1085"><a href="#cb40-1085" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  threads ="</span>, optimal<span class="sc">$</span>threads, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-1086"><a href="#cb40-1086" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  elapsed time ="</span>, <span class="fu">round</span>(optimal<span class="sc">$</span>elapsed, <span class="dv">2</span>), <span class="st">"seconds</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-1087"><a href="#cb40-1087" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-1088"><a href="#cb40-1088" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1089"><a href="#cb40-1089" aria-hidden="true" tabindex="-1"></a><span class="fu">### Visualizing Performance</span></span>
<span id="cb40-1090"><a href="#cb40-1090" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1091"><a href="#cb40-1091" aria-hidden="true" tabindex="-1"></a><span class="in">```r</span></span>
<span id="cb40-1092"><a href="#cb40-1092" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb40-1093"><a href="#cb40-1093" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1094"><a href="#cb40-1094" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot: k vs time for each thread count</span></span>
<span id="cb40-1095"><a href="#cb40-1095" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(benchmark_df, <span class="fu">aes</span>(<span class="at">x=</span>k, <span class="at">y=</span>elapsed, <span class="at">color=</span><span class="fu">factor</span>(threads))) <span class="sc">+</span></span>
<span id="cb40-1096"><a href="#cb40-1096" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">size=</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb40-1097"><a href="#cb40-1097" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size=</span><span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb40-1098"><a href="#cb40-1098" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_log2</span>(<span class="at">breaks=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">4</span>,<span class="dv">8</span>,<span class="dv">16</span>)) <span class="sc">+</span></span>
<span id="cb40-1099"><a href="#cb40-1099" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_brewer</span>(<span class="at">palette=</span><span class="st">"Set1"</span>, <span class="at">name=</span><span class="st">"Threads"</span>) <span class="sc">+</span></span>
<span id="cb40-1100"><a href="#cb40-1100" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb40-1101"><a href="#cb40-1101" aria-hidden="true" tabindex="-1"></a>    <span class="at">title=</span><span class="st">"SVD Performance: Block Size vs Thread Count"</span>,</span>
<span id="cb40-1102"><a href="#cb40-1102" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle=</span><span class="fu">paste</span>(<span class="st">"Dataset:"</span>, nrow, <span class="st">"×"</span>, ncol, <span class="st">"- Hardware:"</span>, RAM, <span class="st">"GB RAM"</span>),</span>
<span id="cb40-1103"><a href="#cb40-1103" aria-hidden="true" tabindex="-1"></a>    <span class="at">x=</span><span class="st">"Number of Blocks (k)"</span>,</span>
<span id="cb40-1104"><a href="#cb40-1104" aria-hidden="true" tabindex="-1"></a>    <span class="at">y=</span><span class="st">"Elapsed Time (seconds)"</span></span>
<span id="cb40-1105"><a href="#cb40-1105" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb40-1106"><a href="#cb40-1106" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size=</span><span class="dv">14</span>) <span class="sc">+</span></span>
<span id="cb40-1107"><a href="#cb40-1107" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"right"</span>)</span>
<span id="cb40-1108"><a href="#cb40-1108" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-1109"><a href="#cb40-1109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1110"><a href="#cb40-1110" aria-hidden="true" tabindex="-1"></a><span class="fu">### Interpreting Benchmarks</span></span>
<span id="cb40-1111"><a href="#cb40-1111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1112"><a href="#cb40-1112" aria-hidden="true" tabindex="-1"></a>**Look for these patterns:**</span>
<span id="cb40-1113"><a href="#cb40-1113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1114"><a href="#cb40-1114" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Optimal k:** Time decreases as k decreases, then levels off or increases. The minimum is your optimal k for this dataset/hardware combination.</span>
<span id="cb40-1115"><a href="#cb40-1115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1116"><a href="#cb40-1116" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Threading efficiency:** Compare times across thread counts for fixed k. If doubling threads doesn't halve time, you're hitting parallelization limits.</span>
<span id="cb40-1117"><a href="#cb40-1117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1118"><a href="#cb40-1118" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Interaction effects:** Sometimes optimal k changes with thread count. With few threads, smaller k is best (less overhead). With many threads, larger k helps (more blocks to parallelize).</span>
<span id="cb40-1119"><a href="#cb40-1119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1120"><a href="#cb40-1120" aria-hidden="true" tabindex="-1"></a>**Example interpretation:**</span>
<span id="cb40-1121"><a href="#cb40-1121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1122"><a href="#cb40-1122" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-1123"><a href="#cb40-1123" aria-hidden="true" tabindex="-1"></a><span class="in">k=2,  threads=1: 48.3s</span></span>
<span id="cb40-1124"><a href="#cb40-1124" aria-hidden="true" tabindex="-1"></a><span class="in">k=2,  threads=4: 14.2s  (speedup: 3.4×, efficiency: 85%)</span></span>
<span id="cb40-1125"><a href="#cb40-1125" aria-hidden="true" tabindex="-1"></a><span class="in">k=8,  threads=4: 18.7s</span></span>
<span id="cb40-1126"><a href="#cb40-1126" aria-hidden="true" tabindex="-1"></a><span class="in">k=16, threads=4: 26.1s</span></span>
<span id="cb40-1127"><a href="#cb40-1127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1128"><a href="#cb40-1128" aria-hidden="true" tabindex="-1"></a><span class="in">Conclusion: k=2 optimal (data fits in memory), threads=4 good efficiency</span></span>
<span id="cb40-1129"><a href="#cb40-1129" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-1130"><a href="#cb40-1130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1131"><a href="#cb40-1131" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb40-1132"><a href="#cb40-1132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1133"><a href="#cb40-1133" aria-hidden="true" tabindex="-1"></a><span class="fu">## Real-World Case Study: 1000 Genomes PCA</span></span>
<span id="cb40-1134"><a href="#cb40-1134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1135"><a href="#cb40-1135" aria-hidden="true" tabindex="-1"></a>Let's walk through complete optimization of a real analysis: PCA on 1000 Genomes data.</span>
<span id="cb40-1136"><a href="#cb40-1136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1137"><a href="#cb40-1137" aria-hidden="true" tabindex="-1"></a>**Dataset:** 2,504 samples × 500 genes from 1000 Genomes Project  </span>
<span id="cb40-1138"><a href="#cb40-1138" aria-hidden="true" tabindex="-1"></a>**Hardware:** Standard workstation (16 GB RAM, 4 physical cores)  </span>
<span id="cb40-1139"><a href="#cb40-1139" aria-hidden="true" tabindex="-1"></a>**Goal:** Optimize PCA to minimize analysis time while ensuring correctness</span>
<span id="cb40-1140"><a href="#cb40-1140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1141"><a href="#cb40-1141" aria-hidden="true" tabindex="-1"></a><span class="fu">### Initial Baseline</span></span>
<span id="cb40-1142"><a href="#cb40-1142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1143"><a href="#cb40-1143" aria-hidden="true" tabindex="-1"></a><span class="in">```r</span></span>
<span id="cb40-1144"><a href="#cb40-1144" aria-hidden="true" tabindex="-1"></a><span class="co"># Conservative starting configuration</span></span>
<span id="cb40-1145"><a href="#cb40-1145" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== Baseline Configuration ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-1146"><a href="#cb40-1146" aria-hidden="true" tabindex="-1"></a>baseline_time <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb40-1147"><a href="#cb40-1147" aria-hidden="true" tabindex="-1"></a>  baseline <span class="ot">&lt;-</span> <span class="fu">bdPCA_hdf5</span>(</span>
<span id="cb40-1148"><a href="#cb40-1148" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> <span class="st">"1000G.hdf5"</span>,</span>
<span id="cb40-1149"><a href="#cb40-1149" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"data"</span>,</span>
<span id="cb40-1150"><a href="#cb40-1150" aria-hidden="true" tabindex="-1"></a>    <span class="at">dataset =</span> <span class="st">"genotypes"</span>,</span>
<span id="cb40-1151"><a href="#cb40-1151" aria-hidden="true" tabindex="-1"></a>    <span class="at">bcenter =</span> <span class="cn">TRUE</span>,</span>
<span id="cb40-1152"><a href="#cb40-1152" aria-hidden="true" tabindex="-1"></a>    <span class="at">bscale =</span> <span class="cn">FALSE</span>,</span>
<span id="cb40-1153"><a href="#cb40-1153" aria-hidden="true" tabindex="-1"></a>    <span class="at">k =</span> <span class="dv">8</span>,    <span class="co"># Conservative blocking</span></span>
<span id="cb40-1154"><a href="#cb40-1154" aria-hidden="true" tabindex="-1"></a>    <span class="at">q =</span> <span class="dv">1</span>,</span>
<span id="cb40-1155"><a href="#cb40-1155" aria-hidden="true" tabindex="-1"></a>    <span class="at">threads =</span> <span class="dv">2</span>  <span class="co"># Conservative threading</span></span>
<span id="cb40-1156"><a href="#cb40-1156" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb40-1157"><a href="#cb40-1157" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb40-1158"><a href="#cb40-1158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1159"><a href="#cb40-1159" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Elapsed time:"</span>, baseline_time[<span class="st">"elapsed"</span>], <span class="st">"seconds</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-1160"><a href="#cb40-1160" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"User time:"</span>, baseline_time[<span class="st">"user"</span>], <span class="st">"seconds</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-1161"><a href="#cb40-1161" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"System time:"</span>, baseline_time[<span class="st">"system"</span>], <span class="st">"seconds</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb40-1162"><a href="#cb40-1162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1163"><a href="#cb40-1163" aria-hidden="true" tabindex="-1"></a><span class="co"># Typical output:</span></span>
<span id="cb40-1164"><a href="#cb40-1164" aria-hidden="true" tabindex="-1"></a><span class="co">#   Elapsed time: 23.45 seconds</span></span>
<span id="cb40-1165"><a href="#cb40-1165" aria-hidden="true" tabindex="-1"></a><span class="co">#   User time: 41.23 seconds</span></span>
<span id="cb40-1166"><a href="#cb40-1166" aria-hidden="true" tabindex="-1"></a><span class="co">#   System time: 3.12 seconds</span></span>
<span id="cb40-1167"><a href="#cb40-1167" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-1168"><a href="#cb40-1168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1169"><a href="#cb40-1169" aria-hidden="true" tabindex="-1"></a>**Initial observations:**</span>
<span id="cb40-1170"><a href="#cb40-1170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1171"><a href="#cb40-1171" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>User time &gt;&gt; elapsed time: Parallelization working (2 threads doing ~1.8× work)</span>
<span id="cb40-1172"><a href="#cb40-1172" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>System time moderate (~13% of elapsed): I/O not dominant but noticeable</span>
<span id="cb40-1173"><a href="#cb40-1173" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Memory usage: ~4 GB peak (plenty of headroom with 16 GB available)</span>
<span id="cb40-1174"><a href="#cb40-1174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1175"><a href="#cb40-1175" aria-hidden="true" tabindex="-1"></a><span class="fu">### Profile to Identify Bottlenecks</span></span>
<span id="cb40-1176"><a href="#cb40-1176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1177"><a href="#cb40-1177" aria-hidden="true" tabindex="-1"></a><span class="in">```r</span></span>
<span id="cb40-1178"><a href="#cb40-1178" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== Profiling to Find Bottlenecks ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-1179"><a href="#cb40-1179" aria-hidden="true" tabindex="-1"></a><span class="fu">Rprof</span>(<span class="st">"pca_profile.out"</span>)</span>
<span id="cb40-1180"><a href="#cb40-1180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1181"><a href="#cb40-1181" aria-hidden="true" tabindex="-1"></a><span class="fu">bdPCA_hdf5</span>(</span>
<span id="cb40-1182"><a href="#cb40-1182" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> <span class="st">"1000G.hdf5"</span>,</span>
<span id="cb40-1183"><a href="#cb40-1183" aria-hidden="true" tabindex="-1"></a>  <span class="at">group =</span> <span class="st">"data"</span>,</span>
<span id="cb40-1184"><a href="#cb40-1184" aria-hidden="true" tabindex="-1"></a>  <span class="at">dataset =</span> <span class="st">"genotypes"</span>,</span>
<span id="cb40-1185"><a href="#cb40-1185" aria-hidden="true" tabindex="-1"></a>  <span class="at">bcenter =</span> <span class="cn">TRUE</span>,</span>
<span id="cb40-1186"><a href="#cb40-1186" aria-hidden="true" tabindex="-1"></a>  <span class="at">bscale =</span> <span class="cn">FALSE</span>,</span>
<span id="cb40-1187"><a href="#cb40-1187" aria-hidden="true" tabindex="-1"></a>  <span class="at">k =</span> <span class="dv">8</span>,</span>
<span id="cb40-1188"><a href="#cb40-1188" aria-hidden="true" tabindex="-1"></a>  <span class="at">q =</span> <span class="dv">1</span>,</span>
<span id="cb40-1189"><a href="#cb40-1189" aria-hidden="true" tabindex="-1"></a>  <span class="at">threads =</span> <span class="dv">2</span></span>
<span id="cb40-1190"><a href="#cb40-1190" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-1191"><a href="#cb40-1191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1192"><a href="#cb40-1192" aria-hidden="true" tabindex="-1"></a><span class="fu">Rprof</span>(<span class="cn">NULL</span>)</span>
<span id="cb40-1193"><a href="#cb40-1193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1194"><a href="#cb40-1194" aria-hidden="true" tabindex="-1"></a><span class="co"># Analyze profile</span></span>
<span id="cb40-1195"><a href="#cb40-1195" aria-hidden="true" tabindex="-1"></a>profile <span class="ot">&lt;-</span> <span class="fu">summaryRprof</span>(<span class="st">"pca_profile.out"</span>)</span>
<span id="cb40-1196"><a href="#cb40-1196" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(profile<span class="sc">$</span>by.self[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>,])</span>
<span id="cb40-1197"><a href="#cb40-1197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1198"><a href="#cb40-1198" aria-hidden="true" tabindex="-1"></a><span class="co"># Typical output shows:</span></span>
<span id="cb40-1199"><a href="#cb40-1199" aria-hidden="true" tabindex="-1"></a><span class="co">#   bdSVD_hdf5:      60% of time (primary bottleneck)</span></span>
<span id="cb40-1200"><a href="#cb40-1200" aria-hidden="true" tabindex="-1"></a><span class="co">#   bdNormalize:     25% of time (opportunity for pre-computation)</span></span>
<span id="cb40-1201"><a href="#cb40-1201" aria-hidden="true" tabindex="-1"></a><span class="co">#   h5read:          12% of time (I/O overhead)</span></span>
<span id="cb40-1202"><a href="#cb40-1202" aria-hidden="true" tabindex="-1"></a><span class="co">#   Other:           3% of time</span></span>
<span id="cb40-1203"><a href="#cb40-1203" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-1204"><a href="#cb40-1204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1205"><a href="#cb40-1205" aria-hidden="true" tabindex="-1"></a>**Bottleneck identified:** SVD computation dominates (60%), normalization is significant (25%), I/O is noticeable (12%).</span>
<span id="cb40-1206"><a href="#cb40-1206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1207"><a href="#cb40-1207" aria-hidden="true" tabindex="-1"></a>**Optimization strategy based on profiling:**</span>
<span id="cb40-1208"><a href="#cb40-1208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1209"><a href="#cb40-1209" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Reduce k to speed up SVD (we have memory headroom)</span>
<span id="cb40-1210"><a href="#cb40-1210" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Increase threads to parallelize SVD better (4 cores available)</span>
<span id="cb40-1211"><a href="#cb40-1211" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Pre-normalize data to eliminate repeated normalization</span>
<span id="cb40-1212"><a href="#cb40-1212" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>Consider HDF5 chunking if I/O remains problematic after other optimizations</span>
<span id="cb40-1213"><a href="#cb40-1213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1214"><a href="#cb40-1214" aria-hidden="true" tabindex="-1"></a><span class="fu">### Optimization 1: Reduce Block Count</span></span>
<span id="cb40-1215"><a href="#cb40-1215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1216"><a href="#cb40-1216" aria-hidden="true" tabindex="-1"></a><span class="in">```r</span></span>
<span id="cb40-1217"><a href="#cb40-1217" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== Optimization 1: Reduce k ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-1218"><a href="#cb40-1218" aria-hidden="true" tabindex="-1"></a>opt1_time <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb40-1219"><a href="#cb40-1219" aria-hidden="true" tabindex="-1"></a>  opt1 <span class="ot">&lt;-</span> <span class="fu">bdPCA_hdf5</span>(</span>
<span id="cb40-1220"><a href="#cb40-1220" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> <span class="st">"1000G.hdf5"</span>,</span>
<span id="cb40-1221"><a href="#cb40-1221" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"data"</span>,</span>
<span id="cb40-1222"><a href="#cb40-1222" aria-hidden="true" tabindex="-1"></a>    <span class="at">dataset =</span> <span class="st">"genotypes"</span>,</span>
<span id="cb40-1223"><a href="#cb40-1223" aria-hidden="true" tabindex="-1"></a>    <span class="at">bcenter =</span> <span class="cn">TRUE</span>,</span>
<span id="cb40-1224"><a href="#cb40-1224" aria-hidden="true" tabindex="-1"></a>    <span class="at">bscale =</span> <span class="cn">FALSE</span>,</span>
<span id="cb40-1225"><a href="#cb40-1225" aria-hidden="true" tabindex="-1"></a>    <span class="at">k =</span> <span class="dv">4</span>,    <span class="co"># Halved from 8</span></span>
<span id="cb40-1226"><a href="#cb40-1226" aria-hidden="true" tabindex="-1"></a>    <span class="at">q =</span> <span class="dv">1</span>,</span>
<span id="cb40-1227"><a href="#cb40-1227" aria-hidden="true" tabindex="-1"></a>    <span class="at">threads =</span> <span class="dv">2</span></span>
<span id="cb40-1228"><a href="#cb40-1228" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb40-1229"><a href="#cb40-1229" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb40-1230"><a href="#cb40-1230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1231"><a href="#cb40-1231" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Elapsed time:"</span>, opt1_time[<span class="st">"elapsed"</span>], <span class="st">"seconds</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-1232"><a href="#cb40-1232" aria-hidden="true" tabindex="-1"></a>improvement1 <span class="ot">&lt;-</span> (baseline_time[<span class="st">"elapsed"</span>] <span class="sc">-</span> opt1_time[<span class="st">"elapsed"</span>]) <span class="sc">/</span> </span>
<span id="cb40-1233"><a href="#cb40-1233" aria-hidden="true" tabindex="-1"></a>                baseline_time[<span class="st">"elapsed"</span>] <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb40-1234"><a href="#cb40-1234" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Improvement:"</span>, <span class="fu">round</span>(improvement1, <span class="dv">1</span>), <span class="st">"%</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb40-1235"><a href="#cb40-1235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1236"><a href="#cb40-1236" aria-hidden="true" tabindex="-1"></a><span class="co"># Typical output:</span></span>
<span id="cb40-1237"><a href="#cb40-1237" aria-hidden="true" tabindex="-1"></a><span class="co">#   Elapsed time: 18.32 seconds</span></span>
<span id="cb40-1238"><a href="#cb40-1238" aria-hidden="true" tabindex="-1"></a><span class="co">#   Improvement: 21.9%</span></span>
<span id="cb40-1239"><a href="#cb40-1239" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-1240"><a href="#cb40-1240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1241"><a href="#cb40-1241" aria-hidden="true" tabindex="-1"></a>**Why this helped:** Reducing from k=8 to k=4 halves the number of block operations. SVD on 4 blocks is faster than SVD on 8 blocks. Memory usage increased from 4GB to 6GB—well within our 16GB capacity.</span>
<span id="cb40-1242"><a href="#cb40-1242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1243"><a href="#cb40-1243" aria-hidden="true" tabindex="-1"></a><span class="fu">### Optimization 2: Increase Threading</span></span>
<span id="cb40-1244"><a href="#cb40-1244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1245"><a href="#cb40-1245" aria-hidden="true" tabindex="-1"></a><span class="in">```r</span></span>
<span id="cb40-1246"><a href="#cb40-1246" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== Optimization 2: Increase threads ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-1247"><a href="#cb40-1247" aria-hidden="true" tabindex="-1"></a>opt2_time <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb40-1248"><a href="#cb40-1248" aria-hidden="true" tabindex="-1"></a>  opt2 <span class="ot">&lt;-</span> <span class="fu">bdPCA_hdf5</span>(</span>
<span id="cb40-1249"><a href="#cb40-1249" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> <span class="st">"1000G.hdf5"</span>,</span>
<span id="cb40-1250"><a href="#cb40-1250" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"data"</span>,</span>
<span id="cb40-1251"><a href="#cb40-1251" aria-hidden="true" tabindex="-1"></a>    <span class="at">dataset =</span> <span class="st">"genotypes"</span>,</span>
<span id="cb40-1252"><a href="#cb40-1252" aria-hidden="true" tabindex="-1"></a>    <span class="at">bcenter =</span> <span class="cn">TRUE</span>,</span>
<span id="cb40-1253"><a href="#cb40-1253" aria-hidden="true" tabindex="-1"></a>    <span class="at">bscale =</span> <span class="cn">FALSE</span>,</span>
<span id="cb40-1254"><a href="#cb40-1254" aria-hidden="true" tabindex="-1"></a>    <span class="at">k =</span> <span class="dv">4</span>,</span>
<span id="cb40-1255"><a href="#cb40-1255" aria-hidden="true" tabindex="-1"></a>    <span class="at">q =</span> <span class="dv">1</span>,</span>
<span id="cb40-1256"><a href="#cb40-1256" aria-hidden="true" tabindex="-1"></a>    <span class="at">threads =</span> <span class="dv">4</span>  <span class="co"># Doubled from 2</span></span>
<span id="cb40-1257"><a href="#cb40-1257" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb40-1258"><a href="#cb40-1258" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb40-1259"><a href="#cb40-1259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1260"><a href="#cb40-1260" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Elapsed time:"</span>, opt2_time[<span class="st">"elapsed"</span>], <span class="st">"seconds</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-1261"><a href="#cb40-1261" aria-hidden="true" tabindex="-1"></a>improvement2 <span class="ot">&lt;-</span> (opt1_time[<span class="st">"elapsed"</span>] <span class="sc">-</span> opt2_time[<span class="st">"elapsed"</span>]) <span class="sc">/</span> </span>
<span id="cb40-1262"><a href="#cb40-1262" aria-hidden="true" tabindex="-1"></a>                opt1_time[<span class="st">"elapsed"</span>] <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb40-1263"><a href="#cb40-1263" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Additional improvement:"</span>, <span class="fu">round</span>(improvement2, <span class="dv">1</span>), <span class="st">"%</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-1264"><a href="#cb40-1264" aria-hidden="true" tabindex="-1"></a>total_improvement <span class="ot">&lt;-</span> (baseline_time[<span class="st">"elapsed"</span>] <span class="sc">-</span> opt2_time[<span class="st">"elapsed"</span>]) <span class="sc">/</span> </span>
<span id="cb40-1265"><a href="#cb40-1265" aria-hidden="true" tabindex="-1"></a>                     baseline_time[<span class="st">"elapsed"</span>] <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb40-1266"><a href="#cb40-1266" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Total improvement vs baseline:"</span>, <span class="fu">round</span>(total_improvement, <span class="dv">1</span>), <span class="st">"%</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb40-1267"><a href="#cb40-1267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1268"><a href="#cb40-1268" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate threading efficiency</span></span>
<span id="cb40-1269"><a href="#cb40-1269" aria-hidden="true" tabindex="-1"></a>speedup <span class="ot">&lt;-</span> opt1_time[<span class="st">"elapsed"</span>] <span class="sc">/</span> opt2_time[<span class="st">"elapsed"</span>]</span>
<span id="cb40-1270"><a href="#cb40-1270" aria-hidden="true" tabindex="-1"></a>efficiency <span class="ot">&lt;-</span> speedup <span class="sc">/</span> <span class="dv">2</span>  <span class="co"># Doubled threads</span></span>
<span id="cb40-1271"><a href="#cb40-1271" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Threading efficiency:"</span>, <span class="fu">round</span>(efficiency <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>), <span class="st">"%</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb40-1272"><a href="#cb40-1272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1273"><a href="#cb40-1273" aria-hidden="true" tabindex="-1"></a><span class="co"># Typical output:</span></span>
<span id="cb40-1274"><a href="#cb40-1274" aria-hidden="true" tabindex="-1"></a><span class="co">#   Elapsed time: 12.84 seconds</span></span>
<span id="cb40-1275"><a href="#cb40-1275" aria-hidden="true" tabindex="-1"></a><span class="co">#   Additional improvement: 29.9%</span></span>
<span id="cb40-1276"><a href="#cb40-1276" aria-hidden="true" tabindex="-1"></a><span class="co">#   Total improvement vs baseline: 45.3%</span></span>
<span id="cb40-1277"><a href="#cb40-1277" aria-hidden="true" tabindex="-1"></a><span class="co">#   Threading efficiency: 71.2%</span></span>
<span id="cb40-1278"><a href="#cb40-1278" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-1279"><a href="#cb40-1279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1280"><a href="#cb40-1280" aria-hidden="true" tabindex="-1"></a>**Why this helped:** With k=4, we have 4 blocks that can compute in parallel. Using 4 threads (matching our 4 physical cores) provides good parallelization. Efficiency of 71% is solid—some overhead from coordination and I/O, but most computation parallelizes well.</span>
<span id="cb40-1281"><a href="#cb40-1281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1282"><a href="#cb40-1282" aria-hidden="true" tabindex="-1"></a><span class="fu">### Optimization 3: Pre-normalize Data</span></span>
<span id="cb40-1283"><a href="#cb40-1283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1284"><a href="#cb40-1284" aria-hidden="true" tabindex="-1"></a><span class="in">```r</span></span>
<span id="cb40-1285"><a href="#cb40-1285" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== Optimization 3: Pre-normalize ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-1286"><a href="#cb40-1286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1287"><a href="#cb40-1287" aria-hidden="true" tabindex="-1"></a><span class="co"># Normalize once</span></span>
<span id="cb40-1288"><a href="#cb40-1288" aria-hidden="true" tabindex="-1"></a>norm_time <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb40-1289"><a href="#cb40-1289" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bdNormalize_hdf5</span>(</span>
<span id="cb40-1290"><a href="#cb40-1290" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> <span class="st">"1000G.hdf5"</span>,</span>
<span id="cb40-1291"><a href="#cb40-1291" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"data"</span>,</span>
<span id="cb40-1292"><a href="#cb40-1292" aria-hidden="true" tabindex="-1"></a>    <span class="at">dataset =</span> <span class="st">"genotypes"</span>,</span>
<span id="cb40-1293"><a href="#cb40-1293" aria-hidden="true" tabindex="-1"></a>    <span class="at">bcenter =</span> <span class="cn">TRUE</span>,</span>
<span id="cb40-1294"><a href="#cb40-1294" aria-hidden="true" tabindex="-1"></a>    <span class="at">bscale =</span> <span class="cn">FALSE</span></span>
<span id="cb40-1295"><a href="#cb40-1295" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb40-1296"><a href="#cb40-1296" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb40-1297"><a href="#cb40-1297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1298"><a href="#cb40-1298" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Normalization time (one-time cost):"</span>, norm_time[<span class="st">"elapsed"</span>], <span class="st">"seconds</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-1299"><a href="#cb40-1299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1300"><a href="#cb40-1300" aria-hidden="true" tabindex="-1"></a><span class="co"># Run PCA on pre-normalized data</span></span>
<span id="cb40-1301"><a href="#cb40-1301" aria-hidden="true" tabindex="-1"></a>opt3_time <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb40-1302"><a href="#cb40-1302" aria-hidden="true" tabindex="-1"></a>  opt3 <span class="ot">&lt;-</span> <span class="fu">bdPCA_hdf5</span>(</span>
<span id="cb40-1303"><a href="#cb40-1303" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> <span class="st">"1000G.hdf5"</span>,</span>
<span id="cb40-1304"><a href="#cb40-1304" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"NORMALIZED/data"</span>,</span>
<span id="cb40-1305"><a href="#cb40-1305" aria-hidden="true" tabindex="-1"></a>    <span class="at">dataset =</span> <span class="st">"genotypes"</span>,</span>
<span id="cb40-1306"><a href="#cb40-1306" aria-hidden="true" tabindex="-1"></a>    <span class="at">bcenter =</span> <span class="cn">FALSE</span>,  <span class="co"># Already normalized</span></span>
<span id="cb40-1307"><a href="#cb40-1307" aria-hidden="true" tabindex="-1"></a>    <span class="at">bscale =</span> <span class="cn">FALSE</span>,</span>
<span id="cb40-1308"><a href="#cb40-1308" aria-hidden="true" tabindex="-1"></a>    <span class="at">k =</span> <span class="dv">4</span>,</span>
<span id="cb40-1309"><a href="#cb40-1309" aria-hidden="true" tabindex="-1"></a>    <span class="at">q =</span> <span class="dv">1</span>,</span>
<span id="cb40-1310"><a href="#cb40-1310" aria-hidden="true" tabindex="-1"></a>    <span class="at">threads =</span> <span class="dv">4</span></span>
<span id="cb40-1311"><a href="#cb40-1311" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb40-1312"><a href="#cb40-1312" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb40-1313"><a href="#cb40-1313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1314"><a href="#cb40-1314" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"PCA time (using pre-normalized):"</span>, opt3_time[<span class="st">"elapsed"</span>], <span class="st">"seconds</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-1315"><a href="#cb40-1315" aria-hidden="true" tabindex="-1"></a>improvement3 <span class="ot">&lt;-</span> (opt2_time[<span class="st">"elapsed"</span>] <span class="sc">-</span> opt3_time[<span class="st">"elapsed"</span>]) <span class="sc">/</span> </span>
<span id="cb40-1316"><a href="#cb40-1316" aria-hidden="true" tabindex="-1"></a>                opt2_time[<span class="st">"elapsed"</span>] <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb40-1317"><a href="#cb40-1317" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Additional improvement:"</span>, <span class="fu">round</span>(improvement3, <span class="dv">1</span>), <span class="st">"%</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-1318"><a href="#cb40-1318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1319"><a href="#cb40-1319" aria-hidden="true" tabindex="-1"></a>final_improvement <span class="ot">&lt;-</span> (baseline_time[<span class="st">"elapsed"</span>] <span class="sc">-</span> opt3_time[<span class="st">"elapsed"</span>]) <span class="sc">/</span> </span>
<span id="cb40-1320"><a href="#cb40-1320" aria-hidden="true" tabindex="-1"></a>                     baseline_time[<span class="st">"elapsed"</span>] <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb40-1321"><a href="#cb40-1321" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"FINAL improvement vs baseline:"</span>, <span class="fu">round</span>(final_improvement, <span class="dv">1</span>), <span class="st">"%</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb40-1322"><a href="#cb40-1322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1323"><a href="#cb40-1323" aria-hidden="true" tabindex="-1"></a><span class="co"># Typical output:</span></span>
<span id="cb40-1324"><a href="#cb40-1324" aria-hidden="true" tabindex="-1"></a><span class="co">#   Normalization time: 4.23 seconds</span></span>
<span id="cb40-1325"><a href="#cb40-1325" aria-hidden="true" tabindex="-1"></a><span class="co">#   PCA time: 9.18 seconds</span></span>
<span id="cb40-1326"><a href="#cb40-1326" aria-hidden="true" tabindex="-1"></a><span class="co">#   Additional improvement: 28.5%</span></span>
<span id="cb40-1327"><a href="#cb40-1327" aria-hidden="true" tabindex="-1"></a><span class="co">#   FINAL improvement vs baseline: 60.9%</span></span>
<span id="cb40-1328"><a href="#cb40-1328" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-1329"><a href="#cb40-1329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1330"><a href="#cb40-1330" aria-hidden="true" tabindex="-1"></a>**Why this helped:** Profiling showed normalization consumed 25% of time. By pre-normalizing, we eliminate that 25% from each subsequent PCA run. If running only once, the one-time normalization cost negates some benefit. But for multiple runs (common in parameter tuning, cross-validation), savings multiply.</span>
<span id="cb40-1331"><a href="#cb40-1331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1332"><a href="#cb40-1332" aria-hidden="true" tabindex="-1"></a>**Amortized analysis:** If running 10 PCAs with different parameters:</span>
<span id="cb40-1333"><a href="#cb40-1333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1334"><a href="#cb40-1334" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Without pre-normalization: 10 × 12.84s = 128.4s total</span>
<span id="cb40-1335"><a href="#cb40-1335" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>With pre-normalization: 4.23s + 10 × 9.18s = 96.0s total (25% faster)</span>
<span id="cb40-1336"><a href="#cb40-1336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1337"><a href="#cb40-1337" aria-hidden="true" tabindex="-1"></a>For 100 runs: 4.23s + 100 × 9.18s = 922s vs 1284s (28% faster)</span>
<span id="cb40-1338"><a href="#cb40-1338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1339"><a href="#cb40-1339" aria-hidden="true" tabindex="-1"></a><span class="fu">### Verification of Correctness</span></span>
<span id="cb40-1340"><a href="#cb40-1340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1341"><a href="#cb40-1341" aria-hidden="true" tabindex="-1"></a><span class="in">```r</span></span>
<span id="cb40-1342"><a href="#cb40-1342" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== Verifying Correctness ===</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-1343"><a href="#cb40-1343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1344"><a href="#cb40-1344" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare principal components</span></span>
<span id="cb40-1345"><a href="#cb40-1345" aria-hidden="true" tabindex="-1"></a>pc_match <span class="ot">&lt;-</span> <span class="fu">all.equal</span>(</span>
<span id="cb40-1346"><a href="#cb40-1346" aria-hidden="true" tabindex="-1"></a>  baseline<span class="sc">$</span>components[, <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>],</span>
<span id="cb40-1347"><a href="#cb40-1347" aria-hidden="true" tabindex="-1"></a>  opt3<span class="sc">$</span>components[, <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>],</span>
<span id="cb40-1348"><a href="#cb40-1348" aria-hidden="true" tabindex="-1"></a>  <span class="at">tolerance =</span> <span class="fl">1e-10</span></span>
<span id="cb40-1349"><a href="#cb40-1349" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-1350"><a href="#cb40-1350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1351"><a href="#cb40-1351" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Principal components match:"</span>, pc_match, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-1352"><a href="#cb40-1352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1353"><a href="#cb40-1353" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare variance explained</span></span>
<span id="cb40-1354"><a href="#cb40-1354" aria-hidden="true" tabindex="-1"></a>var_match <span class="ot">&lt;-</span> <span class="fu">all.equal</span>(</span>
<span id="cb40-1355"><a href="#cb40-1355" aria-hidden="true" tabindex="-1"></a>  baseline<span class="sc">$</span>variance_prop[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>],</span>
<span id="cb40-1356"><a href="#cb40-1356" aria-hidden="true" tabindex="-1"></a>  opt3<span class="sc">$</span>variance_prop[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>],</span>
<span id="cb40-1357"><a href="#cb40-1357" aria-hidden="true" tabindex="-1"></a>  <span class="at">tolerance =</span> <span class="fl">1e-10</span></span>
<span id="cb40-1358"><a href="#cb40-1358" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-1359"><a href="#cb40-1359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1360"><a href="#cb40-1360" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Variance explained matches:"</span>, var_match, <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb40-1361"><a href="#cb40-1361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1362"><a href="#cb40-1362" aria-hidden="true" tabindex="-1"></a><span class="co"># Typical output:</span></span>
<span id="cb40-1363"><a href="#cb40-1363" aria-hidden="true" tabindex="-1"></a><span class="co">#   Principal components match: TRUE</span></span>
<span id="cb40-1364"><a href="#cb40-1364" aria-hidden="true" tabindex="-1"></a><span class="co">#   Variance explained matches: TRUE</span></span>
<span id="cb40-1365"><a href="#cb40-1365" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-1366"><a href="#cb40-1366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1367"><a href="#cb40-1367" aria-hidden="true" tabindex="-1"></a>**Critical step:** Always verify optimization doesn't change results. Numerical differences within tolerance (1e-10) are acceptable—floating-point arithmetic isn't perfectly deterministic. But results should be essentially identical.</span>
<span id="cb40-1368"><a href="#cb40-1368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1369"><a href="#cb40-1369" aria-hidden="true" tabindex="-1"></a><span class="fu">### Final Configuration Summary</span></span>
<span id="cb40-1370"><a href="#cb40-1370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1371"><a href="#cb40-1371" aria-hidden="true" tabindex="-1"></a><span class="in">```r</span></span>
<span id="cb40-1372"><a href="#cb40-1372" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=== Final Optimization Summary ===</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb40-1373"><a href="#cb40-1373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1374"><a href="#cb40-1374" aria-hidden="true" tabindex="-1"></a>summary_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb40-1375"><a href="#cb40-1375" aria-hidden="true" tabindex="-1"></a>  <span class="at">Configuration =</span> <span class="fu">c</span>(<span class="st">"Baseline"</span>, <span class="st">"Opt1: k=4"</span>, <span class="st">"Opt2: +threads"</span>, <span class="st">"Opt3: +prenorm"</span>),</span>
<span id="cb40-1376"><a href="#cb40-1376" aria-hidden="true" tabindex="-1"></a>  <span class="at">Time_seconds =</span> <span class="fu">c</span>(</span>
<span id="cb40-1377"><a href="#cb40-1377" aria-hidden="true" tabindex="-1"></a>    baseline_time[<span class="st">"elapsed"</span>],</span>
<span id="cb40-1378"><a href="#cb40-1378" aria-hidden="true" tabindex="-1"></a>    opt1_time[<span class="st">"elapsed"</span>],</span>
<span id="cb40-1379"><a href="#cb40-1379" aria-hidden="true" tabindex="-1"></a>    opt2_time[<span class="st">"elapsed"</span>],</span>
<span id="cb40-1380"><a href="#cb40-1380" aria-hidden="true" tabindex="-1"></a>    opt3_time[<span class="st">"elapsed"</span>]</span>
<span id="cb40-1381"><a href="#cb40-1381" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb40-1382"><a href="#cb40-1382" aria-hidden="true" tabindex="-1"></a>  <span class="at">Speedup =</span> <span class="fu">c</span>(</span>
<span id="cb40-1383"><a href="#cb40-1383" aria-hidden="true" tabindex="-1"></a>    <span class="fl">1.0</span>,</span>
<span id="cb40-1384"><a href="#cb40-1384" aria-hidden="true" tabindex="-1"></a>    baseline_time[<span class="st">"elapsed"</span>] <span class="sc">/</span> opt1_time[<span class="st">"elapsed"</span>],</span>
<span id="cb40-1385"><a href="#cb40-1385" aria-hidden="true" tabindex="-1"></a>    baseline_time[<span class="st">"elapsed"</span>] <span class="sc">/</span> opt2_time[<span class="st">"elapsed"</span>],</span>
<span id="cb40-1386"><a href="#cb40-1386" aria-hidden="true" tabindex="-1"></a>    baseline_time[<span class="st">"elapsed"</span>] <span class="sc">/</span> opt3_time[<span class="st">"elapsed"</span>]</span>
<span id="cb40-1387"><a href="#cb40-1387" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb40-1388"><a href="#cb40-1388" aria-hidden="true" tabindex="-1"></a>  <span class="at">Config_details =</span> <span class="fu">c</span>(</span>
<span id="cb40-1389"><a href="#cb40-1389" aria-hidden="true" tabindex="-1"></a>    <span class="st">"k=8, threads=2"</span>,</span>
<span id="cb40-1390"><a href="#cb40-1390" aria-hidden="true" tabindex="-1"></a>    <span class="st">"k=4, threads=2"</span>,</span>
<span id="cb40-1391"><a href="#cb40-1391" aria-hidden="true" tabindex="-1"></a>    <span class="st">"k=4, threads=4"</span>,</span>
<span id="cb40-1392"><a href="#cb40-1392" aria-hidden="true" tabindex="-1"></a>    <span class="st">"k=4, threads=4, prenorm"</span></span>
<span id="cb40-1393"><a href="#cb40-1393" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb40-1394"><a href="#cb40-1394" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-1395"><a href="#cb40-1395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1396"><a href="#cb40-1396" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(summary_df)</span>
<span id="cb40-1397"><a href="#cb40-1397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1398"><a href="#cb40-1398" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Final configuration:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-1399"><a href="#cb40-1399" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  - Pre-normalize data once</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-1400"><a href="#cb40-1400" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  - k = 4 (balance speed/memory)</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-1401"><a href="#cb40-1401" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  - threads = 4 (match physical cores)</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-1402"><a href="#cb40-1402" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  - Result: 60.9% faster than baseline</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-1403"><a href="#cb40-1403" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  - Verified: Results identical to baseline</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-1404"><a href="#cb40-1404" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-1405"><a href="#cb40-1405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1406"><a href="#cb40-1406" aria-hidden="true" tabindex="-1"></a>**Key lessons from case study:**</span>
<span id="cb40-1407"><a href="#cb40-1407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1408"><a href="#cb40-1408" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Profile identified the right targets:** Without profiling, we might have optimized I/O (only 12% of time) instead of SVD (60% of time)</span>
<span id="cb40-1409"><a href="#cb40-1409" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Incremental optimization works:** Each step provided measurable benefit (22%, 30%, 29%)</span>
<span id="cb40-1410"><a href="#cb40-1410" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Memory headroom enabled speed:** Having 16GB for a 2GB dataset let us reduce k aggressively</span>
<span id="cb40-1411"><a href="#cb40-1411" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Pre-computation pays off:** One-time normalization cost amortizes over multiple runs</span>
<span id="cb40-1412"><a href="#cb40-1412" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>**Verification is essential:** Always confirm results unchanged after optimization</span>
<span id="cb40-1413"><a href="#cb40-1413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1414"><a href="#cb40-1414" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb40-1415"><a href="#cb40-1415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1416"><a href="#cb40-1416" aria-hidden="true" tabindex="-1"></a><span class="fu">## Interactive Exercise {.exercise}</span></span>
<span id="cb40-1417"><a href="#cb40-1417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1418"><a href="#cb40-1418" aria-hidden="true" tabindex="-1"></a><span class="fu">### Apply Optimization to Your Data</span></span>
<span id="cb40-1419"><a href="#cb40-1419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1420"><a href="#cb40-1420" aria-hidden="true" tabindex="-1"></a>Use this exercise to practice optimization on your own datasets:</span>
<span id="cb40-1421"><a href="#cb40-1421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1422"><a href="#cb40-1422" aria-hidden="true" tabindex="-1"></a><span class="in">```r</span></span>
<span id="cb40-1423"><a href="#cb40-1423" aria-hidden="true" tabindex="-1"></a><span class="co"># ==========================================</span></span>
<span id="cb40-1424"><a href="#cb40-1424" aria-hidden="true" tabindex="-1"></a><span class="co"># Exercise 1: Baseline Measurement</span></span>
<span id="cb40-1425"><a href="#cb40-1425" aria-hidden="true" tabindex="-1"></a><span class="co"># ==========================================</span></span>
<span id="cb40-1426"><a href="#cb40-1426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1427"><a href="#cb40-1427" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Exercise 1: Establishing Baseline</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-1428"><a href="#cb40-1428" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"----------------------------------</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-1429"><a href="#cb40-1429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1430"><a href="#cb40-1430" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: Replace with your actual file, group, dataset</span></span>
<span id="cb40-1431"><a href="#cb40-1431" aria-hidden="true" tabindex="-1"></a>your_file <span class="ot">&lt;-</span> <span class="st">"your_data.hdf5"</span></span>
<span id="cb40-1432"><a href="#cb40-1432" aria-hidden="true" tabindex="-1"></a>your_group <span class="ot">&lt;-</span> <span class="st">"your_group"</span></span>
<span id="cb40-1433"><a href="#cb40-1433" aria-hidden="true" tabindex="-1"></a>your_dataset <span class="ot">&lt;-</span> <span class="st">"your_dataset"</span></span>
<span id="cb40-1434"><a href="#cb40-1434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1435"><a href="#cb40-1435" aria-hidden="true" tabindex="-1"></a>baseline_time <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb40-1436"><a href="#cb40-1436" aria-hidden="true" tabindex="-1"></a>  baseline_result <span class="ot">&lt;-</span> <span class="fu">bdPCA_hdf5</span>(</span>
<span id="cb40-1437"><a href="#cb40-1437" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> your_file,</span>
<span id="cb40-1438"><a href="#cb40-1438" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> your_group,</span>
<span id="cb40-1439"><a href="#cb40-1439" aria-hidden="true" tabindex="-1"></a>    <span class="at">dataset =</span> your_dataset,</span>
<span id="cb40-1440"><a href="#cb40-1440" aria-hidden="true" tabindex="-1"></a>    <span class="at">k =</span> <span class="dv">4</span>,</span>
<span id="cb40-1441"><a href="#cb40-1441" aria-hidden="true" tabindex="-1"></a>    <span class="at">threads =</span> <span class="dv">2</span></span>
<span id="cb40-1442"><a href="#cb40-1442" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb40-1443"><a href="#cb40-1443" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb40-1444"><a href="#cb40-1444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1445"><a href="#cb40-1445" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Baseline time:"</span>, <span class="fu">round</span>(baseline_time[<span class="st">"elapsed"</span>], <span class="dv">2</span>), <span class="st">"seconds</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-1446"><a href="#cb40-1446" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"User time:"</span>, <span class="fu">round</span>(baseline_time[<span class="st">"user"</span>], <span class="dv">2</span>), <span class="st">"seconds</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-1447"><a href="#cb40-1447" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"System time:"</span>, <span class="fu">round</span>(baseline_time[<span class="st">"system"</span>], <span class="dv">2</span>), <span class="st">"seconds</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb40-1448"><a href="#cb40-1448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1449"><a href="#cb40-1449" aria-hidden="true" tabindex="-1"></a><span class="co"># ==========================================</span></span>
<span id="cb40-1450"><a href="#cb40-1450" aria-hidden="true" tabindex="-1"></a><span class="co"># Exercise 2: Test Different k Values</span></span>
<span id="cb40-1451"><a href="#cb40-1451" aria-hidden="true" tabindex="-1"></a><span class="co"># ==========================================</span></span>
<span id="cb40-1452"><a href="#cb40-1452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1453"><a href="#cb40-1453" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Exercise 2: Testing Block Sizes (k)</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-1454"><a href="#cb40-1454" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"------------------------------------</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-1455"><a href="#cb40-1455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1456"><a href="#cb40-1456" aria-hidden="true" tabindex="-1"></a>k_values <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">8</span>, <span class="dv">16</span>)</span>
<span id="cb40-1457"><a href="#cb40-1457" aria-hidden="true" tabindex="-1"></a>k_times <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">length</span>(k_values))</span>
<span id="cb40-1458"><a href="#cb40-1458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1459"><a href="#cb40-1459" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(k_values)) {</span>
<span id="cb40-1460"><a href="#cb40-1460" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Testing k ="</span>, k_values[i], <span class="st">"... "</span>)</span>
<span id="cb40-1461"><a href="#cb40-1461" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb40-1462"><a href="#cb40-1462" aria-hidden="true" tabindex="-1"></a>  t <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb40-1463"><a href="#cb40-1463" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bdPCA_hdf5</span>(your_file, your_group, your_dataset,</span>
<span id="cb40-1464"><a href="#cb40-1464" aria-hidden="true" tabindex="-1"></a>               <span class="at">k=</span>k_values[i], <span class="at">threads=</span><span class="dv">2</span>)</span>
<span id="cb40-1465"><a href="#cb40-1465" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb40-1466"><a href="#cb40-1466" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb40-1467"><a href="#cb40-1467" aria-hidden="true" tabindex="-1"></a>  k_times[i] <span class="ot">&lt;-</span> t[<span class="st">"elapsed"</span>]</span>
<span id="cb40-1468"><a href="#cb40-1468" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">round</span>(k_times[i], <span class="dv">2</span>), <span class="st">"seconds</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-1469"><a href="#cb40-1469" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb40-1470"><a href="#cb40-1470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1471"><a href="#cb40-1471" aria-hidden="true" tabindex="-1"></a><span class="co"># Find optimal k</span></span>
<span id="cb40-1472"><a href="#cb40-1472" aria-hidden="true" tabindex="-1"></a>optimal_k <span class="ot">&lt;-</span> k_values[<span class="fu">which.min</span>(k_times)]</span>
<span id="cb40-1473"><a href="#cb40-1473" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Optimal k:"</span>, optimal_k, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-1474"><a href="#cb40-1474" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Best time:"</span>, <span class="fu">round</span>(<span class="fu">min</span>(k_times), <span class="dv">2</span>), <span class="st">"seconds</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb40-1475"><a href="#cb40-1475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1476"><a href="#cb40-1476" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot k vs time</span></span>
<span id="cb40-1477"><a href="#cb40-1477" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(k_values, k_times, <span class="at">type=</span><span class="st">"b"</span>, <span class="at">pch=</span><span class="dv">19</span>,</span>
<span id="cb40-1478"><a href="#cb40-1478" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab=</span><span class="st">"Number of Blocks (k)"</span>, <span class="at">ylab=</span><span class="st">"Time (seconds)"</span>,</span>
<span id="cb40-1479"><a href="#cb40-1479" aria-hidden="true" tabindex="-1"></a>     <span class="at">main=</span><span class="st">"Impact of Block Size on Performance"</span>,</span>
<span id="cb40-1480"><a href="#cb40-1480" aria-hidden="true" tabindex="-1"></a>     <span class="at">col=</span><span class="st">"blue"</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb40-1481"><a href="#cb40-1481" aria-hidden="true" tabindex="-1"></a><span class="fu">grid</span>()</span>
<span id="cb40-1482"><a href="#cb40-1482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1483"><a href="#cb40-1483" aria-hidden="true" tabindex="-1"></a><span class="co"># ==========================================</span></span>
<span id="cb40-1484"><a href="#cb40-1484" aria-hidden="true" tabindex="-1"></a><span class="co"># Exercise 3: Test Different Thread Counts</span></span>
<span id="cb40-1485"><a href="#cb40-1485" aria-hidden="true" tabindex="-1"></a><span class="co"># ==========================================</span></span>
<span id="cb40-1486"><a href="#cb40-1486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1487"><a href="#cb40-1487" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Exercise 3: Testing Thread Counts</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-1488"><a href="#cb40-1488" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"----------------------------------</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-1489"><a href="#cb40-1489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1490"><a href="#cb40-1490" aria-hidden="true" tabindex="-1"></a>thread_values <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">8</span>)</span>
<span id="cb40-1491"><a href="#cb40-1491" aria-hidden="true" tabindex="-1"></a>thread_times <span class="ot">&lt;-</span> <span class="fu">numeric</span>(<span class="fu">length</span>(thread_values))</span>
<span id="cb40-1492"><a href="#cb40-1492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1493"><a href="#cb40-1493" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(thread_values)) {</span>
<span id="cb40-1494"><a href="#cb40-1494" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Testing threads ="</span>, thread_values[i], <span class="st">"... "</span>)</span>
<span id="cb40-1495"><a href="#cb40-1495" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb40-1496"><a href="#cb40-1496" aria-hidden="true" tabindex="-1"></a>  t <span class="ot">&lt;-</span> <span class="fu">system.time</span>({</span>
<span id="cb40-1497"><a href="#cb40-1497" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bdPCA_hdf5</span>(your_file, your_group, your_dataset,</span>
<span id="cb40-1498"><a href="#cb40-1498" aria-hidden="true" tabindex="-1"></a>               <span class="at">k=</span>optimal_k, <span class="at">threads=</span>thread_values[i])</span>
<span id="cb40-1499"><a href="#cb40-1499" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb40-1500"><a href="#cb40-1500" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb40-1501"><a href="#cb40-1501" aria-hidden="true" tabindex="-1"></a>  thread_times[i] <span class="ot">&lt;-</span> t[<span class="st">"elapsed"</span>]</span>
<span id="cb40-1502"><a href="#cb40-1502" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">round</span>(thread_times[i], <span class="dv">2</span>), <span class="st">"seconds</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-1503"><a href="#cb40-1503" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb40-1504"><a href="#cb40-1504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1505"><a href="#cb40-1505" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate speedup and efficiency</span></span>
<span id="cb40-1506"><a href="#cb40-1506" aria-hidden="true" tabindex="-1"></a>speedup <span class="ot">&lt;-</span> thread_times[<span class="dv">1</span>] <span class="sc">/</span> thread_times</span>
<span id="cb40-1507"><a href="#cb40-1507" aria-hidden="true" tabindex="-1"></a>efficiency <span class="ot">&lt;-</span> speedup <span class="sc">/</span> thread_values</span>
<span id="cb40-1508"><a href="#cb40-1508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1509"><a href="#cb40-1509" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Threading Analysis:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-1510"><a href="#cb40-1510" aria-hidden="true" tabindex="-1"></a>results_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb40-1511"><a href="#cb40-1511" aria-hidden="true" tabindex="-1"></a>  <span class="at">Threads =</span> thread_values,</span>
<span id="cb40-1512"><a href="#cb40-1512" aria-hidden="true" tabindex="-1"></a>  <span class="at">Time =</span> <span class="fu">round</span>(thread_times, <span class="dv">2</span>),</span>
<span id="cb40-1513"><a href="#cb40-1513" aria-hidden="true" tabindex="-1"></a>  <span class="at">Speedup =</span> <span class="fu">round</span>(speedup, <span class="dv">2</span>),</span>
<span id="cb40-1514"><a href="#cb40-1514" aria-hidden="true" tabindex="-1"></a>  <span class="at">Efficiency =</span> <span class="fu">paste0</span>(<span class="fu">round</span>(efficiency <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>), <span class="st">"%"</span>)</span>
<span id="cb40-1515"><a href="#cb40-1515" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-1516"><a href="#cb40-1516" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(results_df)</span>
<span id="cb40-1517"><a href="#cb40-1517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1518"><a href="#cb40-1518" aria-hidden="true" tabindex="-1"></a><span class="co"># ==========================================</span></span>
<span id="cb40-1519"><a href="#cb40-1519" aria-hidden="true" tabindex="-1"></a><span class="co"># Exercise 4: Measure Memory Usage</span></span>
<span id="cb40-1520"><a href="#cb40-1520" aria-hidden="true" tabindex="-1"></a><span class="co"># ==========================================</span></span>
<span id="cb40-1521"><a href="#cb40-1521" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1522"><a href="#cb40-1522" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Exercise 4: Memory Usage by Configuration</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-1523"><a href="#cb40-1523" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"-------------------------------------------</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-1524"><a href="#cb40-1524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1525"><a href="#cb40-1525" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pryr)</span>
<span id="cb40-1526"><a href="#cb40-1526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1527"><a href="#cb40-1527" aria-hidden="true" tabindex="-1"></a>measure_memory <span class="ot">&lt;-</span> <span class="cf">function</span>(k_val) {</span>
<span id="cb40-1528"><a href="#cb40-1528" aria-hidden="true" tabindex="-1"></a>  mem_before <span class="ot">&lt;-</span> <span class="fu">mem_used</span>()</span>
<span id="cb40-1529"><a href="#cb40-1529" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb40-1530"><a href="#cb40-1530" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bdPCA_hdf5</span>(your_file, your_group, your_dataset,</span>
<span id="cb40-1531"><a href="#cb40-1531" aria-hidden="true" tabindex="-1"></a>             <span class="at">k=</span>k_val, <span class="at">threads=</span><span class="dv">2</span>)</span>
<span id="cb40-1532"><a href="#cb40-1532" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb40-1533"><a href="#cb40-1533" aria-hidden="true" tabindex="-1"></a>  mem_after <span class="ot">&lt;-</span> <span class="fu">mem_used</span>()</span>
<span id="cb40-1534"><a href="#cb40-1534" aria-hidden="true" tabindex="-1"></a>  (mem_after <span class="sc">-</span> mem_before) <span class="sc">/</span> <span class="dv">1024</span><span class="sc">^</span><span class="dv">2</span>  <span class="co"># Convert to MB</span></span>
<span id="cb40-1535"><a href="#cb40-1535" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb40-1536"><a href="#cb40-1536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1537"><a href="#cb40-1537" aria-hidden="true" tabindex="-1"></a>memory_usage <span class="ot">&lt;-</span> <span class="fu">sapply</span>(k_values, measure_memory)</span>
<span id="cb40-1538"><a href="#cb40-1538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1539"><a href="#cb40-1539" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Memory Usage by k:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-1540"><a href="#cb40-1540" aria-hidden="true" tabindex="-1"></a>mem_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb40-1541"><a href="#cb40-1541" aria-hidden="true" tabindex="-1"></a>  <span class="at">k =</span> k_values,</span>
<span id="cb40-1542"><a href="#cb40-1542" aria-hidden="true" tabindex="-1"></a>  <span class="at">Memory_MB =</span> <span class="fu">round</span>(memory_usage, <span class="dv">1</span>)</span>
<span id="cb40-1543"><a href="#cb40-1543" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-1544"><a href="#cb40-1544" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(mem_df)</span>
<span id="cb40-1545"><a href="#cb40-1545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1546"><a href="#cb40-1546" aria-hidden="true" tabindex="-1"></a><span class="co"># ==========================================</span></span>
<span id="cb40-1547"><a href="#cb40-1547" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary and Recommendations</span></span>
<span id="cb40-1548"><a href="#cb40-1548" aria-hidden="true" tabindex="-1"></a><span class="co"># ==========================================</span></span>
<span id="cb40-1549"><a href="#cb40-1549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1550"><a href="#cb40-1550" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">========================================</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-1551"><a href="#cb40-1551" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"OPTIMIZATION SUMMARY</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-1552"><a href="#cb40-1552" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"========================================</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb40-1553"><a href="#cb40-1553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1554"><a href="#cb40-1554" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Baseline configuration: k=4, threads=2</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-1555"><a href="#cb40-1555" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Baseline time:"</span>, <span class="fu">round</span>(baseline_time[<span class="st">"elapsed"</span>], <span class="dv">2</span>), <span class="st">"seconds</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb40-1556"><a href="#cb40-1556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1557"><a href="#cb40-1557" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Optimal configuration:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-1558"><a href="#cb40-1558" aria-hidden="true" tabindex="-1"></a>optimal_threads <span class="ot">&lt;-</span> thread_values[<span class="fu">which.min</span>(thread_times)]</span>
<span id="cb40-1559"><a href="#cb40-1559" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  k ="</span>, optimal_k, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-1560"><a href="#cb40-1560" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  threads ="</span>, optimal_threads, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-1561"><a href="#cb40-1561" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"  time ="</span>, <span class="fu">round</span>(<span class="fu">min</span>(thread_times), <span class="dv">2</span>), <span class="st">"seconds</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb40-1562"><a href="#cb40-1562" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1563"><a href="#cb40-1563" aria-hidden="true" tabindex="-1"></a>improvement <span class="ot">&lt;-</span> (baseline_time[<span class="st">"elapsed"</span>] <span class="sc">-</span> <span class="fu">min</span>(thread_times)) <span class="sc">/</span> </span>
<span id="cb40-1564"><a href="#cb40-1564" aria-hidden="true" tabindex="-1"></a>               baseline_time[<span class="st">"elapsed"</span>] <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb40-1565"><a href="#cb40-1565" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Improvement:"</span>, <span class="fu">round</span>(improvement, <span class="dv">1</span>), <span class="st">"%</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb40-1566"><a href="#cb40-1566" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1567"><a href="#cb40-1567" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Threading efficiency:"</span>, </span>
<span id="cb40-1568"><a href="#cb40-1568" aria-hidden="true" tabindex="-1"></a>    <span class="fu">round</span>(efficiency[<span class="fu">which.min</span>(thread_times)] <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>), <span class="st">"%</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-1569"><a href="#cb40-1569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1570"><a href="#cb40-1570" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (efficiency[<span class="fu">which.min</span>(thread_times)] <span class="sc">&lt;</span> <span class="fl">0.5</span>) {</span>
<span id="cb40-1571"><a href="#cb40-1571" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Note: Threading efficiency &lt;50% suggests bottleneck</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-1572"><a href="#cb40-1572" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Possible causes: I/O limitation, memory bandwidth, or BLAS threading</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb40-1573"><a href="#cb40-1573" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb40-1574"><a href="#cb40-1574" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-1575"><a href="#cb40-1575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1576"><a href="#cb40-1576" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip}</span>
<span id="cb40-1577"><a href="#cb40-1577" aria-hidden="true" tabindex="-1"></a><span class="fu">### Reflection Questions</span></span>
<span id="cb40-1578"><a href="#cb40-1578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1579"><a href="#cb40-1579" aria-hidden="true" tabindex="-1"></a>After completing the exercises, consider:</span>
<span id="cb40-1580"><a href="#cb40-1580" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1581"><a href="#cb40-1581" aria-hidden="true" tabindex="-1"></a>**About k (block size):**</span>
<span id="cb40-1582"><a href="#cb40-1582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1583"><a href="#cb40-1583" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>How does k affect time in your data? Is relationship linear?</span>
<span id="cb40-1584"><a href="#cb40-1584" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>What's the memory usage at your optimal k? Could you use smaller k?</span>
<span id="cb40-1585"><a href="#cb40-1585" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Does optimal k change with different thread counts?</span>
<span id="cb40-1586"><a href="#cb40-1586" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1587"><a href="#cb40-1587" aria-hidden="true" tabindex="-1"></a>**About threading:**</span>
<span id="cb40-1588"><a href="#cb40-1588" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1589"><a href="#cb40-1589" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>What speedup did you achieve with maximum threads?</span>
<span id="cb40-1590"><a href="#cb40-1590" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>What's your threading efficiency? Is it &gt;50%?</span>
<span id="cb40-1591"><a href="#cb40-1591" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>If efficiency is low, what bottleneck might exist? (Check user vs system time)</span>
<span id="cb40-1592"><a href="#cb40-1592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1593"><a href="#cb40-1593" aria-hidden="true" tabindex="-1"></a>**About your workflow:**</span>
<span id="cb40-1594"><a href="#cb40-1594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1595"><a href="#cb40-1595" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Could you pre-normalize to save time in repeated runs?</span>
<span id="cb40-1596"><a href="#cb40-1596" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Is I/O (system time) significant? (&gt;20% of elapsed time?)</span>
<span id="cb40-1597"><a href="#cb40-1597" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Would different HDF5 chunking help if I/O is high?</span>
<span id="cb40-1598"><a href="#cb40-1598" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>What's the best tradeoff for your specific needs?</span>
<span id="cb40-1599"><a href="#cb40-1599" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1600"><a href="#cb40-1600" aria-hidden="true" tabindex="-1"></a>**Decision making:**</span>
<span id="cb40-1601"><a href="#cb40-1601" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1602"><a href="#cb40-1602" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Which configuration would you use for production? Why?</span>
<span id="cb40-1603"><a href="#cb40-1603" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>How would your choice change if RAM was limited?</span>
<span id="cb40-1604"><a href="#cb40-1604" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>How would your choice change if speed was critical?</span>
<span id="cb40-1605"><a href="#cb40-1605" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>What evidence supports your configuration choice?</span>
<span id="cb40-1606"><a href="#cb40-1606" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb40-1607"><a href="#cb40-1607" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1608"><a href="#cb40-1608" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb40-1609"><a href="#cb40-1609" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1610"><a href="#cb40-1610" aria-hidden="true" tabindex="-1"></a><span class="fu">## Key Takeaways {.key-concept}</span></span>
<span id="cb40-1611"><a href="#cb40-1611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1612"><a href="#cb40-1612" aria-hidden="true" tabindex="-1"></a>Let's consolidate essential principles that guide effective performance optimization.</span>
<span id="cb40-1613"><a href="#cb40-1613" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1614"><a href="#cb40-1614" aria-hidden="true" tabindex="-1"></a>**Optimization is about tradeoffs, not absolutes.** There's no universally "best" configuration—optimal settings depend on your dataset size, available hardware, and whether memory or speed limits you more. Understanding why these tradeoffs exist helps you make intelligent decisions for your specific situation. When memory is tight, accept slower computation with more blocking. When speed matters and memory is abundant, minimize blocking for faster execution.</span>
<span id="cb40-1615"><a href="#cb40-1615" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1616"><a href="#cb40-1616" aria-hidden="true" tabindex="-1"></a>**Profile before optimizing.** Intuition about bottlenecks is frequently wrong. You might assume I/O dominates when actually computation takes 80% of time, or vice versa. Profiling with <span class="in">`system.time()`</span>, <span class="in">`Rprof()`</span>, or <span class="in">`profvis`</span> reveals where time actually goes. Focus optimization effort on operations consuming &gt;20% of total time—optimizing minor contributors wastes effort with minimal benefit.</span>
<span id="cb40-1617"><a href="#cb40-1617" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1618"><a href="#cb40-1618" aria-hidden="true" tabindex="-1"></a>**Block size (k) controls the fundamental memory-speed tradeoff.** Smaller k means fewer, larger blocks—faster but more RAM required. Larger k means many small blocks—slower but memory-efficient. Start with k that uses 50-70% of available RAM. If hitting memory limits, increase k. If memory usage is low and speed matters, decrease k. The relationship is roughly linear: doubling k halves memory usage and increases time by 20-50% depending on operation intensity.</span>
<span id="cb40-1619"><a href="#cb40-1619" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1620"><a href="#cb40-1620" aria-hidden="true" tabindex="-1"></a>**Threading scales only when operations parallelize.** More threads help when work divides independently (processing blocks in parallel, parallel BLAS operations). Threading doesn't help when operations are sequential, I/O-bound, or memory-bandwidth-limited. If 4 threads provide &lt;2× speedup compared to 1 thread, you've hit a fundamental bottleneck—adding more threads won't help. Common bottlenecks: disk I/O (all threads wait for disk), memory bandwidth (all threads compete for RAM access), Amdahl's law (inherent sequential portions limit parallelism).</span>
<span id="cb40-1621"><a href="#cb40-1621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1622"><a href="#cb40-1622" aria-hidden="true" tabindex="-1"></a>**HDF5 chunk size affects I/O performance dramatically.** Optimal chunking aligns chunks with your access patterns—row-wise chunks for row-wise operations, column-wise chunks for column-wise operations. Target 1-10 MB chunks that match typical block sizes. If profiling shows high system time (&gt;30% of elapsed time), investigate chunk size. Proper chunking can reduce I/O time by 50-80% for I/O-heavy operations.</span>
<span id="cb40-1623"><a href="#cb40-1623" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1624"><a href="#cb40-1624" aria-hidden="true" tabindex="-1"></a>**Leverage HDF5 persistence to avoid redundant computation.** Operations like normalization, centering, and scaling are deterministic—same input always produces same output. Compute these operations once, store results in HDF5, and reuse them in subsequent analyses. For workflows with repeated analyses (parameter sweeps, cross-validation, bootstrapping), pre-computation saves enormous time. A one-time normalization cost amortizes over hundreds of runs.</span>
<span id="cb40-1625"><a href="#cb40-1625" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1626"><a href="#cb40-1626" aria-hidden="true" tabindex="-1"></a>**Always verify correctness after optimization.** Faster incorrect results are worse than slower correct results. After each optimization, verify results match baseline within numerical tolerance. Test with <span class="in">`all.equal(result1, result2, tolerance=1e-10)`</span>. If results differ beyond floating-point noise, optimization introduced a bug—revert and investigate.</span>
<span id="cb40-1627"><a href="#cb40-1627" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1628"><a href="#cb40-1628" aria-hidden="true" tabindex="-1"></a>**Iterate systematically.** Start with conservative configuration guaranteed to complete successfully. Profile to identify bottlenecks. Optimize the biggest bottleneck. Measure improvement. Verify correctness. Repeat. Change one parameter at a time so you know what helped. Keep what works, revert what doesn't. Document your final configuration and the reasoning behind it.</span>
<span id="cb40-1629"><a href="#cb40-1629" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1630"><a href="#cb40-1630" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb40-1631"><a href="#cb40-1631" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1632"><a href="#cb40-1632" aria-hidden="true" tabindex="-1"></a><span class="fu">## Next Steps</span></span>
<span id="cb40-1633"><a href="#cb40-1633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1634"><a href="#cb40-1634" aria-hidden="true" tabindex="-1"></a>**Apply to your data:**</span>
<span id="cb40-1635"><a href="#cb40-1635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1636"><a href="#cb40-1636" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Profile your current workflows to identify where time goes</span>
<span id="cb40-1637"><a href="#cb40-1637" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Experiment with different k and thread values systematically</span>
<span id="cb40-1638"><a href="#cb40-1638" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Measure actual improvements—don't assume</span>
<span id="cb40-1639"><a href="#cb40-1639" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Verify results remain correct after each optimization</span>
<span id="cb40-1640"><a href="#cb40-1640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1641"><a href="#cb40-1641" aria-hidden="true" tabindex="-1"></a>**Explore advanced optimization:**</span>
<span id="cb40-1642"><a href="#cb40-1642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1643"><a href="#cb40-1643" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Study how different operations scale (SVD vs matrix multiplication vs statistical tests)</span>
<span id="cb40-1644"><a href="#cb40-1644" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Experiment with HDF5 chunking if I/O is your bottleneck</span>
<span id="cb40-1645"><a href="#cb40-1645" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Consider hybrid strategies: pre-compute expensive operations, cache intermediate results</span>
<span id="cb40-1646"><a href="#cb40-1646" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Learn about your BLAS library configuration (single-threaded vs multi-threaded)</span>
<span id="cb40-1647"><a href="#cb40-1647" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1648"><a href="#cb40-1648" aria-hidden="true" tabindex="-1"></a>**Deepen understanding:**</span>
<span id="cb40-1649"><a href="#cb40-1649" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1650"><a href="#cb40-1650" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Read about <span class="co">[</span><span class="ot">Block-wise Computing</span><span class="co">](../fundamentals/blockwise-computing.qmd)</span> mathematical foundations</span>
<span id="cb40-1651"><a href="#cb40-1651" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Explore <span class="co">[</span><span class="ot">HDF5 storage</span><span class="co">](../fundamentals/understanding-hdf5.qmd)</span> optimization in detail</span>
<span id="cb40-1652"><a href="#cb40-1652" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Study <span class="co">[</span><span class="ot">CCA implementation</span><span class="co">](../developing-methods/cca-r-implementation.qmd)</span> as complex workflow example</span>
<span id="cb40-1653"><a href="#cb40-1653" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Review BigDataStatMeth paper for algorithmic details and theoretical analysis</span>
<span id="cb40-1654"><a href="#cb40-1654" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1655"><a href="#cb40-1655" aria-hidden="true" tabindex="-1"></a>**Share knowledge:**</span>
<span id="cb40-1656"><a href="#cb40-1656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1657"><a href="#cb40-1657" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Document configurations that work well for your datasets and hardware</span>
<span id="cb40-1658"><a href="#cb40-1658" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Share benchmarking results with colleagues analyzing similar data</span>
<span id="cb40-1659"><a href="#cb40-1659" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Contribute performance findings to the community</span>
<span id="cb40-1660"><a href="#cb40-1660" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Help others optimize their workflows based on your experience</span>
<span id="cb40-1661"><a href="#cb40-1661" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1662"><a href="#cb40-1662" aria-hidden="true" tabindex="-1"></a>Performance optimization is empirical and iterative. What works for one dataset on one machine might not work for another dataset on different hardware. The principles here provide a systematic framework for discovering what works in your environment. Apply them methodically, measure carefully, and you'll achieve substantial improvements in your BigDataStatMeth workflows.</span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>© 2025 BigDataStatMeth - ISGlobal BRGE</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/isglobal-brge/BigDataStatMeth/edit/main/technical/performance.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/isglobal-brge/BigDataStatMeth/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/isglobal-brge/BigDataStatMeth">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item">
 License: GPL-3
  </li>  
</ul>
    </div>
  </div>
</footer>




<script src="../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>